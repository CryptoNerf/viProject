<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#d4d0c8">
    <title>Vi-Project</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="molecules_icon.png">
    <link rel="apple-touch-icon" href="molecules_icon.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #f5f5f5;
            color: #333;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #videoElement {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transform: scaleX(-1);
            transition: opacity 0.3s;
            z-index: 1;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #d4d0c8;
            padding: 20px;
            padding-top: 30px;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
            max-width: 320px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            font-family: 'MS Sans Serif', sans-serif;
        }

        #controls.minimized {
            transform: translateX(calc(100% + 20px));
            opacity: 0;
            pointer-events: none;
        }

        h2 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #000;
            font-weight: bold;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .control-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
            color: #000;
            font-family: 'MS Sans Serif', sans-serif;
        }

        /* Windows 95 —Å—Ç–∏–ª—å –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #c0c0c0;
            border-top: 2px solid #808080;
            border-left: 2px solid #808080;
            border-right: 2px solid #dfdfdf;
            border-bottom: 2px solid #dfdfdf;
            cursor: pointer;
            margin: 10px 0;
            border-radius: 0;
        }

        /* –¢—Ä–µ–∫ —Å–ª–∞–π–¥–µ—Ä–∞ (–¥–æ—Ä–æ–∂–∫–∞) - Chrome/Safari */
        input[type="range"]::-webkit-slider-track {
            width: 100%;
            height: 6px;
            background: #c0c0c0;
            border-top: 2px solid #808080;
            border-left: 2px solid #808080;
            border-right: 2px solid #dfdfdf;
            border-bottom: 2px solid #dfdfdf;
            border-radius: 0;
            box-sizing: border-box;
        }

        /* –¢—Ä–µ–∫ —Å–ª–∞–π–¥–µ—Ä–∞ (–¥–æ—Ä–æ–∂–∫–∞) - Firefox */
        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 6px;
            background: #c0c0c0;
            border-top: 2px solid #808080;
            border-left: 2px solid #808080;
            border-right: 2px solid #dfdfdf;
            border-bottom: 2px solid #dfdfdf;
            border-radius: 0;
            box-sizing: border-box;
        }

        /* –ü–æ–ª–∑—É–Ω–æ–∫ —Å–ª–∞–π–¥–µ—Ä–∞ - Chrome/Safari */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 18px;
            background: #d4d0c8;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            cursor: pointer;
            margin-top: 0px;
            border-radius: 0;
            box-sizing: border-box;
        }

        /* –ü–æ–ª–∑—É–Ω–æ–∫ —Å–ª–∞–π–¥–µ—Ä–∞ - Firefox */
        input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 18px;
            background: #d4d0c8;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            cursor: pointer;
            border-radius: 0;
            box-sizing: border-box;
        }

        /* –ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª–∑—É–Ω–æ–∫ */
        input[type="range"]:active::-webkit-slider-thumb {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #ffffff;
            border-bottom: 2px solid #ffffff;
        }

        input[type="range"]:active::-moz-range-thumb {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #ffffff;
            border-bottom: 2px solid #ffffff;
        }

        /* Windows 95 —Å—Ç–∏–ª—å –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ */
        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #ffffff;
            border: 2px inset #808080;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            margin-right: 6px;
        }

        /* –ì–∞–ª–æ—á–∫–∞ –¥–ª—è –æ—Ç–º–µ—á–µ–Ω–Ω–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞ */
        input[type="checkbox"]:checked::before {
            content: '‚úì';
            position: absolute;
            top: -2px;
            left: 1px;
            font-size: 14px;
            font-weight: bold;
            color: #000;
        }

        /* –§–æ–∫—É—Å –Ω–∞ —á–µ–∫–±–æ–∫—Å–µ */
        input[type="checkbox"]:focus {
            outline: 1px dotted #000;
            outline-offset: 2px;
        }

        .value-display {
            display: inline-block;
            margin-left: 10px;
            color: #000;
            font-weight: bold;
            font-family: 'MS Sans Serif', sans-serif;
        }

        button {
            width: 100%;
            padding: 8px 12px;
            margin-top: 8px;
            background: #d4d0c8;
            border: 2px outset #ffffff;
            color: #000;
            font-weight: normal;
            cursor: pointer;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 12px;
        }

        button:hover {
            background: #e0dcd4;
        }

        button:active {
            border-style: inset;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-group input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: #333;
        }

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: #d4d0c8;
            padding: 10px 18px;
            font-size: 11px;
            color: #000;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            border: 2px outset #ffffff;
            z-index: 10;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #333;
            text-align: center;
            z-index: 100;
        }

        .gesture-hint {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #d4d0c8;
            padding: 15px 20px;
            padding-top: 30px;
            font-size: 12px;
            color: #000;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            border: 2px outset #ffffff;
            max-width: 300px;
            z-index: 10;
            transition: transform 0.3s ease, opacity 0.3s ease;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .gesture-hint.minimized {
            transform: translateX(calc(-100% - 20px));
            opacity: 0;
            pointer-events: none;
        }

        .gesture-hint strong {
            display: block;
            margin-bottom: 8px;
            color: #000;
            font-size: 14px;
        }

        .audio-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 40px;
            background: #d4d0c8;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            overflow: hidden;
            z-index: 10;
        }

        .audio-bars {
            display: flex;
            align-items: flex-end;
            height: 100%;
            padding: 5px;
            gap: 2px;
        }

        .audio-bar {
            flex: 1;
            background: #333;
            border-radius: 2px;
            transition: height 0.1s;
        }

        /* –ö–Ω–æ–ø–∫–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π */
        .toggle-btn {
            position: absolute;
            width: 36px;
            height: 36px;
            background: #d4d0c8;
            border: 2px outset #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 11;
            font-size: 18px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .toggle-btn:hover {
            background: #e0dcd4;
        }

        .toggle-btn:active {
            border-style: inset;
        }

        #toggleHints {
            top: 20px;
            left: 20px;
        }

        #toggleControls {
            top: 20px;
            right: 20px;
        }

        #togglePalette {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .toggle-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ */
        .close-panel {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            min-width: 20px;
            min-height: 20px;
            background: #d4d0c8;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            border-radius: 0;
            cursor: pointer;
            padding: 0;
            margin: 0;
            font-size: 14px;
            line-height: 16px;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: none;
            flex-shrink: 0;
            font-family: 'MS Sans Serif', sans-serif;
            font-weight: bold;
        }

        .close-panel:hover {
            background: #e0dcd4;
        }

        .close-panel:active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #ffffff;
            border-bottom: 2px solid #ffffff;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–∏—Ç—Ä—ã –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
        #closePalette {
            display: none;
        }

        /* –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        #virtualControls {
            position: absolute;
            left: 10px;
            bottom: 80px;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            flex-direction: column;
            gap: 10px;
            z-index: 12;
        }

        #virtualControls.active {
            display: flex;
        }

        .virtual-btn {
            width: 50px;
            height: 50px;
            background: #d4d0c8;
            border: 2px outset #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            user-select: none;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .virtual-btn:active {
            border-style: inset;
        }

        .virtual-btn:hover {
            background: #e0dcd4;
        }

        .virtual-btn.selected {
            background: #8080ff;
            color: #fff;
            border-style: inset;
        }

        /* –£–¥–∞–ª–µ–Ω–æ –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫–∞ menu-toggle-btn - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ toggleControls */

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 768px) {
            #controls {
                top: 10px;
                right: 10px;
                padding: 20px;
                padding-top: 30px;
                max-width: calc(100vw - 40px); /* –®–∏—Ä–∏–Ω–∞ –ø–æ—á—Ç–∏ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ */
                width: 90vw;
                font-size: 14px; /* –£–≤–µ–ª–∏—á–µ–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
                background: #d4d0c8;
                max-height: 85vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                scrollbar-width: thin; /* –¢–æ–Ω–∫–∏–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –Ω–∞ Firefox */
            }

            /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –¥–ª—è Webkit */
            #controls::-webkit-scrollbar {
                width: 4px;
            }

            #controls::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
                border-radius: 2px;
            }

            #controls::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 2px;
            }

            /* Collapsed state for controls on mobile */
            #controls.mobile-collapsed {
                transform: translateX(calc(100% + 20px));
                opacity: 0;
                pointer-events: none;
            }

            h2 {
                font-size: 20px; /* –£–≤–µ–ª–∏—á–µ–Ω —Å 14px */
                margin-bottom: 15px;
            }

            h3 {
                font-size: 16px; /* –î–ª—è –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
            }

            .control-group {
                margin-bottom: 0px; /* –£–≤–µ–ª–∏—á–µ–Ω—ã –æ—Ç—Å—Ç—É–ø—ã */
            }

            label {
                font-size: 16px; /* –£–≤–µ–ª–∏—á–µ–Ω —Å 10px */
                line-height: 1.6;
                margin-bottom: 0px;
            }

            button {
                padding: 14px 18px; /* –£–≤–µ–ª–∏—á–µ–Ω—ã –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è */
                font-size: 16px; /* –£–≤–µ–ª–∏—á–µ–Ω —Å 11px */
                margin-top: 10px;
                min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Ç–∞–ø–∞ */
            }

            input[type="range"] {
                height: 32px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞ —Å–ª–∞–π–¥–µ—Ä–∞ */
                margin: 8px 0;
            }

            input[type="checkbox"] {
                width: 20px;
                height: 20px;
                margin-right: 10px;
            }

            /* –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –≥–∞–ª–æ—á–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            input[type="checkbox"]:checked::before {
                font-size: 18px;
                top: -4px;
                left: 1px;
            }

            .checkbox-group {
                margin-bottom: 15px;
            }

            .checkbox-group label {
                display: flex;
                align-items: center;
                cursor: pointer;
                padding: 8px;
            }

            .gesture-hint {
                top: 10px;
                left: 10px;
                padding: 15px 18px;
                padding-top: 30px;
                font-size: 14px; /* –£–≤–µ–ª–∏—á–µ–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
                max-width: 280px;
                background: #d4d0c8;
            }

            .gesture-hint div {
                line-height: 1.6;
                margin-bottom: 4px;
            }

            .gesture-hint strong {
                font-size: 18px; /* –£–≤–µ–ª–∏—á–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
            }

            /* –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –æ–Ω –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –º–µ–Ω—é */
            .mode-indicator {
                display: none !important;
            }

            .toggle-btn {
                width: 50px; /* –£–≤–µ–ª–∏—á–µ–Ω —Å 32px */
                height: 50px;
                font-size: 24px; /* –£–≤–µ–ª–∏—á–µ–Ω —Å 16px */
            }

            /* –ö–Ω–æ–ø–∫–∏ toggleHints –∏ toggleControls –Ω–∏–∂–µ –ø–∞–Ω–µ–ª–µ–π */
            #toggleHints, #toggleControls {
                z-index: 9;
            }

            /* –ö–Ω–æ–ø–∫–∞ togglePalette –≤—ã—à–µ, —á—Ç–æ–±—ã –±—ã—Ç—å –≤–∏–¥–∏–º–æ–π */
            #togglePalette {
                z-index: 20 !important; /* –í—ã—à–µ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
                bottom: 15px;
                left: 50%;
                transform: translateX(-50%); /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É */
                opacity: 1 !important; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∏–º–∞—è –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
                pointer-events: auto !important; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è */
            }

            /* –ù–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–≥–¥–∞ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
            #togglePalette:not(.visible) {
                opacity: 0 !important;
                pointer-events: none !important;
            }

            /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–µ–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .close-panel {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                min-height: 40px !important;
                font-size: 28px !important;
                line-height: 40px !important;
                background: rgba(255, 100, 100, 0.15);
            }

            .close-panel:hover {
                background: rgba(255, 100, 100, 0.25);
            }

            /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–∏—Ç—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            #closePalette {
                display: flex !important;
            }

            #toggleHints {
                top: 10px;
                left: 10px;
            }

            #toggleControls {
                top: 10px;
                right: 10px;
            }

            #status {
                bottom: 10px;
                left: 10px;
                padding: 10px 14px;
                font-size: 12px;
            }

            .audio-indicator {
                bottom: 10px;
                right: 10px;
                width: 100px;
                height: 30px;
            }

            .value-display {
                font-size: 16px; /* –£–≤–µ–ª–∏—á–µ–Ω —Å 11px */
                font-weight: bold;
            }

            /* Mobile-friendly color palette */
            #colorPalette {
                display: block !important; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π display: none */
                left: 50%;
                transform: translateX(-50%);
                width: 95%;
                max-width: 350px;
                padding: 8px;
                padding-top: 25px;
                bottom: 10px;
                max-height: 60vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                transition: transform 0.3s ease, opacity 0.3s ease; /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
                pointer-events: auto !important; /* –†–∞–∑—Ä–µ—à–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–∞–ª–∏—Ç—Ä–æ–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            }

            #colorPalette::-webkit-scrollbar {
                width: 4px;
            }

            #colorPalette::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
                border-radius: 2px;
            }

            #colorPalette::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 2px;
            }

            #colorPalette.mobile-collapsed {
                transform: translateX(-50%) translateY(calc(100% + 20px));
                opacity: 0;
                pointer-events: none !important; /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–≥–¥–∞ —Å–∫—Ä—ã—Ç–∞ */
            }

            #colorGrid {
                grid-template-columns: repeat(10, 20px); /* Reduce from 14 to 10 columns */
            }

            .color-section {
                margin-bottom: 6px;
            }

            .label-paint {
                font-size: 9px;
            }

            /* Paint toolbar mobile */
            #paintToolbar {
                width: 50px;
                left: 10px;
                padding: 4px;
            }

            .paint-tool {
                width: 20px;
                height: 20px;
                font-size: 14px;
                margin: 2px auto;
            }

            /* Mode indicator smaller on mobile */
            .mode-indicator {
                font-size: 13px;
                padding: 8px 18px;
                top: 15px;
            }
        }


        /* === PAINT –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê === */

        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å–ª–µ–≤–∞ (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º Paint) */
        #paintToolbar {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            background: #d4d0c8;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            padding: 5px;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            z-index: 15;
        }

        #paintToolbar.active {
            display: block;
        }

        .paint-tool {
            width: 24px;
            height: 24px;
            margin: 3px auto;
            background: #c0c0c0;
            border: 1px outset #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .paint-tool:hover {
            background: #b0b0b0;
        }

        .paint-tool:active {
            border-style: inset;
        }

        .paint-tool.selected {
            border: 2px inset #ffffff;
            background: #a0a0a0;
        }

        /* –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ –≤–Ω–∏–∑—É (–∫–∞–∫ –≤ Paint) */
        #colorPalette {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(212, 208, 200, 0.95);
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            padding: 10px;
            padding-top: 25px;
            display: none;
            z-index: 15;
            pointer-events: none; /* –ü–∞–Ω–µ–ª—å –ø—Ä–æ–∑—Ä–∞—á–Ω–∞ –¥–ª—è —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏ - –º–æ–∂–Ω–æ —Ä–∏—Å–æ–≤–∞—Ç—å —Å–∫–≤–æ–∑—å –Ω–µ—ë */
        }

        #colorPalette.active {
            display: block;
        }

        #colorPalette .color-section {
            margin-bottom: 8px;
        }

        /* –¢–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –ø–∞–ª–∏—Ç—Ä—ã –ª–æ–≤—è—Ç —Å–æ–±—ã—Ç–∏—è */
        #colorPalette button,
        #colorPalette input,
        #colorPalette .color-swatch,
        #colorPalette .color-box,
        #colorPalette label {
            pointer-events: auto;
        }

        #bgClearBtn {
            margin-top: 0px;
        }

        #paletteHandle {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to bottom, #ffffff, #d4d0c8);
            border-bottom: 1px solid #808080;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
            user-select: none;
            pointer-events: auto;
        }

        #paletteHandle:hover {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
        }

        #colorPalette .label-paint {
            font-size: 10px;
            color: #000;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            margin-bottom: 4px;
        }

        #colorGrid {
            display: grid;
            grid-template-columns: repeat(14, 20px);
            gap: 2px;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border: 1px solid #000;
            cursor: pointer;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1);
        }

        .color-swatch:hover {
            border: 2px solid #fff;
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        .color-swatch.selected {
            border: 3px solid #0000ff;
        }

        #currentColorDisplay {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .color-box {
            width: 32px;
            height: 32px;
            border: 2px inset #ffffff;
        }

        .color-label {
            font-size: 9px;
            text-align: center;
            margin-top: 2px;
            color: #000;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ - –Ω–∞—Å–ª–µ–¥—É–µ—Ç —Å—Ç–∏–ª–∏ –æ—Ç –æ–±—ã—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        #modeToggleBtn {
            margin-top: 15px;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ */
        .mode-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 20px;
            background: #d4d0c8;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            font-size: 14px;
            font-weight: bold;
            z-index: 16;
            display: none;
            font-family: 'MS Sans Serif', sans-serif;
            color: #000;
        }

        .mode-indicator.active {
            display: block;
        }

        .mode-indicator.gesture-mode {
            background: #c8f0c8;
            color: #000;
            border: 2px outset #ffffff;
        }

        .mode-indicator.editor-mode {
            background: #ffe8b4;
            color: #000;
            border: 2px outset #ffffff;
        }

        /* –ö–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–∞ –∑–∞–ª–∏–≤–∫–∏ */
        .fill-mode-btn {
            flex: 1;
            padding: 4px 8px;
            font-size: 11px;
            background: #d4d0c8;
            border: 2px outset #ffffff;
            cursor: pointer;
            font-family: 'MS Sans Serif', sans-serif;
            color: #000;
        }

        .fill-mode-btn:hover {
            background: #e0dcd4;
        }

        .fill-mode-btn:active {
            border-style: inset;
        }

        .fill-mode-btn.active {
            background: #8080ff;
            color: #fff;
            border-style: inset;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvas"></canvas>

        <div class="gesture-hint" id="gestureHint">
            <button class="close-panel" id="closeHints" title="–°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏">√ó</button>
            <strong>–ñ–µ—Å—Ç—ã:</strong>
            <div>‚úåÔ∏è –©–∏–ø–æ–∫ ‚Üí —Å–æ–∑–¥–∞—Ç—å –º–æ–ª–µ–∫—É–ª—É</div>
            <div>üòÆ –û—Ç–∫—Ä—ã—Ç—å —Ä–æ—Ç ‚Üí —Ä–µ–∂–∏–º ‚úé</div>
            <div>‚úã –õ–∞–¥–æ–Ω—å ‚Üí –¥–≤–∏–≥–∞—Ç—å –º–æ–ª–µ–∫—É–ª—É</div>
            <div>‚úã (–≤ —Ä–µ–∂–∏–º–µ ‚úé) ‚Üí —Ä–∞–∑–º–µ—Ä –∏ —Ñ–æ—Ä–º–∞</div>
            <div style="font-size: 10px; margin-left: 10px;">‚Ü≥ —à–∏—Ä–∏–Ω–∞ –ª–∞–¥–æ–Ω–∏ = —Ä–∞–∑–º–µ—Ä</div>
            <div style="font-size: 10px; margin-left: 10px;">‚Ü≥ –∑–∞–≥–Ω—É—Ç—ã–µ –ø–∞–ª—å—Ü—ã = —Ñ–æ—Ä–º–∞</div>
            <div>‚úä –ö—É–ª–∞–∫ 2 —Å–µ–∫ ‚Üí —Ñ–∏–∫—Å–∞—Ü–∏—è –º–æ–ª–µ–∫—É–ª—ã</div>
            <div>‚úä‚úä –î–≤–∞ –∫—É–ª–∞–∫–∞ 2 —Å–µ–∫ ‚Üí —Ñ–∏–∫—Å–∞—Ü–∏—è –í–°–ï–•</div>
            <div>ü§ô –ú–∏–∑–∏–Ω–µ—Ü ‚Üí —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>
            <div>ü§û –°–∫—Ä–µ—â. –ø–∞–ª—å—Ü—ã 2 —Å–µ–∫ ‚Üí —É–¥–∞–ª–∏—Ç—å</div>
            <div>üé§ –ó–≤—É–∫ ‚Üí –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–æ–Ω—Ç—É—Ä–∞</div>
        </div>

        <div class="toggle-btn" id="toggleHints" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏">üí°</div>

        <div id="controls">
            <button class="close-panel" id="closeControls" title="–°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å">√ó</button>
            <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>

            <div class="control-group">
                <label>–†–∞–∑–º–µ—Ä –º–æ–ª–µ–∫—É–ª—ã: <span class="value-display" id="molSize">100</span></label>
                <input type="range" id="molSizeSlider" min="50" max="300" value="100" step="10">
            </div>

            <div class="control-group">
                <label>–°–∏–ª–∞ —Å–ª–∏—è–Ω–∏—è: <span class="value-display" id="mergeStrength">1.5</span></label>
                <input type="range" id="mergeSlider" min="0.5" max="3" value="1.5" step="0.1">
            </div>

            <div class="control-group">
                <label>–ó–≤—É–∫–æ–≤–∞—è —Ä–µ–∞–∫—Ü–∏—è: <span class="value-display" id="audioSens">20</span></label>
                <input type="range" id="audioSensSlider" min="5" max="50" value="20" step="5">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="audioEnabled" checked>
                <label for="audioEnabled">–ó–≤—É–∫ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ–æ—Ä–º—É</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="showVideo">
                <label for="showVideo">–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ</label>
            </div>

            <button id="lockBtn">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ</button>
            <button id="unlockBtn">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ</button>
            <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
            <button id="modeToggleBtn">üé® –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞</button>

            <div class="checkbox-group" id="gestureDebugCheckbox" style="margin-top: 10px;">
                <input type="checkbox" id="showGestureDebug" checked>
                <label for="showGestureDebug">üîç –û—Ç–ª–∞–¥–∫–∞ –∂–µ—Å—Ç–æ–≤</label>
            </div>

            <h3 style="margin-top: 15px; margin-bottom: 8px; font-size: 14px; border-top: 1px solid #ccc; padding-top: 10px;">üì∏ –≠–∫—Å–ø–æ—Ä—Ç</h3>

            <div class="checkbox-group">
                <input type="checkbox" id="exportWithBackground" checked>
                <label for="exportWithBackground">–° —Ñ–æ–Ω–æ–º</label>
            </div>

            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                <button id="exportPngBtn" style="background: #4CAF50; color: white;">üì∑ –≠–∫—Å–ø–æ—Ä—Ç PNG</button>
                <button id="recordVideoBtn" style="background: #f44336; color: white;">
                    <span id="recordBtnText">üé• –ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ (30 —Å–µ–∫)</span>
                </button>
            </div>
        </div>

        <div class="toggle-btn" id="toggleControls" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å">‚öôÔ∏è</div>

        <div class="audio-indicator">
            <div class="audio-bars" id="audioBars"></div>
        </div>

        <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="loading" id="loading">
            <div>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
            <div style="font-size: 14px; margin-top: 10px;">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</div>
        </div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ -->
        <div class="mode-indicator gesture-mode active" id="modeIndicator">
            üëã –†–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤
        </div>

        <!-- Paint –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
        <div id="paintToolbar">
            <div class="paint-tool selected" data-tool="select" title="–í—ã–±–æ—Ä">üîç</div>
            <div class="paint-tool" data-tool="fill" title="–ó–∞–ª–∏–≤–∫–∞">ü™£</div>
            <div class="paint-tool" data-tool="pencil" title="–ö–∞—Ä–∞–Ω–¥–∞—à">‚úèÔ∏è</div>
            <div class="paint-tool" data-tool="eraser" title="–õ–∞—Å—Ç–∏–∫">üßπ</div>
        </div>

        <!-- Paint –ø–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ -->
        <div id="colorPalette">
            <button class="close-panel" id="closePalette" title="–°–∫—Ä—ã—Ç—å –ø–∞–ª–∏—Ç—Ä—É">√ó</button>
            <div id="paletteHandle">‚ãÆ‚ãÆ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è ‚ãÆ‚ãÆ</div>
            <div class="color-section">
                <div class="label-paint">–¶–≤–µ—Ç–∞:</div>
                <div id="colorGrid"></div>
            </div>
            <div class="color-section">
                <div class="label-paint">–¢–µ–∫—É—â–∏–π —Ü–≤–µ—Ç:</div>
                <div id="currentColorDisplay">
                    <div>
                        <div class="color-box" id="primaryColor" style="background: #000000;"></div>
                        <div class="color-label">–î–ª—è –º–æ–ª–µ–∫—É–ª</div>
                    </div>
                </div>
            </div>
            <div class="color-section">
                <div class="label-paint">–°–≤–æ–π —Ü–≤–µ—Ç –º–æ–ª–µ–∫—É–ª—ã:</div>
                <div style="margin-top: 5px;">
                    <input type="color" id="customPrimaryColor" value="#000000" style="width: 100%; height: 35px; border: 2px solid #999; cursor: pointer;" title="–í—ã–±—Ä–∞—Ç—å —Å–≤–æ–π —Ü–≤–µ—Ç –¥–ª—è –∑–∞–ª–∏–≤–∫–∏ –º–æ–ª–µ–∫—É–ª">
                </div>
            </div>
            <div class="color-section">
                <div class="label-paint" id="fillModeLabel">–†–µ–∂–∏–º –∑–∞–ª–∏–≤–∫–∏:</div>
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button class="fill-mode-btn active" data-mode="both" title="–û–±–∞">–û–±–∞</button>
                    <button class="fill-mode-btn" data-mode="interior" title="–¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å">–í–Ω—É—Ç—Ä–∏</button>
                    <button class="fill-mode-btn" data-mode="edge" title="–¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç—É—Ä">–ö–æ–Ω—Ç—É—Ä</button>
                </div>
            </div>
            <div class="color-section">
                <div class="label-paint">–≠—Ñ—Ñ–µ–∫—Ç—ã:</div>
                <div style="margin-top: 5px; display: flex; flex-direction: column; gap: 3px;">
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; cursor: pointer;">
                        <input type="checkbox" id="embossEffect" style="cursor: pointer;">
                        <span>–¢–∏—Å–Ω–µ–Ω–∏–µ</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; cursor: pointer;">
                        <input type="checkbox" id="microStripesEffect" style="cursor: pointer;">
                        <span>–ú–∏–∫—Ä–æ-–ø–æ–ª–æ—Å–∫–∏</span>
                    </label>
                    <div id="microStripesSettings" style="display: none; margin-left: 20px; margin-top: 5px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; gap: 8px; flex-direction: column;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 10px; color: #555;">–¶–≤–µ—Ç 1:</label>
                            <input type="color" id="stripeColor1" value="#ff0000" style="width: 100%; height: 25px; border: 1px solid #ccc; cursor: pointer;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 10px; color: #555;">–¶–≤–µ—Ç 2:</label>
                            <input type="color" id="stripeColor2" value="#0000ff" style="width: 100%; height: 25px; border: 1px solid #ccc; cursor: pointer;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 10px; color: #555;">–®–∏—Ä–∏–Ω–∞: <span id="stripeWidthValue">2</span>px</label>
                            <input type="range" id="stripeWidth" min="1" max="10" value="2" style="width: 100%; cursor: pointer;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 10px; color: #555;">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: <span id="stripeSpacingValue">3</span>px</label>
                            <input type="range" id="stripeSpacing" min="2" max="15" value="3" style="width: 100%; cursor: pointer;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="color-section">
                <div class="label-paint" id="pencilToolLabel">–ö–∞—Ä–∞–Ω–¥–∞—à:</div>
                <div style="margin-top: 5px; display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <label style="font-size: 11px;">–¢–æ–ª—â–∏–Ω–∞: <span id="pencilWidthValue">3</span>px</label>
                        <input type="range" id="pencilWidth" min="1" max="20" value="3" style="width: 100%; cursor: pointer;">
                    </div>
                    <div class="checkbox-group" id="smartEraserCheckbox" style="display: none;">
                        <input type="checkbox" id="smartEraser">
                        <label for="smartEraser" style="font-size: 11px;">‚ú® –£–º–Ω—ã–π –ª–∞—Å—Ç–∏–∫ (—É–¥–∞–ª—è–µ—Ç —Ü–µ–ª–∏–∫–æ–º)</label>
                    </div>
                    <button id="clearDrawings" style="padding: 6px 12px; cursor: pointer; font-size: 11px; background: #ff4444; color: white; border: 1px solid #cc0000; border-radius: 3px;">–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–∞—Ä–∞–Ω–¥–∞—à</button>
                </div>
            </div>
            <div class="color-section">
                <div class="label-paint">–§–æ–Ω canvas:</div>
                <div style="display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap;">
                    <input type="color" id="bgColorPicker" value="#ffffff" title="–¶–≤–µ—Ç —Ñ–æ–Ω–∞ canvas" style="width: 50px; height: 30px; border: 2px outset #fff; cursor: pointer;">
                    <label class="fill-mode-btn" style="padding: 4px 8px; cursor: pointer; flex: 1; min-width: 70px; text-align: center;">
                        –§–∞–π–ª
                        <input type="file" id="bgFilePicker" accept="image/*,video/*" style="display: none;">
                    </label>
                    <button class="fill-mode-btn" id="bgClearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ–Ω">‚úñ</button>
                </div>
                <div id="bgPreview" style="margin-top: 5px; font-size: 10px; color: #666;"></div>
            </div>
        </div>

        <div class="toggle-btn" id="togglePalette" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–ª–∏—Ç—Ä—É">üé®</div>

        <!-- –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
        <div id="virtualControls">
            <div class="virtual-btn" data-action="create" title="–°–æ–∑–¥–∞—Ç—å –º–æ–ª–µ–∫—É–ª—É">‚ûï</div>
            <div class="virtual-btn" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å –º–æ–ª–µ–∫—É–ª—É">üóëÔ∏è</div>
            <div class="virtual-btn" data-action="move" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –º–æ–ª–µ–∫—É–ª—É">‚úã</div>
            <div class="virtual-btn" data-action="scale-up" title="–£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä">‚¨ÜÔ∏è</div>
            <div class="virtual-btn" data-action="scale-down" title="–£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä">‚¨áÔ∏è</div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <script>
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ Service Worker –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                for (let registration of registrations) {
                    registration.unregister();
                    console.log('Service Worker —É–¥–∞–ª–µ–Ω');
                }
            });
        }

        // === –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ú–û–ë–ò–õ–¨–ù–û–ì–û –£–°–¢–†–û–ô–°–¢–í–ê ===
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ||
                        ('ontouchstart' in window) ||
                        (navigator.maxTouchPoints > 0);

        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        console.log('–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:', isMobile);
        console.log('–ü–æ–¥–¥–µ—Ä–∂–∫–∞ touch:', isTouchDevice);

        // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø TOUCH –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===
        let touchMode = isMobile ? 'create' : null; // –†–µ–∂–∏–º—ã: create, move, scale, delete
        let activeTouches = new Map(); // –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Å–∞–Ω–∏—è
        let initialPinchDistance = 0; // –î–ª—è pinch-to-zoom
        let touchedMolecule = null; // –ú–æ–ª–µ–∫—É–ª–∞ –∫–æ—Ç–æ—Ä—É—é —Ç—Ä–æ–≥–∞—é—Ç

        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('videoElement');
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');

        let width, height;
        let molecules = [];
        let hands = [];
        let previousPinchStates = [false, false];
        let audioLevel = 0;
        let audioFrequencyData = [];
        let isMouthOpen = false; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—Ç–∞
        let wasMouthOpen = false; // –ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—Ç–∞ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è
        let editingMolecule = null; // –ú–æ–ª–µ–∫—É–ª–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let hoveredMolecule = null; // –ú–æ–ª–µ–∫—É–ª–∞ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–≤–µ–¥–µ–Ω–∞ —Ä—É–∫–∞ –°–ï–ô–ß–ê–°
        let lastHoveredMolecule = null; // –ü–æ—Å–ª–µ–¥–Ω—è—è –º–æ–ª–µ–∫—É–ª–∞ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–≤–æ–¥–∏–ª–∏—Å—å

        // === –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê ===
        let editorMode = false; // false = –∂–µ—Å—Ç—ã, true = —Ä–µ–¥–∞–∫—Ç–æ—Ä
        let frozenMolecules = []; // –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –º–æ–ª–µ–∫—É–ª—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let selectedMolecule = null; // –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–ª–µ–∫—É–ª–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
        let hoveredMoleculeEditor = null; // –ú–æ–ª–µ–∫—É–ª–∞ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ

        // === –û–¢–õ–ê–î–ö–ê –ñ–ï–°–¢–û–í ===
        let showGestureDebug = true; // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–ª–∞–¥–∫–∏ –∂–µ—Å—Ç–æ–≤
        let currentTool = 'select'; // –¢–µ–∫—É—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (select, fill, pencil, eraser)
        let primaryColor = '#000000'; // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç
        let secondaryColor = '#ffffff'; // –§–æ–Ω–æ–≤—ã–π —Ü–≤–µ—Ç
        let fillMode = 'both'; // –†–µ–∂–∏–º –∑–∞–ª–∏–≤–∫–∏: 'interior' (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å), 'edge' (–∫–æ–Ω—Ç—É—Ä), 'both' (–æ–±–∞)

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä–∞–Ω–¥–∞—à–∞
        let pencilWidth = 3; // –¢–æ–ª—â–∏–Ω–∞ –∫–∞—Ä–∞–Ω–¥–∞—à–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        let smartEraserMode = false; // –†–µ–∂–∏–º —É–º–Ω–æ–≥–æ –ª–∞—Å—Ç–∏–∫–∞ (—É–¥–∞–ª—è–µ—Ç —Ü–µ–ª–∏–∫–æ–º –ø–æ –∫–ª–∏–∫—É)
        let drawnStrokes = []; // –ú–∞—Å—Å–∏–≤ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã—Ö —à—Ç—Ä–∏—Ö–æ–≤ { points: [{x, y}], color: string, width: number }
        let currentStroke = null; // –¢–µ–∫—É—â–∏–π —Ä–∏—Å—É–µ–º—ã–π —à—Ç—Ä–∏—Ö
        let isDrawing = false; // –§–ª–∞–≥ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        let filledRegions = []; // –ú–∞—Å—Å–∏–≤ –∑–∞–ª–∏—Ç—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π { imageData: ImageData, x: number, y: number, width: number, height: number }
        let backgroundFills = []; // –ú–∞—Å—Å–∏–≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–ª–∏–≤–æ–∫ (—Ä–∏—Å—É—é—Ç—Å—è –ø–æ–¥ –º–æ–ª–µ–∫—É–ª–∞–º–∏)

        // –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏–π (Ctrl+Z)
        let history = []; // –°—Ç–µ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–π
        const MAX_HISTORY_SIZE = 50; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π

        // –§–æ–Ω
        let backgroundColor = '#ffffff'; // –¶–≤–µ—Ç —Ñ–æ–Ω–∞
        let backgroundImage = null; // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ–Ω–∞ (Image –∏–ª–∏ video —ç–ª–µ–º–µ–Ω—Ç)
        let backgroundType = 'color'; // 'color', 'image', 'video'

        // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ–Ω–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        let backgroundCache = null; // OffscreenCanvas –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ–Ω–∞
        let backgroundCacheCtx = null;
        let backgroundCacheValid = false; // –§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–µ—à–∞

        // –ü–∞–ª–∏—Ç—Ä–∞ Paint (28 –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö —Ü–≤–µ—Ç–æ–≤)
        const paintColors = [
            '#000000', '#808080', '#800000', '#808000', '#008000', '#008080', '#000080', '#800080',
            '#808000', '#FFFFFF', '#C0C0C0', '#FF0000', '#FFFF00', '#00FF00', '#00FFFF', '#0000FF',
            '#FF00FF', '#FFFF80', '#80FFFF', '#FF8080', '#8080FF', '#FF80FF', '#804040', '#408080',
            '#804080', '#408040', '#FF8040', '#80FF40'
        ];

        // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–≤ - —Ö—Ä–∞–Ω–∏–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 –∫–∞–¥—Ä–æ–≤ (–£–õ–£–ß–®–ï–ù–û: –±—ã–ª–æ 5)
        // –ë–æ–ª—å—à–µ –∏—Å—Ç–æ—Ä–∏–∏ = –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è, –º–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
        const GESTURE_HISTORY_SIZE = 10;
        let gestureHistory = []; // –ú–∞—Å—Å–∏–≤ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ—Å—Ç–æ—è–Ω–∏–π —Ä—É–∫

        // –£–õ–£–ß–®–ï–ù–û v6: –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è - –∑–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞
        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "—Å–ª–µ—Ç–∞–Ω–∏–µ" –∂–µ—Å—Ç–æ–≤ –∏ –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
        const GESTURE_STABILITY = {
            pinch: { required: 6, history: [] },      // –©–∏–ø–æ–∫ - —Ç—Ä–µ–±—É–µ—Ç 6 –∏–∑ 10 –∫–∞–¥—Ä–æ–≤ (60%)
            pinky: { required: 5, history: [] },      // –ú–∏–∑–∏–Ω–µ—Ü - —Ç—Ä–µ–±—É–µ—Ç 5 –∏–∑ 10 (50%) - –£–°–ò–õ–ï–ù–û –¥–ª—è –º–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
            crossed: { required: 6, history: [] },    // –°–∫—Ä–µ—â–µ–Ω–Ω—ã–µ - —Ç—Ä–µ–±—É–µ—Ç 6 –∏–∑ 10 (60%)
            fist: { required: 5, history: [] },       // –ö—É–ª–∞–∫ - —Ç—Ä–µ–±—É–µ—Ç 5 –∏–∑ 10 (50%) - –£–°–ò–õ–ï–ù–û –¥–ª—è –º–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
            open: { required: 3, history: [] }        // –û—Ç–∫—Ä—ã—Ç–∞—è –ª–∞–¥–æ–Ω—å - —Ç—Ä–µ–±—É–µ—Ç 3 –∏–∑ 10 (30%)
        };

        // –ù–û–í–û–ï: –£–º–Ω–∞—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏–π —Ä—É–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const HAND_SMOOTHING_WINDOW = 5; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤ –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
        let handPositionHistory = []; // –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∑–∏—Ü–∏–π —Ä—É–∫ –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è

        // –§—É–Ω–∫—Ü–∏—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π —Ä—É–∫ (moving average)
        function smoothHandPositions(currentHands) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
            handPositionHistory.push(currentHands.map(h => ({
                x: h.x,
                y: h.y,
                handWidth: h.handWidth
            })));

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
            if (handPositionHistory.length > HAND_SMOOTHING_WINDOW) {
                handPositionHistory.shift();
            }

            // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏
            if (handPositionHistory.length < 2) {
                return currentHands;
            }

            // –í—ã—á–∏—Å–ª—è–µ–º —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
            const smoothedHands = currentHands.map((hand, handIndex) => {
                let sumX = 0, sumY = 0, sumWidth = 0;
                let count = 0;

                // –ë–µ—Ä—ë–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —ç—Ç–æ–π —Ä—É–∫–∏
                handPositionHistory.forEach(frame => {
                    if (frame[handIndex]) {
                        sumX += frame[handIndex].x;
                        sumY += frame[handIndex].y;
                        sumWidth += frame[handIndex].handWidth;
                        count++;
                    }
                });

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–µ—Å–∞ - –±–æ–ª–µ–µ —Å–≤–µ–∂–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤–∞–∂–Ω–µ–µ
                // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
                const alpha = 0.3; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (0 = —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—è, 1 = —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–µ)
                const avgX = sumX / count;
                const avgY = sumY / count;
                const avgWidth = sumWidth / count;

                return {
                    ...hand,
                    x: hand.x * alpha + avgX * (1 - alpha),
                    y: hand.y * alpha + avgY * (1 - alpha),
                    handWidth: hand.handWidth * alpha + avgWidth * (1 - alpha)
                };
            });

            return smoothedHands;
        }

        // –¢–∞–π–º–µ—Ä—ã –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è
        const HOLD_DURATION = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        const RESET_TOLERANCE = 300; // –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º —Ç–∞–π–º–µ—Ä–∞ (–º—Å)
        let fistHoldStart = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∫—É–ª–∞–∫–∞ –Ω–∞ –º–æ–ª–µ–∫—É–ª–µ
        let twoFistsHoldStart = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è –¥–≤—É—Ö –∫—É–ª–∞–∫–æ–≤
        let fistHoldMolecule = null; // –ú–æ–ª–µ–∫—É–ª–∞, –Ω–∞–¥ –∫–æ—Ç–æ—Ä–æ–π —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∫—É–ª–∞–∫
        let crossedHoldStart = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è —Å–∫—Ä–µ—â–µ–Ω–Ω—ã—Ö –ø–∞–ª—å—Ü–µ–≤
        let crossedHoldMolecule = null; // –ú–æ–ª–µ–∫—É–ª–∞, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç—è—Ç —É–¥–∞–ª–∏—Ç—å
        let crossedHoldLostTime = null; // –í—Ä–µ–º—è –∫–æ–≥–¥–∞ –∂–µ—Å—Ç –±—ã–ª –ø–æ—Ç–µ—Ä—è–Ω

        let config = {
            moleculeSize: 150, // –£–í–ï–õ–ò–ß–ï–ù–û: –±—ã–ª–æ 100, —Ç–µ–ø–µ—Ä—å 150 - –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–π –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
            mergeStrength: 1.5,
            audioSensitivity: 20,
            audioEnabled: true,
            showVideo: false
        };

        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –º–æ–ª–µ–∫—É–ª (–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ resize())
        let minMoleculeSize = 30;  // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –º–æ–ª–µ–∫—É–ª—ã
        let maxMoleculeSize = 300; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –º–æ–ª–µ–∫—É–ª—ã

        // –ê—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–µ—Ç–∞–±–æ–ª–ª–æ–≤
        // –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—É—á–∞—é—Ç –ø–æ–Ω–∏–∂–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        let gridResolution = isMobile ? 20 : 15; // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–µ—Ç–∫–∏ –¥–ª—è marching squares (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ)
        const baseGridResolution = isMobile ? 20 : 15; // –ë–∞–∑–æ–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ö–æ—Ä–æ—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const lowQualityGridResolution = isMobile ? 30 : 25; // –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
        let currentFillResolution = isMobile ? 6 : 4; // –¢–µ–∫—É—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞–ª–∏–≤–∫–∏ (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ)

        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–æ–ª–µ–∫—É–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const maxMolecules = isMobile ? 30 : 100;

        // –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        let frameTimeHistory = [];
        const frameTimeHistorySize = 10; // –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º 10 –∫–∞–¥—Ä–∞–º
        let isLowPerformanceMode = isMobile; // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –Ω–∞—á–∏–Ω–∞–µ–º —Å —Ä–µ–∂–∏–º–∞ –Ω–∏–∑–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

        // –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (Spatial Hashing)
        const spatialCellSize = 150; // –†–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–µ—Ç–∫–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–¥–∏—É—Å–∞ –≤–ª–∏—è–Ω–∏—è –º–æ–ª–µ–∫—É–ª—ã)
        let spatialHash = new Map(); // –•–µ—à-—Ç–∞–±–ª–∏—Ü–∞: –∫–ª—é—á = "x,y" –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏, –∑–Ω–∞—á–µ–Ω–∏–µ = –º–∞—Å—Å–∏–≤ –º–æ–ª–µ–∫—É–ª

        // –§—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ö–µ—à–∞
        function buildSpatialHash() {
            spatialHash.clear();

            for (const mol of molecules) {
                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è –º–æ–ª–µ–∫—É–ª—ã —Å —É—á—ë—Ç–æ–º —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è
                // –î–ª—è –≤—ã—Ç—è–Ω—É—Ç—ã—Ö –º–æ–ª–µ–∫—É–ª —Ä–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è –±–æ–ª—å—à–µ
                const maxStretch = Math.max(mol.stretchX || 1, mol.stretchY || 1);
                const influenceRadius = mol.size * maxStretch * 2.5; // –ó–∞–ø–∞—Å –¥–ª—è –≤—ã—Ç—è–Ω—É—Ç—ã—Ö –º–æ–ª–µ–∫—É–ª

                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —è—á–µ–π–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã —ç—Ç–æ–π –º–æ–ª–µ–∫—É–ª–æ–π
                const minCellX = Math.floor((mol.x - influenceRadius) / spatialCellSize);
                const maxCellX = Math.floor((mol.x + influenceRadius) / spatialCellSize);
                const minCellY = Math.floor((mol.y - influenceRadius) / spatialCellSize);
                const maxCellY = Math.floor((mol.y + influenceRadius) / spatialCellSize);

                // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–ª–µ–∫—É–ª—É –≤–æ –≤—Å–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —è—á–µ–π–∫–∏
                for (let cy = minCellY; cy <= maxCellY; cy++) {
                    for (let cx = minCellX; cx <= maxCellX; cx++) {
                        const key = `${cx},${cy}`;
                        if (!spatialHash.has(key)) {
                            spatialHash.set(key, []);
                        }
                        spatialHash.get(key).push(mol);
                    }
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–ª–µ–∫—É–ª, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ —Ç–æ—á–∫—É (x, y)
        function getNearbyMolecules(x, y) {
            const cellX = Math.floor(x / spatialCellSize);
            const cellY = Math.floor(y / spatialCellSize);
            const key = `${cellX},${cellY}`;
            return spatialHash.get(key) || [];
        }

        // –§—É–Ω–∫—Ü–∏—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function adaptRenderingQuality(frameTime) {
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–¥—Ä–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
            frameTimeHistory.push(frameTime);
            if (frameTimeHistory.length > frameTimeHistorySize) {
                frameTimeHistory.shift();
            }

            // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∫–∞–¥—Ä–∞
            const avgFrameTime = frameTimeHistory.reduce((a, b) => a + b, 0) / frameTimeHistory.length;

            // –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –∫–∞–¥—Ä–∞ - –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Ü–µ–ª–∏–º—Å—è –≤ 30 FPS –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –±–∞—Ç–∞—Ä–µ–∏
            const targetFrameTime = isMobile ? 33.33 : 16.67; // 30 FPS –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö, 60 FPS –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
            const criticalFrameTime = isMobile ? 66.67 : 50; // 15 FPS –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö, 20 FPS –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞

            // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞
            if (avgFrameTime > criticalFrameTime && !isLowPerformanceMode) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º –Ω–∏–∑–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                isLowPerformanceMode = true;
                gridResolution = lowQualityGridResolution;
                currentFillResolution = 8; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∞–≥ –∑–∞–ª–∏–≤–∫–∏
                console.log('‚ö†Ô∏è –†–µ–∂–∏–º –Ω–∏–∑–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');

                // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ–º –¥–æ—Ä–æ–≥–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
                if (isMobile) {
                    const embossCheckbox = document.getElementById('embossEffect');
                    const microStripesCheckbox = document.getElementById('microStripesEffect');
                    if (embossCheckbox) embossCheckbox.checked = false;
                    if (microStripesCheckbox) microStripesCheckbox.checked = false;
                }
            } else if (avgFrameTime < targetFrameTime * 1.5 && isLowPerformanceMode && !isMobile) {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –∫–∞—á–µ—Å—Ç–≤—É (—Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ, –º–æ–±–∏–ª—å–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ —ç–∫–æ–Ω–æ–º–∏–∏)
                isLowPerformanceMode = false;
                gridResolution = baseGridResolution;
                currentFillResolution = 4;
                console.log('‚úÖ –í–æ–∑–≤—Ä–∞—Ç –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –∫–∞—á–µ—Å—Ç–≤—É');
            } else if (avgFrameTime > targetFrameTime && avgFrameTime <= criticalFrameTime && !isLowPerformanceMode) {
                // –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å - –Ω–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∂–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
                gridResolution = Math.floor((baseGridResolution + lowQualityGridResolution) / 2); // 20
                currentFillResolution = 6;
            }
        }

        // –ö–ª–∞—Å—Å –º–æ–ª–µ–∫—É–ª—ã (–º–µ—Ç–∞–±–æ–ª)
        class Molecule {
            constructor(x, y, size) {
                this.x = x;
                this.y = y;
                this.baseSize = size;
                this.size = size;
                this.targetSize = size;  // –¶–µ–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                this.vx = 0;
                this.vy = 0;
                this.targetX = x;
                this.targetY = y;

                // –î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç —Ä—É–∫
                this.stretchX = 1;
                this.stretchY = 1;

                // –£–≥–æ–ª –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–¥–ª—è —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è –ø–æ–¥ —É–≥–ª–æ–º)
                this.deformAngle = 0;

                // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                this._cachedCos = 1; // cos(0)
                this._cachedSin = 0; // sin(0)
                this._lastCachedAngle = 0;

                // –î–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ - –ø–æ–∑–∏—Ü–∏–∏ —Ä—É–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                this.editingHands = null; // { hand1: {x, y}, hand2: {x, y} }

                // –î–ª—è –∑–≤—É–∫–æ–≤—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
                this.audioPhase = Math.random() * Math.PI * 2;
                this.creationAudioLevel = audioLevel;

                // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞—Ö–≤–∞—Ç–∞
                this.isGrabbed = false;
                this.isLocked = false; // –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–∑–∏—Ü–∏—è
                this.isShapeLocked = false; // –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ —Ñ–æ—Ä–º–∞ (—Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ)
                this.isEditing = false; // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

                // –¶–≤–µ—Ç–∞ –¥–ª—è Paint —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (—Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ)
                this.fillColor = null; // –¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                this.edgeColor = null; // –¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –∫–æ–Ω—Ç—É—Ä–∞ (–ø–∏–∫—Å–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
                this.emboss = false; // –≠—Ñ—Ñ–µ–∫—Ç —Ç–∏—Å–Ω–µ–Ω–∏—è (bevel & emboss)
                this.microStripes = false; // –≠—Ñ—Ñ–µ–∫—Ç –º–∏–∫—Ä–æ-–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã—Ö –ø–æ–ª–æ—Å–æ–∫
                this.stripeColor1 = '#ff0000'; // –¶–≤–µ—Ç 1 –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –ø–æ–ª–æ—Å–æ–∫
                this.stripeColor2 = '#0000ff'; // –¶–≤–µ—Ç 2 –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –ø–æ–ª–æ—Å–æ–∫
                this.stripeWidth = 2; // –®–∏—Ä–∏–Ω–∞ –ø–æ–ª–æ—Å–æ–∫
                this.stripeSpacing = 3; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–æ–ª–æ—Å–∫–∞–º–∏

                // –ö–µ—à –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                this._gradientCache = null;
                this._gradientCacheKey = null;

                // –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã - —Å—á–µ—Ç—á–∏–∫ –∫–∞–¥—Ä–æ–≤ —Å –¥–≤—É–º—è —Ä—É–∫–∞–º–∏
                this.twoHandsFrameCount = 0; // –°–∫–æ–ª—å–∫–æ –∫–∞–¥—Ä–æ–≤ –ø–æ–¥—Ä—è–¥ –≤–∏–¥–∏–º 2 —Ä—É–∫–∏
                this.STABLE_HANDS_THRESHOLD = 5; // –ù—É–∂–Ω–æ 5 –∫–∞–¥—Ä–æ–≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
            }

            update() {
                // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏ (–µ—Å–ª–∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)
                if (!this.isLocked) {
                    this.x += (this.targetX - this.x) * 0.1;
                    this.y += (this.targetY - this.y) * 0.1;
                }

                // –ü–ª–∞–≤–Ω–∞—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è (–µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)
                // –£–ü–†–û–©–ï–ù–û: –ø—Ä—è–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–µ–∑ targetStretch –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
                if (!this.isShapeLocked) {
                    // –î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                }

                // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
                this.size += (this.targetSize - this.size) * 0.1;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–∑—É –¥–ª—è –∑–≤—É–∫–∞
                this.audioPhase += 0.05;

                // –ï—Å–ª–∏ –º–æ–ª–µ–∫—É–ª–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ - –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –∂–µ—Å—Ç—ã
                if (this.isLocked) {
                    this.isGrabbed = false;
                    return;
                }

                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä—É–∫–∏
                let openHands = hands.filter(h => h.isOpen && !h.isPinching && !h.isFist);

                if (this.isEditing) {
                    // –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤—É–º—è —Ä—É–∫–∞–º–∏
                    if (openHands.length === 2) {
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                        this.twoHandsFrameCount++;

                        // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä—É–∫ –¥–ª—è —É–≥–ª–∞ –∏ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è (–±–µ–∑ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è)
                        // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ —Ü–µ–Ω—Ç—Ä–∞ –º–æ–ª–µ–∫—É–ª—ã
                        const rawHand1 = openHands[0];
                        const rawHand2 = openHands[1];

                        this.isGrabbed = true;

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Ä—É–∫ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                        this.editingHands = {
                            hand1: { x: rawHand1.x, y: rawHand1.y },
                            hand2: { x: rawHand2.x, y: rawHand2.y }
                        };

                        // === –î–ï–§–û–†–ú–ê–¶–ò–Ø: –º–µ–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä—É–∫–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã ===
                        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
                        if (this.twoHandsFrameCount >= this.STABLE_HANDS_THRESHOLD) {
                            // –í–µ–∫—Ç–æ—Ä –º–µ–∂–¥—É —Ä—É–∫–∞–º–∏
                            const handsVecX = rawHand2.x - rawHand1.x;
                            const handsVecY = rawHand2.y - rawHand1.y;
                            const handsDist = Math.sqrt(handsVecX * handsVecX + handsVecY * handsVecY);

                            // –£–ì–û–õ: –ø—Ä—è–º–æ –æ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è —Ä—É–∫, –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫
                            this.deformAngle = Math.atan2(handsVecY, handsVecX);

                            // –†–ê–°–¢–Ø–ñ–ï–ù–ò–ï –í–î–û–õ–¨ –û–°–ò –†–£–ö (X –≤ –ø–æ–≤—ë—Ä–Ω—É—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
                            // –ü—Ä—è–º–∞—è –ø—Ä–æ–ø–æ—Ä—Ü–∏—è: handsDist / baseSize
                            const baseStretch = handsDist / this.size;
                            this.stretchX = Math.max(0.2, Math.min(5.0, baseStretch));

                            // –°–ñ–ê–¢–ò–ï –ü–û–ü–ï–†–Å–ö (Y –≤ –ø–æ–≤—ë—Ä–Ω—É—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
                            // –ö–æ–≥–¥–∞ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –≤–¥–æ–ª—å - —Å–∂–∏–º–∞–µ–º –ø–æ–ø–µ—Ä—ë–∫ (–∫–∞–∫ —Ä–µ–∑–∏–Ω–∫–∞)
                            if (this.stretchX > 1.2) {
                                // –ï—Å–ª–∏ —Ä–∞—Å—Ç—è–Ω—É—Ç–∞ - —Å–∂–∏–º–∞–µ–º –ø–æ–ø–µ—Ä—ë–∫
                                this.stretchY = Math.max(0.3, 1.0 / Math.sqrt(this.stretchX));
                            } else if (this.stretchX < 0.8) {
                                // –ï—Å–ª–∏ —Å–∂–∞—Ç–∞ –≤–¥–æ–ª—å - —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –ø–æ–ø–µ—Ä—ë–∫
                                this.stretchY = Math.min(2.5, 1.0 / Math.sqrt(this.stretchX));
                            } else {
                                // –ë–ª–∏–∑–∫–æ –∫ 1.0 - –ø–æ—á—Ç–∏ –∫—Ä—É–≥–ª–∞—è
                                this.stretchY = 1.0;
                            }
                        }
                        // –ï—Å–ª–∏ —Ä—É–∫–∏ –µ—â—ë –Ω–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã - —Ñ–æ—Ä–º–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å

                        // === –ü–û–ó–ò–¶–ò–Ø –ò –†–ê–ó–ú–ï–†: –º–æ–∂–µ–º —Å–≥–ª–∞–¥–∏—Ç—å –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ ===

                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ª—ë–≥–∫–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∫ –ø–æ–∑–∏—Ü–∏—è–º (–Ω–µ –∫ —É–≥–ª—É!)
                        const smoothedHands = smoothHandPositions(openHands);
                        const hand1 = smoothedHands[0];
                        const hand2 = smoothedHands[1];

                        // –¶–µ–Ω—Ç—Ä –º–µ–∂–¥—É –¥–≤—É–º—è —Ä—É–∫–∞–º–∏ (—Å–≥–ª–∞–∂–µ–Ω–Ω—ã–π –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è)
                        const centerX = (hand1.x + hand2.x) / 2;
                        const centerY = (hand1.y + hand2.y) / 2;

                        this.targetX = centerX;
                        this.targetY = centerY;

                        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–ó–ú–ï–†–û–ú - —Å—Ä–µ–¥–Ω—è—è —à–∏—Ä–∏–Ω–∞ –ª–∞–¥–æ–Ω–µ–π
                        const avgHandWidth = (hand1.handWidth + hand2.handWidth) / 2;
                        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
                        const sizeMultiplier = maxMoleculeSize * 2.5; // ~750 –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞, ~300 –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤
                        const newSize = Math.max(minMoleculeSize, Math.min(maxMoleculeSize * 2, avgHandWidth * sizeMultiplier));
                        this.targetSize = newSize;
                    } else if (openHands.length === 1) {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –µ—Å–ª–∏ –≤–∏–¥–∏–º –æ–¥–Ω—É —Ä—É–∫—É
                        this.twoHandsFrameCount = 0;
                        // –û–¥–Ω–∞ —Ä—É–∫–∞ - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏ —Ä–∞–∑–º–µ—Ä
                        const hand = openHands[0];
                        const dist = Math.sqrt((this.x - hand.x) ** 2 + (this.y - hand.y) ** 2);

                        if (dist < 150) {
                            this.isGrabbed = true;
                            this.targetX = hand.x;
                            this.targetY = hand.y;

                            // –®–∏—Ä–∏–Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ª–∞–¥–æ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ–¥ —ç–∫—Ä–∞–Ω)
                            const sizeMultiplier = maxMoleculeSize * 2.5; // ~750 –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞, ~300 –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤
                            const newSize = Math.max(minMoleculeSize, Math.min(maxMoleculeSize * 2, hand.handWidth * sizeMultiplier));
                            this.targetSize = newSize;

                            // –§–æ—Ä–º–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–π —Ä—É–∫–æ–π
                            this.editingHands = null;
                        } else {
                            this.isGrabbed = false;
                            this.editingHands = null;
                        }
                    } else {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –µ—Å–ª–∏ —Ä—É–∫ –Ω–µ—Ç –∏–ª–∏ –Ω–µ –≤–∏–¥–∏–º –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                        this.twoHandsFrameCount = 0;
                        this.isGrabbed = false;
                        this.editingHands = null;
                    }
                } else if (!this.isEditing && openHands.length === 1) {
                    // –û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ª–∞–¥–æ–Ω—å—é (—Ñ–æ—Ä–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è!)
                    const hand = openHands[0];
                    const dist = Math.sqrt((this.x - hand.x) ** 2 + (this.y - hand.y) ** 2);

                    if (dist < 120) {
                        this.isGrabbed = true;
                        this.targetX = hand.x;
                        this.targetY = hand.y;
                        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –§–æ—Ä–º–∞ –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
                    } else {
                        this.isGrabbed = false;
                    }
                } else {
                    // –ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä—É–∫ - –æ—Ç–ø—É—Å–∫–∞–µ–º
                    this.isGrabbed = false;
                }

                // –ì—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
                // –£–õ–£–ß–®–ï–ù–û: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π margin = —Ä–∞–∑–º–µ—Ä –º–æ–ª–µ–∫—É–ª—ã, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–¥—Ö–æ–¥–∏—Ç—å –≤–ø–ª–æ—Ç–Ω—É—é –∫ –∫—Ä–∞—è–º
                // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–æ–ª–µ–∫—É–ª—ã —É —Å–∞–º–æ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ –±–µ–∑ "–æ—Ç–º–∞–≥–Ω–∏—á–∏–≤–∞–Ω–∏—è"
                const margin = this.size;  // –ë—ã–ª–æ: Math.min(this.size * 1.5, 200)
                this.targetX = Math.max(margin, Math.min(width - margin, this.targetX));
                this.targetY = Math.max(margin, Math.min(height - margin, this.targetY));
            }

            // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º–æ–ª–µ–∫—É–ª—É (–¥–ª—è UI)
            lock() {
                this.isLocked = true;
                this.isShapeLocked = true;
            }

            // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º–æ–ª–µ–∫—É–ª—É (–¥–ª—è UI)
            unlock() {
                this.isLocked = false;
                this.isShapeLocked = false;
            }

            // –§—É–Ω–∫—Ü–∏—è –≤–ª–∏—è–Ω–∏—è –¥–ª—è –º–µ—Ç–∞–±–æ–ª–ª–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–æ–≤–æ—Ä–æ—Ç–∞ –∏ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è
            getInfluence(px, py) {
                // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –º–æ–ª–µ–∫—É–ª—ã
                const dx = px - this.x;
                const dy = py - this.y;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏–∏ –µ—Å–ª–∏ —É–≥–æ–ª –∏–∑–º–µ–Ω–∏–ª—Å—è
                if (this.deformAngle !== this._lastCachedAngle) {
                    this._cachedCos = Math.cos(-this.deformAngle);
                    this._cachedSin = Math.sin(-this.deformAngle);
                    this._lastCachedAngle = this.deformAngle;
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const rotatedX = dx * this._cachedCos - dy * this._cachedSin;
                const rotatedY = dx * this._cachedSin + dy * this._cachedCos;

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ –≤ –ø–æ–≤—ë—Ä–Ω—É—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                const stretchedX = rotatedX / this.stretchX;
                const stretchedY = rotatedY / this.stretchY;
                const distSq = stretchedX * stretchedX + stretchedY * stretchedY;

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤—É–∫–æ–≤—É—é –º–æ–¥—É–ª—è—Ü–∏—é (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∂–µ—Å—Ç–æ–≤)
                let audioMod = 1;
                if (config.audioEnabled && !editorMode) {
                    const angle = Math.atan2(dy, dx);
                    audioMod = 1 + Math.sin(angle * 3 + this.audioPhase) * audioLevel * config.audioSensitivity * 0.02;
                }

                const effectiveSize = this.size * audioMod;

                // mergeStrength —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è - –º–æ–ª–µ–∫—É–ª—ã "–¥–æ—Ç—è–≥–∏–≤–∞—é—Ç—Å—è" –¥–∞–ª—å—à–µ
                const effectiveRadius = effectiveSize * Math.sqrt(config.mergeStrength);
                const effectiveRadiusSq = effectiveRadius * effectiveRadius;

                if (distSq > effectiveRadiusSq * 4) return 0;

                // Smooth kernel –¥–ª—è –º–µ—Ç–∞–±–æ–ª–ª–æ–≤
                return effectiveRadiusSq / (distSq + effectiveRadiusSq);
            }
        }

        // === –°–ò–°–¢–ï–ú–ê –°–õ–ò–Ø–ù–ò–Ø –ú–û–õ–ï–ö–£–õ ===

        // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ–ª–∂–Ω—ã –ª–∏ –¥–≤–µ –º–æ–ª–µ–∫—É–ª—ã —Å–ª–∏—Ç—å—Å—è
        function shouldMergeMolecules(mol1, mol2) {
            // –ù–µ —Å–ª–∏–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –º–æ–ª–µ–∫—É–ª—ã
            if (mol1.isLocked || mol2.isLocked) return false;
            if (mol1.isEditing || mol2.isEditing) return false;

            // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ü–µ–Ω—Ç—Ä–∞–º–∏
            const dx = mol2.x - mol1.x;
            const dy = mol2.y - mol1.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // –ü–æ—Ä–æ–≥ —Å–ª–∏—è–Ω–∏—è: —Å—É–º–º–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ √ó 0.3
            // –°–¢–†–û–ì–ò–ô –ü–û–†–û–ì: –º–æ–ª–µ–∫—É–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –û–ß–ï–ù–¨ –±–ª–∏–∑–∫–æ, –ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å—Å—è
            // –ü—Ä–∏ 0.3 —Ü–µ–Ω—Ç—Ä—ã –º–æ–ª–µ–∫—É–ª –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ < 30% –æ—Ç —Å—É–º–º—ã —Ä–∞–∑–º–µ—Ä–æ–≤
            // –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–≤–µ –º–æ–ª–µ–∫—É–ª—ã –ø–æ 100px: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å < 60px –¥–ª—è —Å–ª–∏—è–Ω–∏—è
            const mergeThreshold = (mol1.size + mol2.size) * 0.3;

            // –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
            if (distance >= mergeThreshold) return false;

            // === –ó–ê–©–ò–¢–ê –û–¢ –°–õ–ò–Ø–ù–ò–Ø –ö–†–ï–°–¢–û–û–ë–†–ê–ó–ù–´–• –§–û–†–ú ===
            // –ï—Å–ª–∏ –º–æ–ª–µ–∫—É–ª—ã –≤—ã—Ç—è–Ω—É—Ç—ã –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ (–∫–∞–∫ –≤ –∫—Ä–µ—Å—Ç–∏–∫–µ),
            // –æ–Ω–∏ –ù–ï –¥–æ–ª–∂–Ω—ã —Å–ª–∏–≤–∞—Ç—å—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Ü–µ–Ω—Ç—Ä—ã –±–ª–∏–∑–∫–æ

            const isStretched1 = mol1.stretchX > 1.5; // –ú–æ–ª–µ–∫—É–ª–∞ 1 –≤—ã—Ç—è–Ω—É—Ç–∞
            const isStretched2 = mol2.stretchX > 1.5; // –ú–æ–ª–µ–∫—É–ª–∞ 2 –≤—ã—Ç—è–Ω—É—Ç–∞

            // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –º–æ–ª–µ–∫—É–ª–∞ —Å–∏–ª—å–Ω–æ –≤—ã—Ç—è–Ω—É—Ç–∞
            if (isStretched1 || isStretched2) {
                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É —É–≥–ª–æ–≤
                let angleDiff = Math.abs(mol1.deformAngle - mol2.deformAngle);

                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–∞–∑–Ω–∏—Ü—É —É–≥–ª–æ–≤ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [0, œÄ]
                while (angleDiff > Math.PI) angleDiff -= Math.PI;
                if (angleDiff > Math.PI / 2) angleDiff = Math.PI - angleDiff;

                // –ï—Å–ª–∏ —É–≥–ª—ã –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –Ω–∞ ~90¬∞ (¬± 30¬∞), —ç—Ç–æ –∫—Ä–µ—Å—Ç - –ù–ï —Å–ª–∏–≤–∞–µ–º
                const isPerpendicular = Math.abs(angleDiff - Math.PI / 2) < Math.PI / 6; // ¬±30¬∞

                if (isPerpendicular) {
                    return false; // –ö—Ä–µ—Å—Ç–æ–æ–±—Ä–∞–∑–Ω–∞—è —Ñ–æ—Ä–º–∞ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–µ –º–æ–ª–µ–∫—É–ª—ã
                }

                // –¢–∞–∫–∂–µ –ù–ï —Å–ª–∏–≤–∞–µ–º –µ—Å–ª–∏ —É–≥–ª—ã –ø–æ—á—Ç–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ (~0¬∞ –∏–ª–∏ ~180¬∞)
                // –Ω–æ –º–æ–ª–µ–∫—É–ª—ã –≤—ã—Ç—è–Ω—É—Ç—ã —Å–ª–∞–±–æ –≤ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
                // (—ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏)
                const isParallel = angleDiff < Math.PI / 6; // ¬±30¬∞
                const isAntiParallel = Math.abs(angleDiff - Math.PI) < Math.PI / 6;

                if (isParallel || isAntiParallel) {
                    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –≤—ã—Ç—è–Ω—É—Ç—ã–µ –º–æ–ª–µ–∫—É–ª—ã –º–æ–≥—É—Ç —Å–ª–∏–≤–∞—Ç—å—Å—è
                    // (—ç—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
                    return true;
                }
            }

            // –ï—Å–ª–∏ –º–æ–ª–µ–∫—É–ª—ã –Ω–µ –≤—ã—Ç—è–Ω—É—Ç—ã –∏–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –æ–¥–∏–Ω–∞–∫–æ–≤–æ - —Å–ª–∏–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
            return true;
        }

        // –°–ª–∏–≤–∞–µ—Ç –¥–≤–µ –º–æ–ª–µ–∫—É–ª—ã –≤ –æ–¥–Ω—É –Ω–æ–≤—É—é
        // –°–º–µ—à–∏–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ RGB —Å –≤–µ—Å–∞–º–∏
        function blendColors(color1, color2, weight1, weight2) {
            if (!color1 && !color2) return null;
            if (!color1) return color2;
            if (!color2) return color1;

            // –ü–∞—Ä—Å–∏–º —Ü–≤–µ—Ç–∞ –∏–∑ HEX –≤ RGB
            const parseColor = (hex) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return { r, g, b };
            };

            const c1 = parseColor(color1);
            const c2 = parseColor(color2);

            // –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ RGB
            const r = Math.round(c1.r * weight1 + c2.r * weight2);
            const g = Math.round(c1.g * weight1 + c2.g * weight2);
            const b = Math.round(c1.b * weight1 + c2.b * weight2);

            // –û–±—Ä–∞—Ç–Ω–æ –≤ HEX
            const toHex = (n) => {
                const hex = n.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };

            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        function mergeMolecules(mol1, mol2) {
            // –í—ã—á–∏—Å–ª—è–µ–º –≤–µ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–æ—â–∞–¥–∏ (size¬≤)
            const area1 = mol1.size * mol1.size;
            const area2 = mol2.size * mol2.size;
            const totalArea = area1 + area2;
            const weight1 = area1 / totalArea;
            const weight2 = area2 / totalArea;

            // –ü–û–ó–ò–¶–ò–Ø: –í–∑–≤–µ—à–µ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä –º–∞—Å—Å
            const newX = mol1.x * weight1 + mol2.x * weight2;
            const newY = mol1.y * weight1 + mol2.y * weight2;

            // –†–ê–ó–ú–ï–†: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å
            // newArea = area1 + area2
            // newSize¬≤ = size1¬≤ + size2¬≤
            const newSize = Math.sqrt(area1 + area2);

            // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –º–æ–ª–µ–∫—É–ª—É
            const merged = new Molecule(newX, newY, newSize);

            // –§–û–†–ú–ê: –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–π
            // –ë–æ–ª—å—à–∞—è –º–æ–ª–µ–∫—É–ª–∞ –∏–º–µ–µ—Ç –±–æ–ª—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ñ–æ—Ä–º—É
            merged.stretchX = mol1.stretchX * weight1 + mol2.stretchX * weight2;
            merged.stretchY = mol1.stretchY * weight1 + mol2.stretchY * weight2;

            // –£–ì–û–õ: –£—Å—Ä–µ–¥–Ω—è–µ–º —É–≥–ª—ã (—É—á–∏—Ç—ã–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å)
            // –ü–µ—Ä–µ–≤–æ–¥–∏–º —É–≥–ª—ã –≤ –≤–µ–∫—Ç–æ—Ä—ã, —É—Å—Ä–µ–¥–Ω—è–µ–º, –ø–µ—Ä–µ–≤–æ–¥–∏–º –æ–±—Ä–∞—Ç–Ω–æ
            const angle1X = Math.cos(mol1.deformAngle);
            const angle1Y = Math.sin(mol1.deformAngle);
            const angle2X = Math.cos(mol2.deformAngle);
            const angle2Y = Math.sin(mol2.deformAngle);

            const avgAngleX = angle1X * weight1 + angle2X * weight2;
            const avgAngleY = angle1Y * weight1 + angle2Y * weight2;
            merged.deformAngle = Math.atan2(avgAngleY, avgAngleX);

            // –°–ö–û–†–û–°–¢–¨: –£—Å—Ä–µ–¥–Ω—è–µ–º (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–ø—É–ª—å—Å–∞)
            merged.vx = mol1.vx * weight1 + mol2.vx * weight2;
            merged.vy = mol1.vy * weight1 + mol2.vy * weight2;
            merged.targetX = newX;
            merged.targetY = newY;

            // –ó–í–£–ö: –£—Å—Ä–µ–¥–Ω—è–µ–º —Ñ–∞–∑—É
            merged.audioPhase = (mol1.audioPhase + mol2.audioPhase) / 2;

            // –¶–í–ï–¢–ê: –°–º–µ—à–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –≤–∑–≤–µ—à–µ–Ω–Ω–æ
            merged.fillColor = blendColors(mol1.fillColor, mol2.fillColor, weight1, weight2);
            merged.edgeColor = blendColors(mol1.edgeColor, mol2.edgeColor, weight1, weight2);

            // –≠–§–§–ï–ö–¢–´: –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –º–æ–ª–µ–∫—É–ª–∞ –∏–º–µ–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç - –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            merged.emboss = mol1.emboss || mol2.emboss;

            return merged;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–∏—è–Ω–∏—è –º–æ–ª–µ–∫—É–ª
        function checkAndMergeMolecules() {
            let merged = false;

            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º –º–æ–ª–µ–∫—É–ª
            for (let i = 0; i < molecules.length; i++) {
                for (let j = i + 1; j < molecules.length; j++) {
                    const mol1 = molecules[i];
                    const mol2 = molecules[j];

                    if (shouldMergeMolecules(mol1, mol2)) {
                        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—É—é –º–æ–ª–µ–∫—É–ª—É
                        const newMolecule = mergeMolecules(mol1, mol2);

                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–æ–ª–µ–∫—É–ª—ã
                        molecules.splice(j, 1); // –£–¥–∞–ª—è–µ–º j —Å–Ω–∞—á–∞–ª–∞ (–±–æ–ª—å—à–∏–π –∏–Ω–¥–µ–∫—Å)
                        molecules.splice(i, 1); // –ü–æ—Ç–æ–º i

                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é
                        molecules.push(newMolecule);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–æ–ª–µ–∫—É–ª—ã –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ hovered
                        if (hoveredMolecule === mol1 || hoveredMolecule === mol2) {
                            hoveredMolecule = newMolecule;
                        }
                        if (lastHoveredMolecule === mol1 || lastHoveredMolecule === mol2) {
                            lastHoveredMolecule = newMolecule;
                        }
                        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: editingMolecule –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º, —Ç.–∫. —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –º–æ–ª–µ–∫—É–ª—ã
                        // –Ω–µ –º–æ–≥—É—Ç —Å–ª–∏–≤–∞—Ç—å—Å—è (—Å–º. shouldMergeMolecules)

                        saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã

                        merged = true;
                        break;
                    }
                }
                if (merged) break; // –í—ã—Ö–æ–¥–∏–º –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ü–∏–∫–ª–∞
            }

            // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–ª–∏—è–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—â—ë —Ä–∞–∑ (–º–æ–≥—É—Ç –±—ã—Ç—å —Ü–µ–ø–Ω—ã–µ —Å–ª–∏—è–Ω–∏—è)
            if (merged) {
                checkAndMergeMolecules();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ
        async function setupAudio() {
            console.log('–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∞—É–¥–∏–æ...');
            try {
                console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω!', stream);

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);

                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                microphone.connect(analyser);

                // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
                const audioBars = document.getElementById('audioBars');
                for (let i = 0; i < 10; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'audio-bar';
                    audioBars.appendChild(bar);
                }

                console.log('–ê—É–¥–∏–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                console.error('–ò–º—è –æ—à–∏–±–∫–∏:', error.name);
                console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
                return false;
            }
        }

        // –ê–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ
        function analyzeAudio() {
            if (!analyser || !dataArray) return;

            analyser.getByteFrequencyData(dataArray);

            // –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            audioLevel = (sum / dataArray.length) / 255;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            const bars = document.querySelectorAll('.audio-bar');
            bars.forEach((bar, i) => {
                const value = dataArray[i * Math.floor(dataArray.length / bars.length)] / 255;
                bar.style.height = `${value * 100}%`;
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ–Ω–∞ (—Ü–≤–µ—Ç –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
        function renderBackgroundToCache() {
            // –°–æ–∑–¥–∞—ë–º OffscreenCanvas –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ä–∞–∑–º–µ—Ä
            if (!backgroundCache || backgroundCache.width !== width || backgroundCache.height !== height) {
                backgroundCache = new OffscreenCanvas(width, height);
                backgroundCacheCtx = backgroundCache.getContext('2d');
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ñ–æ–Ω –≤ –∫–µ—à
            if (backgroundType === 'color') {
                backgroundCacheCtx.fillStyle = backgroundColor;
                backgroundCacheCtx.fillRect(0, 0, width, height);
            } else if (backgroundType === 'image' && backgroundImage) {
                const imgAspect = backgroundImage.width / backgroundImage.height;
                const canvasAspect = width / height;
                let drawWidth, drawHeight, offsetX, offsetY;

                if (imgAspect > canvasAspect) {
                    drawHeight = height;
                    drawWidth = height * imgAspect;
                    offsetX = (width - drawWidth) / 2;
                    offsetY = 0;
                } else {
                    drawWidth = width;
                    drawHeight = width / imgAspect;
                    offsetX = 0;
                    offsetY = (height - drawHeight) / 2;
                }

                backgroundCacheCtx.drawImage(backgroundImage, offsetX, offsetY, drawWidth, drawHeight);
            } else {
                // –ë–µ–ª—ã–π —Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                backgroundCacheCtx.fillStyle = '#ffffff';
                backgroundCacheCtx.fillRect(0, 0, width, height);
            }

            backgroundCacheValid = true;
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–ª–æ–≤ —á–µ—Ä–µ–∑ marching squares
        function drawMetaballs() {
            // –ù–£–õ–ï–í–û–ô –°–õ–û–ô: –§–æ–Ω (—Ä–∏—Å—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –≤–∫–ª—é—á–µ–Ω–æ "–ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ")
            // –í —Ä–µ–∂–∏–º–µ "–ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ" —Ñ–æ–Ω —É–∂–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω –≤ animate() - —ç—Ç–æ –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã
            if (!config.showVideo) {
                if (backgroundType === 'transparent') {
                    // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω - –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∏—Å—É–µ–º (–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ PNG/SVG)
                    ctx.clearRect(0, 0, width, height);
                } else if (backgroundType === 'video' && backgroundImage) {
                    // –í–∏–¥–µ–æ —Ñ–æ–Ω —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä (–Ω–µ –∫–µ—à–∏—Ä—É–µ–º)
                    const vidAspect = backgroundImage.videoWidth / backgroundImage.videoHeight;
                    const canvasAspect = width / height;
                    let drawWidth, drawHeight, offsetX, offsetY;

                    if (vidAspect > canvasAspect) {
                        drawHeight = height;
                        drawWidth = height * vidAspect;
                        offsetX = (width - drawWidth) / 2;
                        offsetY = 0;
                    } else {
                        drawWidth = width;
                        drawHeight = width / vidAspect;
                        offsetX = 0;
                        offsetY = (height - drawHeight) / 2;
                    }

                    ctx.drawImage(backgroundImage, offsetX, offsetY, drawWidth, drawHeight);
                } else {
                    // –î–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à
                    if (!backgroundCacheValid) {
                        renderBackgroundToCache();
                    }
                    // –ü—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω
                    ctx.drawImage(backgroundCache, 0, 0);
                }
            }

            // –†–∏—Å—É–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–ª–∏–≤–∫–∏ (–ø–æ–¥ –º–æ–ª–µ–∫—É–ª–∞–º–∏ –∏ —à—Ç—Ä–∏—Ö–∞–º–∏)
            for (const region of backgroundFills) {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = region.width;
                tempCanvas.height = region.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.putImageData(region.imageData, 0, 0);
                ctx.drawImage(tempCanvas, region.x, region.y);
            }

            if (molecules.length === 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –º–æ–ª–µ–∫—É–ª, —Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ —à—Ç—Ä–∏—Ö–∏ –∫–∞—Ä–∞–Ω–¥–∞—à–∞
                // –°–Ω–∞—á–∞–ª–∞ —Ä–∏—Å—É–µ–º –∑–∞–ª–∏—Ç—ã–µ –æ–±–ª–∞—Å—Ç–∏ (–ø–æ–¥ —à—Ç—Ä–∏—Ö–∞–º–∏)
                for (const region of filledRegions) {
                    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = region.width;
                    tempCanvas.height = region.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.putImageData(region.imageData, 0, 0);
                    ctx.drawImage(tempCanvas, region.x, region.y);
                }

                // –ó–∞—Ç–µ–º —Ä–∏—Å—É–µ–º –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏
                for (const stroke of drawnStrokes) {
                    if (stroke.points.length < 2) continue;

                    ctx.strokeStyle = stroke.color;
                    ctx.lineWidth = stroke.width;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';

                    ctx.beginPath();
                    ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
                    for (let i = 1; i < stroke.points.length; i++) {
                        ctx.lineTo(stroke.points[i].x, stroke.points[i].y);
                    }
                    ctx.stroke();
                }

                // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Å—É–µ–º—ã–π —à—Ç—Ä–∏—Ö
                if (currentStroke && currentStroke.points.length > 1) {
                    ctx.strokeStyle = currentStroke.color;
                    ctx.lineWidth = currentStroke.width;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';

                    ctx.beginPath();
                    ctx.moveTo(currentStroke.points[0].x, currentStroke.points[0].y);
                    for (let i = 1; i < currentStroke.points.length; i++) {
                        ctx.lineTo(currentStroke.points[i].x, currentStroke.points[i].y);
                    }
                    ctx.stroke();
                }
                return;
            }

            // –°—Ç—Ä–æ–∏–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ö–µ—à –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            const spatialHashStartTime = performance.now();
            buildSpatialHash();
            const spatialHashTime = performance.now() - spatialHashStartTime;

            // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –ò –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏—Ö –º–æ–ª–µ–∫—É–ª
            const cols = Math.ceil(width / gridResolution) + 1;
            const rows = Math.ceil(height / gridResolution) + 1;
            const field = [];
            const dominantMolecule = []; // –ú–æ–ª–µ–∫—É–ª–∞ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –≤–ª–∏—è–Ω–∏–µ–º –≤ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–µ

            // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–ª–µ –≤–ª–∏—è–Ω–∏—è –∏ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ –º–æ–ª–µ–∫—É–ª—ã
            for (let i = 0; i < rows; i++) {
                field[i] = [];
                dominantMolecule[i] = [];
                for (let j = 0; j < cols; j++) {
                    const x = j * gridResolution;
                    const y = i * gridResolution;
                    let sum = 0;
                    let maxInfluence = 0;
                    let dominantMol = null;

                    // –°—É–º–º–∏—Ä—É–µ–º –≤–ª–∏—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –±–ª–∏–∑–∫–∏—Ö –º–æ–ª–µ–∫—É–ª (–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
                    const nearbyMolecules = getNearbyMolecules(x, y);
                    for (const mol of nearbyMolecules) {
                        const influence = mol.getInfluence(x, y);
                        sum += influence;

                        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –º–æ–ª–µ–∫—É–ª—É —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –≤–ª–∏—è–Ω–∏–µ–º
                        if (influence > maxInfluence) {
                            maxInfluence = influence;
                            dominantMol = mol;
                        }
                    }

                    field[i][j] = sum;
                    dominantMolecule[i][j] = dominantMol;
                }
            }

            // –ò–°–ü–†–ê–í–õ–ï–ù–û: Threshold —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫, —á—Ç–æ–±—ã –æ–¥–∏–Ω–æ—á–Ω–∞—è –º–æ–ª–µ–∫—É–ª–∞
            // —Å–æ—Ö—Ä–∞–Ω—è–ª–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —Ä–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è
            // –§–æ—Ä–º—É–ª–∞: –ø—Ä–∏ mergeStrength=1 threshold=0.5, –ø—Ä–∏ mergeStrength=2 threshold=0.667
            // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–ª–µ–∫—É–ª–∞–º —Å–ª–∏–≤–∞—Ç—å—Å—è –Ω–∞ –±–æ–ª—å—à–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º mergeStrength
            const threshold = config.mergeStrength / (1 + config.mergeStrength);

            // –ü–ï–†–í–´–ô –°–õ–û–ô: –ì–ª–∞–¥–∫–∞—è –∑–∞–ª–∏–≤–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –æ–±–ª–∞—Å—Ç–µ–π
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∏–∫—Å–µ–ª—è–º —Å–µ—Ç–∫–∏ –∏ –∑–∞–ª–∏–≤–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≥–ª–∞–¥–∫–æ
            const fillResolution = currentFillResolution; // –®–∞–≥ –¥–ª—è –∑–∞–ª–∏–≤–∫–∏ (–ø–∏–∫—Å–µ–ª–∏, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π)

            for (let py = 0; py < height; py += fillResolution) {
                for (let px = 0; px < width; px += fillResolution) {
                    // –í—ã—á–∏—Å–ª—è–µ–º –≤–ª–∏—è–Ω–∏–µ –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
                    let totalInfluence = 0;
                    let maxInfluence = 0;
                    let dominantMol = null;

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
                    const nearbyMolecules = getNearbyMolecules(px, py);
                    for (const mol of nearbyMolecules) {
                        const influence = mol.getInfluence(px, py);
                        totalInfluence += influence;

                        if (influence > maxInfluence) {
                            maxInfluence = influence;
                            dominantMol = mol;
                        }
                    }

                    // –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç—É—Ä–∞ (–≤–ª–∏—è–Ω–∏–µ –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞) –∏ –µ—Å—Ç—å fillColor
                    if (totalInfluence >= threshold && dominantMol && dominantMol.fillColor) {
                        ctx.fillStyle = dominantMol.fillColor;
                        ctx.fillRect(px, py, fillResolution, fillResolution);
                    }
                }
            }

            // –í–¢–û–†–û–ô –°–õ–û–ô: Marching squares —Å –±–ª–æ—á–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º –Ω–∞ –∫–æ–Ω—Ç—É—Ä–∞—Ö
            ctx.fillStyle = '#f5f5f5';
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 2.5;

            for (let i = 0; i < rows - 1; i++) {
                for (let j = 0; j < cols - 1; j++) {
                    const x = j * gridResolution;
                    const y = i * gridResolution;

                    const tl = field[i][j] >= threshold ? 1 : 0;
                    const tr = field[i][j + 1] >= threshold ? 1 : 0;
                    const br = field[i + 1][j + 1] >= threshold ? 1 : 0;
                    const bl = field[i + 1][j] >= threshold ? 1 : 0;

                    const cellIndex = tl * 8 + tr * 4 + br * 2 + bl * 1;

                    if (cellIndex === 0 || cellIndex === 15) continue;

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∫–æ–Ω—Ç—É—Ä–∞ –¥–ª—è —ç—Ç–æ–π —è—á–µ–π–∫–∏ (–ø–æ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–π –º–æ–ª–µ–∫—É–ª–µ –≤ —Ü–µ–Ω—Ç—Ä–µ)
                    const centerMol = dominantMolecule[i][j];
                    const cellEdgeColor = (centerMol && centerMol.edgeColor) ? centerMol.edgeColor : null;

                    // –†–∏—Å—É–µ–º —è—á–µ–π–∫—É —Å –±–ª–æ—á–Ω–æ–π –∑–∞–ª–∏–≤–∫–æ–π –∫–æ–Ω—Ç—É—Ä–∞
                    drawMarchingSquareCell(x, y, cellIndex, field, i, j, threshold, cellEdgeColor);
                }
            }

            // –¢–†–ï–¢–ò–ô –°–õ–û–ô: –≠—Ñ—Ñ–µ–∫—Ç —Ç–∏—Å–Ω–µ–Ω–∏—è (Bevel & Emboss) - —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–ª—é–∑–∏–∏ —Ä–µ–ª—å–µ—Ñ–∞
            // –†–∏—Å—É–µ–º —Å–º–µ—â–µ–Ω–Ω—ã–µ —Å–≤–µ—Ç–ª—ã–µ –∏ —Ç–µ–º–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤—ã–ø—É–∫–ª–æ—Å—Ç–∏/–≤–æ–≥–Ω—É—Ç–æ—Å—Ç–∏
            // –û–¢–ö–õ–Æ–ß–ï–ù–û –≤ —Ä–µ–∂–∏–º–µ –Ω–∏–∑–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

            // –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç—É—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏ –¥–ª—è –º–æ–ª–µ–∫—É–ª —Å —Ç–∏—Å–Ω–µ–Ω–∏–µ–º
            const embossContours = [];

            if (!isLowPerformanceMode) {

            for (let i = 0; i < rows - 1; i++) {
                for (let j = 0; j < cols - 1; j++) {
                    const x = j * gridResolution;
                    const y = i * gridResolution;

                    const tl = field[i][j] >= threshold ? 1 : 0;
                    const tr = field[i][j + 1] >= threshold ? 1 : 0;
                    const br = field[i + 1][j + 1] >= threshold ? 1 : 0;
                    const bl = field[i + 1][j] >= threshold ? 1 : 0;

                    const cellIndex = tl * 8 + tr * 4 + br * 2 + bl * 1;

                    if (cellIndex === 0 || cellIndex === 15) continue;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–æ–ª–µ–∫—É–ª–∞ –∏–º–µ–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç —Ç–∏—Å–Ω–µ–Ω–∏—è
                    const centerMol = dominantMolecule[i][j];
                    if (!centerMol || !centerMol.emboss) continue;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç—É—Ä–Ω—ã—Ö –ª–∏–Ω–∏—è—Ö
                    embossContours.push({ x, y, i, j, cellIndex, mol: centerMol });
                }
            }

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç—É—Ä—ã —Å —Ç–∏—Å–Ω–µ–Ω–∏–µ–º - —Ä–∏—Å—É–µ–º —ç—Ñ—Ñ–µ–∫—Ç
            if (embossContours.length > 0) {
                const size = gridResolution;
                const embossDistance = 7; // –£–°–ò–õ–ï–ù–û: –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –≥–ª—É–±–∏–Ω—ã (–±—ã–ª–æ 3)
                const lightAngle = -135 * Math.PI / 180; // –£–≥–æ–ª —Å–≤–µ—Ç–∞ (—Å–≤–µ—Ä—Ö—É-—Å–ª–µ–≤–∞)
                const offsetX = Math.cos(lightAngle) * embossDistance;
                const offsetY = Math.sin(lightAngle) * embossDistance;

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞
                const getBgColor = () => {
                    if (backgroundType === 'color') {
                        return backgroundColor;
                    }
                    return '#f5f5f5'; // –î–µ—Ñ–æ–ª—Ç
                };

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å–≤–µ—Ç–ª–µ–Ω–∏—è/–∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞
                const adjustColor = (color, amount) => {
                    const r = parseInt(color.slice(1, 3), 16);
                    const g = parseInt(color.slice(3, 5), 16);
                    const b = parseInt(color.slice(5, 7), 16);

                    const newR = Math.max(0, Math.min(255, r + amount));
                    const newG = Math.max(0, Math.min(255, g + amount));
                    const newB = Math.max(0, Math.min(255, b + amount));

                    return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
                };

                // –õ–∏–Ω–∏–∏ –¥–ª—è marching squares
                const lines = {
                    1: [[3, 2]], 2: [[1, 2]], 3: [[3, 1]],
                    4: [[0, 1]], 5: [[0, 3], [1, 2]], 6: [[0, 2]],
                    7: [[0, 3]], 8: [[0, 3]], 9: [[0, 2]],
                    10: [[0, 1], [3, 2]], 11: [[0, 1]], 12: [[3, 1]],
                    13: [[1, 2]], 14: [[3, 2]]
                };

                function getEdgePoint(edge, i, j) {
                    const tl = field[i][j];
                    const tr = field[i][j + 1];
                    const br = field[i + 1][j + 1];
                    const bl = field[i + 1][j];
                    let t = 0.5;

                    switch(edge) {
                        case 0: // –í–µ—Ä—Ö
                            t = (threshold - tl) / (tr - tl);
                            return { x: t * size, y: 0 };
                        case 1: // –ü—Ä–∞–≤–æ
                            t = (threshold - tr) / (br - tr);
                            return { x: size, y: t * size };
                        case 2: // –ù–∏–∑
                            t = (threshold - bl) / (br - bl);
                            return { x: t * size, y: size };
                        case 3: // –õ–µ–≤–æ
                            t = (threshold - tl) / (bl - tl);
                            return { x: 0, y: t * size };
                    }
                }

                // –†–∏—Å—É–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞
                for (const contour of embossContours) {
                    const { x, y, i, j, cellIndex, mol } = contour;

                    if (!lines[cellIndex]) continue;

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç (—Ñ–æ–Ω –∏–ª–∏ –∑–∞–ª–∏–≤–∫–∞ –º–æ–ª–µ–∫—É–ª—ã)
                    const baseColor = mol.fillColor || getBgColor();

                    // –°–í–ï–¢–õ–´–ô –ö–û–ù–¢–£–† (—Å–º–µ—â–µ–Ω –≤ —Å—Ç–æ—Ä–æ–Ω—É —Å–≤–µ—Ç–∞)
                    ctx.strokeStyle = adjustColor(baseColor, 130); // –£–°–ò–õ–ï–ù–û: –°–≤–µ—Ç–ª–µ–µ (–±—ã–ª–æ 80)
                    ctx.lineWidth = 4.5; // –£–°–ò–õ–ï–ù–û: –¢–æ–ª—â–µ (–±—ã–ª–æ 2.5)
                    ctx.shadowColor = 'rgba(255, 255, 255, 0.9)'; // –£–°–ò–õ–ï–ù–û: –Ø—Ä—á–µ —Ç–µ–Ω—å (–±—ã–ª–æ 0.6)
                    ctx.shadowBlur = 6; // –£–°–ò–õ–ï–ù–û: –ú—è–≥—á–µ —Ç–µ–Ω—å (–±—ã–ª–æ 3)

                    ctx.beginPath();
                    for (const [e1, e2] of lines[cellIndex]) {
                        const p1 = getEdgePoint(e1, i, j);
                        const p2 = getEdgePoint(e2, i, j);
                        ctx.moveTo(x + p1.x + offsetX, y + p1.y + offsetY);
                        ctx.lineTo(x + p2.x + offsetX, y + p2.y + offsetY);
                    }
                    ctx.stroke();
                    ctx.shadowBlur = 0;

                    // –¢–ï–ú–ù–´–ô –ö–û–ù–¢–£–† (—Å–º–µ—â–µ–Ω –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ —Å–≤–µ—Ç—É)
                    ctx.strokeStyle = adjustColor(baseColor, -130); // –£–°–ò–õ–ï–ù–û: –¢–µ–º–Ω–µ–µ (–±—ã–ª–æ -80)
                    ctx.lineWidth = 4.5; // –£–°–ò–õ–ï–ù–û: –¢–æ–ª—â–µ (–±—ã–ª–æ 2.5)
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.9)'; // –£–°–ò–õ–ï–ù–û: –¢–µ–º–Ω–µ–µ —Ç–µ–Ω—å (–±—ã–ª–æ 0.6)
                    ctx.shadowBlur = 6; // –£–°–ò–õ–ï–ù–û: –ú—è–≥—á–µ —Ç–µ–Ω—å (–±—ã–ª–æ 3)

                    ctx.beginPath();
                    for (const [e1, e2] of lines[cellIndex]) {
                        const p1 = getEdgePoint(e1, i, j);
                        const p2 = getEdgePoint(e2, i, j);
                        ctx.moveTo(x + p1.x - offsetX, y + p1.y - offsetY);
                        ctx.lineTo(x + p2.x - offsetX, y + p2.y - offsetY);
                    }
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                }
            }
            } // –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ if (!isLowPerformanceMode) –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç–∏—Å–Ω–µ–Ω–∏—è

            // –ß–ï–¢–í–ï–†–¢–´–ô –°–õ–û–ô: –ú–∏–∫—Ä–æ-–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å—é –ø–ª–æ—â–∞–¥—å –º–æ–ª–µ–∫—É–ª—ã –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–º–∏ –ø–æ–ª–æ—Å–∫–∞–º–∏
            // –û–¢–ö–õ–Æ–ß–ï–ù–û –≤ —Ä–µ–∂–∏–º–µ –Ω–∏–∑–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

            // –°–æ–±–∏—Ä–∞–µ–º –º–æ–ª–µ–∫—É–ª—ã —Å –º–∏–∫—Ä–æ–ø–æ–ª–æ—Å–∫–∞–º–∏
            const moleculesWithStripes = !isLowPerformanceMode ? molecules.filter(mol => mol.microStripes) : [];

            if (moleculesWithStripes.length > 0) {
                for (const mol of moleculesWithStripes) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –º–æ–ª–µ–∫—É–ª—ã
                    const stripeWidth = mol.stripeWidth || 2;
                    const stripeSpacing = mol.stripeSpacing || 3;
                    const color1 = mol.stripeColor1 || '#ff0000';
                    const color2 = mol.stripeColor2 || '#0000ff';

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º bounding box –º–æ–ª–µ–∫—É–ª—ã
                    let minX = Infinity, maxX = -Infinity;
                    let minY = Infinity, maxY = -Infinity;

                    // –ù–∞—Ö–æ–¥–∏–º –≥—Ä–∞–Ω–∏—Ü—ã –º–æ–ª–µ–∫—É–ª—ã –ø–æ –ø–æ–ª—é
                    for (let i = 0; i < rows; i++) {
                        for (let j = 0; j < cols; j++) {
                            if (dominantMolecule[i][j] === mol && field[i][j] >= threshold) {
                                const x = j * gridResolution;
                                const y = i * gridResolution;
                                minX = Math.min(minX, x);
                                maxX = Math.max(maxX, x);
                                minY = Math.min(minY, y);
                                maxY = Math.max(maxY, y);
                            }
                        }
                    }

                    if (minX === Infinity) continue;

                    // –ö–µ—à–∏—Ä—É–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
                    const cacheKey = `${color1}_${color2}`;
                    let colorStops;

                    if (mol._gradientCacheKey === cacheKey && mol._gradientCache) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞
                        colorStops = mol._gradientCache;
                    } else {
                        // –í—ã—á–∏—Å–ª—è–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
                        const r1 = parseInt(color1.slice(1, 3), 16);
                        const g1 = parseInt(color1.slice(3, 5), 16);
                        const b1 = parseInt(color1.slice(5, 7), 16);

                        const r2 = parseInt(color2.slice(1, 3), 16);
                        const g2 = parseInt(color2.slice(3, 5), 16);
                        const b2 = parseInt(color2.slice(5, 7), 16);

                        // –ü—Ä–µ–¥–≤—ã—á–∏—Å–ª—è–µ–º –≤—Å–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
                        const numStops = 10;
                        colorStops = [];
                        for (let i = 0; i <= numStops; i++) {
                            const t = i / numStops;
                            const baseR = r1 + (r2 - r1) * t;
                            const baseG = g1 + (g2 - g1) * t;
                            const baseB = b1 + (b2 - b1) * t;
                            colorStops.push({ t, baseR, baseG, baseB });
                        }

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
                        mol._gradientCache = colorStops;
                        mol._gradientCacheKey = cacheKey;
                    }

                    // –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –¥–ª—è –º–æ–ª–µ–∫—É–ª—ã
                    ctx.save();
                    ctx.beginPath();

                    // –û–±–≤–æ–¥–∏–º –∫–æ–Ω—Ç—É—Ä –º–æ–ª–µ–∫—É–ª—ã –¥–ª—è –º–∞—Å–∫–∏
                    for (let i = 0; i < rows - 1; i++) {
                        for (let j = 0; j < cols - 1; j++) {
                            if (dominantMolecule[i][j] !== mol) continue;

                            const x = j * gridResolution;
                            const y = i * gridResolution;

                            const tl = field[i][j] >= threshold ? 1 : 0;
                            const tr = field[i][j + 1] >= threshold ? 1 : 0;
                            const br = field[i + 1][j + 1] >= threshold ? 1 : 0;
                            const bl = field[i + 1][j] >= threshold ? 1 : 0;

                            // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–ª–∏–≤–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –º–æ–ª–µ–∫—É–ª—ã
                            if (tl || tr || br || bl) {
                                ctx.rect(x, y, gridResolution, gridResolution);
                            }
                        }
                    }

                    ctx.clip(); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –æ–±–ª–∞—Å—Ç—å—é –º–æ–ª–µ–∫—É–ª—ã

                    // –†–∏—Å—É–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
                    for (let x = minX - stripeSpacing; x <= maxX + stripeSpacing; x += stripeSpacing) {
                        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å–∫–∏ –æ—Ç color1 –∫ color2
                        const gradient = ctx.createLinearGradient(x, minY, x, maxY);

                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
                        for (const stop of colorStops) {
                            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã
                            const variation = (Math.sin(x * 0.1 + stop.t * Math.PI * 4) * 0.5 + 0.5) * 20 - 10;

                            const newR = Math.max(0, Math.min(255, stop.baseR + variation));
                            const newG = Math.max(0, Math.min(255, stop.baseG + variation));
                            const newB = Math.max(0, Math.min(255, stop.baseB + variation));

                            gradient.addColorStop(stop.t, `rgb(${newR}, ${newG}, ${newB})`);
                        }

                        ctx.fillStyle = gradient;
                        ctx.fillRect(x, minY, stripeWidth, maxY - minY);
                    }

                    ctx.restore();
                }
            }

            // –ü–Ø–¢–´–ô –°–õ–û–ô: –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–æ–ª–µ–∫—É–ª—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            if (editorMode && hoveredMoleculeEditor && (currentTool === 'fill' || currentTool === 'eraser')) {
                const mol = hoveredMoleculeEditor;

                // –†–∏—Å—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ –∫–æ–Ω—Ç—É—Ä—É –º–æ–ª–µ–∫—É–ª—ã
                ctx.save();
                ctx.translate(mol.x, mol.y);
                ctx.rotate(mol.deformAngle);

                // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
                ctx.strokeStyle = currentTool === 'fill' ? 'rgba(0, 150, 255, 0.8)' : 'rgba(255, 100, 100, 0.8)';
                ctx.lineWidth = 4;
                ctx.setLineDash([10, 5]);

                // –†–∏—Å—É–µ–º —ç–ª–ª–∏–ø—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                ctx.beginPath();
                ctx.ellipse(0, 0, mol.size * mol.stretchX, mol.size * mol.stretchY, 0, 0, Math.PI * 2);
                ctx.stroke();

                ctx.setLineDash([]);
                ctx.restore();

                // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ —Ä–µ–∂–∏–º–µ –∑–∞–ª–∏–≤–∫–∏
                if (currentTool === 'fill') {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.font = '14px Arial';
                    const hint = fillMode === 'interior' ? 'ü™£ –í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å' :
                                 fillMode === 'edge' ? 'ü™£ –ö–æ–Ω—Ç—É—Ä' : 'ü™£ –û–±–∞';
                    const metrics = ctx.measureText(hint);
                    ctx.fillText(hint, mol.x - metrics.width / 2, mol.y - mol.size - 10);
                }
            }

            // –®–ï–°–¢–û–ô –°–õ–û–ô: –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —à—Ç—Ä–∏—Ö–æ–≤ –∫–∞—Ä–∞–Ω–¥–∞—à–∞ (–ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö –º–æ–ª–µ–∫—É–ª)
            // –°–Ω–∞—á–∞–ª–∞ —Ä–∏—Å—É–µ–º –∑–∞–ª–∏—Ç—ã–µ –æ–±–ª–∞—Å—Ç–∏ (–ø–æ–¥ —à—Ç—Ä–∏—Ö–∞–º–∏)
            for (const region of filledRegions) {
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = region.width;
                tempCanvas.height = region.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.putImageData(region.imageData, 0, 0);
                ctx.drawImage(tempCanvas, region.x, region.y);
            }

            // –ó–∞—Ç–µ–º —Ä–∏—Å—É–µ–º –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏
            for (const stroke of drawnStrokes) {
                if (stroke.points.length < 2) continue;

                ctx.strokeStyle = stroke.color;
                ctx.lineWidth = stroke.width;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                ctx.beginPath();
                ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
                for (let i = 1; i < stroke.points.length; i++) {
                    ctx.lineTo(stroke.points[i].x, stroke.points[i].y);
                }
                ctx.stroke();
            }

            // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Å—É–µ–º—ã–π —à—Ç—Ä–∏—Ö
            if (currentStroke && currentStroke.points.length > 1) {
                ctx.strokeStyle = currentStroke.color;
                ctx.lineWidth = currentStroke.width;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                ctx.beginPath();
                ctx.moveTo(currentStroke.points[0].x, currentStroke.points[0].y);
                for (let i = 1; i < currentStroke.points.length; i++) {
                    ctx.lineTo(currentStroke.points[i].x, currentStroke.points[i].y);
                }
                ctx.stroke();
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–¥–Ω–æ–π —è—á–µ–π–∫–∏ marching squares
        function drawMarchingSquareCell(x, y, cellIndex, field, i, j, threshold, edgeColor) {
            const size = gridResolution;

            // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –≥—Ä–∞–Ω—è—Ö
            function lerp(v0, v1, t) {
                return v0 + t * (v1 - v0);
            }

            function getEdgePoint(edge) {
                const tl = field[i][j];
                const tr = field[i][j + 1];
                const br = field[i + 1][j + 1];
                const bl = field[i + 1][j];

                let t = 0.5; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ—Ä–µ–¥–∏–Ω–∞

                switch(edge) {
                    case 0: // –í–µ—Ä—Ö
                        t = (threshold - tl) / (tr - tl);
                        return { x: lerp(x, x + size, t), y: y };
                    case 1: // –ü—Ä–∞–≤–æ
                        t = (threshold - tr) / (br - tr);
                        return { x: x + size, y: lerp(y, y + size, t) };
                    case 2: // –ù–∏–∑
                        t = (threshold - bl) / (br - bl);
                        return { x: lerp(x, x + size, t), y: y + size };
                    case 3: // –õ–µ–≤–æ
                        t = (threshold - tl) / (bl - tl);
                        return { x: x, y: lerp(y, y + size, t) };
                }
            }

            // –õ–∏–Ω–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π marching squares
            const lines = {
                1: [[3, 2]], 2: [[1, 2]], 3: [[3, 1]],
                4: [[0, 1]], 5: [[0, 3], [1, 2]], 6: [[0, 2]],
                7: [[0, 3]], 8: [[0, 3]], 9: [[0, 2]],
                10: [[0, 1], [3, 2]], 11: [[0, 1]], 12: [[3, 1]],
                13: [[1, 2]], 14: [[3, 2]]
            };

            if (!lines[cellIndex]) return;

            // –ë–õ–û–ß–ù–´–ô –≠–§–§–ï–ö–¢: –†–∏—Å—É–µ–º –±–ª–æ—á–Ω—É—é –∑–∞–ª–∏–≤–∫—É —Ç–æ–ª—å–∫–æ –Ω–∞ –∫—Ä–∞–µ–≤—ã—Ö —è—á–µ–π–∫–∞—Ö
            // (—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è –∫–æ–Ω—Ç—É—Ä–æ–º - 1-2 –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —É–≥–ª–∞)
            // –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –∫—Ä—É—Ç–æ–π –ø–∏–∫—Å–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö
            if (edgeColor) {
                const tl = field[i][j] >= threshold;
                const tr = field[i][j + 1] >= threshold;
                const br = field[i + 1][j + 1] >= threshold;
                const bl = field[i + 1][j] >= threshold;

                const filledCorners = [tl, tr, br, bl].filter(Boolean).length;

                // –ë–ª–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫ (1-2 —É–≥–ª–∞)
                // –≠—Ç–æ —è—á–µ–π–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è –∫–æ–Ω—Ç—É—Ä–æ–º
                if (filledCorners >= 1 && filledCorners <= 2) {
                    ctx.fillStyle = edgeColor;
                    ctx.fillRect(x, y, size, size);
                }
            }

            // –†–∏—Å—É–µ–º –∫–æ–Ω—Ç—É—Ä –ø–æ–≤–µ—Ä—Ö
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            for (const [e1, e2] of lines[cellIndex]) {
                const p1 = getEdgePoint(e1);
                const p2 = getEdgePoint(e2);
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
            }
            ctx.stroke();
        }

        // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–≤ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∂–µ—Å—Ç —Å—Ç–∞–±–∏–ª–µ–Ω –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –∫–∞–¥—Ä–∞—Ö
        function getStableGesture(handIndex, gestureName) {
            if (gestureHistory.length < GESTURE_HISTORY_SIZE) {
                return false; // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –∫–∞–¥—Ä–∞—Ö –∂–µ—Å—Ç –±—ã–ª –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º
            let consistentCount = 0;
            for (let i = 0; i < GESTURE_HISTORY_SIZE; i++) {
                const frame = gestureHistory[gestureHistory.length - 1 - i];
                if (frame && frame[handIndex] && frame[handIndex][gestureName]) {
                    consistentCount++;
                }
            }

            // –¢—Ä–µ–±—É–µ–º –º–∏–Ω–∏–º—É–º 4 –∏–∑ 5 –∫–∞–¥—Ä–æ–≤ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            return consistentCount >= 4;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ–±–µ–∏—Ö —Ä—É–∫ (–Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º—Å—è –∫ –∏–Ω–¥–µ–∫—Å—É —Ä—É–∫–∏)
        function checkStableTwoHands(gestureName) {
            if (hands.length !== 2) return false;
            if (gestureHistory.length < 3) return false; // –£–º–µ–Ω—å—à–∞–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 –∫–∞–¥—Ä–∞—Ö –±—ã–ª–æ —Ä–æ–≤–Ω–æ 2 —Ä—É–∫–∏ —Å –Ω—É–∂–Ω—ã–º –∂–µ—Å—Ç–æ–º
            let consistentCount = 0;
            for (let i = 0; i < Math.min(3, gestureHistory.length); i++) {
                const frame = gestureHistory[gestureHistory.length - 1 - i];
                if (frame && frame.length === 2) {
                    // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ä—É–∫ –∏–º–µ—é—Ç –Ω—É–∂–Ω—ã–π –∂–µ—Å—Ç –≤ —ç—Ç–æ–º –∫–∞–¥—Ä–µ
                    const handsWithGesture = frame.filter(h => h[gestureName]).length;
                    if (handsWithGesture === 2) {
                        consistentCount++;
                    }
                }
            }

            // –¢—Ä–µ–±—É–µ–º –º–∏–Ω–∏–º—É–º 2 –∏–∑ 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–∞–¥—Ä–æ–≤
            return consistentCount >= 2;
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∂–µ—Å—Ç–æ–≤
        function getPinchDistance(landmarks) {
            const thumb = landmarks[4];
            const index = landmarks[8];
            const dx = thumb.x - index.x;
            const dy = thumb.y - index.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // –ù–û–í–û–ï: –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è —â–∏–ø–∫–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —â–∏–ø–æ–∫, –∞ –Ω–µ –Ω–∞—á–∞–ª–æ –∫—É–ª–∞–∫–∞
        function isPinching(landmarks) {
            const pinchDist = getPinchDistance(landmarks);

            // –û—Å–Ω–æ–≤–Ω–æ–π –∫—Ä–∏—Ç–µ—Ä–∏–π - –±–æ–ª—å—à–æ–π –∏ —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–ª—å—Ü—ã –±–ª–∏–∑–∫–æ
            if (pinchDist >= 0.05) return false;

            // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥—Ä—É–≥–∏–µ –ø–∞–ª—å—Ü—ã –ù–ï —Å–∂–∞—Ç—ã –≤ –∫—É–ª–∞–∫
            // –ü—Ä–∏ –Ω–∞—Å—Ç–æ—è—â–µ–º —â–∏–ø–∫–µ —Å—Ä–µ–¥–Ω–∏–π, –±–µ–∑—ã–º—è–Ω–Ω—ã–π –∏ –º–∏–∑–∏–Ω–µ—Ü –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã
            const palmCenter = landmarks[9];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const pinkyTip = landmarks[20];

            // –†–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥—Ä—É–≥–∏—Ö –ø–∞–ª—å—Ü–µ–≤ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ª–∞–¥–æ–Ω–∏
            const middleFromPalm = Math.sqrt(
                (middleTip.x - palmCenter.x) ** 2 +
                (middleTip.y - palmCenter.y) ** 2
            );
            const ringFromPalm = Math.sqrt(
                (ringTip.x - palmCenter.x) ** 2 +
                (ringTip.y - palmCenter.y) ** 2
            );
            const pinkyFromPalm = Math.sqrt(
                (pinkyTip.x - palmCenter.x) ** 2 +
                (pinkyTip.y - palmCenter.y) ** 2
            );

            // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –ø–∞–ª—å—Ü–µ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã
            // –ï—Å–ª–∏ –ø–∞–ª–µ—Ü –¥–∞–ª–µ–∫–æ –æ—Ç –ª–∞–¥–æ–Ω–∏ - –æ–Ω –æ—Ç–∫—Ä—ã—Ç
            let openFingersCount = 0;
            if (middleFromPalm > 0.10) openFingersCount++;
            if (ringFromPalm > 0.09) openFingersCount++;
            if (pinkyFromPalm > 0.08) openFingersCount++;

            // –î–ª—è —â–∏–ø–∫–∞ –º–∏–Ω–∏–º—É–º 2 –∏–∑ 3 –ø–∞–ª—å—Ü–µ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫—É–ª–∞–∫–∞
            return openFingersCount >= 2;
        }

        // –ù–û–í–û–ï: –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –∑–∞–≥–Ω—É—Ç—ã—Ö –ø–∞–ª—å—Ü–µ–≤ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function detectFoldedFingers(landmarks) {
            const palmCenter = landmarks[9];
            const palm = landmarks[0];

            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞–ª—å—Ü–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º:
            // 1. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—á–∏–∫–∞ –æ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏—è (–ø—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–∏–±–∞)
            // 2. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—á–∏–∫–∞ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ª–∞–¥–æ–Ω–∏ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
            // 3. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏

            // –ë–û–õ–¨–®–û–ô –ü–ê–õ–ï–¶
            const thumbTip = landmarks[4];
            const thumbBase = landmarks[2];
            const thumbLength = Math.sqrt(
                (thumbTip.x - thumbBase.x) ** 2 +
                (thumbTip.y - thumbBase.y) ** 2
            );
            const thumbToPalm = Math.sqrt(
                (thumbTip.x - palmCenter.x) ** 2 +
                (thumbTip.y - palmCenter.y) ** 2
            );
            const thumbFolded = thumbLength < 0.065 || thumbToPalm < 0.11;

            // –£–ö–ê–ó–ê–¢–ï–õ–¨–ù–´–ô –ü–ê–õ–ï–¶
            const indexTip = landmarks[8];
            const indexBase = landmarks[5];
            const indexMid = landmarks[6];
            const indexLength = Math.sqrt(
                (indexTip.x - indexBase.x) ** 2 +
                (indexTip.y - indexBase.y) ** 2
            );
            const indexToPalm = Math.sqrt(
                (indexTip.x - palmCenter.x) ** 2 +
                (indexTip.y - palmCenter.y) ** 2
            );
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≥–æ–ª —Å–≥–∏–±–∞ —á–µ—Ä–µ–∑ —Å—Ä–µ–¥–Ω—é—é —Ñ–∞–ª–∞–Ω–≥—É
            const indexBend = Math.sqrt(
                (indexTip.x - indexMid.x) ** 2 +
                (indexTip.y - indexMid.y) ** 2
            );
            const indexFolded = (indexLength < 0.09 && indexToPalm < 0.14) || indexBend < 0.05;

            // –°–†–ï–î–ù–ò–ô –ü–ê–õ–ï–¶
            const middleTip = landmarks[12];
            const middleBase = landmarks[9];
            const middleMid = landmarks[10];
            const middleLength = Math.sqrt(
                (middleTip.x - middleBase.x) ** 2 +
                (middleTip.y - middleBase.y) ** 2
            );
            const middleToPalm = Math.sqrt(
                (middleTip.x - palmCenter.x) ** 2 +
                (middleTip.y - palmCenter.y) ** 2
            );
            const middleBend = Math.sqrt(
                (middleTip.x - middleMid.x) ** 2 +
                (middleTip.y - middleMid.y) ** 2
            );
            const middleFolded = (middleLength < 0.10 && middleToPalm < 0.14) || middleBend < 0.05;

            // –ë–ï–ó–´–ú–Ø–ù–ù–´–ô –ü–ê–õ–ï–¶
            const ringTip = landmarks[16];
            const ringBase = landmarks[13];
            const ringMid = landmarks[14];
            const ringLength = Math.sqrt(
                (ringTip.x - ringBase.x) ** 2 +
                (ringTip.y - ringBase.y) ** 2
            );
            const ringToPalm = Math.sqrt(
                (ringTip.x - palmCenter.x) ** 2 +
                (ringTip.y - palmCenter.y) ** 2
            );
            const ringBend = Math.sqrt(
                (ringTip.x - ringMid.x) ** 2 +
                (ringTip.y - ringMid.y) ** 2
            );
            const ringFolded = (ringLength < 0.09 && ringToPalm < 0.13) || ringBend < 0.05;

            // –ú–ò–ó–ò–ù–ï–¶
            const pinkyTip = landmarks[20];
            const pinkyBase = landmarks[17];
            const pinkyMid = landmarks[18];
            const pinkyLength = Math.sqrt(
                (pinkyTip.x - pinkyBase.x) ** 2 +
                (pinkyTip.y - pinkyBase.y) ** 2
            );
            const pinkyToPalm = Math.sqrt(
                (pinkyTip.x - palmCenter.x) ** 2 +
                (pinkyTip.y - palmCenter.y) ** 2
            );
            const pinkyBend = Math.sqrt(
                (pinkyTip.x - pinkyMid.x) ** 2 +
                (pinkyTip.y - pinkyMid.y) ** 2
            );
            const pinkyFolded = (pinkyLength < 0.07 && pinkyToPalm < 0.12) || pinkyBend < 0.04;

            return {
                thumb: thumbFolded,
                index: indexFolded,
                middle: middleFolded,
                ring: ringFolded,
                pinky: pinkyFolded
            };
        }

        function isHandOpen(landmarks) {
            // –£–õ–£–ß–®–ï–ù–û: –ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç–æ–π –ª–∞–¥–æ–Ω–∏
            const palm = landmarks[0];
            const palmCenter = landmarks[9];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—á–∏–∫–æ–≤ –ø–∞–ª—å—Ü–µ–≤ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ª–∞–¥–æ–Ω–∏
            const fingerTips = [
                { tip: landmarks[8], base: landmarks[5], name: 'index' },    // –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π
                { tip: landmarks[12], base: landmarks[9], name: 'middle' },  // –°—Ä–µ–¥–Ω–∏–π
                { tip: landmarks[16], base: landmarks[13], name: 'ring' },   // –ë–µ–∑—ã–º—è–Ω–Ω—ã–π
                { tip: landmarks[20], base: landmarks[17], name: 'pinky' }   // –ú–∏–∑–∏–Ω–µ—Ü
            ];

            let extendedCount = 0;
            fingerTips.forEach(finger => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞–ª–µ—Ü –≤—ã—Ç—è–Ω—É—Ç (–∫–æ–Ω—á–∏–∫ –¥–∞–ª–µ–∫–æ –æ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏—è)
                const tipToBase = Math.sqrt(
                    (finger.tip.x - finger.base.x) ** 2 +
                    (finger.tip.y - finger.base.y) ** 2
                );

                // –ò –ø–∞–ª–µ—Ü –¥–∞–ª–µ–∫–æ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ª–∞–¥–æ–Ω–∏
                const tipToPalm = Math.sqrt(
                    (finger.tip.x - palmCenter.x) ** 2 +
                    (finger.tip.y - palmCenter.y) ** 2
                );

                // –ü–∞–ª–µ—Ü —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –µ—Å–ª–∏ –æ–Ω –≤—ã—Ç—è–Ω—É—Ç –ò –¥–∞–ª–µ–∫–æ –æ—Ç –ª–∞–¥–æ–Ω–∏
                if (tipToBase > 0.07 && tipToPalm > 0.13) {
                    extendedCount++;
                }
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü –æ—Ç–¥–µ–ª—å–Ω–æ
            const thumbTip = landmarks[4];
            const thumbBase = landmarks[2];
            const thumbExtended = Math.sqrt(
                (thumbTip.x - thumbBase.x) ** 2 +
                (thumbTip.y - thumbBase.y) ** 2
            ) > 0.06;

            // –õ–∞–¥–æ–Ω—å –æ—Ç–∫—Ä—ã—Ç–∞ –µ—Å–ª–∏ –º–∏–Ω–∏–º—É–º 3 –ø–∞–ª—å—Ü–∞ (–Ω–µ —Å—á–∏—Ç–∞—è –±–æ–ª—å—à–æ–π) –≤—ã—Ç—è–Ω—É—Ç—ã
            // –ò–õ–ò –≤—Å–µ 4 –ø–∞–ª—å—Ü–∞ + –±–æ–ª—å—à–æ–π –≤—ã—Ç—è–Ω—É—Ç—ã
            return extendedCount >= 3 || (extendedCount >= 2 && thumbExtended);
        }

        function isHandFist(landmarks) {
            // –£–õ–£–ß–®–ï–ù–û v5: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–∞–∫–∞
            const palmCenter = landmarks[9];
            const palm = landmarks[0];

            const fingerPairs = [
                { tip: landmarks[8], base: landmarks[5], name: 'index' },    // –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π
                { tip: landmarks[12], base: landmarks[9], name: 'middle' },  // –°—Ä–µ–¥–Ω–∏–π
                { tip: landmarks[16], base: landmarks[13], name: 'ring' },   // –ë–µ–∑—ã–º—è–Ω–Ω—ã–π
                { tip: landmarks[20], base: landmarks[17], name: 'pinky' }   // –ú–∏–∑–∏–Ω–µ—Ü
            ];

            let closedCount = 0;
            const fingerDistances = [];

            fingerPairs.forEach(finger => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—á–∏–∫ –±–ª–∏–∑–∫–æ –∫ –æ—Å–Ω–æ–≤–∞–Ω–∏—é (–ø–∞–ª–µ—Ü —Å–æ–≥–Ω—É—Ç)
                const tipToBase = Math.sqrt(
                    (finger.tip.x - finger.base.x) ** 2 +
                    (finger.tip.y - finger.base.y) ** 2
                );

                // –ò –∫–æ–Ω—á–∏–∫ –±–ª–∏–∑–∫–æ –∫ —Ü–µ–Ω—Ç—Ä—É –ª–∞–¥–æ–Ω–∏
                const tipToPalm = Math.sqrt(
                    (finger.tip.x - palmCenter.x) ** 2 +
                    (finger.tip.y - palmCenter.y) ** 2
                );

                fingerDistances.push({
                    name: finger.name,
                    tipToBase: tipToBase.toFixed(3),
                    tipToPalm: tipToPalm.toFixed(3)
                });

                // –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–û v6: –ó–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞
                // tipToBase < 0.14 - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—á–∏–∫-–æ—Å–Ω–æ–≤–∞–Ω–∏–µ
                // tipToPalm < 0.19 - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—á–∏–∫-—Ü–µ–Ω—Ç—Ä –ª–∞–¥–æ–Ω–∏
                if (tipToBase < 0.14 && tipToPalm < 0.19) {
                    closedCount++;
                }
            });

            // –ë–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–Ω –±–ª–∏–∑–∫–æ –∫ –ª–∞–¥–æ–Ω–∏
            const thumbTip = landmarks[4];
            const thumbToPalm = Math.sqrt(
                (thumbTip.x - palmCenter.x) ** 2 +
                (thumbTip.y - palmCenter.y) ** 2
            );

            // –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–û: –ó–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞ –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞
            const thumbClosed = thumbToPalm < 0.18;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —â–∏–ø–æ–∫
            const thumbIndexDist = Math.sqrt(
                (thumbTip.x - landmarks[8].x) ** 2 +
                (thumbTip.y - landmarks[8].y) ** 2
            );
            const notPinching = thumbIndexDist > 0.05;

            // –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–û v6: –ö—É–ª–∞–∫ = 3 –∏–∑ 4 –ø–∞–ª—å—Ü–µ–≤ + –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞–ª—å—Ü—ã –≤ —Å—Ä–µ–¥–Ω–µ–º –±–ª–∏–∑–∫–æ –∫ –ª–∞–¥–æ–Ω–∏ (–Ω–µ —Ä–∞—Å—Ç–æ–ø—ã—Ä–µ–Ω—ã)
            const avgTipToPalm = fingerDistances.reduce((sum, f) => sum + parseFloat(f.tipToPalm), 0) / 4;
            const isCompact = avgTipToPalm < 0.17; // –°—Ä–µ–¥–Ω—è—è –±–ª–∏–∑–æ—Å—Ç—å –≤—Å–µ—Ö –ø–∞–ª—å—Ü–µ–≤

            const isFist = closedCount >= 3 && thumbClosed && notPinching && isCompact;

            // –û–¢–õ–ê–î–ö–ê: –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ—á—Ç–∏ –∫—É–ª–∞–∫ (–¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
            // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
            // if (closedCount >= 1 || thumbToPalm < 0.22) {
            //     console.log('üîç Fist Debug:', {
            //         closedCount: `${closedCount}/4`,
            //         thumbToPalm: thumbToPalm.toFixed(3),
            //         thumbClosed,
            //         notPinching,
            //         thumbIndexDist: thumbIndexDist.toFixed(3),
            //         isFist,
            //         fingers: fingerDistances
            //     });
            // }

            return isFist;
        }

        function isFingersCrossed(landmarks) {
            // –£–õ–£–ß–®–ï–ù–û v5: –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å—é
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const palm = landmarks[0];
            const palmCenter = landmarks[9];
            const indexBase = landmarks[5];
            const middleBase = landmarks[9];

            // 1. –ö–õ–Æ–ß–ï–í–û–ô –ö–†–ò–¢–ï–†–ò–ô: –ü–∞–ª—å—Ü—ã –±–ª–∏–∑–∫–æ –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É
            const fingersDist = Math.sqrt(
                (indexTip.x - middleTip.x) ** 2 +
                (indexTip.y - middleTip.y) ** 2
            );

            // 2. –û–±–∞ –ø–∞–ª—å—Ü–∞ –≤—ã—Ç—è–Ω—É—Ç—ã –æ—Ç –ª–∞–¥–æ–Ω–∏
            const indexFromPalm = Math.sqrt(
                (indexTip.x - palm.x) ** 2 +
                (indexTip.y - palm.y) ** 2
            );
            const middleFromPalm = Math.sqrt(
                (middleTip.x - palm.x) ** 2 +
                (middleTip.y - palm.y) ** 2
            );

            // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞–ª—å—Ü—ã –≤—ã—Ç—è–Ω—É—Ç—ã
            const indexLength = Math.sqrt(
                (indexTip.x - indexBase.x) ** 2 +
                (indexTip.y - indexBase.y) ** 2
            );
            const middleLength = Math.sqrt(
                (middleTip.x - middleBase.x) ** 2 +
                (middleTip.y - middleBase.y) ** 2
            );

            // 4. –ù–µ —â–∏–ø–æ–∫
            const thumbTip = landmarks[4];
            const thumbIndexDist = Math.sqrt(
                (thumbTip.x - indexTip.x) ** 2 +
                (thumbTip.y - indexTip.y) ** 2
            );

            // 5. –ù–µ –∫—É–ª–∞–∫
            const thumbToPalm = Math.sqrt(
                (thumbTip.x - palmCenter.x) ** 2 +
                (thumbTip.y - palmCenter.y) ** 2
            );

            // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ–±–∞ –ø–∞–ª—å—Ü–∞ –≤—ã—Ç—è–Ω—É—Ç—ã –û–î–ò–ù–ê–ö–û–í–û (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã)
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∫–æ–≥–¥–∞ –æ–¥–∏–Ω –ø–∞–ª–µ—Ü —Å–æ–≥–Ω—É—Ç
            const fingersEvenlyExtended = Math.abs(indexFromPalm - middleFromPalm) < 0.04;

            // –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò (–∑–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞):
            const fingersClose = fingersDist < 0.035;             // –ë–ê–õ–ê–ù–°: –º–µ–∂–¥—É —Å—Ç—Ä–æ–≥–∏–º (0.025) –∏ –º—è–≥–∫–∏–º (0.055)
            const bothExtended = indexFromPalm > 0.14 &&          // –ë–ê–õ–ê–ù–°: –º–µ–∂–¥—É 0.12 –∏ 0.15
                                middleFromPalm > 0.14;
            const bothLongEnough = indexLength > 0.075 &&         // –ë–ê–õ–ê–ù–°: –º–µ–∂–¥—É 0.07 –∏ 0.08
                                  middleLength > 0.075;
            const notPinching = thumbIndexDist > 0.055;           // –ß—É—Ç—å –º—è–≥—á–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            const notFist = thumbToPalm > 0.085;                  // –ë–ê–õ–ê–ù–°: –º–µ–∂–¥—É 0.08 –∏ 0.09

            return fingersClose &&
                   bothExtended &&
                   bothLongEnough &&
                   fingersEvenlyExtended &&  // –ù–û–í–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞!
                   notPinching &&
                   notFist;
        }

        // –î–µ—Ç–µ–∫—Ü–∏—è –º–∏–∑–∏–Ω—Ü–∞ (—Ç–æ–ª—å–∫–æ –º–∏–∑–∏–Ω–µ—Ü –ø–æ–¥–Ω—è—Ç)
        function isPinkyUp(landmarks) {
            const palm = landmarks[0];
            const palmCenter = landmarks[9];
            const pinkyTip = landmarks[20];
            const pinkyBase = landmarks[17];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const thumbTip = landmarks[4];

            // 1. –ú–∏–∑–∏–Ω–µ—Ü –≤—ã—Ç—è–Ω—É—Ç
            const pinkyExtended = Math.sqrt(
                (pinkyTip.x - pinkyBase.x) ** 2 +
                (pinkyTip.y - pinkyBase.y) ** 2
            ) > 0.05;

            // 2. –†–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç –ª–∞–¥–æ–Ω–∏
            const pinkyFromPalm = Math.sqrt(
                (pinkyTip.x - palmCenter.x) ** 2 +
                (pinkyTip.y - palmCenter.y) ** 2
            );
            const indexFromPalm = Math.sqrt(
                (indexTip.x - palmCenter.x) ** 2 +
                (indexTip.y - palmCenter.y) ** 2
            );
            const middleFromPalm = Math.sqrt(
                (middleTip.x - palmCenter.x) ** 2 +
                (middleTip.y - palmCenter.y) ** 2
            );
            const ringFromPalm = Math.sqrt(
                (ringTip.x - palmCenter.x) ** 2 +
                (ringTip.y - palmCenter.y) ** 2
            );
            const thumbFromPalm = Math.sqrt(
                (thumbTip.x - palmCenter.x) ** 2 +
                (thumbTip.y - palmCenter.y) ** 2
            );

            // –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–û v4: –ó–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –º–∏–∑–∏–Ω—Ü–∞
            // 3. –ú–∏–∑–∏–Ω–µ—Ü –≤—ã—Ç—è–Ω—É—Ç –∏ –¥–∞–ª—å—à–µ –æ—Ç –ª–∞–¥–æ–Ω–∏ —á–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞–ª—å—Ü—ã
            const pinkyFarthest = pinkyFromPalm > 0.10 &&                    // –í–µ—Ä–Ω—É–ª–∏ –∫ 0.10
                                  pinkyFromPalm > indexFromPalm * 0.75 &&    // –ó–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞
                                  pinkyFromPalm > middleFromPalm * 0.75 &&
                                  pinkyFromPalm > ringFromPalm * 0.70;       // –ß—É—Ç—å –º—è–≥—á–µ –¥–ª—è –±–µ–∑—ã–º—è–Ω–Ω–æ–≥–æ

            // 4. –î—Ä—É–≥–∏–µ –ø–∞–ª—å—Ü—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–æ–≥–Ω—É—Ç—ã
            // –£–ñ–ï–°–¢–û–ß–ï–ù–û: –í—Å–µ 3 –ø–∞–ª—å—Ü–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–≥–Ω—É—Ç—ã (–Ω–µ 2 –∏–∑ 3)
            const othersClosed = indexFromPalm < 0.15 &&
                                middleFromPalm < 0.15 &&
                                ringFromPalm < 0.14;

            // 5. –ë–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü –Ω–µ —Å–∏–ª—å–Ω–æ –≤—ã—Ç—è–Ω—É—Ç
            const thumbNotExtended = thumbFromPalm < 0.17;

            // 6. –ù–µ —â–∏–ø–æ–∫
            const thumbIndexDist = Math.sqrt(
                (thumbTip.x - indexTip.x) ** 2 +
                (thumbTip.y - indexTip.y) ** 2
            );
            const notPinching = thumbIndexDist > 0.05;

            return pinkyExtended &&
                   pinkyFarthest &&
                   othersClosed &&
                   thumbNotExtended &&
                   notPinching;
        }

        // –£–õ–£–ß–®–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∂–µ—Å—Ç–∞
        function isGestureStable(gestureName, currentValue) {
            const stability = GESTURE_STABILITY[gestureName];
            if (!stability) return currentValue;

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            stability.history.push(currentValue);
            if (stability.history.length > GESTURE_HISTORY_SIZE) {
                stability.history.shift();
            }

            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∂–µ—Å—Ç –±—ã–ª true –≤ –∏—Å—Ç–æ—Ä–∏–∏
            const trueCount = stability.history.filter(v => v).length;

            // –ñ–µ—Å—Ç —Å—Ç–∞–±–∏–ª–µ–Ω –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ
            return trueCount >= stability.required;
        }

        // –£–õ–£–ß–®–ï–ù–û: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂–µ—Å—Ç–∞ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º (–¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
        function getPrimaryGesture(landmarks) {
            const pinchDist = getPinchDistance(landmarks);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∂–µ—Å—Ç—ã (raw detection)
            const rawGestures = {
                isPinching: isPinching(landmarks),  // –£–õ–£–ß–®–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
                isPinky: isPinkyUp(landmarks),
                isCrossed: isFingersCrossed(landmarks),
                isFist: isHandFist(landmarks),
                isOpen: isHandOpen(landmarks)
            };

            // –£–õ–£–ß–®–ï–ù–û: –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫ –∫–∞–∂–¥–æ–º—É –∂–µ—Å—Ç—É –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ
            const stableGestures = {
                isPinching: isGestureStable('pinch', rawGestures.isPinching),
                isPinky: isGestureStable('pinky', rawGestures.isPinky),
                isCrossed: isGestureStable('crossed', rawGestures.isCrossed),
                isFist: isGestureStable('fist', rawGestures.isFist),
                isOpen: isGestureStable('open', rawGestures.isOpen)
            };

            // –ü–†–ò–û–†–ò–¢–ï–¢ –ñ–ï–°–¢–û–í (–æ—Ç –≤—ã—Å–æ–∫–æ–≥–æ –∫ –Ω–∏–∑–∫–æ–º—É):
            // 1. –©–∏–ø–æ–∫ - –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–ª–µ–∫—É–ª (—Å–∞–º—ã–π —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π)
            if (stableGestures.isPinching) {
                return {
                    isPinching: true,
                    isPinky: false,
                    isCrossed: false,
                    isFist: false,
                    isOpen: false,
                    primaryGesture: 'pinch'
                };
            }

            // 2. –ú–∏–∑–∏–Ω–µ—Ü - –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–æ—á–µ–Ω—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∂–µ—Å—Ç)
            if (stableGestures.isPinky) {
                return {
                    isPinching: false,
                    isPinky: true,
                    isCrossed: false,
                    isFist: false,
                    isOpen: false,
                    primaryGesture: 'pinky'
                };
            }

            // 3. –°–∫—Ä–µ—â–µ–Ω–Ω—ã–µ –ø–∞–ª—å—Ü—ã - –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π)
            if (stableGestures.isCrossed) {
                return {
                    isPinching: false,
                    isPinky: false,
                    isCrossed: true,
                    isFist: false,
                    isOpen: false,
                    primaryGesture: 'crossed'
                };
            }

            // 4. –ö—É–ª–∞–∫ - –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ (–±–æ–ª–µ–µ –æ–±—â–∏–π)
            if (stableGestures.isFist) {
                return {
                    isPinching: false,
                    isPinky: false,
                    isCrossed: false,
                    isFist: true,
                    isOpen: false,
                    primaryGesture: 'fist'
                };
            }

            // 5. –û—Ç–∫—Ä—ã—Ç–∞—è –ª–∞–¥–æ–Ω—å - –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (—Å–∞–º—ã–π –æ–±—â–∏–π)
            if (stableGestures.isOpen) {
                return {
                    isPinching: false,
                    isPinky: false,
                    isCrossed: false,
                    isFist: false,
                    isOpen: true,
                    primaryGesture: 'open'
                };
            }

            // –ù–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –∂–µ—Å—Ç–∞
            return {
                isPinching: false,
                isPinky: false,
                isCrossed: false,
                isFist: false,
                isOpen: false,
                primaryGesture: 'none'
            };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ MediaPipe
        let frameCount = 0;
        function onResults(results) {
            const newHands = [];
            const currentFrame = [];

            // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 60 –∫–∞–¥—Ä–æ–≤
            frameCount++;
            if (frameCount === 1) {
                console.log('üéâ onResults –≤—ã–∑–≤–∞–Ω –ø–µ—Ä–≤—ã–π —Ä–∞–∑! MediaPipe —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                console.log('‚úÖ WASM —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:', wasmFilesLoaded);
            }
            if (frameCount % 60 === 0) {
                console.log('MediaPipe Hands —Ä–∞–±–æ—Ç–∞–µ—Ç. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä—É–∫:', results.multiHandLandmarks ? results.multiHandLandmarks.length : 0);
            }

            if (results.multiHandLandmarks) {
                results.multiHandLandmarks.forEach((landmarks, idx) => {
                    // –£–õ–£–ß–®–ï–ù–û: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –ª–∞–Ω–¥–º–∞—Ä–∫–æ–≤ (–µ—Å–ª–∏ visibility –¥–æ—Å—Ç—É–ø–µ–Ω)
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–µ–¥–Ω—é—é visibility –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö –ª–∞–Ω–¥–º–∞—Ä–∫–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                    const keyLandmarks = [0, 4, 8, 12, 16, 20]; // –ó–∞–ø—è—Å—Ç—å–µ + –∫–æ–Ω—á–∏–∫–∏ –ø–∞–ª—å—Ü–µ–≤
                    let totalVisibility = 0;
                    let validCount = 0;

                    for (const idx of keyLandmarks) {
                        if (landmarks[idx] && landmarks[idx].visibility !== undefined) {
                            totalVisibility += landmarks[idx].visibility;
                            validCount++;
                        }
                    }

                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ visibility –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ò –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∑–∫–∏–π
                    // –ï—Å–ª–∏ visibility –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (validCount === 0) - —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ, –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                    if (validCount > 0) {
                        const avgVisibility = totalVisibility / validCount;

                        // –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä—É–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ visibility –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–π (< 0.3)
                        // –ë—ã–ª–æ 0.5, –Ω–æ —ç—Ç–æ —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ - –º–Ω–æ–≥–∏–µ –∫–∞–º–µ—Ä—ã –¥–∞—é—Ç visibility –æ–∫–æ–ª–æ 0.4-0.5
                        if (avgVisibility < 0.3) {
                            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É —Ä—É–∫—É - —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                            return;
                        }
                    }
                    // –ï—Å–ª–∏ visibility –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–µ—Ç–µ–∫—Ü–∏–∏

                    const palm = landmarks[9];

                    // –£–õ–£–ß–®–ï–ù–û: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ö–≤–∞—Ç–∞ –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞
                    // MediaPipe –æ–±—ã—á–Ω–æ –¥–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ~0.05-0.95 –¥–∞–∂–µ –Ω–∞ –∫—Ä–∞—è—Ö –≤–∏–¥–µ–æ
                    // –†–µ–º–∞–ø–ø–∏–º —ç—Ç–æ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–∞ –ø–æ–ª–Ω—ã–π 0-1 —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–æ–ª–µ–∫—É–ª—ã –Ω–∞ —Å–∞–º–æ–º –∫—Ä–∞—é
                    const edgeMargin = 0.08; // –ó–∞–ø–∞—Å –Ω–∞ –∫—Ä–∞—è—Ö (8%)
                    const remapX = Math.max(0, Math.min(1, (palm.x - edgeMargin) / (1 - 2 * edgeMargin)));
                    const remapY = Math.max(0, Math.min(1, (palm.y - edgeMargin) / (1 - 2 * edgeMargin)));

                    const handX = (1 - remapX) * width;  // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º X –¥–ª—è –∑–µ—Ä–∫–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const handY = remapY * height;

                    // –£–õ–£–ß–®–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∂–µ—Å—Ç–æ–≤
                    const gestureResult = getPrimaryGesture(landmarks);
                    const pinchDist = getPinchDistance(landmarks);

                    const isPinching = gestureResult.isPinching;
                    const isOpen = gestureResult.isOpen;
                    const isFist = gestureResult.isFist;
                    const isCrossed = gestureResult.isCrossed;
                    const isPinky = gestureResult.isPinky;

                    // –£–õ–£–ß–®–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—É—é –¥–µ—Ç–µ–∫—Ü–∏—é –∑–∞–≥–Ω—É—Ç—ã—Ö –ø–∞–ª—å—Ü–µ–≤
                    const fingersState = detectFoldedFingers(landmarks);

                    // –®–∏—Ä–∏–Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ª–∞–¥–æ–Ω–∏ (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞ –¥–æ –º–∏–∑–∏–Ω—Ü–∞)
                    const handWidth = Math.sqrt(
                        (landmarks[4].x - landmarks[20].x) ** 2 +
                        (landmarks[4].y - landmarks[20].y) ** 2
                    );

                    const handData = {
                        x: handX,
                        y: handY,
                        isPinching,
                        isOpen,
                        isFist,
                        isCrossed,
                        isPinky,
                        fingersState,
                        handWidth,
                        pinchDist // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                    };

                    newHands.push(handData);
                    currentFrame.push(handData);

                    // –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–ª–µ–∫—É–ª—ã –ø—Ä–∏ —â–∏–ø–∫–µ (–Ω–æ –ù–ï –ø—Ä–∏ –∫—É–ª–∞–∫–µ –∏ –¥—Ä—É–≥–∏—Ö –∂–µ—Å—Ç–∞—Ö!)
                    // –£–õ–£–ß–®–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∫—Ä–µ—â–µ–Ω–Ω—ã–µ –ø–∞–ª—å—Ü—ã –∏ –º–∏–∑–∏–Ω–µ—Ü
                    if (isPinching && !isFist && !isCrossed && !isPinky && !previousPinchStates[idx]) {
                        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–æ–ª–µ–∫—É–ª –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö)
                        if (molecules.length < maxMolecules) {
                            molecules.push(new Molecule(
                                handX,
                                handY,
                                config.moleculeSize
                            ));
                            saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                        }
                    }

                    previousPinchStates[idx] = isPinching;
                });
            }

            hands = newHands;

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –≤ –∏—Å—Ç–æ—Ä–∏—é
            gestureHistory.push(currentFrame);
            if (gestureHistory.length > GESTURE_HISTORY_SIZE) {
                gestureHistory.shift(); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–∞–¥—Ä—ã
            }
        }

        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å MediaPipe
        console.log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ë–†–ê–£–ó–ï–†–ê ===');
        console.log('–ë—Ä–∞—É–∑–µ—Ä:', navigator.userAgent);
        console.log('crossOriginIsolated:', window.crossOriginIsolated);
        console.log('SharedArrayBuffer:', typeof SharedArrayBuffer !== 'undefined');
        console.log('WebAssembly:', typeof WebAssembly !== 'undefined');

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        let wasmFilesLoaded = [];
        let wasmLoadErrors = [];

        window.addEventListener('error', (event) => {
            if (event.filename && event.filename.includes('mediapipe')) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ MediaPipe:', event.filename, event.message);
                wasmLoadErrors.push(event.filename);
            }
        }, true);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π –∫ MediaPipe
        const isLocalDevelopment = window.location.hostname === 'localhost' ||
                                    window.location.hostname === '127.0.0.1' ||
                                    window.location.hostname === '';

        // –¢–µ–ø–µ—Ä—å index.html –≤ public/, –ø–æ—ç—Ç–æ–º—É –ø—É—Ç–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –¥–ª—è –æ–±–æ–∏—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
        const mediapipeBasePath = './mediapipe';
        console.log('–û–∫—Ä—É–∂–µ–Ω–∏–µ:', isLocalDevelopment ? 'Live Server' : 'Production (Vercel)');
        console.log('MediaPipe –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å:', mediapipeBasePath);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaPipe Hands
        console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø MEDIAPIPE HANDS ===');
        const handsDetector = new Hands({
            locateFile: (file) => {
                console.log('üì¶ MediaPipe –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç:', file);
                wasmFilesLoaded.push(file);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤–º–µ—Å—Ç–æ CDN –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                const path = `${mediapipeBasePath}/hands/${file}`;
                console.log('  ‚Üí –ü—É—Ç—å:', path);
                return path;
            }
        });

        handsDetector.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏/—Ç–æ—á–Ω–æ—Å—Ç–∏
            minDetectionConfidence: 0.8,  // –£–õ–£–ß–®–ï–ù–û: –±—ã–ª–æ 0.7 - –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏
            minTrackingConfidence: 0.75   // –£–õ–£–ß–®–ï–ù–û: –±—ã–ª–æ 0.7 - –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
        });
        console.log('MediaPipe Hands –Ω–∞—Å—Ç—Ä–æ–µ–Ω');

        handsDetector.onResults(onResults);
        console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ onResults –ø–æ–¥–∫–ª—é—á–µ–Ω');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaPipe FaceMesh –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —Ä—Ç–∞ (–æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è, –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è)
        let faceMesh = null;
        let faceMeshReady = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º FaceMesh –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Hands
        setTimeout(() => {
            console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø MEDIAPIPE FACEMESH (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) ===');
            faceMesh = new FaceMesh({
                locateFile: (file) => {
                    console.log('üì¶ FaceMesh –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç:', file);
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤–º–µ—Å—Ç–æ CDN –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    const path = `${mediapipeBasePath}/face_mesh/${file}`;
                    console.log('  ‚Üí –ü—É—Ç—å:', path);
                    return path;
                }
            });

            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            faceMesh.onResults(onFaceResults);
            faceMeshReady = true;
            console.log('‚úÖ FaceMesh –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞, —á—Ç–æ–±—ã Hands –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ø–µ—Ä–≤—ã–º

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ FaceMesh
        function onFaceResults(results) {
            try {
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];

                    // FaceMesh –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã:
                    // 13 - –≤–µ—Ä—Ö–Ω—è—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≥—É–±–∞
                    // 14 - –Ω–∏–∂–Ω—è—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≥—É–±–∞
                    // –î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º:
                    // 13 –∏ 14 –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ç–æ—á–µ–∫ –≥—É–±
                    if (landmarks[13] && landmarks[14]) {
                        const upperLip = landmarks[13];
                        const lowerLip = landmarks[14];

                        // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤–µ—Ä—Ö–Ω–µ–π –∏ –Ω–∏–∂–Ω–µ–π –≥—É–±–æ–π
                        const mouthOpenDistance = Math.abs(lowerLip.y - upperLip.y);

                        // –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –±–æ–ª—å—à–µ –ø–æ—Ä–æ–≥–∞ - —Ä–æ—Ç –æ—Ç–∫—Ä—ã—Ç
                        isMouthOpen = mouthOpenDistance > 0.02; // –ü–æ–¥–æ–±—Ä–∞–Ω–Ω—ã–π –ø–æ—Ä–æ–≥

                        // TOGGLE —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä—Ç–∞
                        if (isMouthOpen && !wasMouthOpen) {
                            // –ú–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä—Ç–∞ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
                            if (editingMolecule) {
                                // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                                editingMolecule.isEditing = false;
                                editingMolecule = null;
                            } else {
                                // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –¥–ª—è –º–æ–ª–µ–∫—É–ª—ã –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–≤–µ–¥–µ–Ω–∞ —Ä—É–∫–∞
                                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ç–µ–∫—É—â–∞—è hovered –º–æ–ª–µ–∫—É–ª–∞ > –ø–æ—Å–ª–µ–¥–Ω—è—è hovered –º–æ–ª–µ–∫—É–ª–∞
                                let moleculeToEdit = hoveredMolecule || lastHoveredMolecule;

                                if (moleculeToEdit && molecules.includes(moleculeToEdit)) {
                                    // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —É –≤—Å–µ—Ö –º–æ–ª–µ–∫—É–ª
                                    molecules.forEach(m => m.isEditing = false);
                                    // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π
                                    moleculeToEdit.isEditing = true;
                                    editingMolecule = moleculeToEdit;
                                }
                            }
                        }

                        wasMouthOpen = isMouthOpen;
                    } else {
                        isMouthOpen = false;
                        wasMouthOpen = false;
                    }
                } else {
                    isMouthOpen = false;
                    wasMouthOpen = false;
                }
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –≤ onFaceResults:', error);
                isMouthOpen = false;
                wasMouthOpen = false;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
        async function setupCamera() {
            console.log('–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞–º–µ—Ä—ã...');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É API
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                status.textContent = '–û—à–∏–±–∫–∞: –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ';
                return null;
            }

            try {
                console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...');

                // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–¥–µ–æ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                const videoConstraints = isMobile ? {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user' // –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –∂–µ—Å—Ç–æ–≤
                } : {
                    width: 1280,
                    height: 720,
                    facingMode: 'user'
                };

                console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–¥–µ–æ:', videoConstraints);

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: videoConstraints
                });

                console.log('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø–æ–ª—É—á–µ–Ω!', stream);
                video.srcObject = stream;

                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        console.log('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                        resolve(video);
                    };
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
                console.error('–ò–º—è –æ—à–∏–±–∫–∏:', error.name);
                console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);

                status.textContent = `–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ${error.name}`;

                // –ü—Ä–æ–±—É–µ–º —Å –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                try {
                    console.log('–ü—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∫–∞–º–µ—Ä—É —Å –±–∞–∑–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏...');
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: true
                    });
                    console.log('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø–æ–ª—É—á–µ–Ω (–±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)!', stream);
                    video.srcObject = stream;
                    return new Promise((resolve) => {
                        video.onloadedmetadata = () => {
                            console.log('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (–±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)');
                            resolve(video);
                        };
                    });
                } catch (fallbackError) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ:', fallbackError);
                    status.textContent = `–û—à–∏–±–∫–∞: ${fallbackError.message}`;
                    return null;
                }
            }
        }

        // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–¢–ú–ï–ù–´ –î–ï–ô–°–¢–í–ò–ô (Ctrl+Z) ===

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é
        function saveState() {
            console.log(`üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –º–æ–ª–µ–∫—É–ª = ${molecules.length}, —à—Ç—Ä–∏—Ö–æ–≤ = ${drawnStrokes.length}`);

            // –°–æ–∑–¥–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            const state = {
                molecules: molecules.map(mol => ({
                    x: mol.x,
                    y: mol.y,
                    baseSize: mol.baseSize,
                    size: mol.size,
                    stretchX: mol.stretchX,
                    stretchY: mol.stretchY,
                    deformAngle: mol.deformAngle,
                    fillColor: mol.fillColor,
                    edgeColor: mol.edgeColor,
                    emboss: mol.emboss,
                    microStripes: mol.microStripes,
                    stripeColor1: mol.stripeColor1,
                    stripeColor2: mol.stripeColor2,
                    stripeWidth: mol.stripeWidth,
                    stripeSpacing: mol.stripeSpacing
                })),
                drawnStrokes: drawnStrokes.map(stroke => ({
                    points: stroke.points.map(p => ({x: p.x, y: p.y})),
                    color: stroke.color,
                    width: stroke.width
                })),
                filledRegions: filledRegions.map(region => ({
                    imageData: new ImageData(
                        new Uint8ClampedArray(region.imageData.data),
                        region.imageData.width,
                        region.imageData.height
                    ),
                    x: region.x,
                    y: region.y,
                    width: region.width,
                    height: region.height
                })),
                backgroundFills: backgroundFills.map(region => ({
                    imageData: new ImageData(
                        new Uint8ClampedArray(region.imageData.data),
                        region.imageData.width,
                        region.imageData.height
                    ),
                    x: region.x,
                    y: region.y,
                    width: region.width,
                    height: region.height
                }))
            };

            history.push(state);

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
            if (history.length > MAX_HISTORY_SIZE) {
                history.shift(); // –£–¥–∞–ª—è–µ–º —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            }

            console.log(`üíæ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ | –ò—Å—Ç–æ—Ä–∏—è: ${history.length}/${MAX_HISTORY_SIZE}`);
        }

        // –û—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è (Ctrl+Z)
        function undo() {
            console.log(`üîç –û—Ç–º–µ–Ω–∞: –∏—Å—Ç–æ—Ä–∏—è –¥–æ = ${history.length}, –º–æ–ª–µ–∫—É–ª –¥–æ = ${molecules.length}`);

            if (history.length === 0) {
                status.textContent = '‚ö†Ô∏è –ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å';
                return;
            }

            // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏)
            history.pop();
            console.log(`üîç –£–¥–∞–ª–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ = ${history.length}`);

            // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (history.length === 0) {
                console.log(`üîç –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ`);
                molecules = [];
                drawnStrokes = [];
                filledRegions = [];
                backgroundFills = [];
                if (editorMode) {
                    frozenMolecules = [];
                }
                backgroundCacheValid = false; // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞
                status.textContent = `‚Ü©Ô∏è –û—Ç–º–µ–Ω–µ–Ω–æ –≤—Å—ë | –ß–∏—Å—Ç–æ`;
                console.log(`‚Ü©Ô∏è –û—Ç–º–µ–Ω–µ–Ω–æ –≤—Å—ë`);
                return;
            }

            // –ë–µ—Ä–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ç–µ–ø–µ—Ä—å –æ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ)
            const state = history[history.length - 1];
            console.log(`üîç –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –º–æ–ª–µ–∫—É–ª = ${state.molecules.length}, —à—Ç—Ä–∏—Ö–æ–≤ = ${state.drawnStrokes.length}`);

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            molecules = state.molecules.map(mol => {
                // –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä Molecule
                const newMol = new Molecule(mol.x, mol.y, mol.size);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞
                newMol.baseSize = mol.baseSize;
                newMol.stretchX = mol.stretchX;
                newMol.stretchY = mol.stretchY;
                newMol.deformAngle = mol.deformAngle;
                newMol.fillColor = mol.fillColor;
                newMol.edgeColor = mol.edgeColor;
                newMol.emboss = mol.emboss;
                newMol.microStripes = mol.microStripes;
                newMol.stripeColor1 = mol.stripeColor1;
                newMol.stripeColor2 = mol.stripeColor2;
                newMol.stripeWidth = mol.stripeWidth;
                newMol.stripeSpacing = mol.stripeSpacing;

                return newMol;
            });

            drawnStrokes = state.drawnStrokes.map(stroke => ({
                points: stroke.points.map(p => ({x: p.x, y: p.y})),
                color: stroke.color,
                width: stroke.width
            }));

            filledRegions = state.filledRegions.map(region => ({
                imageData: new ImageData(
                    new Uint8ClampedArray(region.imageData.data),
                    region.imageData.width,
                    region.imageData.height
                ),
                x: region.x,
                y: region.y,
                width: region.width,
                height: region.height
            }));

            backgroundFills = state.backgroundFills.map(region => ({
                imageData: new ImageData(
                    new Uint8ClampedArray(region.imageData.data),
                    region.imageData.width,
                    region.imageData.height
                ),
                x: region.x,
                y: region.y,
                width: region.width,
                height: region.height
            }));

            // –û–±–Ω–æ–≤–ª—è–µ–º frozenMolecules –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            if (editorMode) {
                frozenMolecules = molecules.map(mol => ({
                    x: mol.x,
                    y: mol.y,
                    size: mol.size,
                    stretchX: mol.stretchX,
                    stretchY: mol.stretchY,
                    deformAngle: mol.deformAngle,
                    fillColor: mol.fillColor,
                    edgeColor: mol.edgeColor,
                    emboss: mol.emboss,
                    microStripes: mol.microStripes
                }));
            }

            // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞, —Ç–∞–∫ –∫–∞–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            backgroundCacheValid = false;

            status.textContent = `‚Ü©Ô∏è –û—Ç–º–µ–Ω–µ–Ω–æ | –û—Å—Ç–∞–ª–æ—Å—å: ${history.length}`;
            console.log(`‚Ü©Ô∏è –û—Ç–º–µ–Ω–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ | –ò—Å—Ç–æ—Ä–∏—è: ${history.length}/${MAX_HISTORY_SIZE} | –ú–æ–ª–µ–∫—É–ª –ø–æ—Å–ª–µ: ${molecules.length}`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            backgroundCacheValid = false; // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞

            // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä –º–æ–ª–µ–∫—É–ª –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
            // –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä 150px –¥–ª—è —ç–∫—Ä–∞–Ω–∞ 1920px
            // –î–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ (—Å–º–∞—Ä—Ç—Ñ–æ–Ω—ã ~400px) —Ä–∞–∑–º–µ—Ä –±—É–¥–µ—Ç ~60px
            const screenScale = Math.max(0.3, Math.min(1, width / 1500));
            config.moleculeSize = Math.round(150 * screenScale);

            // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä—ã –º–æ–ª–µ–∫—É–ª
            minMoleculeSize = Math.round(30 * screenScale);   // 30px -> ~12px –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ
            maxMoleculeSize = Math.round(300 * screenScale);  // 300px -> ~120px –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∞–Ω–∏–º–∞—Ü–∏–∏
        function animate() {
            // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ canvas –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–∞–¥—Ä–∞
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—ã –æ—Ç –¥–≤–∏–∂—É—â–∏—Ö—Å—è –æ–±—ä–µ–∫—Ç–æ–≤
            ctx.clearRect(0, 0, width, height);

            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ "–ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ" - —Ä–∏—Å—É–µ–º –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã –∫–∞–∫ —Ñ–æ–Ω
            if (config.showVideo && video.videoWidth > 0) {
                ctx.save();
                // –û—Ç–∑–µ—Ä–∫–∞–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
                ctx.scale(-1, 1);
                ctx.drawImage(video, -width, 0, width, height);
                ctx.restore();
            }

            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–≤—É–∫ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∂–µ—Å—Ç–æ–≤)
            if (config.audioEnabled && !editorMode) {
                analyzeAudio();
            }

            // –§–∏–∫—Å–∞—Ü–∏—è —Å —Ç–∞–π–º–µ—Ä–æ–º
            const fists = hands.filter(h => h.isFist);
            const twoFistsStable = checkStableTwoHands('isFist');

            // –§–ò–ö–°–ê–¶–ò–Ø –í–°–ï–• –ú–û–õ–ï–ö–£–õ - –¥–≤–∞ –∫—É–ª–∞–∫–∞ —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã
            if (fists.length === 2 && twoFistsStable) {
                if (twoFistsHoldStart === null) {
                    twoFistsHoldStart = Date.now();
                } else {
                    const holdDuration = Date.now() - twoFistsHoldStart;
                    if (holdDuration >= HOLD_DURATION) {
                        // –§–∏–∫—Å–∏—Ä—É–µ–º –í–°–ï –º–æ–ª–µ–∫—É–ª—ã
                        molecules.forEach(mol => {
                            if (!mol.isLocked) {
                                mol.isLocked = true;
                                mol.isShapeLocked = true;
                                mol.isGrabbed = false;
                                // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º isEditing –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                            }
                        });
                    }
                }
            } else {
                twoFistsHoldStart = null;
            }

            // –§–ò–ö–°–ê–¶–ò–Ø –û–î–ù–û–ô –ú–û–õ–ï–ö–£–õ–´ - –æ–¥–∏–Ω –∫—É–ª–∞–∫ –Ω–∞–¥ –º–æ–ª–µ–∫—É–ª–æ–π —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã
            if (fists.length === 1 && hands.length === 1) {
                const fist = fists[0];
                let closestMol = null;
                let closestDist = Infinity;

                // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é –º–æ–ª–µ–∫—É–ª—É
                molecules.forEach(mol => {
                    if (!mol.isLocked) {
                        const dist = Math.sqrt((mol.x - fist.x) ** 2 + (mol.y - fist.y) ** 2);
                        if (dist < 150 && dist < closestDist) {
                            closestDist = dist;
                            closestMol = mol;
                        }
                    }
                });

                if (closestMol) {
                    if (fistHoldMolecule === closestMol) {
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–∞–¥ —Ç–æ–π –∂–µ –º–æ–ª–µ–∫—É–ª–æ–π
                        const holdDuration = Date.now() - fistHoldStart;
                        if (holdDuration >= HOLD_DURATION) {
                            // –§–∏–∫—Å–∏—Ä—É–µ–º —ç—Ç—É –º–æ–ª–µ–∫—É–ª—É
                            closestMol.isLocked = true;
                            closestMol.isShapeLocked = true;
                            closestMol.isGrabbed = false;
                            // –ù–ï –°–ë–†–ê–°–´–í–ê–ï–ú isEditing - –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ
                            fistHoldStart = null;
                            fistHoldMolecule = null;
                        }
                    } else {
                        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å—á–µ—Ç —Å –Ω–æ–≤–æ–π –º–æ–ª–µ–∫—É–ª–æ–π
                        fistHoldStart = Date.now();
                        fistHoldMolecule = closestMol;
                    }
                } else {
                    fistHoldStart = null;
                    fistHoldMolecule = null;
                }
            } else {
                fistHoldStart = null;
                fistHoldMolecule = null;
            }

            // –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê –ú–ò–ó–ò–ù–¶–ï–ú - –ø–æ–∫–∞–∑–∞—Ç—å –º–∏–∑–∏–Ω–µ—Ü –Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–ª–µ–∫—É–ª–µ
            const pinkyHands = hands.filter(h => h.isPinky);
            if (pinkyHands.length === 1) {
                const pinky = pinkyHands[0];
                molecules.forEach(mol => {
                    if (mol.isLocked) {
                        const dist = Math.sqrt((mol.x - pinky.x) ** 2 + (mol.y - pinky.y) ** 2);
                        if (dist < 150) {
                            mol.isLocked = false;
                            mol.isShapeLocked = false;
                        }
                    }
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–ª–µ–∫—É–ª (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∂–µ—Å—Ç–æ–≤)
            if (!editorMode) {
                molecules.forEach(mol => mol.update());

                // –ü–†–û–í–ï–†–ö–ê –ò –°–õ–ò–Ø–ù–ò–ï –ú–û–õ–ï–ö–£–õ
                checkAndMergeMolecules();
            }

            // –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –ú–û–õ–ï–ö–£–õ–´ –ü–û–î –õ–ê–î–û–ù–¨–Æ (–¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
            hoveredMolecule = null;
            const openHands = hands.filter(h => h.isOpen && !h.isPinching && !h.isFist && !h.isCrossed && !h.isPinky);
            if (openHands.length > 0) {
                // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –º–æ–ª–µ–∫—É–ª—É –ø–æ–¥ –ª—é–±–æ–π –æ—Ç–∫—Ä—ã—Ç–æ–π –ª–∞–¥–æ–Ω—å—é
                let closestMol = null;
                let closestDist = Infinity;

                openHands.forEach(hand => {
                    molecules.forEach(mol => {
                        const dist = Math.sqrt((mol.x - hand.x) ** 2 + (mol.y - hand.y) ** 2);
                        if (dist < 150 && dist < closestDist) {
                            closestDist = dist;
                            closestMol = mol;
                        }
                    });
                });

                if (closestMol) {
                    hoveredMolecule = closestMol;
                    lastHoveredMolecule = closestMol;
                }
            }

            // –£–î–ê–õ–ï–ù–ò–ï –ú–û–õ–ï–ö–£–õ–´ - —Å–∫—Ä–µ—â–µ–Ω–Ω—ã–µ –ø–∞–ª—å—Ü—ã —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã
            const crossedHands = hands.filter(h => h.isCrossed);
            if (crossedHands.length === 1) {
                const crossed = crossedHands[0];
                let closestMol = null;
                let closestDist = Infinity;

                // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –º–æ–ª–µ–∫—É–ª—É
                molecules.forEach(mol => {
                    const dist = Math.sqrt((mol.x - crossed.x) ** 2 + (mol.y - crossed.y) ** 2);
                    if (dist < 120 && dist < closestDist) {
                        closestDist = dist;
                        closestMol = mol;
                    }
                });

                if (closestMol) {
                    // –£–õ–£–ß–®–ï–ù–û: –ñ–µ—Å—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏
                    crossedHoldLostTime = null;

                    if (crossedHoldMolecule === closestMol) {
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–∞–¥ —Ç–æ–π –∂–µ –º–æ–ª–µ–∫—É–ª–æ–π
                        const holdDuration = Date.now() - crossedHoldStart;
                        if (holdDuration >= HOLD_DURATION) {
                            // –£–¥–∞–ª—è–µ–º –º–æ–ª–µ–∫—É–ª—É –ø–æ—Å–ª–µ 2 —Å–µ–∫—É–Ω–¥
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ —É–¥–∞–ª—è–µ–º–∞—è –º–æ–ª–µ–∫—É–ª–∞ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ
                            if (editingMolecule === closestMol) {
                                editingMolecule = null;
                            }
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º lastHoveredMolecule –µ—Å–ª–∏ —ç—Ç–æ –æ–Ω–∞
                            if (lastHoveredMolecule === closestMol) {
                                lastHoveredMolecule = null;
                            }
                            molecules = molecules.filter(m => m !== closestMol);
                            crossedHoldStart = null;
                            crossedHoldMolecule = null;
                            crossedHoldLostTime = null;
                        }
                    } else {
                        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å—á–µ—Ç —Å –Ω–æ–≤–æ–π –º–æ–ª–µ–∫—É–ª–æ–π
                        crossedHoldStart = Date.now();
                        crossedHoldMolecule = closestMol;
                        crossedHoldLostTime = null;
                    }
                } else {
                    // –£–õ–£–ß–®–ï–ù–û: –ù–µ—Ç –º–æ–ª–µ–∫—É–ª—ã —Ä—è–¥–æ–º - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å
                    if (crossedHoldStart && !crossedHoldLostTime) {
                        crossedHoldLostTime = Date.now();
                    } else if (crossedHoldLostTime && (Date.now() - crossedHoldLostTime > RESET_TOLERANCE)) {
                        crossedHoldStart = null;
                        crossedHoldMolecule = null;
                        crossedHoldLostTime = null;
                    }
                }
            } else {
                // –£–õ–£–ß–®–ï–ù–û: –ñ–µ—Å—Ç –ø–æ—Ç–µ—Ä—è–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º
                if (crossedHoldStart && !crossedHoldLostTime) {
                    crossedHoldLostTime = Date.now();
                } else if (crossedHoldLostTime && (Date.now() - crossedHoldLostTime > RESET_TOLERANCE)) {
                    crossedHoldStart = null;
                    crossedHoldMolecule = null;
                    crossedHoldLostTime = null;
                }
            }

            // –†–∏—Å–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–ª–æ–≤ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            const renderStartTime = performance.now();

            drawMetaballs();

            // –ò–∑–º–µ—Ä—è–µ–º –≤—Ä–µ–º—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
            const renderTime = performance.now() - renderStartTime;
            adaptRenderingQuality(renderTime);

            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ç–∞–π–º–µ—Ä–æ–≤

            // –ü—Ä–æ–≥—Ä–µ—Å—Å —Ñ–∏–∫—Å–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –º–æ–ª–µ–∫—É–ª—ã
            if (fistHoldMolecule && fistHoldStart) {
                const progress = (Date.now() - fistHoldStart) / HOLD_DURATION;
                const angle = Math.PI * 2 * progress;

                ctx.strokeStyle = 'rgba(255, 200, 0, 0.9)';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(fistHoldMolecule.x, fistHoldMolecule.y, 35, -Math.PI / 2, -Math.PI / 2 + angle);
                ctx.stroke();

                // –¢–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                ctx.fillStyle = 'rgba(255, 200, 0, 0.9)';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üîí', fistHoldMolecule.x, fistHoldMolecule.y);
            }

            // –ü—Ä–æ–≥—Ä–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è –º–æ–ª–µ–∫—É–ª—ã
            if (crossedHoldMolecule && crossedHoldStart) {
                const progress = (Date.now() - crossedHoldStart) / HOLD_DURATION;
                const angle = Math.PI * 2 * progress;

                ctx.strokeStyle = 'rgba(255, 50, 50, 0.9)';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(crossedHoldMolecule.x, crossedHoldMolecule.y, 35, -Math.PI / 2, -Math.PI / 2 + angle);
                ctx.stroke();

                // –¢–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                ctx.fillStyle = 'rgba(255, 50, 50, 0.9)';
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üóëÔ∏è', crossedHoldMolecule.x, crossedHoldMolecule.y);
            }

            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–ª–µ–∫—É–ª
            molecules.forEach(mol => {
                if (mol.isLocked) {
                    if (mol.isShapeLocked) {
                        // –î–≤–æ–π–Ω–æ–π –∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã
                        ctx.strokeStyle = 'rgba(255, 100, 0, 0.8)';
                        ctx.lineWidth = 3;
                        const size = 15;

                        // –í–Ω–µ—à–Ω–∏–π –∫—Ä–µ—Å—Ç–∏–∫
                        ctx.beginPath();
                        ctx.moveTo(mol.x - size, mol.y - size);
                        ctx.lineTo(mol.x + size, mol.y + size);
                        ctx.moveTo(mol.x + size, mol.y - size);
                        ctx.lineTo(mol.x - size, mol.y + size);
                        ctx.stroke();

                        // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä–µ—Å—Ç–∏–∫
                        ctx.strokeStyle = 'rgba(255, 150, 50, 0.6)';
                        ctx.lineWidth = 2;
                        const smallSize = 8;
                        ctx.beginPath();
                        ctx.moveTo(mol.x - smallSize, mol.y - smallSize);
                        ctx.lineTo(mol.x + smallSize, mol.y + smallSize);
                        ctx.moveTo(mol.x + smallSize, mol.y - smallSize);
                        ctx.lineTo(mol.x - smallSize, mol.y + smallSize);
                        ctx.stroke();
                    } else {
                        // –ö—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                        ctx.strokeStyle = 'rgba(255, 50, 50, 0.7)';
                        ctx.lineWidth = 3;
                        const size = 15;
                        ctx.beginPath();
                        ctx.moveTo(mol.x - size, mol.y - size);
                        ctx.lineTo(mol.x + size, mol.y + size);
                        ctx.moveTo(mol.x + size, mol.y - size);
                        ctx.lineTo(mol.x - size, mol.y + size);
                        ctx.stroke();
                    }
                } else if (mol.isEditing) {
                    // –í–ò–ó–£–ê–õ–¨–ù–´–ô –ü–†–ï–í–¨–Æ –î–ï–§–û–†–ú–ê–¶–ò–ò

                    // 1. –Ø—Ä–∫–∏–π –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π –∫—Ä—É–≥ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    const pulse = 0.5 + Math.sin(Date.now() / 300) * 0.2;
                    ctx.strokeStyle = `rgba(50, 150, 255, ${pulse})`;
                    ctx.lineWidth = 5;
                    ctx.setLineDash([10, 5]);
                    ctx.beginPath();
                    ctx.arc(mol.x, mol.y, 35 + Math.sin(Date.now() / 400) * 3, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // 2. –ù–û–í–û–ï: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä—É–∫ –∏ –æ—Å–∏ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    if (mol.editingHands) {
                        const h1 = mol.editingHands.hand1;
                        const h2 = mol.editingHands.hand2;

                        // –õ–∏–Ω–∏—è –º–µ–∂–¥—É —Ä—É–∫–∞–º–∏ (–∑–µ–ª—ë–Ω–∞—è) - –æ—Å—å —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è
                        ctx.strokeStyle = 'rgba(50, 255, 100, 0.8)';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([10, 5]);
                        ctx.beginPath();
                        ctx.moveTo(h1.x, h1.y);
                        ctx.lineTo(h2.x, h2.y);
                        ctx.stroke();
                        ctx.setLineDash([]);

                        // –¢–æ—á–∫–∏ —Ä—É–∫
                        ctx.fillStyle = 'rgba(255, 100, 100, 0.9)';
                        ctx.beginPath();
                        ctx.arc(h1.x, h1.y, 10, 0, Math.PI * 2);
                        ctx.fill();

                        ctx.fillStyle = 'rgba(255, 150, 50, 0.9)';
                        ctx.beginPath();
                        ctx.arc(h2.x, h2.y, 10, 0, Math.PI * 2);
                        ctx.fill();

                        // –û—Å—å –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –º–æ–ª–µ–∫—É–ª—É
                        const axisLength = mol.size * mol.stretchX * 0.8;
                        const axisX1 = mol.x + Math.cos(mol.deformAngle) * axisLength;
                        const axisY1 = mol.y + Math.sin(mol.deformAngle) * axisLength;
                        const axisX2 = mol.x - Math.cos(mol.deformAngle) * axisLength;
                        const axisY2 = mol.y - Math.sin(mol.deformAngle) * axisLength;

                        ctx.strokeStyle = 'rgba(255, 100, 255, 0.7)';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([8, 4]);
                        ctx.beginPath();
                        ctx.moveTo(axisX1, axisY1);
                        ctx.lineTo(axisX2, axisY2);
                        ctx.stroke();

                        // –ü–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–∞—è –æ—Å—å (—Å–∂–∞—Ç–∏–µ)
                        const perpAngle = mol.deformAngle + Math.PI / 2;
                        const perpLength = mol.size * mol.stretchY * 0.8;
                        const perpX1 = mol.x + Math.cos(perpAngle) * perpLength;
                        const perpY1 = mol.y + Math.sin(perpAngle) * perpLength;
                        const perpX2 = mol.x - Math.cos(perpAngle) * perpLength;
                        const perpY2 = mol.y - Math.sin(perpAngle) * perpLength;

                        ctx.strokeStyle = 'rgba(100, 255, 255, 0.6)';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([4, 4]);
                        ctx.beginPath();
                        ctx.moveTo(perpX1, perpY1);
                        ctx.lineTo(perpX2, perpY2);
                        ctx.stroke();
                        ctx.setLineDash([]);

                        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–µ–ø–µ–Ω–∏ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';

                        // –†–∞—Å—Ç—è–∂–µ–Ω–∏–µ –≤–¥–æ–ª—å (X)
                        ctx.fillStyle = 'rgba(255, 100, 255, 0.9)';
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.lineWidth = 3;
                        ctx.strokeText(`${mol.stretchX.toFixed(1)}x`, axisX1 + Math.cos(mol.deformAngle) * 20, axisY1 + Math.sin(mol.deformAngle) * 20);
                        ctx.fillText(`${mol.stretchX.toFixed(1)}x`, axisX1 + Math.cos(mol.deformAngle) * 20, axisY1 + Math.sin(mol.deformAngle) * 20);

                        // –°–∂–∞—Ç–∏–µ –ø–æ–ø–µ—Ä—ë–∫ (Y)
                        ctx.fillStyle = 'rgba(100, 255, 255, 0.9)';
                        ctx.strokeText(`${mol.stretchY.toFixed(1)}x`, perpX1 + Math.cos(perpAngle) * 20, perpY1 + Math.sin(perpAngle) * 20);
                        ctx.fillText(`${mol.stretchY.toFixed(1)}x`, perpX1 + Math.cos(perpAngle) * 20, perpY1 + Math.sin(perpAngle) * 20);
                    }

                    // 3. –ò–∫–æ–Ω–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = 'rgba(50, 150, 255, 0.9)';
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.lineWidth = 2;
                    ctx.strokeText('‚úé', mol.x, mol.y - 50);
                    ctx.fillText('‚úé', mol.x, mol.y - 50);

                    // 4. –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ —Ä–µ–∂–∏–º–µ
                    ctx.font = '13px Arial';
                    ctx.fillStyle = 'rgba(50, 150, 255, 0.8)';
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)';
                    ctx.lineWidth = 2;
                    const hint = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–æ—Ç–∫—Ä–æ–π—Ç–µ —Ä–æ—Ç –¥–ª—è –≤—ã—Ö–æ–¥–∞)';
                    ctx.strokeText(hint, mol.x, mol.y + 55);
                    ctx.fillText(hint, mol.x, mol.y + 55);
                } else if (mol.isGrabbed) {
                    // –ó–µ–ª—ë–Ω—ã–π –∫—Ä—É–≥ –¥–ª—è –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö
                    ctx.strokeStyle = 'rgba(50, 255, 50, 0.8)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(mol.x, mol.y, 25, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // –ù–û–í–û–ï: –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–æ–ª–µ–∫—É–ª—ã –ø–æ–¥ –ª–∞–¥–æ–Ω—å—é (–≥–æ—Ç–æ–≤–∞ –∫ –≤—ã–±–æ—Ä—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                if (mol === hoveredMolecule && !mol.isEditing && !mol.isLocked) {
                    // –ñ—ë–ª—Ç—ã–π –∫—Ä—É–≥ —Å –ø—É–Ω–∫—Ç–∏—Ä–æ–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ —ç—Ç–∞ –º–æ–ª–µ–∫—É–ª–∞ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–∞
                    ctx.strokeStyle = 'rgba(255, 200, 50, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([6, 3]);
                    ctx.beginPath();
                    ctx.arc(mol.x, mol.y, 28, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // –ü–æ–¥—Å–∫–∞–∑–∫–∞
                    ctx.font = '11px Arial';
                    ctx.fillStyle = 'rgba(255, 200, 50, 0.9)';
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)';
                    ctx.lineWidth = 2;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    const hintText = '–û—Ç–∫—Ä–æ–π—Ç–µ —Ä–æ—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                    ctx.strokeText(hintText, mol.x, mol.y + 35);
                    ctx.fillText(hintText, mol.x, mol.y + 35);
                }

                // PAINT –†–ï–î–ê–ö–¢–û–†: –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–ª–µ–∫—É–ª—ã
                if (editorMode && mol === selectedMolecule) {
                    // –û—Ä–∞–Ω–∂–µ–≤—ã–π –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π –∫–æ–Ω—Ç—É—Ä
                    const pulse = 0.6 + Math.sin(Date.now() / 200) * 0.3;
                    ctx.strokeStyle = `rgba(255, 165, 0, ${pulse})`;
                    ctx.lineWidth = 4;
                    ctx.setLineDash([8, 4]);
                    ctx.beginPath();
                    ctx.arc(mol.x, mol.y, mol.size * 1.1, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // –ú–µ—Ç–∫–∞ "–í–´–ë–†–ê–ù–ê"
                    ctx.font = 'bold 14px Arial';
                    ctx.fillStyle = 'rgba(255, 165, 0, 0.9)';
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.lineWidth = 3;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.strokeText('–í–´–ë–†–ê–ù–ê', mol.x, mol.y - mol.size - 10);
                    ctx.fillText('–í–´–ë–†–ê–ù–ê', mol.x, mol.y - mol.size - 10);
                }
            });

            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä—É–∫
            hands.forEach(hand => {
                let color, label;
                // –£–õ–£–ß–®–ï–ù–û: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∂–µ—Å—Ç–æ–≤
                if (hand.isPinching) {
                    color = 'rgba(255, 100, 100, 0.6)';
                    label = '‚úåÔ∏è';
                } else if (hand.isPinky) {
                    color = 'rgba(255, 200, 0, 0.7)';
                    label = 'ü§ô';
                } else if (hand.isCrossed) {
                    color = 'rgba(255, 50, 150, 0.7)';
                    label = 'ü§û';
                } else if (hand.isFist) {
                    color = 'rgba(255, 150, 50, 0.6)';
                    label = '‚úä';
                } else if (hand.isOpen) {
                    color = 'rgba(100, 255, 100, 0.6)';
                    label = '‚úã';
                } else {
                    color = 'rgba(150, 150, 150, 0.5)';
                    label = '';
                }

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(hand.x, hand.y, 15, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#1a1a1a';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Emoji –¥–ª—è –∂–µ—Å—Ç–∞
                if (label) {
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(label, hand.x, hand.y - 35);
                }
            });

            // –õ–∏–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ä—É–∫–∞–º–∏
            const openHandsForLine = hands.filter(h => h.isOpen);
            if (openHandsForLine.length === 2) {
                // –ï—Å–ª–∏ –º–æ–ª–µ–∫—É–ª–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é
                const inEditMode = editingMolecule && editingMolecule.isEditing;

                if (inEditMode) {
                    // –Ø—Ä–∫–∞—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–∏–Ω–∏—è –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    const gradient = ctx.createLinearGradient(
                        openHandsForLine[0].x, openHandsForLine[0].y,
                        openHandsForLine[1].x, openHandsForLine[1].y
                    );
                    gradient.addColorStop(0, 'rgba(50, 150, 255, 0.7)');
                    gradient.addColorStop(0.5, 'rgba(100, 200, 255, 0.9)');
                    gradient.addColorStop(1, 'rgba(50, 150, 255, 0.7)');

                    ctx.strokeStyle = gradient;
                    ctx.lineWidth = 4;
                    ctx.setLineDash([10, 5]);
                    ctx.beginPath();
                    ctx.moveTo(openHandsForLine[0].x, openHandsForLine[0].y);
                    ctx.lineTo(openHandsForLine[1].x, openHandsForLine[1].y);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                    const distX = Math.abs(openHandsForLine[1].x - openHandsForLine[0].x);
                    const distY = Math.abs(openHandsForLine[1].y - openHandsForLine[0].y);
                    const midX = (openHandsForLine[0].x + openHandsForLine[1].x) / 2;
                    const midY = (openHandsForLine[0].y + openHandsForLine[1].y) / 2;

                    ctx.font = '12px Arial';
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ —É–≥–æ–ª
                    const totalDist = Math.round(Math.sqrt(distX * distX + distY * distY));
                    const angle = Math.round(editingMolecule.targetDeformAngle * 180 / Math.PI);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    const text = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${totalDist}px | –£–≥–æ–ª: ${angle}¬∞`;
                    ctx.strokeText(text, midX, midY - 10);
                    ctx.fillText(text, midX, midY - 10);

                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    const stretchInfo = `–†–∞—Å—Ç—è–∂–µ–Ω–∏–µ: ${editingMolecule.stretchX.toFixed(2)} √ó ${editingMolecule.stretchY.toFixed(2)}`;
                    ctx.font = '10px Arial';
                    ctx.strokeText(stretchInfo, midX, midY + 10);
                    ctx.fillText(stretchInfo, midX, midY + 10);
                } else {
                    // –û–±—ã—á–Ω–∞—è –ª–∏–Ω–∏—è
                    ctx.strokeStyle = 'rgba(100, 255, 100, 0.4)';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(openHandsForLine[0].x, openHandsForLine[0].y);
                    ctx.lineTo(openHandsForLine[1].x, openHandsForLine[1].y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }

            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –Ω–∏–∑–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
            let currentYOffset = 10;
            if (isLowPerformanceMode && frameTimeHistory.length > 0) {
                const avgFrameTime = frameTimeHistory.reduce((a, b) => a + b, 0) / frameTimeHistory.length;
                const fps = Math.round(1000 / avgFrameTime);

                ctx.save();
                ctx.fillStyle = 'rgba(255, 150, 0, 0.8)';
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.lineWidth = 2;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';

                const text = `‚ö° –†–µ–∂–∏–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | ${fps} FPS | –ö–∞—á–µ—Å—Ç–≤–æ: –Ω–∏–∑–∫–æ–µ`;
                const padding = 10;
                const textMetrics = ctx.measureText(text);
                const boxWidth = textMetrics.width + padding * 2;
                const boxHeight = 30;

                // –§–æ–Ω
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(10, currentYOffset, boxWidth, boxHeight);

                // –¢–µ–∫—Å—Ç
                ctx.fillStyle = 'rgba(255, 200, 100, 1)';
                ctx.fillText(text, 10 + padding, currentYOffset + padding);
                ctx.restore();

                currentYOffset += boxHeight + 10; // –°–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
            }

            // –ù–û–í–û–ï: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–∏—Ö –∂–µ—Å—Ç–æ–≤ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏)
            if (hands.length > 0 && !editorMode && showGestureDebug) {
                ctx.save();
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';

                const padding = 10;
                const lineHeight = 22;
                let debugLines = [];

                // –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∂–µ—Å—Ç–æ–≤
                const gestureIcons = {
                    'fist': '‚úä',
                    'open': '‚úã',
                    'pinch': 'ü§è',
                    'crossed': 'ü§û',
                    'pinky': 'ü§ô',
                    'none': '‚ùì'
                };

                // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–π —Ä—É–∫–µ
                hands.forEach((hand, idx) => {
                    const handLabel = `–†—É–∫–∞ ${idx + 1}`;
                    let gesture = 'none';

                    if (hand.isFist) gesture = 'fist';
                    else if (hand.isPinching) gesture = 'pinch';
                    else if (hand.isCrossed) gesture = 'crossed';
                    else if (hand.isPinky) gesture = 'pinky';
                    else if (hand.isOpen) gesture = 'open';

                    const icon = gestureIcons[gesture] || '‚ùì';
                    const gestureName = {
                        'fist': '–ö—É–ª–∞–∫',
                        'open': '–û—Ç–∫—Ä—ã—Ç–∞',
                        'pinch': '–©–∏–ø–æ–∫',
                        'crossed': '–°–∫—Ä–µ—â–µ–Ω—ã',
                        'pinky': '–ú–∏–∑–∏–Ω–µ—Ü',
                        'none': '–ù–µ—Ç –∂–µ—Å—Ç–∞'
                    }[gesture];

                    debugLines.push(`${icon} ${handLabel}: ${gestureName}`);
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∂–µ—Å—Ç–æ–≤ (—Å–∫–æ–ª—å–∫–æ –∏–∑ 10 –∫–∞–¥—Ä–æ–≤)
                const stabilityInfo = [];
                for (const [gestureName, data] of Object.entries(GESTURE_STABILITY)) {
                    const count = data.history.filter(v => v).length;
                    const required = data.required;
                    if (count > 0) {
                        const percent = Math.round((count / GESTURE_HISTORY_SIZE) * 100);
                        const stableIcon = count >= required ? '‚úì' : '‚óã';
                        const nameRu = {
                            'fist': '–ö—É–ª–∞–∫',
                            'pinch': '–©–∏–ø–æ–∫',
                            'crossed': '–°–∫—Ä–µ—â–µ–Ω—ã',
                            'pinky': '–ú–∏–∑–∏–Ω–µ—Ü',
                            'open': '–û—Ç–∫—Ä—ã—Ç–∞'
                        }[gestureName] || gestureName;
                        stabilityInfo.push(`${stableIcon} ${nameRu}: ${count}/${required} (${percent}%)`);
                    }
                }

                if (stabilityInfo.length > 0) {
                    debugLines.push('‚îÄ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚îÄ');
                    debugLines = debugLines.concat(stabilityInfo);
                }

                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –±–æ–∫—Å–∞
                const maxWidth = Math.max(...debugLines.map(line => ctx.measureText(line).width));
                const boxWidth = maxWidth + padding * 2;
                const boxHeight = debugLines.length * lineHeight + padding * 2;

                // –†–∏—Å—É–µ–º —Ñ–æ–Ω
                ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
                ctx.fillRect(10, currentYOffset, boxWidth, boxHeight);

                // –†–∞–º–∫–∞
                ctx.strokeStyle = 'rgba(100, 200, 255, 0.5)';
                ctx.lineWidth = 2;
                ctx.strokeRect(10, currentYOffset, boxWidth, boxHeight);

                // –†–∏—Å—É–µ–º —Ç–µ–∫—Å—Ç
                debugLines.forEach((line, idx) => {
                    // –†–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å—Ç—Ä–æ–∫
                    if (line.includes('‚úì')) {
                        ctx.fillStyle = 'rgba(100, 255, 100, 1)'; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –∂–µ—Å—Ç–æ–≤
                    } else if (line.includes('‚óã')) {
                        ctx.fillStyle = 'rgba(255, 200, 100, 1)'; // –ñ–µ–ª—Ç—ã–π –¥–ª—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö
                    } else if (line.includes('‚îÄ')) {
                        ctx.fillStyle = 'rgba(150, 150, 150, 1)'; // –°–µ—Ä—ã–π –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
                    } else {
                        ctx.fillStyle = 'rgba(200, 220, 255, 1)'; // –ì–æ–ª—É–±–æ–π –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                    }
                    ctx.fillText(line, 10 + padding, currentYOffset + padding + idx * lineHeight);
                });

                ctx.restore();
            }

            requestAnimationFrame(animate);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è MediaPipe
        let detectHandsStarted = false;
        let sendCount = 0;
        async function detectHands() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                if (!detectHandsStarted) {
                    console.log('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ, –Ω–∞—á–∏–Ω–∞–µ–º –¥–µ—Ç–µ–∫—Ü–∏—é —Ä—É–∫');
                    detectHandsStarted = true;
                }
                try {
                    sendCount++;
                    if (sendCount === 1) {
                        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä –≤ MediaPipe...');
                    }
                    if (sendCount === 30 && frameCount === 0) {
                        console.warn('‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 30 –∫–∞–¥—Ä–æ–≤, –Ω–æ onResults –Ω–∏ —Ä–∞–∑—É –Ω–µ –≤—ã–∑–≤–∞–Ω!');
                        console.warn('MediaPipe WASM –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è.');
                        console.warn('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:', wasmFilesLoaded);
                        console.warn('–û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏:', wasmLoadErrors.length > 0 ? wasmLoadErrors : '–Ω–µ—Ç');
                        console.warn('crossOriginIsolated:', window.crossOriginIsolated);
                    }
                    if (sendCount === 100 && frameCount === 0) {
                        console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: MediaPipe –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ 100 –∫–∞–¥—Ä–æ–≤!');
                        console.error('–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å CORS –∏–ª–∏ COEP –ø–æ–ª–∏—Ç–∏–∫–æ–π.');
                        console.error('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network –≤–∫–ª–∞–¥–∫—É –≤ DevTools –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
                    }

                    await handsDetector.send({ image: video });
                    // FaceMesh –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Ä—É–∫
                    if (faceMeshReady && faceMesh) {
                        try {
                            await faceMesh.send({ image: video });
                        } catch (faceError) {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ FaceMesh
                        }
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ä—É–∫:', error);
                }
            }
            requestAnimationFrame(detectHands);
        }

        // UI –∫–æ–Ω—Ç—Ä–æ–ª—ã
        document.getElementById('molSizeSlider').addEventListener('input', (e) => {
            config.moleculeSize = parseInt(e.target.value);
            document.getElementById('molSize').textContent = config.moleculeSize;
        });

        document.getElementById('mergeSlider').addEventListener('input', (e) => {
            config.mergeStrength = parseFloat(e.target.value);
            document.getElementById('mergeStrength').textContent = config.mergeStrength.toFixed(1);
        });

        document.getElementById('audioSensSlider').addEventListener('input', (e) => {
            config.audioSensitivity = parseInt(e.target.value);
            document.getElementById('audioSens').textContent = config.audioSensitivity;
        });

        document.getElementById('audioEnabled').addEventListener('change', (e) => {
            config.audioEnabled = e.target.checked;
        });

        document.getElementById('showVideo').addEventListener('change', (e) => {
            config.showVideo = e.target.checked;
            video.style.opacity = config.showVideo ? '0.3' : '0';
        });

        document.getElementById('lockBtn').addEventListener('click', () => {
            molecules.forEach(mol => mol.lock());
        });

        document.getElementById('unlockBtn').addEventListener('click', () => {
            molecules.forEach(mol => mol.unlock());
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            molecules = [];
        });

        // –≠–ö–°–ü–û–†–¢: PNG (—Å —Ñ–æ–Ω–æ–º –∏–ª–∏ –±–µ–∑ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥–∞–ª–æ—á–∫–∏)
        document.getElementById('exportPngBtn').addEventListener('click', () => {
            const withBackground = document.getElementById('exportWithBackground').checked;

            if (withBackground) {
                // –≠–∫—Å–ø–æ—Ä—Ç —Å —Ñ–æ–Ω–æ–º - –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π canvas
                const link = document.createElement('a');
                link.download = `molecules_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                status.textContent = 'PNG —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω (—Å —Ñ–æ–Ω–æ–º)';
            } else {
                // –≠–∫—Å–ø–æ—Ä—Ç –±–µ–∑ —Ñ–æ–Ω–∞ - –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Ñ–æ–Ω
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const originalBgType = backgroundType;
                const originalBgImage = backgroundImage;
                const originalBgColor = backgroundColor;
                const originalShowVideo = config.showVideo;

                // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Ñ–æ–Ω
                backgroundType = 'transparent';
                backgroundImage = null;
                config.showVideo = false;

                // –†–∏—Å—É–µ–º –æ–¥–∏–Ω –∫–∞–¥—Ä –±–µ–∑ —Ñ–æ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º canvas
                drawMetaballs();

                // –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(canvas, 0, 0);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                backgroundType = originalBgType;
                backgroundImage = originalBgImage;
                backgroundColor = originalBgColor;
                config.showVideo = originalShowVideo;

                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å —Ñ–æ–Ω–æ–º (—á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω)
                drawMetaballs();

                // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º
                const link = document.createElement('a');
                link.download = `molecules_transparent_${Date.now()}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
                status.textContent = 'PNG —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω (–±–µ–∑ —Ñ–æ–Ω–∞)';
            }
        });

        // –≠–ö–°–ü–û–†–¢: –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStartTime = null;
        let savedBackgroundSettings = null;

        document.getElementById('recordVideoBtn').addEventListener('click', async () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
                mediaRecorder.stop();

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ—Ç–∫–ª—é—á–µ–Ω
                if (savedBackgroundSettings) {
                    backgroundType = savedBackgroundSettings.bgType;
                    backgroundImage = savedBackgroundSettings.bgImage;
                    backgroundColor = savedBackgroundSettings.bgColor;
                    config.showVideo = savedBackgroundSettings.showVideo;
                    savedBackgroundSettings = null;
                    drawMetaballs();
                }
                return;
            }

            try {
                const withBackground = document.getElementById('exportWithBackground').checked;

                // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –±–µ–∑ —Ñ–æ–Ω–∞ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ—Ç–∫–ª—é—á–∞–µ–º —Ñ–æ–Ω
                if (!withBackground) {
                    savedBackgroundSettings = {
                        bgType: backgroundType,
                        bgImage: backgroundImage,
                        bgColor: backgroundColor,
                        showVideo: config.showVideo
                    };

                    backgroundType = 'transparent';
                    backgroundImage = null;
                    config.showVideo = false;
                    drawMetaballs();
                }

                // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å
                const stream = canvas.captureStream(60); // 60 FPS
                const options = { mimeType: 'video/webm;codecs=vp9' };

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ñ–æ—Ä–º–∞—Ç–∞
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm'; // fallback
                }

                mediaRecorder = new MediaRecorder(stream, options);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `molecules_animation_${Date.now()}.webm`;
                    link.click();
                    URL.revokeObjectURL(url);

                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ—Ç–∫–ª—é—á–µ–Ω
                    if (savedBackgroundSettings) {
                        backgroundType = savedBackgroundSettings.bgType;
                        backgroundImage = savedBackgroundSettings.bgImage;
                        backgroundColor = savedBackgroundSettings.bgColor;
                        config.showVideo = savedBackgroundSettings.showVideo;
                        savedBackgroundSettings = null;
                        drawMetaballs();
                    }

                    document.getElementById('recordBtnText').textContent = 'üé• –ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ (30 —Å–µ–∫)';
                    status.textContent = '–í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                };

                mediaRecorder.start();
                recordingStartTime = Date.now();
                document.getElementById('recordBtnText').textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
                status.textContent = withBackground ? '–ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ —Å —Ñ–æ–Ω–æ–º... (30 —Å–µ–∫)' : '–ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ –±–µ–∑ —Ñ–æ–Ω–∞... (30 —Å–µ–∫)';

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 30000);

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ:', err);
                status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ';

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                if (savedBackgroundSettings) {
                    backgroundType = savedBackgroundSettings.bgType;
                    backgroundImage = savedBackgroundSettings.bgImage;
                    backgroundColor = savedBackgroundSettings.bgColor;
                    config.showVideo = savedBackgroundSettings.showVideo;
                    savedBackgroundSettings = null;
                    drawMetaballs();
                }
            }
        });

        // UI —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π
        const gestureHint = document.getElementById('gestureHint');
        const controlsPanel = document.getElementById('controls');
        const toggleHintsBtn = document.getElementById('toggleHints');
        const toggleControlsBtn = document.getElementById('toggleControls');
        const closeHintsBtn = document.getElementById('closeHints');
        const closeControlsBtn = document.getElementById('closeControls');

        // –°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
        closeHintsBtn.addEventListener('click', () => {
            gestureHint.classList.add('minimized');
            toggleHintsBtn.classList.add('visible');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
        toggleHintsBtn.addEventListener('click', () => {
            gestureHint.classList.remove('minimized');
            toggleHintsBtn.classList.remove('visible');
        });

        // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        closeControlsBtn.addEventListener('click', () => {
            controlsPanel.classList.add('minimized');
            toggleControlsBtn.classList.add('visible');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        toggleControlsBtn.addEventListener('click', () => {
            controlsPanel.classList.remove('minimized');
            toggleControlsBtn.classList.remove('visible');
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö (—Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
        if (isMobile) {
            gestureHint.classList.add('minimized');
            toggleHintsBtn.classList.add('visible');
        }

        // === –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–ê–ù–ï–õ–ï–ô ===
        const colorPalette = document.getElementById('colorPalette');
        const togglePaletteBtn = document.getElementById('togglePalette');
        const closePaletteBtn = document.getElementById('closePalette');
        const virtualControls = document.getElementById('virtualControls');

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å –ø–∞–Ω–µ–ª–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        if (isMobile) {
            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            controlsPanel.classList.add('mobile-collapsed');
            toggleControlsBtn.classList.add('visible');

            // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–æ–Ω–∏ –Ω–µ—É–¥–æ–±–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∂–µ—Å—Ç—ã)
            virtualControls.style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–∞–ª–∏—Ç—Ä—ã —Ü–≤–µ—Ç–æ–≤
        function closePalette() {
            if (isMobile) {
                colorPalette.classList.add('mobile-collapsed');
                // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–∞–ª–∏—Ç—Ä—É
                togglePaletteBtn.textContent = 'üé®';
                togglePaletteBtn.title = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–ª–∏—Ç—Ä—É';
            } else {
                colorPalette.classList.remove('active');
            }
        }

        closePaletteBtn.addEventListener('click', closePalette);
        closePaletteBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            closePalette();
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–ª–∏—Ç—Ä—ã
        function togglePalette() {
            if (isMobile) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–ª–∏—Ç—Ä—ã
                const isCollapsed = colorPalette.classList.contains('mobile-collapsed');
                console.log('togglePalette: isCollapsed =', isCollapsed); // –û—Ç–ª–∞–¥–∫–∞
                if (isCollapsed) {
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É
                    colorPalette.classList.remove('mobile-collapsed');
                    // –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∏–¥–∏–º–æ–π, —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É
                    togglePaletteBtn.textContent = '‚ùå';
                    togglePaletteBtn.title = '–°–∫—Ä—ã—Ç—å –ø–∞–ª–∏—Ç—Ä—É';
                    console.log('Palette opened'); // –û—Ç–ª–∞–¥–∫–∞
                } else {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É
                    colorPalette.classList.add('mobile-collapsed');
                    // –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∏–¥–∏–º–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∫–æ–Ω–∫—É
                    togglePaletteBtn.textContent = 'üé®';
                    togglePaletteBtn.title = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–ª–∏—Ç—Ä—É';
                    console.log('Palette closed'); // –û—Ç–ª–∞–¥–∫–∞
                }
            } else {
                colorPalette.classList.add('active');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
        togglePaletteBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            togglePalette();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ touch –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö - –∏—Å–ø–æ–ª—å–∑—É–µ–º touchstart –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–∫—Ü–∏–∏
        togglePaletteBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('üñ±Ô∏è togglePalette touchstart fired!', {
                isMobile,
                paletteClasses: colorPalette.className,
                buttonClasses: togglePaletteBtn.className
            });
            togglePalette();
        }, { passive: false });

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ touchend –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        togglePaletteBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, { passive: false });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        const originalCloseControls = closeControlsBtn.onclick;
        closeControlsBtn.addEventListener('click', (e) => {
            if (isMobile) {
                controlsPanel.classList.add('mobile-collapsed');
                toggleControlsBtn.classList.add('visible');
            }
        });

        const originalToggleControls = toggleControlsBtn.onclick;
        toggleControlsBtn.addEventListener('click', (e) => {
            if (isMobile) {
                controlsPanel.classList.remove('mobile-collapsed');
                toggleControlsBtn.classList.remove('visible');
            }
        });

        // === –í–ò–†–¢–£–ê–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===
        let virtualMode = null; // 'create', 'delete', 'move', 'scale-up', 'scale-down'

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.virtual-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.dataset.action;

                // –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ —Ç–∞ –∂–µ –∫–Ω–æ–ø–∫–∞ - –æ—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
                if (virtualMode === action) {
                    virtualMode = null;
                    btn.classList.remove('selected');
                } else {
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                    document.querySelectorAll('.virtual-btn').forEach(b => b.classList.remove('selected'));

                    // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º
                    virtualMode = action;
                    btn.classList.add('selected');

                    // –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–ª–µ–∫—É–ª—ã - –¥–µ–ª–∞–µ–º —ç—Ç–æ —Å—Ä–∞–∑—É
                    if (action === 'create') {
                        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–æ–ª–µ–∫—É–ª –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                        if (molecules.length < maxMolecules) {
                            // –°–æ–∑–¥–∞—ë–º –º–æ–ª–µ–∫—É–ª—É –≤ —Ü–µ–Ω—Ç—Ä–µ —ç–∫—Ä–∞–Ω–∞
                            const centerX = width / 2;
                            const centerY = height / 2;
                            molecules.push(new Molecule(centerX, centerY, currentMolSize));
                            saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                        }

                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
                        setTimeout(() => {
                            virtualMode = null;
                            btn.classList.remove('selected');
                        }, 100);
                    }
                }
            });
        });

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
        let virtualSelectedMolecule = null;

        // === PAINT –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê - UI ===

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–ª–∏—Ç—Ä—ã —Ü–≤–µ—Ç–æ–≤
        function initColorPalette() {
            const colorGrid = document.getElementById('colorGrid');
            paintColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.background = color;
                swatch.dataset.color = color;

                swatch.addEventListener('click', (e) => {
                    primaryColor = color;
                    document.getElementById('primaryColor').style.background = color;

                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
                    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                });

                colorGrid.appendChild(swatch);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –º–æ–ª–µ–∫—É–ª—ã
            document.getElementById('customPrimaryColor').addEventListener('input', (e) => {
                primaryColor = e.target.value;
                document.getElementById('primaryColor').style.background = e.target.value;
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤ –ø–∞–ª–∏—Ç—Ä—ã
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–ª–∏—Ç—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            if (isMobile) {
                // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–ª–∏—Ç—Ä–∞ —Å–∫—Ä—ã—Ç–∞ (–±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞)
                colorPalette.classList.add('mobile-collapsed');
                console.log('üì± –ü–∞–ª–∏—Ç—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö (—Å–∫—Ä—ã—Ç–∞)');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
        function toggleEditorMode() {
            editorMode = !editorMode;

            const modeBtn = document.getElementById('modeToggleBtn');
            const modeIndicator = document.getElementById('modeIndicator');
            const paintToolbar = document.getElementById('paintToolbar');
            // colorPalette —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
            const controlsPanel = document.getElementById('controls');
            const gestureHint = document.getElementById('gestureHint');
            const gestureDebugCheckbox = document.getElementById('gestureDebugCheckbox');

            if (editorMode) {
                // –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                modeBtn.textContent = 'üëã –†–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤';

                modeIndicator.textContent = 'üé® –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞';
                modeIndicator.className = 'mode-indicator editor-mode active';

                paintToolbar.classList.add('active');

                // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–∞–ª–∏—Ç—Ä—ã, –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å—Ä–∞–∑—É
                if (isMobile) {
                    togglePaletteBtn.classList.add('visible');
                    colorPalette.classList.add('mobile-collapsed');
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–∫–æ–Ω–∫—É (–ø–∞–ª–∏—Ç—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∞)
                    togglePaletteBtn.textContent = 'üé®';
                    togglePaletteBtn.title = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–ª–∏—Ç—Ä—É';
                    console.log('üì± –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º:', {
                        buttonVisible: togglePaletteBtn.classList.contains('visible'),
                        paletteCollapsed: colorPalette.classList.contains('mobile-collapsed')
                    });
                } else {
                    colorPalette.classList.add('active');
                }

                // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∂–µ—Å—Ç–æ–≤, –ø–∞–Ω–µ–ª—å controls –æ—Å—Ç–∞–≤–ª—è–µ–º
                gestureHint.classList.add('minimized');

                // –°–∫—Ä—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å –æ—Ç–ª–∞–¥–∫–∏ –∂–µ—Å—Ç–æ–≤ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                gestureDebugCheckbox.style.display = 'none';

                // –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–ª–µ–∫—É–ª
                frozenMolecules = molecules.map(mol => ({
                    x: mol.x,
                    y: mol.y,
                    size: mol.size,
                    stretchX: mol.stretchX,
                    stretchY: mol.stretchY,
                    deformAngle: mol.deformAngle,
                    fillColor: mol.fillColor || null, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                    edgeColor: mol.edgeColor || null, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –∫–æ–Ω—Ç—É—Ä–∞
                    emboss: mol.emboss || false       // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Ç–∏—Å–Ω–µ–Ω–∏—è
                }));

                status.textContent = `–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ | –ú–æ–ª–µ–∫—É–ª: ${molecules.length}`;
            } else {
                // –í–æ–∑–≤—Ä–∞—Ç –≤ —Ä–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤
                modeBtn.textContent = 'üé® –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞';

                modeIndicator.textContent = 'üëã –†–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤';
                modeIndicator.className = 'mode-indicator gesture-mode active';

                paintToolbar.classList.remove('active');

                // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É –∏ –∫–Ω–æ–ø–∫—É –ø–∞–ª–∏—Ç—Ä—ã
                if (isMobile) {
                    colorPalette.classList.add('mobile-collapsed');
                    togglePaletteBtn.classList.remove('visible');

                    // –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Å–∫—Ä—ã—Ç—ã–º–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö (–æ–Ω–∏ –≤ –º–µ–Ω—é)
                    // virtualControls –æ—Å—Ç–∞–µ—Ç—Å—è display: none
                } else {
                    colorPalette.classList.remove('active');
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å –æ—Ç–ª–∞–¥–∫–∏ –∂–µ—Å—Ç–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –∂–µ—Å—Ç–æ–≤
                gestureDebugCheckbox.style.display = 'flex';

                selectedMolecule = null;

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ –∫ –º–æ–ª–µ–∫—É–ª–∞–º
                frozenMolecules.forEach((frozen, i) => {
                    if (molecules[i]) {
                        molecules[i].fillColor = frozen.fillColor;
                        molecules[i].edgeColor = frozen.edgeColor;
                        molecules[i].emboss = frozen.emboss;
                    }
                });

                status.textContent = '–†–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤ | –ì–æ—Ç–æ–≤';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
        document.getElementById('modeToggleBtn').addEventListener('click', toggleEditorMode);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ–∫–±–æ–∫—Å–∞ –æ—Ç–ª–∞–¥–∫–∏ –∂–µ—Å—Ç–æ–≤
        document.getElementById('showGestureDebug').addEventListener('change', (e) => {
            showGestureDebug = e.target.checked;
        });

        // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        function selectTool(toolElement) {
            document.querySelectorAll('.paint-tool').forEach(t => t.classList.remove('selected'));
            toolElement.classList.add('selected');
            currentTool = toolElement.dataset.tool;

            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Ä–µ–∂–∏–º–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            const fillModeLabel = document.getElementById('fillModeLabel');
            const pencilToolLabel = document.getElementById('pencilToolLabel');
            const smartEraserCheckbox = document.getElementById('smartEraserCheckbox');

            if (currentTool === 'eraser') {
                fillModeLabel.textContent = '–†–µ–∂–∏–º –ª–∞—Å—Ç–∏–∫–∞:';
                pencilToolLabel.textContent = '–õ–∞—Å—Ç–∏–∫:';
                smartEraserCheckbox.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å —É–º–Ω–æ–≥–æ –ª–∞—Å—Ç–∏–∫–∞
            } else if (currentTool === 'fill') {
                fillModeLabel.textContent = '–†–µ–∂–∏–º –∑–∞–ª–∏–≤–∫–∏:';
                pencilToolLabel.textContent = '–ö–∞—Ä–∞–Ω–¥–∞—à:';
                smartEraserCheckbox.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å
            } else if (currentTool === 'pencil') {
                fillModeLabel.textContent = '–†–µ–∂–∏–º –∑–∞–ª–∏–≤–∫–∏:';
                pencilToolLabel.textContent = '–ö–∞—Ä–∞–Ω–¥–∞—à:';
                smartEraserCheckbox.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å
            } else {
                fillModeLabel.textContent = '–†–µ–∂–∏–º –∑–∞–ª–∏–≤–∫–∏:';
                pencilToolLabel.textContent = '–ö–∞—Ä–∞–Ω–¥–∞—à:';
                smartEraserCheckbox.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∏–∫–∞ –∏ —Ç–∞—á–∞)
        document.querySelectorAll('.paint-tool').forEach(tool => {
            // Click –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
            tool.addEventListener('click', () => {
                selectTool(tool);
            });

            // Touch –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            tool.addEventListener('touchend', (e) => {
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–≤–æ–π–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ
                selectTool(tool);
            });
        });

        // –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∑–∞–ª–∏–≤–∫–∏/–ª–∞—Å—Ç–∏–∫–∞
        document.querySelectorAll('.fill-mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –±–µ–∑ data-mode (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–Ω–æ–ø–∫–∏ —Ñ–æ–Ω–∞)
                if (!btn.dataset.mode) return;

                document.querySelectorAll('.fill-mode-btn').forEach(b => {
                    if (b.dataset.mode) b.classList.remove('active');
                });
                btn.classList.add('active');
                fillMode = btn.dataset.mode;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                const modeLabel = currentTool === 'eraser' ? '–†–µ–∂–∏–º –ª–∞—Å—Ç–∏–∫–∞' : '–†–µ–∂–∏–º –∑–∞–ª–∏–≤–∫–∏';
                status.textContent = `${modeLabel}: ${btn.textContent}`;
            });
        });

        // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞
        document.getElementById('bgColorPicker').addEventListener('input', (e) => {
            backgroundColor = e.target.value;
            backgroundType = 'color';
            backgroundImage = null;
            backgroundCacheValid = false; // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞
            document.getElementById('bgPreview').textContent = `–¶–≤–µ—Ç: ${backgroundColor}`;
            status.textContent = `–§–æ–Ω: —Ü–≤–µ—Ç ${backgroundColor}`;
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Ñ–æ–Ω–∞
        document.getElementById('bgFilePicker').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            const fileType = file.type;

            if (fileType.startsWith('image/')) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const img = new Image();
                img.onload = () => {
                    backgroundImage = img;
                    backgroundType = 'image';
                    backgroundCacheValid = false; // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞
                    document.getElementById('bgPreview').textContent = `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${file.name}`;
                    status.textContent = `–§–æ–Ω: ${file.name}`;
                };
                img.src = url;
            } else if (fileType.startsWith('video/')) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ
                const video = document.createElement('video');
                video.src = url;
                video.loop = true;
                video.muted = true;
                video.playsInline = true;
                video.play().then(() => {
                    backgroundImage = video;
                    backgroundType = 'video';
                    document.getElementById('bgPreview').textContent = `–í–∏–¥–µ–æ: ${file.name}`;
                    status.textContent = `–§–æ–Ω: ${file.name}`;
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', err);
                    status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ';
                });
            }
        });

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ–Ω–∞
        document.getElementById('bgClearBtn').addEventListener('click', () => {
            backgroundColor = '#ffffff';
            backgroundImage = null;
            backgroundType = 'color';
            backgroundCacheValid = false; // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞
            document.getElementById('bgColorPicker').value = '#ffffff';
            document.getElementById('bgPreview').textContent = '';
            status.textContent = '–§–æ–Ω –æ—á–∏—â–µ–Ω (–±–µ–ª—ã–π)';
        });

        // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∏–∫—Ä–æ–ø–æ–ª–æ—Å–æ–∫
        document.getElementById('microStripesEffect').addEventListener('change', (e) => {
            const settings = document.getElementById('microStripesSettings');
            settings.style.display = e.target.checked ? 'flex' : 'none';
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã –ø–æ–ª–æ—Å–æ–∫
        document.getElementById('stripeWidth').addEventListener('input', (e) => {
            document.getElementById('stripeWidthValue').textContent = e.target.value;
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—â–∏–Ω—ã –∫–∞—Ä–∞–Ω–¥–∞—à–∞
        document.getElementById('pencilWidth').addEventListener('input', (e) => {
            pencilWidth = parseInt(e.target.value);
            document.getElementById('pencilWidthValue').textContent = e.target.value;
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —É–º–Ω–æ–≥–æ –ª–∞—Å—Ç–∏–∫–∞
        document.getElementById('smartEraser').addEventListener('change', (e) => {
            smartEraserMode = e.target.checked;
            status.textContent = smartEraserMode ? '‚ú® –£–º–Ω—ã–π –ª–∞—Å—Ç–∏–∫: –∫–ª–∏–∫ —É–¥–∞–ª—è–µ—Ç –æ–±–ª–∞—Å—Ç—å —Ü–µ–ª–∏–∫–æ–º' : '–û–±—ã—á–Ω—ã–π –ª–∞—Å—Ç–∏–∫: —Å—Ç–∏—Ä–∞–µ—Ç —á–∞—Å—Ç—è–º–∏';
        });

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ä–∏—Å—É–Ω–∫–æ–≤ –∫–∞—Ä–∞–Ω–¥–∞—à–æ–º
        document.getElementById('clearDrawings').addEventListener('click', () => {
            if (drawnStrokes.length > 0 || filledRegions.length > 0 || backgroundFills.length > 0) {
                if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏ –∏ –∑–∞–ª–∏—Ç—ã–µ –æ–±–ª–∞—Å—Ç–∏?')) {
                    drawnStrokes = [];
                    filledRegions = [];
                    backgroundFills = [];
                    status.textContent = '–í—Å–µ —Ä–∏—Å—É–Ω–∫–∏ —É–¥–∞–ª–µ–Ω—ã';
                }
            } else {
                status.textContent = '–ù–µ—Ç —Ä–∏—Å—É–Ω–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è';
            }
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª–æ—Å–∫–∞–º–∏
        document.getElementById('stripeSpacing').addEventListener('input', (e) => {
            document.getElementById('stripeSpacingValue').textContent = e.target.value;
        });

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø–∞–ª–∏—Ç—Ä—ã —Ü–≤–µ—Ç–æ–≤
        (function() {
            const palette = document.getElementById('colorPalette');
            const handle = document.getElementById('paletteHandle');
            let isDragging = false;
            let offsetX = 0;
            let offsetY = 0;

            handle.addEventListener('mousedown', (e) => {
                isDragging = true;
                const rect = palette.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                palette.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
                let newLeft = e.clientX - offsetX;
                let newTop = e.clientY - offsetY;

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–∫–Ω–∞
                const paletteRect = palette.getBoundingClientRect();
                const maxLeft = window.innerWidth - paletteRect.width;
                const maxTop = window.innerHeight - paletteRect.height;

                newLeft = Math.max(0, Math.min(newLeft, maxLeft));
                newTop = Math.max(0, Math.min(newTop, maxTop));

                // –£–±–∏—Ä–∞–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                palette.style.left = newLeft + 'px';
                palette.style.top = newTop + 'px';
                palette.style.bottom = 'auto';
                palette.style.transform = 'none';
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    palette.style.cursor = '';
                }
            });
        })();

        // –î–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ - –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        canvas.addEventListener('mousemove', (e) => {
            if (!editorMode) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;

            // –ù–∞—Ö–æ–¥–∏–º –º–æ–ª–µ–∫—É–ª—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
            hoveredMoleculeEditor = null;
            for (let i = molecules.length - 1; i >= 0; i--) {
                const mol = molecules[i];
                const dx = mouseX - mol.x;
                const dy = mouseY - mol.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < mol.size) {
                    hoveredMoleculeEditor = mol;
                    break;
                }
            }

            // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
            if (currentTool === 'fill' || currentTool === 'eraser') {
                canvas.style.cursor = hoveredMoleculeEditor ? 'pointer' : 'crosshair';
            } else if (currentTool === 'select') {
                canvas.style.cursor = hoveredMoleculeEditor ? 'pointer' : 'default';
            }
        });

        // –ö–ª–∏–∫ –Ω–∞ canvas –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        canvas.addEventListener('click', (e) => {
            if (!editorMode) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clickX = (e.clientX - rect.left) * scaleX;
            const clickY = (e.clientY - rect.top) * scaleY;

            // –ù–∞—Ö–æ–¥–∏–º –º–æ–ª–µ–∫—É–ª—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º hoveredMoleculeEditor –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏)
            let clickedMolecule = hoveredMoleculeEditor;

            if (currentTool === 'select') {
                selectedMolecule = clickedMolecule;
                status.textContent = clickedMolecule ?
                    `–í—ã–±—Ä–∞–Ω–∞ –º–æ–ª–µ–∫—É–ª–∞ (${clickedMolecule.size.toFixed(0)}px)` :
                    '–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–ª–µ–∫—É–ª—ã';
            } else if (currentTool === 'fill' && clickedMolecule) {
                // –ó–∞–ª–∏–≤–∫–∞ —Ü–≤–µ—Ç–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (fillMode === 'interior' || fillMode === 'both') {
                    clickedMolecule.fillColor = primaryColor;
                }
                if (fillMode === 'edge' || fillMode === 'both') {
                    clickedMolecule.edgeColor = primaryColor;
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã
                const embossCheckbox = document.getElementById('embossEffect');
                const microStripesCheckbox = document.getElementById('microStripesEffect');
                clickedMolecule.emboss = embossCheckbox.checked;
                clickedMolecule.microStripes = microStripesCheckbox.checked;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ–ø–æ–ª–æ—Å–æ–∫ –µ—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –≤–∫–ª—é—á–µ–Ω
                if (clickedMolecule.microStripes) {
                    clickedMolecule.stripeColor1 = document.getElementById('stripeColor1').value;
                    clickedMolecule.stripeColor2 = document.getElementById('stripeColor2').value;
                    clickedMolecule.stripeWidth = parseInt(document.getElementById('stripeWidth').value);
                    clickedMolecule.stripeSpacing = parseInt(document.getElementById('stripeSpacing').value);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const molIndex = molecules.indexOf(clickedMolecule);
                if (frozenMolecules[molIndex]) {
                    if (fillMode === 'interior' || fillMode === 'both') {
                        frozenMolecules[molIndex].fillColor = primaryColor;
                    }
                    if (fillMode === 'edge' || fillMode === 'both') {
                        frozenMolecules[molIndex].edgeColor = primaryColor;
                    }
                    frozenMolecules[molIndex].emboss = clickedMolecule.emboss;
                    frozenMolecules[molIndex].microStripes = clickedMolecule.microStripes;
                    frozenMolecules[molIndex].stripeColor1 = clickedMolecule.stripeColor1;
                    frozenMolecules[molIndex].stripeColor2 = clickedMolecule.stripeColor2;
                    frozenMolecules[molIndex].stripeWidth = clickedMolecule.stripeWidth;
                    frozenMolecules[molIndex].stripeSpacing = clickedMolecule.stripeSpacing;
                }

                const modeText = fillMode === 'interior' ? '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å' :
                                 fillMode === 'edge' ? '–∫–æ–Ω—Ç—É—Ä' : '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å+–∫–æ–Ω—Ç—É—Ä';
                const effectsText = [];
                if (clickedMolecule.emboss) effectsText.push('—Ç–∏—Å–Ω–µ–Ω–∏–µ');
                if (clickedMolecule.microStripes) effectsText.push('–ø–æ–ª–æ—Å–∫–∏');
                const effectsSuffix = effectsText.length > 0 ? ' + ' + effectsText.join(' + ') : '';
                status.textContent = `–ó–∞–ª–∏—Ç–æ ${modeText} —Ü–≤–µ—Ç–æ–º ${primaryColor}${effectsSuffix}`;
                saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
            } else if (currentTool === 'fill' && !clickedMolecule) {
                // –ó–∞–ª–∏–≤–∫–∞ –æ–±–ª–∞—Å—Ç–µ–π, –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞—Ä–∞–Ω–¥–∞—à–æ–º (flood fill)
                const fillResult = floodFillStrokes(clickX, clickY, primaryColor);
                if (fillResult === 'too_large') {
                    status.textContent = '‚ö†Ô∏è –û–±–ª–∞—Å—Ç—å —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è! –ù–∞—Ä–∏—Å—É–π—Ç–µ –∑–∞–º–∫–Ω—É—Ç—É—é —Ñ–∏–≥—É—Ä—É –∫–∞—Ä–∞–Ω–¥–∞—à–æ–º';
                } else if (fillResult) {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º - —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–ª–∏–≤–∫–∞ –∏–ª–∏ –æ–±—ã—á–Ω–∞—è
                    const fillArea = fillResult.width * fillResult.height;
                    const canvasArea = canvas.width * canvas.height;
                    const areaRatio = fillArea / canvasArea;

                    // –ï—Å–ª–∏ –∑–∞–ª–∏–≤–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª–µ–µ 30% —ç–∫—Ä–∞–Ω–∞ - —ç—Ç–æ —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–ª–∏–≤–∫–∞
                    const isBackground = areaRatio > 0.3;

                    if (isBackground) {
                        backgroundFills.push(fillResult);
                        status.textContent = `üñºÔ∏è –§–æ–Ω –∑–∞–ª–∏—Ç —Ü–≤–µ—Ç–æ–º ${primaryColor}`;
                        saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                    } else {
                        filledRegions.push(fillResult);
                        status.textContent = `ü™£ –ó–∞–ª–∏—Ç–æ ${fillArea} –ø–∏–∫—Å–µ–ª–µ–π —Ü–≤–µ—Ç–æ–º ${primaryColor}`;
                        saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                    }
                } else {
                    status.textContent = '–ù–µ—á–µ–≥–æ –∑–∞–ª–∏–≤–∞—Ç—å (–∫–ª–∏–∫–Ω–∏—Ç–µ –≤–Ω—É—Ç—Ä–∏ –∑–∞–º–∫–Ω—É—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏)';
                }
            } else if (currentTool === 'eraser' && clickedMolecule) {
                // –õ–∞—Å—Ç–∏–∫ —É–¥–∞–ª—è–µ—Ç –∑–∞–ª–∏–≤–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (fillMode === 'interior' || fillMode === 'both') {
                    clickedMolecule.fillColor = null;
                }
                if (fillMode === 'edge' || fillMode === 'both') {
                    clickedMolecule.edgeColor = null;
                }
                clickedMolecule.emboss = false; // –£–±–∏—Ä–∞–µ–º —Ç–∏—Å–Ω–µ–Ω–∏–µ
                clickedMolecule.microStripes = false; // –£–±–∏—Ä–∞–µ–º –ø–æ–ª–æ—Å–∫–∏

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const molIndex = molecules.indexOf(clickedMolecule);
                if (frozenMolecules[molIndex]) {
                    if (fillMode === 'interior' || fillMode === 'both') {
                        frozenMolecules[molIndex].fillColor = null;
                    }
                    if (fillMode === 'edge' || fillMode === 'both') {
                        frozenMolecules[molIndex].edgeColor = null;
                    }
                    frozenMolecules[molIndex].emboss = false;
                    frozenMolecules[molIndex].microStripes = false;
                }

                const modeText = fillMode === 'interior' ? '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å' :
                                 fillMode === 'edge' ? '–∫–æ–Ω—Ç—É—Ä' : '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å+–∫–æ–Ω—Ç—É—Ä';
                status.textContent = `–°—Ç—ë—Ä—Ç–æ ${modeText}`;
                saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Ç–æ—á–∫–∏ —Å –ª–∏–Ω–∏–µ–π (–¥–ª—è –ª–∞—Å—Ç–∏–∫–∞)
        function distanceToLineSegment(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;

            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;

            if (lenSq != 0) param = dot / lenSq;

            let xx, yy;

            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }

            const dx = px - xx;
            const dy = py - yy;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–ª–∏–≤–∫–∏ –æ–±–ª–∞—Å—Ç–∏ (flood fill) - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–ª–æ–µ
        function floodFillStrokes(startX, startY, fillColor) {
            // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ —à—Ç—Ä–∏—Ö–æ–≤
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');

            // –†–∏—Å—É–µ–º –≤—Å–µ —à—Ç—Ä–∏—Ö–∏ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–º canvas
            for (const stroke of drawnStrokes) {
                if (stroke.points.length < 2) continue;
                tempCtx.strokeStyle = stroke.color;
                tempCtx.lineWidth = stroke.width;
                tempCtx.lineCap = 'round';
                tempCtx.lineJoin = 'round';
                tempCtx.beginPath();
                tempCtx.moveTo(stroke.points[0].x, stroke.points[0].y);
                for (let i = 1; i < stroke.points.length; i++) {
                    tempCtx.lineTo(stroke.points[i].x, stroke.points[i].y);
                }
                tempCtx.stroke();
            }

            // –ü–æ–ª—É—á–∞–µ–º imageData
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const pixels = imageData.data;
            const width = tempCanvas.width;
            const height = tempCanvas.height;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ø–∏—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ imageData –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —à—Ç—Ä–∏—Ö–æ–≤
            const originalPixels = new Uint8ClampedArray(pixels);

            startX = Math.floor(startX);
            startY = Math.floor(startY);

            if (startX < 0 || startX >= width || startY < 0 || startY >= height) {
                return null;
            }

            const startIndex = (startY * width + startX) * 4;
            const startR = pixels[startIndex];
            const startG = pixels[startIndex + 1];
            const startB = pixels[startIndex + 2];
            const startA = pixels[startIndex + 3];

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ü–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –≤ RGB
            const colorCanvas = document.createElement('canvas');
            colorCanvas.width = 1;
            colorCanvas.height = 1;
            const colorCtx = colorCanvas.getContext('2d');
            colorCtx.fillStyle = fillColor;
            colorCtx.fillRect(0, 0, 1, 1);
            const colorData = colorCtx.getImageData(0, 0, 1, 1).data;
            const fillR = colorData[0];
            const fillG = colorData[1];
            const fillB = colorData[2];
            const fillA = 255;

            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —à—Ç—Ä–∏—Ö (–Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –ø–∏–∫—Å–µ–ª—å), –Ω–µ –∑–∞–ª–∏–≤–∞–µ–º
            if (startA !== 0) {
                return null;
            }

            const stack = [[startX, startY]];
            const visited = new Set();
            let minX = startX, maxX = startX, minY = startY, maxY = startY;

            function matchesStart(index) {
                return pixels[index] === startR &&
                       pixels[index + 1] === startG &&
                       pixels[index + 2] === startB &&
                       pixels[index + 3] === startA;
            }

            const MAX_FILL_AREA = 2000000; // –ú–∞–∫—Å–∏–º—É–º 2 –º–∏–ª–ª–∏–æ–Ω–∞ –ø–∏–∫—Å–µ–ª–µ–π (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∏–≥—É—Ä)

            while (stack.length > 0) {
                const [x, y] = stack.pop();
                const key = `${x},${y}`;

                if (visited.has(key)) continue;
                if (x < 0 || x >= width || y < 0 || y >= height) continue;

                const index = (y * width + x) * 4;

                if (!matchesStart(index)) continue;

                visited.add(key);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –æ–±–ª–∞—Å—Ç–∏ - –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è, –æ—Ç–º–µ–Ω—è–µ–º –∑–∞–ª–∏–≤–∫—É
                if (visited.size > MAX_FILL_AREA) {
                    return 'too_large';
                }

                // –ó–∞–ª–∏–≤–∞–µ–º –ø–∏–∫—Å–µ–ª—å
                pixels[index] = fillR;
                pixels[index + 1] = fillG;
                pixels[index + 2] = fillB;
                pixels[index + 3] = fillA;

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
                minX = Math.min(minX, x);
                maxX = Math.max(maxX, x);
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å–µ–¥–µ–π
                stack.push([x + 1, y]);
                stack.push([x - 1, y]);
                stack.push([x, y + 1]);
                stack.push([x, y - 1]);
            }

            if (visited.size === 0) return null;

            // –°–æ–∑–¥–∞—ë–º –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π imageData —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–ª–∏—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏
            const fillWidth = maxX - minX + 1;
            const fillHeight = maxY - minY + 1;
            const fillImageData = tempCtx.createImageData(fillWidth, fillHeight);

            for (let y = minY; y <= maxY; y++) {
                for (let x = minX; x <= maxX; x++) {
                    const srcIndex = (y * width + x) * 4;
                    const dstIndex = ((y - minY) * fillWidth + (x - minX)) * 4;

                    // –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–∏–∫—Å–µ–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏ (–ù–ï —à—Ç—Ä–∏—Ö–∏)
                    // –ï—Å–ª–∏ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ –ø–∏–∫—Å–µ–ª—å –±—ã–ª –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º (—à—Ç—Ä–∏—Ö), –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º
                    if (originalPixels[srcIndex + 3] === 0) {
                        fillImageData.data[dstIndex] = pixels[srcIndex];
                        fillImageData.data[dstIndex + 1] = pixels[srcIndex + 1];
                        fillImageData.data[dstIndex + 2] = pixels[srcIndex + 2];
                        fillImageData.data[dstIndex + 3] = pixels[srcIndex + 3];
                    } else {
                        // –®—Ç—Ä–∏—Ö - –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º
                        fillImageData.data[dstIndex] = 0;
                        fillImageData.data[dstIndex + 1] = 0;
                        fillImageData.data[dstIndex + 2] = 0;
                        fillImageData.data[dstIndex + 3] = 0;
                    }
                }
            }

            return {
                imageData: fillImageData,
                x: minX,
                y: minY,
                width: fillWidth,
                height: fillHeight
            };
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º—ã—à–∏ –¥–ª—è –∫–∞—Ä–∞–Ω–¥–∞—à–∞ –∏ –ª–∞—Å—Ç–∏–∫–∞
        canvas.addEventListener('mousedown', (e) => {
            if (!editorMode) return;
            if (currentTool !== 'pencil' && currentTool !== 'eraser') return;

            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (currentTool === 'pencil') {
                // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —à—Ç—Ä–∏—Ö
                currentStroke = {
                    points: [{x, y}],
                    color: primaryColor,
                    width: pencilWidth
                };
            } else if (currentTool === 'eraser') {
                if (smartEraserMode) {
                    // ‚ú® –£–ú–ù–´–ô –õ–ê–°–¢–ò–ö: —É–¥–∞–ª—è–µ—Ç —Ü–µ–ª–∏–∫–æ–º –ø–æ –æ–¥–Ω–æ–º—É –∫–ª–∏–∫—É
                    let deletedSomething = false;

                    // –£–¥–∞–ª—è–µ–º —à—Ç—Ä–∏—Ö —Ü–µ–ª–∏–∫–æ–º (–µ—Å–ª–∏ —Ä–µ–∂–∏–º edge –∏–ª–∏ both)
                    if (fillMode === 'edge' || fillMode === 'both') {
                        const initialLength = drawnStrokes.length;
                        drawnStrokes = drawnStrokes.filter(stroke => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –∫–ª–∏–∫ –Ω–∞ —ç—Ç–æ—Ç —à—Ç—Ä–∏—Ö
                            for (const point of stroke.points) {
                                const dist = Math.sqrt((point.x - x) ** 2 + (point.y - y) ** 2);
                                if (dist < stroke.width * 2) {
                                    return false; // –£–¥–∞–ª—è–µ–º –≤–µ—Å—å —à—Ç—Ä–∏—Ö —Ü–µ–ª–∏–∫–æ–º
                                }
                            }
                            return true;
                        });
                        if (drawnStrokes.length < initialLength) {
                            deletedSomething = true;
                            status.textContent = 'üóëÔ∏è –ö–æ–Ω—Ç—É—Ä —É–¥–∞–ª–µ–Ω';
                        }
                    }

                    // –£–¥–∞–ª—è–µ–º –∑–∞–ª–∏—Ç—É—é –æ–±–ª–∞—Å—Ç—å —Ü–µ–ª–∏–∫–æ–º (–µ—Å–ª–∏ —Ä–µ–∂–∏–º interior –∏–ª–∏ both)
                    if (fillMode === 'interior' || fillMode === 'both') {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ã—á–Ω—ã–µ –∑–∞–ª–∏–≤–∫–∏
                        const initialLength = filledRegions.length;
                        filledRegions = filledRegions.filter(region => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –∫–ª–∏–∫ –≤ —ç—Ç—É –æ–±–ª–∞—Å—Ç—å
                            if (x >= region.x && x < region.x + region.width &&
                                y >= region.y && y < region.y + region.height) {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –ª–∏ –ø–∏–∫—Å–µ–ª—å –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
                                const px = Math.floor(x - region.x);
                                const py = Math.floor(y - region.y);
                                const idx = (py * region.width + px) * 4;
                                const alpha = region.imageData.data[idx + 3];
                                if (alpha > 0) {
                                    return false; // –£–¥–∞–ª—è–µ–º –≤—Å—é –æ–±–ª–∞—Å—Ç—å —Ü–µ–ª–∏–∫–æ–º
                                }
                            }
                            return true;
                        });

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–ª–∏–≤–∫–∏
                        const initialBgLength = backgroundFills.length;
                        backgroundFills = backgroundFills.filter(region => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –∫–ª–∏–∫ –≤ —ç—Ç—É –æ–±–ª–∞—Å—Ç—å
                            if (x >= region.x && x < region.x + region.width &&
                                y >= region.y && y < region.y + region.height) {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –ª–∏ –ø–∏–∫—Å–µ–ª—å –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
                                const px = Math.floor(x - region.x);
                                const py = Math.floor(y - region.y);
                                const idx = (py * region.width + px) * 4;
                                const alpha = region.imageData.data[idx + 3];
                                if (alpha > 0) {
                                    return false; // –£–¥–∞–ª—è–µ–º –≤—Å—é –æ–±–ª–∞—Å—Ç—å —Ü–µ–ª–∏–∫–æ–º
                                }
                            }
                            return true;
                        });

                        if (filledRegions.length < initialLength || backgroundFills.length < initialBgLength) {
                            deletedSomething = true;
                            status.textContent = 'üóëÔ∏è –ó–∞–ª–∏–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞';
                        }
                    }

                    if (!deletedSomething) {
                        status.textContent = '–ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å (–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–æ–Ω—Ç—É—Ä –∏–ª–∏ –∑–∞–ª–∏–≤–∫—É)';
                    }
                } else {
                    // –û–ë–´–ß–ù–´–ô –õ–ê–°–¢–ò–ö: —Å—Ç–∏—Ä–∞–µ—Ç —á–∞—Å—Ç—è–º–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
                    const eraserSize = pencilWidth * 2; // –õ–∞—Å—Ç–∏–∫ –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –∫–∞—Ä–∞–Ω–¥–∞—à–∞

                    // –°—Ç–∏—Ä–∞–µ–º —à—Ç—Ä–∏—Ö–∏ –ø–æ–¥ –ª–∞—Å—Ç–∏–∫–æ–º (–µ—Å–ª–∏ —Ä–µ–∂–∏–º edge –∏–ª–∏ both)
                    if (fillMode === 'edge' || fillMode === 'both') {
                        drawnStrokes = drawnStrokes.filter(stroke => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Ç–æ—á–∫—É —à—Ç—Ä–∏—Ö–∞
                            for (const point of stroke.points) {
                                const dist = Math.sqrt((point.x - x) ** 2 + (point.y - y) ** 2);
                                if (dist < eraserSize) {
                                    return false; // –£–¥–∞–ª—è–µ–º —ç—Ç–æ—Ç —à—Ç—Ä–∏—Ö
                                }
                            }
                            return true;
                        });
                    }

                    // –°—Ç–∏—Ä–∞–µ–º –∑–∞–ª–∏—Ç—ã–µ –æ–±–ª–∞—Å—Ç–∏ (–µ—Å–ª–∏ —Ä–µ–∂–∏–º interior –∏–ª–∏ both)
                    if (fillMode === 'interior' || fillMode === 'both') {
                        for (const region of filledRegions) {
                            if (x >= region.x && x < region.x + region.width &&
                                y >= region.y && y < region.y + region.height) {
                                // –°—Ç–∏—Ä–∞–µ–º –∫—Ä—É–≥ –≤ imageData
                                const pixels = region.imageData.data;
                                for (let dy = -eraserSize; dy <= eraserSize; dy++) {
                                    for (let dx = -eraserSize; dx <= eraserSize; dx++) {
                                        const dist = Math.sqrt(dx * dx + dy * dy);
                                        if (dist <= eraserSize) {
                                            const px = Math.floor(x - region.x + dx);
                                            const py = Math.floor(y - region.y + dy);
                                            if (px >= 0 && px < region.width && py >= 0 && py < region.height) {
                                                const idx = (py * region.width + px) * 4;
                                                pixels[idx + 3] = 0; // –î–µ–ª–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!editorMode) return;
            if (currentTool !== 'pencil' && currentTool !== 'eraser') return;
            if (!isDrawing) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (currentTool === 'pencil') {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –∫ —Ç–µ–∫—É—â–µ–º—É —à—Ç—Ä–∏—Ö—É
                currentStroke.points.push({x, y});
            } else if (currentTool === 'eraser' && !smartEraserMode) {
                // –û–±—ã—á–Ω—ã–π –ª–∞—Å—Ç–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ (—É–º–Ω—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É)
                const eraserSize = pencilWidth * 2;

                // –°—Ç–∏—Ä–∞–µ–º —à—Ç—Ä–∏—Ö–∏ –ø–æ–¥ –ª–∞—Å—Ç–∏–∫–æ–º (–µ—Å–ª–∏ —Ä–µ–∂–∏–º edge –∏–ª–∏ both)
                if (fillMode === 'edge' || fillMode === 'both') {
                    drawnStrokes = drawnStrokes.filter(stroke => {
                        for (let i = 0; i < stroke.points.length; i++) {
                            const point = stroke.points[i];
                            const dist = Math.sqrt((point.x - x) ** 2 + (point.y - y) ** 2);
                            if (dist < eraserSize) {
                                return false;
                            }
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–∫–∂–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å –ª–∏–Ω–∏–µ–π –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
                            if (i > 0) {
                                const prevPoint = stroke.points[i - 1];
                                const lineDist = distanceToLineSegment(x, y, prevPoint.x, prevPoint.y, point.x, point.y);
                                if (lineDist < eraserSize) {
                                    return false;
                                }
                            }
                        }
                        return true;
                    });
                }

                // –°—Ç–∏—Ä–∞–µ–º –∑–∞–ª–∏—Ç—ã–µ –æ–±–ª–∞—Å—Ç–∏ (–µ—Å–ª–∏ —Ä–µ–∂–∏–º interior –∏–ª–∏ both)
                if (fillMode === 'interior' || fillMode === 'both') {
                    // –°—Ç–∏—Ä–∞–µ–º –æ–±—ã—á–Ω—ã–µ –∑–∞–ª–∏–≤–∫–∏
                    for (const region of filledRegions) {
                        if (x >= region.x && x < region.x + region.width &&
                            y >= region.y && y < region.y + region.height) {
                            // –°—Ç–∏—Ä–∞–µ–º –∫—Ä—É–≥ –≤ imageData
                            const pixels = region.imageData.data;
                            for (let dy = -eraserSize; dy <= eraserSize; dy++) {
                                for (let dx = -eraserSize; dx <= eraserSize; dx++) {
                                    const dist = Math.sqrt(dx * dx + dy * dy);
                                    if (dist <= eraserSize) {
                                        const px = Math.floor(x - region.x + dx);
                                        const py = Math.floor(y - region.y + dy);
                                        if (px >= 0 && px < region.width && py >= 0 && py < region.height) {
                                            const idx = (py * region.width + px) * 4;
                                            pixels[idx + 3] = 0; // –î–µ–ª–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // –°—Ç–∏—Ä–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–ª–∏–≤–∫–∏
                    for (const region of backgroundFills) {
                        if (x >= region.x && x < region.x + region.width &&
                            y >= region.y && y < region.y + region.height) {
                            // –°—Ç–∏—Ä–∞–µ–º –∫—Ä—É–≥ –≤ imageData
                            const pixels = region.imageData.data;
                            for (let dy = -eraserSize; dy <= eraserSize; dy++) {
                                for (let dx = -eraserSize; dx <= eraserSize; dx++) {
                                    const dist = Math.sqrt(dx * dx + dy * dy);
                                    if (dist <= eraserSize) {
                                        const px = Math.floor(x - region.x + dx);
                                        const py = Math.floor(y - region.y + dy);
                                        if (px >= 0 && px < region.width && py >= 0 && py < region.height) {
                                            const idx = (py * region.width + px) * 4;
                                            pixels[idx + 3] = 0; // –î–µ–ª–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                status.textContent = `–®—Ç—Ä–∏—Ö–æ–≤: ${drawnStrokes.length}, –û–±–ª–∞—Å—Ç–µ–π: ${filledRegions.length}`;
            }
        });

        // –õ–æ–∫–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mouseup –Ω–∞ canvas
        canvas.addEventListener('mouseup', () => {
            if (!editorMode) return;
            if (currentTool !== 'pencil' && currentTool !== 'eraser') return;
            if (!isDrawing) return;

            isDrawing = false;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —à—Ç—Ä–∏—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ä–∞–Ω–¥–∞—à–∞)
            if (currentTool === 'pencil') {
                if (currentStroke && currentStroke.points.length > 1) {
                    drawnStrokes.push(currentStroke);
                    status.textContent = `–ù–∞—Ä–∏—Å–æ–≤–∞–Ω–æ ${drawnStrokes.length} —à—Ç—Ä–∏—Ö–æ–≤`;
                    saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                }
                currentStroke = null;
            } else if (currentTool === 'eraser') {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —Å—Ç–∏—Ä–∞–Ω–∏—è
                saveState();
            }
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mouseup - –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—É—â–µ–Ω–∞ –≤–Ω–µ canvas
        document.addEventListener('mouseup', () => {
            if (!editorMode) return;
            if (currentTool !== 'pencil' && currentTool !== 'eraser') return;
            if (!isDrawing) return;

            isDrawing = false;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —à—Ç—Ä–∏—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ä–∞–Ω–¥–∞—à–∞)
            if (currentTool === 'pencil') {
                if (currentStroke && currentStroke.points.length > 1) {
                    drawnStrokes.push(currentStroke);
                    status.textContent = `–ù–∞—Ä–∏—Å–æ–≤–∞–Ω–æ ${drawnStrokes.length} —à—Ç—Ä–∏—Ö–æ–≤`;
                    saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                }
                currentStroke = null;
            } else if (currentTool === 'eraser') {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —Å—Ç–∏—Ä–∞–Ω–∏—è
                saveState();
            }
        });

        // === –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–õ–ê–í–ò–ê–¢–£–†–´ –î–õ–Ø –û–¢–ú–ï–ù–´ –î–ï–ô–°–¢–í–ò–ô ===
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z –∏–ª–∏ Cmd+Z (–¥–ª—è Mac) - –∏—Å–ø–æ–ª—å–∑—É–µ–º e.code –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –ª—é–±–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ
            if ((e.ctrlKey || e.metaKey) && e.code === 'KeyZ') {
                console.log(`‚å®Ô∏è –ù–∞–∂–∞—Ç–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è Ctrl+Z (—Ä–∞—Å–∫–ª–∞–¥–∫–∞: ${e.key})`);
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
                undo();
            }
        });

        // === TOUCH –°–û–ë–´–¢–ò–Ø –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í ===
        if (isTouchDevice) {
            let longPressTimer = null;
            const LONG_PRESS_DURATION = 500; // –º—Å

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –∏ zoom –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

                const touches = e.touches;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                if (touches.length === 1) {
                    // –û–¥–∏–Ω–æ—á–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ
                    const touch = touches[0];
                    const x = (touch.clientX - rect.left) * scaleX;
                    const y = (touch.clientY - rect.top) * scaleY;

                    // –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä–∞–Ω–¥–∞—à–∞, –ª–∞—Å—Ç–∏–∫–∞ –∏ –∑–∞–ª–∏–≤–∫–∏
                    if (editorMode) {
                        if (currentTool === 'pencil') {
                            isDrawing = true;
                            currentStroke = {
                                points: [{x, y}],
                                color: primaryColor,
                                width: pencilWidth
                            };
                        } else if (currentTool === 'eraser') {
                            isDrawing = true;

                            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –Ω–∞ –º–æ–ª–µ–∫—É–ª—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ª–∏–≤–∫–∏
                            let clickedMolecule = null;
                            for (let i = molecules.length - 1; i >= 0; i--) {
                                const mol = molecules[i];
                                const dx = x - mol.x;
                                const dy = y - mol.y;
                                const distance = Math.sqrt(dx * dx + dy * dy);
                                if (distance < mol.size) {
                                    clickedMolecule = mol;
                                    break;
                                }
                            }

                            if (clickedMolecule) {
                                // –£–¥–∞–ª—è–µ–º –∑–∞–ª–∏–≤–∫—É –º–æ–ª–µ–∫—É–ª—ã
                                if (fillMode === 'interior' || fillMode === 'both') {
                                    clickedMolecule.fillColor = null;
                                }
                                if (fillMode === 'edge' || fillMode === 'both') {
                                    clickedMolecule.edgeColor = null;
                                }
                                clickedMolecule.emboss = false;
                                clickedMolecule.microStripes = false;

                                // –û–±–Ω–æ–≤–ª—è–µ–º frozenMolecules
                                const molIndex = molecules.indexOf(clickedMolecule);
                                if (frozenMolecules[molIndex]) {
                                    if (fillMode === 'interior' || fillMode === 'both') {
                                        frozenMolecules[molIndex].fillColor = null;
                                    }
                                    if (fillMode === 'edge' || fillMode === 'both') {
                                        frozenMolecules[molIndex].edgeColor = null;
                                    }
                                    frozenMolecules[molIndex].emboss = false;
                                    frozenMolecules[molIndex].microStripes = false;
                                }

                                const modeText = fillMode === 'interior' ? '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å' :
                                                 fillMode === 'edge' ? '–∫–æ–Ω—Ç—É—Ä' : '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å+–∫–æ–Ω—Ç—É—Ä';
                                status.textContent = `üßπ –°—Ç—ë—Ä—Ç–æ ${modeText} –º–æ–ª–µ–∫—É–ª—ã`;
                                saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                            } else if (smartEraserMode) {
                                // –£–º–Ω—ã–π –ª–∞—Å—Ç–∏–∫ - —É–¥–∞–ª—è–µ–º —à—Ç—Ä–∏—Ö–∏ –∏ –∑–∞–ª–∏–≤–∫–∏ —Ü–µ–ª–∏–∫–æ–º
                                let deletedSomething = false;
                                if (fillMode === 'edge' || fillMode === 'both') {
                                    const initialLength = drawnStrokes.length;
                                    drawnStrokes = drawnStrokes.filter(stroke => {
                                        for (const point of stroke.points) {
                                            const dist = Math.sqrt((point.x - x) ** 2 + (point.y - y) ** 2);
                                            if (dist < stroke.width * 2) return false;
                                        }
                                        return true;
                                    });
                                    if (drawnStrokes.length < initialLength) {
                                        deletedSomething = true;
                                        status.textContent = 'üóëÔ∏è –ö–æ–Ω—Ç—É—Ä —É–¥–∞–ª–µ–Ω';
                                    }
                                }
                                if (fillMode === 'interior' || fillMode === 'both') {
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ã—á–Ω—ã–µ –∑–∞–ª–∏–≤–∫–∏
                                    const initialLength = filledRegions.length;
                                    filledRegions = filledRegions.filter(region => {
                                        if (x >= region.x && x < region.x + region.width &&
                                            y >= region.y && y < region.y + region.height) {
                                            const px = Math.floor(x - region.x);
                                            const py = Math.floor(y - region.y);
                                            const idx = (py * region.width + px) * 4;
                                            const alpha = region.imageData.data[idx + 3];
                                            if (alpha > 0) return false;
                                        }
                                        return true;
                                    });

                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–ª–∏–≤–∫–∏
                                    const initialBgLength = backgroundFills.length;
                                    backgroundFills = backgroundFills.filter(region => {
                                        if (x >= region.x && x < region.x + region.width &&
                                            y >= region.y && y < region.y + region.height) {
                                            const px = Math.floor(x - region.x);
                                            const py = Math.floor(y - region.y);
                                            const idx = (py * region.width + px) * 4;
                                            const alpha = region.imageData.data[idx + 3];
                                            if (alpha > 0) return false;
                                        }
                                        return true;
                                    });

                                    if (filledRegions.length < initialLength || backgroundFills.length < initialBgLength) {
                                        deletedSomething = true;
                                        status.textContent = 'üóëÔ∏è –ó–∞–ª–∏–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞';
                                    }
                                }
                                if (!deletedSomething) {
                                    status.textContent = '–ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å';
                                } else {
                                    saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                                }
                            }
                        } else if (currentTool === 'fill') {
                            // –ó–∞–ª–∏–≤–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –Ω–∞ –º–æ–ª–µ–∫—É–ª—É
                            let clickedMolecule = null;
                            for (let i = molecules.length - 1; i >= 0; i--) {
                                const mol = molecules[i];
                                const dx = x - mol.x;
                                const dy = y - mol.y;
                                const distance = Math.sqrt(dx * dx + dy * dy);
                                if (distance < mol.size) {
                                    clickedMolecule = mol;
                                    break;
                                }
                            }

                            if (clickedMolecule) {
                                // –ó–∞–ª–∏–≤–∫–∞ –º–æ–ª–µ–∫—É–ª—ã
                                if (fillMode === 'interior' || fillMode === 'both') {
                                    clickedMolecule.fillColor = primaryColor;
                                }
                                if (fillMode === 'edge' || fillMode === 'both') {
                                    clickedMolecule.edgeColor = primaryColor;
                                }

                                // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º frozenMolecules –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                                const molIndex = molecules.indexOf(clickedMolecule);
                                if (frozenMolecules[molIndex]) {
                                    if (fillMode === 'interior' || fillMode === 'both') {
                                        frozenMolecules[molIndex].fillColor = primaryColor;
                                    }
                                    if (fillMode === 'edge' || fillMode === 'both') {
                                        frozenMolecules[molIndex].edgeColor = primaryColor;
                                    }
                                }

                                status.textContent = `ü™£ –ú–æ–ª–µ–∫—É–ª–∞ –∑–∞–ª–∏—Ç–∞ —Ü–≤–µ—Ç–æ–º`;
                                saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                            } else {
                                // –ó–∞–ª–∏–≤–∫–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π
                                const fillResult = floodFillStrokes(x, y, primaryColor);
                                if (fillResult === 'too_large') {
                                    status.textContent = '‚ö†Ô∏è –û–±–ª–∞—Å—Ç—å —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è! –ù–∞—Ä–∏—Å—É–π—Ç–µ –∑–∞–º–∫–Ω—É—Ç—É—é —Ñ–∏–≥—É—Ä—É';
                                } else if (fillResult) {
                                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º - —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–ª–∏–≤–∫–∞ –∏–ª–∏ –æ–±—ã—á–Ω–∞—è
                                    const fillArea = fillResult.width * fillResult.height;
                                    const canvasArea = canvas.width * canvas.height;
                                    const areaRatio = fillArea / canvasArea;

                                    // –ï—Å–ª–∏ –∑–∞–ª–∏–≤–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª–µ–µ 30% —ç–∫—Ä–∞–Ω–∞ - —ç—Ç–æ —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–ª–∏–≤–∫–∞
                                    const isBackground = areaRatio > 0.3;

                                    if (isBackground) {
                                        backgroundFills.push(fillResult);
                                        status.textContent = `üñºÔ∏è –§–æ–Ω –∑–∞–ª–∏—Ç —Ü–≤–µ—Ç–æ–º ${primaryColor}`;
                                        saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                                    } else {
                                        filledRegions.push(fillResult);
                                        status.textContent = `ü™£ –û–±–ª–∞—Å—Ç—å –∑–∞–ª–∏—Ç–∞ —Ü–≤–µ—Ç–æ–º ${primaryColor}`;
                                        saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                                    }
                                } else {
                                    status.textContent = '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ª–∏—Ç—å (–Ω–µ—Ç –∑–∞–º–∫–Ω—É—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏)';
                                }
                            }
                        }
                        return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                    }

                    // –†–ï–ñ–ò–ú –ñ–ï–°–¢–û–í - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–ª–µ–∫—É–ª

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –Ω–∞ –º–æ–ª–µ–∫—É–ª—É
                    touchedMolecule = null;
                    for (let i = molecules.length - 1; i >= 0; i--) {
                        const mol = molecules[i];
                        const dx = x - mol.x;
                        const dy = y - mol.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < mol.size) {
                            touchedMolecule = mol;
                            break;
                        }
                    }

                    if (touchedMolecule) {
                        // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
                        if (virtualMode) {
                            clearTimeout(longPressTimer);

                            if (virtualMode === 'delete') {
                                const index = molecules.indexOf(touchedMolecule);
                                if (index > -1) {
                                    molecules.splice(index, 1);
                                    status.textContent = `üóëÔ∏è –ú–æ–ª–µ–∫—É–ª–∞ —É–¥–∞–ª–µ–Ω–∞ | ${molecules.length}/${maxMolecules}`;
                                }
                                touchedMolecule = null;
                            } else if (virtualMode === 'scale-up') {
                                touchedMolecule.targetSize = Math.min(maxMoleculeSize, touchedMolecule.size + 20);
                                status.textContent = `‚¨ÜÔ∏è –†–∞–∑–º–µ—Ä: ${Math.round(touchedMolecule.targetSize)}`;
                            } else if (virtualMode === 'scale-down') {
                                touchedMolecule.targetSize = Math.max(minMoleculeSize, touchedMolecule.size - 20);
                                status.textContent = `‚¨áÔ∏è –†–∞–∑–º–µ—Ä: ${Math.round(touchedMolecule.targetSize)}`;
                            } else if (virtualMode === 'move') {
                                virtualSelectedMolecule = touchedMolecule;
                                touchedMolecule.isGrabbed = true;
                                status.textContent = `‚úã –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–æ–ª–µ–∫—É–ª—ã`;
                            }
                        } else {
                            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
                            // –ù–∞—á–∏–Ω–∞–µ–º –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                            longPressTimer = setTimeout(() => {
                                // –£–¥–∞–ª—è–µ–º –º–æ–ª–µ–∫—É–ª—É –ø—Ä–∏ –¥–ª–∏–Ω–Ω–æ–º –Ω–∞–∂–∞—Ç–∏–∏
                                const index = molecules.indexOf(touchedMolecule);
                                if (index > -1) {
                                    molecules.splice(index, 1);
                                    status.textContent = `üóëÔ∏è –ú–æ–ª–µ–∫—É–ª–∞ —É–¥–∞–ª–µ–Ω–∞ (–¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ)`;
                                    touchedMolecule = null;
                                }
                            }, LONG_PRESS_DURATION);

                            // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                            touchedMolecule.isGrabbed = true;
                            touchedMolecule.targetX = x;
                            touchedMolecule.targetY = y;
                        }
                    } else if (!editorMode && molecules.length < maxMolecules) {
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–æ–ª–µ–∫—É–ª—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –∞–∫—Ç–∏–≤–µ–Ω –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–∫—Ä–æ–º–µ create)
                        if (!virtualMode || virtualMode === 'create') {
                            clearTimeout(longPressTimer);
                            const newMol = new Molecule(x, y, config.moleculeSize);
                            molecules.push(newMol);
                            touchedMolecule = newMol;
                            status.textContent = `‚ú® –ú–æ–ª–µ–∫—É–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ | ${molecules.length}/${maxMolecules}`;
                            saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                        }
                    }

                    activeTouches.set(touch.identifier, {x, y});

                } else if (touches.length === 2) {
                    // –î–≤–∞ –∫–∞—Å–∞–Ω–∏—è - —Ä–µ–∂–∏–º pinch-to-zoom
                    clearTimeout(longPressTimer);

                    const touch1 = touches[0];
                    const touch2 = touches[1];

                    const x1 = (touch1.clientX - rect.left) * scaleX;
                    const y1 = (touch1.clientY - rect.top) * scaleY;
                    const x2 = (touch2.clientX - rect.left) * scaleX;
                    const y2 = (touch2.clientY - rect.top) * scaleY;

                    initialPinchDistance = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);

                    // –ù–∞—Ö–æ–¥–∏–º –º–æ–ª–µ–∫—É–ª—É –º–µ–∂–¥—É –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏
                    const centerX = (x1 + x2) / 2;
                    const centerY = (y1 + y2) / 2;

                    touchedMolecule = null;
                    for (let i = molecules.length - 1; i >= 0; i--) {
                        const mol = molecules[i];
                        const dx = centerX - mol.x;
                        const dy = centerY - mol.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < mol.size * 2) {
                            touchedMolecule = mol;
                            break;
                        }
                    }

                    activeTouches.set(touch1.identifier, {x: x1, y: y1});
                    activeTouches.set(touch2.identifier, {x: x2, y: y2});
                }
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();

                const touches = e.touches;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                // –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê - —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –∫–∞—Ä–∞–Ω–¥–∞—à–æ–º –∏ —Å—Ç–∏—Ä–∞–Ω–∏–µ –ª–∞—Å—Ç–∏–∫–æ–º
                if (editorMode && isDrawing && touches.length === 1) {
                    const touch = touches[0];
                    const x = (touch.clientX - rect.left) * scaleX;
                    const y = (touch.clientY - rect.top) * scaleY;

                    if (currentTool === 'pencil' && currentStroke) {
                        currentStroke.points.push({x, y});
                    } else if (currentTool === 'eraser' && !smartEraserMode) {
                        // –û–±—ã—á–Ω—ã–π –ª–∞—Å—Ç–∏–∫ —Å—Ç–∏—Ä–∞–µ—Ç –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
                        const eraserSize = pencilWidth * 2;
                        if (fillMode === 'edge' || fillMode === 'both') {
                            drawnStrokes = drawnStrokes.filter(stroke => {
                                for (const point of stroke.points) {
                                    const dist = Math.sqrt((point.x - x) ** 2 + (point.y - y) ** 2);
                                    if (dist < eraserSize) return false;
                                }
                                return true;
                            });
                        }
                        if (fillMode === 'interior' || fillMode === 'both') {
                            // –°—Ç–∏—Ä–∞–µ–º –æ–±—ã—á–Ω—ã–µ –∑–∞–ª–∏–≤–∫–∏
                            for (const region of filledRegions) {
                                if (x >= region.x && x < region.x + region.width &&
                                    y >= region.y && y < region.y + region.height) {
                                    const pixels = region.imageData.data;
                                    for (let dy = -eraserSize; dy <= eraserSize; dy++) {
                                        for (let dx = -eraserSize; dx <= eraserSize; dx++) {
                                            const dist = Math.sqrt(dx * dx + dy * dy);
                                            if (dist <= eraserSize) {
                                                const px = Math.floor(x - region.x + dx);
                                                const py = Math.floor(y - region.y + dy);
                                                if (px >= 0 && px < region.width && py >= 0 && py < region.height) {
                                                    const idx = (py * region.width + px) * 4;
                                                    pixels[idx + 3] = 0;
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            // –°—Ç–∏—Ä–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–ª–∏–≤–∫–∏
                            for (const region of backgroundFills) {
                                if (x >= region.x && x < region.x + region.width &&
                                    y >= region.y && y < region.y + region.height) {
                                    const pixels = region.imageData.data;
                                    for (let dy = -eraserSize; dy <= eraserSize; dy++) {
                                        for (let dx = -eraserSize; dx <= eraserSize; dx++) {
                                            const dist = Math.sqrt(dx * dx + dy * dy);
                                            if (dist <= eraserSize) {
                                                const px = Math.floor(x - region.x + dx);
                                                const py = Math.floor(y - region.y + dy);
                                                if (px >= 0 && px < region.width && py >= 0 && py < region.height) {
                                                    const idx = (py * region.width + px) * 4;
                                                    pixels[idx + 3] = 0;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    return;
                }

                // –†–ï–ñ–ò–ú –ñ–ï–°–¢–û–í - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–æ–ª–µ–∫—É–ª
                if (touches.length === 1 && touchedMolecule) {
                    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–æ–ª–µ–∫—É–ª—ã –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º
                    clearTimeout(longPressTimer); // –û—Ç–º–µ–Ω—è–µ–º –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏

                    const touch = touches[0];
                    const x = (touch.clientX - rect.left) * scaleX;
                    const y = (touch.clientY - rect.top) * scaleY;

                    touchedMolecule.targetX = x;
                    touchedMolecule.targetY = y;

                } else if (touches.length === 2 && touchedMolecule) {
                    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–ª–µ–∫—É–ª—ã –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏ (pinch)
                    clearTimeout(longPressTimer);

                    const touch1 = touches[0];
                    const touch2 = touches[1];

                    const x1 = (touch1.clientX - rect.left) * scaleX;
                    const y1 = (touch1.clientY - rect.top) * scaleY;
                    const x2 = (touch2.clientX - rect.left) * scaleX;
                    const y2 = (touch2.clientY - rect.top) * scaleY;

                    const currentDistance = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                    const scaleFactor = currentDistance / initialPinchDistance;

                    // –ò–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –º–æ–ª–µ–∫—É–ª—ã —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
                    const newSize = Math.max(minMoleculeSize * 0.7, Math.min(maxMoleculeSize * 0.7, touchedMolecule.size * scaleFactor));
                    touchedMolecule.targetSize = newSize;

                    initialPinchDistance = currentDistance; // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–∞–¥—Ä–∞

                    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–æ–ª–µ–∫—É–ª—ã –∫ —Ü–µ–Ω—Ç—Ä—É –º–µ–∂–¥—É –ø–∞–ª—å—Ü–∞–º–∏
                    const centerX = (x1 + x2) / 2;
                    const centerY = (y1 + y2) / 2;
                    touchedMolecule.targetX = centerX;
                    touchedMolecule.targetY = centerY;

                    status.textContent = `üìè –†–∞–∑–º–µ—Ä: ${Math.round(newSize)}px (pinch)`;
                }
            }, { passive: false });

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();

                // –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                if (editorMode && isDrawing) {
                    if (currentTool === 'pencil' && currentStroke && currentStroke.points.length > 0) {
                        drawnStrokes.push(currentStroke);
                        currentStroke = null;
                        status.textContent = `‚úèÔ∏è –®—Ç—Ä–∏—Ö –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω | –í—Å–µ–≥–æ: ${drawnStrokes.length}`;
                        saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                    } else if (currentTool === 'eraser') {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —Å—Ç–∏—Ä–∞–Ω–∏—è
                        saveState();
                    }
                    isDrawing = false;
                    return;
                }

                // –†–ï–ñ–ò–ú –ñ–ï–°–¢–û–í
                clearTimeout(longPressTimer);

                if (touchedMolecule) {
                    touchedMolecule.isGrabbed = false;
                }

                // –û—á–∏—â–∞–µ–º activeTouches
                const remainingTouches = e.touches;
                const remainingIds = new Set();
                for (let i = 0; i < remainingTouches.length; i++) {
                    remainingIds.add(remainingTouches[i].identifier);
                }

                for (const [id] of activeTouches) {
                    if (!remainingIds.has(id)) {
                        activeTouches.delete(id);
                    }
                }

                if (activeTouches.size === 0) {
                    touchedMolecule = null;
                    initialPinchDistance = 0;
                }
            }, { passive: false });

            canvas.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                clearTimeout(longPressTimer);

                if (touchedMolecule) {
                    touchedMolecule.isGrabbed = false;
                }

                activeTouches.clear();
                touchedMolecule = null;
                initialPinchDistance = 0;
            }, { passive: false });

            console.log('‚úÖ Touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            console.log('=== –ù–ê–ß–ê–õ–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ===');

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–ª–∏—Ç—Ä—É —Ü–≤–µ—Ç–æ–≤ Paint
            initColorPalette();

            resize();
            window.addEventListener('resize', resize);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω—ã –ø–µ—Ä–≤–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
            saveState();

            console.log('–ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é...');
            animate();

            console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
            const [camera, audio] = await Promise.all([
                setupCamera(),
                setupAudio()
            ]);

            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - –ö–∞–º–µ—Ä–∞:', camera, '–ê—É–¥–∏–æ:', audio);

            if (camera && audio) {
                console.log('‚úÖ –í–°–Å –£–°–ü–ï–®–ù–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–û');
                loading.style.display = 'none';
                status.textContent = '–†–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤ | –ì–æ—Ç–æ–≤';
                detectHands();
            } else {
                console.log('‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –ö–∞–º–µ—Ä–∞:', !!camera, '–ê—É–¥–∏–æ:', !!audio);
                loading.style.display = 'none';
                status.textContent = camera ? '–†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∑–≤—É–∫–∞' : '–†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∫–∞–º–µ—Ä—ã';
                if (camera) detectHands();
            }

            console.log('=== –ö–û–ù–ï–¶ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ===');
        }

        console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
        init();
    </script>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
