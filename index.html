<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>–ú–æ–ª–µ–∫—É–ª—è—Ä–Ω–∞—è –°–∏–º—É–ª—è—Ü–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #f5f5f5;
            color: #333;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #videoElement {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transform: scaleX(-1);
            transition: opacity 0.3s;
            z-index: 1;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 10;
            max-width: 320px;
            border: 2px solid #e0e0e0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #controls.minimized {
            transform: translateX(calc(100% + 20px));
            opacity: 0;
            pointer-events: none;
        }

        h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #666;
        }

        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .value-display {
            display: inline-block;
            margin-left: 10px;
            color: #333;
            font-weight: bold;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #333;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #555;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-group input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: #333;
        }

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 12px;
            color: #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            z-index: 10;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #333;
            text-align: center;
            z-index: 100;
        }

        .gesture-hint {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 14px;
            color: #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            max-width: 300px;
            z-index: 10;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .gesture-hint.minimized {
            transform: translateX(calc(-100% - 20px));
            opacity: 0;
            pointer-events: none;
        }

        .gesture-hint strong {
            display: block;
            margin-bottom: 8px;
            color: #000;
        }

        .audio-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            overflow: hidden;
            z-index: 10;
        }

        .audio-bars {
            display: flex;
            align-items: flex-end;
            height: 100%;
            padding: 5px;
            gap: 2px;
        }

        .audio-bar {
            flex: 1;
            background: #333;
            border-radius: 2px;
            transition: height 0.1s;
        }

        /* –ö–Ω–æ–ø–∫–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π */
        .toggle-btn {
            position: absolute;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 11;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .toggle-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        #toggleHints {
            top: 20px;
            left: 20px;
        }

        #toggleControls {
            top: 20px;
            right: 20px;
        }

        .toggle-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ */
        .close-panel {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-panel:hover {
            background: rgba(0, 0, 0, 0.2);
            color: #333;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 768px) {
            #controls {
                top: 10px;
                right: 10px;
                padding: 12px;
                max-width: 220px;
                font-size: 11px;
                background: rgba(255, 255, 255, 0.85); /* –ß—É—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ */
            }

            h2 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .control-group {
                margin-bottom: 10px;
            }

            label {
                font-size: 10px;
            }

            button {
                padding: 8px;
                font-size: 11px;
                margin-top: 6px;
            }

            .gesture-hint {
                top: 10px;
                left: 10px;
                padding: 10px 12px;
                font-size: 11px;
                max-width: 200px;
                background: rgba(255, 255, 255, 0.85); /* –ß—É—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ */
            }

            .toggle-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            #toggleHints {
                top: 10px;
                left: 10px;
            }

            #toggleControls {
                top: 10px;
                right: 10px;
            }

            .gesture-hint strong {
                margin-bottom: 5px;
                font-size: 12px;
            }

            .gesture-hint div {
                line-height: 1.4;
                margin-bottom: 2px;
            }

            #status {
                bottom: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 10px;
            }

            .audio-indicator {
                bottom: 10px;
                right: 10px;
                width: 100px;
                height: 30px;
            }

            .value-display {
                font-size: 11px;
            }
        }

        /* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ (—Å–º–∞—Ä—Ç—Ñ–æ–Ω—ã) */
        @media (max-width: 480px) {
            #controls {
                max-width: 180px;
                padding: 10px;
            }

            .gesture-hint {
                font-size: 9px;
                max-width: 160px;
                padding: 8px 10px;
            }

            .gesture-hint div {
                line-height: 1.3;
            }

            h2 {
                font-size: 12px;
            }

            button {
                padding: 6px;
                font-size: 10px;
            }

            #status {
                font-size: 9px;
                padding: 6px 10px;
            }
        }

        /* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 900px) and (orientation: landscape) {
            .gesture-hint {
                max-width: 180px;
                font-size: 10px;
            }

            #controls {
                max-width: 200px;
            }
        }

        /* === PAINT –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê === */

        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å–ª–µ–≤–∞ (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º Paint) */
        #paintToolbar {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            background: #d4d0c8;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            padding: 5px;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            z-index: 15;
        }

        #paintToolbar.active {
            display: block;
        }

        .paint-tool {
            width: 24px;
            height: 24px;
            margin: 3px auto;
            background: #c0c0c0;
            border: 1px outset #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .paint-tool:hover {
            background: #b0b0b0;
        }

        .paint-tool:active {
            border-style: inset;
        }

        .paint-tool.selected {
            border: 2px inset #ffffff;
            background: #a0a0a0;
        }

        /* –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ –≤–Ω–∏–∑—É (–∫–∞–∫ –≤ Paint) */
        #colorPalette {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #d4d0c8;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            padding: 10px;
            display: none;
            z-index: 15;
        }

        #colorPalette.active {
            display: block;
        }

        #colorPalette .color-section {
            margin-bottom: 8px;
        }

        #colorPalette .label-paint {
            font-size: 10px;
            color: #000;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            margin-bottom: 4px;
        }

        #colorGrid {
            display: grid;
            grid-template-columns: repeat(14, 20px);
            gap: 2px;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border: 1px solid #000;
            cursor: pointer;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1);
        }

        .color-swatch:hover {
            border: 2px solid #fff;
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        .color-swatch.selected {
            border: 3px solid #0000ff;
        }

        #currentColorDisplay {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .color-box {
            width: 32px;
            height: 32px;
            border: 2px inset #ffffff;
        }

        .color-label {
            font-size: 9px;
            text-align: center;
            margin-top: 2px;
            color: #000;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ - –Ω–∞—Å–ª–µ–¥—É–µ—Ç —Å—Ç–∏–ª–∏ –æ—Ç –æ–±—ã—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        #modeToggleBtn {
            margin-top: 15px;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ */
        .mode-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 16px;
            font-weight: 600;
            z-index: 16;
            display: none;
        }

        .mode-indicator.active {
            display: block;
        }

        .mode-indicator.gesture-mode {
            background: rgba(200, 240, 200, 0.95);
            color: #2d5a2d;
            border: 2px solid #5a9a5a;
        }

        .mode-indicator.editor-mode {
            background: rgba(255, 235, 180, 0.95);
            color: #805500;
            border: 2px solid #cc8800;
        }

        /* –ö–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–∞ –∑–∞–ª–∏–≤–∫–∏ */
        .fill-mode-btn {
            flex: 1;
            padding: 4px 8px;
            font-size: 11px;
            background: #d4d0c8;
            border: 2px outset #ffffff;
            cursor: pointer;
            font-family: 'MS Sans Serif', sans-serif;
            color: #000;
        }

        .fill-mode-btn:hover {
            background: #e0dcd4;
        }

        .fill-mode-btn:active {
            border-style: inset;
        }

        .fill-mode-btn.active {
            background: #8080ff;
            color: #fff;
            border-style: inset;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvas"></canvas>

        <div class="gesture-hint" id="gestureHint">
            <button class="close-panel" id="closeHints" title="–°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏">√ó</button>
            <strong>–ñ–µ—Å—Ç—ã:</strong>
            <div>‚úåÔ∏è –©–∏–ø–æ–∫ ‚Üí —Å–æ–∑–¥–∞—Ç—å –º–æ–ª–µ–∫—É–ª—É</div>
            <div>üòÆ –û—Ç–∫—Ä—ã—Ç—å —Ä–æ—Ç ‚Üí —Ä–µ–∂–∏–º ‚úé</div>
            <div>‚úã –õ–∞–¥–æ–Ω—å ‚Üí –¥–≤–∏–≥–∞—Ç—å –º–æ–ª–µ–∫—É–ª—É</div>
            <div>‚úã (–≤ —Ä–µ–∂–∏–º–µ ‚úé) ‚Üí —Ä–∞–∑–º–µ—Ä –∏ —Ñ–æ—Ä–º–∞</div>
            <div style="font-size: 10px; margin-left: 10px;">‚Ü≥ —à–∏—Ä–∏–Ω–∞ –ª–∞–¥–æ–Ω–∏ = —Ä–∞–∑–º–µ—Ä</div>
            <div style="font-size: 10px; margin-left: 10px;">‚Ü≥ –∑–∞–≥–Ω—É—Ç—ã–µ –ø–∞–ª—å—Ü—ã = —Ñ–æ—Ä–º–∞</div>
            <div>‚úä –ö—É–ª–∞–∫ 2 —Å–µ–∫ ‚Üí —Ñ–∏–∫—Å–∞—Ü–∏—è –º–æ–ª–µ–∫—É–ª—ã</div>
            <div>‚úä‚úä –î–≤–∞ –∫—É–ª–∞–∫–∞ 2 —Å–µ–∫ ‚Üí —Ñ–∏–∫—Å–∞—Ü–∏—è –í–°–ï–•</div>
            <div>ü§ô –ú–∏–∑–∏–Ω–µ—Ü ‚Üí —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>
            <div>ü§û –°–∫—Ä–µ—â. –ø–∞–ª—å—Ü—ã 2 —Å–µ–∫ ‚Üí —É–¥–∞–ª–∏—Ç—å</div>
            <div>üé§ –ó–≤—É–∫ ‚Üí –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–æ–Ω—Ç—É—Ä–∞</div>
        </div>

        <div class="toggle-btn" id="toggleHints" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏">üí°</div>

        <div id="controls">
            <button class="close-panel" id="closeControls" title="–°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å">√ó</button>
            <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>

            <div class="control-group">
                <label>–†–∞–∑–º–µ—Ä –º–æ–ª–µ–∫—É–ª—ã: <span class="value-display" id="molSize">100</span></label>
                <input type="range" id="molSizeSlider" min="50" max="300" value="100" step="10">
            </div>

            <div class="control-group">
                <label>–°–∏–ª–∞ —Å–ª–∏—è–Ω–∏—è: <span class="value-display" id="mergeStrength">1.5</span></label>
                <input type="range" id="mergeSlider" min="0.5" max="3" value="1.5" step="0.1">
            </div>

            <div class="control-group">
                <label>–ó–≤—É–∫–æ–≤–∞—è —Ä–µ–∞–∫—Ü–∏—è: <span class="value-display" id="audioSens">20</span></label>
                <input type="range" id="audioSensSlider" min="5" max="50" value="20" step="5">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="audioEnabled" checked>
                <label for="audioEnabled">–ó–≤—É–∫ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ–æ—Ä–º—É</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="showVideo">
                <label for="showVideo">–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ</label>
            </div>

            <button id="unlockBtn">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ</button>
            <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
            <button id="modeToggleBtn">üé® –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞</button>
        </div>

        <div class="toggle-btn" id="toggleControls" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å">‚öôÔ∏è</div>

        <div class="audio-indicator">
            <div class="audio-bars" id="audioBars"></div>
        </div>

        <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="loading" id="loading">
            <div>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
            <div style="font-size: 14px; margin-top: 10px;">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</div>
        </div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ -->
        <div class="mode-indicator gesture-mode active" id="modeIndicator">
            üëã –†–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤
        </div>

        <!-- Paint –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
        <div id="paintToolbar">
            <div class="paint-tool selected" data-tool="select" title="–í—ã–±–æ—Ä">üîç</div>
            <div class="paint-tool" data-tool="fill" title="–ó–∞–ª–∏–≤–∫–∞">ü™£</div>
            <div class="paint-tool" data-tool="pencil" title="–ö–∞—Ä–∞–Ω–¥–∞—à">‚úèÔ∏è</div>
            <div class="paint-tool" data-tool="eraser" title="–õ–∞—Å—Ç–∏–∫">üßπ</div>
        </div>

        <!-- Paint –ø–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ -->
        <div id="colorPalette">
            <div class="color-section">
                <div class="label-paint">–¶–≤–µ—Ç–∞:</div>
                <div id="colorGrid"></div>
            </div>
            <div class="color-section">
                <div class="label-paint">–¢–µ–∫—É—â–∏–π:</div>
                <div id="currentColorDisplay">
                    <div>
                        <div class="color-box" id="primaryColor" style="background: #000000;"></div>
                        <div class="color-label">–û—Å–Ω–æ–≤–Ω–æ–π</div>
                    </div>
                    <div>
                        <div class="color-box" id="secondaryColor" style="background: #ffffff;"></div>
                        <div class="color-label">–§–æ–Ω–æ–≤—ã–π</div>
                    </div>
                </div>
            </div>
            <div class="color-section">
                <div class="label-paint">–†–µ–∂–∏–º –∑–∞–ª–∏–≤–∫–∏:</div>
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button class="fill-mode-btn active" data-mode="both" title="–ó–∞–ª–∏–≤–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç—É—Ä–∞">–û–±–∞</button>
                    <button class="fill-mode-btn" data-mode="interior" title="–¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å">–í–Ω—É—Ç—Ä–∏</button>
                    <button class="fill-mode-btn" data-mode="edge" title="–¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç—É—Ä">–ö–æ–Ω—Ç—É—Ä</button>
                </div>
            </div>
            <div class="color-section">
                <div class="label-paint">–≠—Ñ—Ñ–µ–∫—Ç—ã:</div>
                <div style="margin-top: 5px; display: flex; flex-direction: column; gap: 3px;">
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; cursor: pointer;">
                        <input type="checkbox" id="embossEffect" style="cursor: pointer;">
                        <span>–¢–∏—Å–Ω–µ–Ω–∏–µ</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; cursor: pointer;">
                        <input type="checkbox" id="microStripesEffect" style="cursor: pointer;">
                        <span>–ú–∏–∫—Ä–æ-–ø–æ–ª–æ—Å–∫–∏</span>
                    </label>
                    <div id="microStripesSettings" style="display: none; margin-left: 20px; margin-top: 5px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; gap: 8px; flex-direction: column;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 10px; color: #555;">–¶–≤–µ—Ç 1:</label>
                            <input type="color" id="stripeColor1" value="#ff0000" style="width: 100%; height: 25px; border: 1px solid #ccc; cursor: pointer;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 10px; color: #555;">–¶–≤–µ—Ç 2:</label>
                            <input type="color" id="stripeColor2" value="#0000ff" style="width: 100%; height: 25px; border: 1px solid #ccc; cursor: pointer;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 10px; color: #555;">–®–∏—Ä–∏–Ω–∞: <span id="stripeWidthValue">2</span>px</label>
                            <input type="range" id="stripeWidth" min="1" max="10" value="2" style="width: 100%; cursor: pointer;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label style="font-size: 10px; color: #555;">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: <span id="stripeSpacingValue">3</span>px</label>
                            <input type="range" id="stripeSpacing" min="2" max="15" value="3" style="width: 100%; cursor: pointer;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="color-section">
                <div class="label-paint">–§–æ–Ω:</div>
                <div style="display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap;">
                    <input type="color" id="bgColorPicker" value="#ffffff" title="–¶–≤–µ—Ç —Ñ–æ–Ω–∞" style="width: 50px; height: 30px; border: 2px outset #fff; cursor: pointer;">
                    <label class="fill-mode-btn" style="padding: 4px 8px; cursor: pointer; flex: 1; min-width: 70px; text-align: center;">
                        –§–∞–π–ª
                        <input type="file" id="bgFilePicker" accept="image/*,video/*" style="display: none;">
                    </label>
                    <button class="fill-mode-btn" id="bgClearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ–Ω">‚úñ</button>
                </div>
                <div id="bgPreview" style="margin-top: 5px; font-size: 10px; color: #666;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <script>
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ Service Worker –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                for (let registration of registrations) {
                    registration.unregister();
                    console.log('Service Worker —É–¥–∞–ª–µ–Ω');
                }
            });
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('videoElement');
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');

        let width, height;
        let molecules = [];
        let hands = [];
        let previousPinchStates = [false, false];
        let audioLevel = 0;
        let audioFrequencyData = [];
        let isMouthOpen = false; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—Ç–∞
        let wasMouthOpen = false; // –ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—Ç–∞ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è
        let editingMolecule = null; // –ú–æ–ª–µ–∫—É–ª–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let hoveredMolecule = null; // –ú–æ–ª–µ–∫—É–ª–∞ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–≤–µ–¥–µ–Ω–∞ —Ä—É–∫–∞ –°–ï–ô–ß–ê–°
        let lastHoveredMolecule = null; // –ü–æ—Å–ª–µ–¥–Ω—è—è –º–æ–ª–µ–∫—É–ª–∞ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–≤–æ–¥–∏–ª–∏—Å—å

        // === –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê ===
        let editorMode = false; // false = –∂–µ—Å—Ç—ã, true = —Ä–µ–¥–∞–∫—Ç–æ—Ä
        let frozenMolecules = []; // –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –º–æ–ª–µ–∫—É–ª—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let selectedMolecule = null; // –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–ª–µ–∫—É–ª–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
        let hoveredMoleculeEditor = null; // –ú–æ–ª–µ–∫—É–ª–∞ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
        let currentTool = 'select'; // –¢–µ–∫—É—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (select, fill, pencil, eraser)
        let primaryColor = '#000000'; // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç
        let secondaryColor = '#ffffff'; // –§–æ–Ω–æ–≤—ã–π —Ü–≤–µ—Ç
        let fillMode = 'both'; // –†–µ–∂–∏–º –∑–∞–ª–∏–≤–∫–∏: 'interior' (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å), 'edge' (–∫–æ–Ω—Ç—É—Ä), 'both' (–æ–±–∞)

        // –§–æ–Ω
        let backgroundColor = '#ffffff'; // –¶–≤–µ—Ç —Ñ–æ–Ω–∞
        let backgroundImage = null; // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ–Ω–∞ (Image –∏–ª–∏ video —ç–ª–µ–º–µ–Ω—Ç)
        let backgroundType = 'color'; // 'color', 'image', 'video'

        // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ–Ω–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        let backgroundCache = null; // OffscreenCanvas –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ–Ω–∞
        let backgroundCacheCtx = null;
        let backgroundCacheValid = false; // –§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–µ—à–∞

        // –ü–∞–ª–∏—Ç—Ä–∞ Paint (28 –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö —Ü–≤–µ—Ç–æ–≤)
        const paintColors = [
            '#000000', '#808080', '#800000', '#808000', '#008000', '#008080', '#000080', '#800080',
            '#808000', '#FFFFFF', '#C0C0C0', '#FF0000', '#FFFF00', '#00FF00', '#00FFFF', '#0000FF',
            '#FF00FF', '#FFFF80', '#80FFFF', '#FF8080', '#8080FF', '#FF80FF', '#804040', '#408080',
            '#804080', '#408040', '#FF8040', '#80FF40'
        ];

        // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–≤ - —Ö—Ä–∞–Ω–∏–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –∫–∞–¥—Ä–æ–≤
        const GESTURE_HISTORY_SIZE = 5;
        let gestureHistory = []; // –ú–∞—Å—Å–∏–≤ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ—Å—Ç–æ—è–Ω–∏–π —Ä—É–∫

        // –£–õ–£–ß–®–ï–ù–û: –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∂–µ—Å—Ç–∞
        const GESTURE_STABILITY = {
            pinch: { required: 4, history: [] },      // –©–∏–ø–æ–∫ - —Ç—Ä–µ–±—É–µ—Ç 4 –∏–∑ 5 –∫–∞–¥—Ä–æ–≤ (–£–õ–£–ß–®–ï–ù–û: –±—ã–ª–æ 3)
            pinky: { required: 3, history: [] },      // –ú–∏–∑–∏–Ω–µ—Ü - —Ç—Ä–µ–±—É–µ—Ç 3 –∏–∑ 5
            crossed: { required: 4, history: [] },    // –°–∫—Ä–µ—â–µ–Ω–Ω—ã–µ - —Ç—Ä–µ–±—É–µ—Ç 4 –∏–∑ 5
            fist: { required: 3, history: [] },       // –ö—É–ª–∞–∫ - —Ç—Ä–µ–±—É–µ—Ç 3 –∏–∑ 5
            open: { required: 2, history: [] }        // –û—Ç–∫—Ä—ã—Ç–∞—è –ª–∞–¥–æ–Ω—å - —Ç—Ä–µ–±—É–µ—Ç 2 –∏–∑ 5 (–º—è–≥—á–µ)
        };

        // –ù–û–í–û–ï: –£–º–Ω–∞—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏–π —Ä—É–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const HAND_SMOOTHING_WINDOW = 5; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤ –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
        let handPositionHistory = []; // –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∑–∏—Ü–∏–π —Ä—É–∫ –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è

        // –§—É–Ω–∫—Ü–∏—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π —Ä—É–∫ (moving average)
        function smoothHandPositions(currentHands) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
            handPositionHistory.push(currentHands.map(h => ({
                x: h.x,
                y: h.y,
                handWidth: h.handWidth
            })));

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
            if (handPositionHistory.length > HAND_SMOOTHING_WINDOW) {
                handPositionHistory.shift();
            }

            // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏
            if (handPositionHistory.length < 2) {
                return currentHands;
            }

            // –í—ã—á–∏—Å–ª—è–µ–º —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
            const smoothedHands = currentHands.map((hand, handIndex) => {
                let sumX = 0, sumY = 0, sumWidth = 0;
                let count = 0;

                // –ë–µ—Ä—ë–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —ç—Ç–æ–π —Ä—É–∫–∏
                handPositionHistory.forEach(frame => {
                    if (frame[handIndex]) {
                        sumX += frame[handIndex].x;
                        sumY += frame[handIndex].y;
                        sumWidth += frame[handIndex].handWidth;
                        count++;
                    }
                });

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–µ—Å–∞ - –±–æ–ª–µ–µ —Å–≤–µ–∂–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤–∞–∂–Ω–µ–µ
                // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
                const alpha = 0.3; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (0 = —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—è, 1 = —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–µ)
                const avgX = sumX / count;
                const avgY = sumY / count;
                const avgWidth = sumWidth / count;

                return {
                    ...hand,
                    x: hand.x * alpha + avgX * (1 - alpha),
                    y: hand.y * alpha + avgY * (1 - alpha),
                    handWidth: hand.handWidth * alpha + avgWidth * (1 - alpha)
                };
            });

            return smoothedHands;
        }

        // –¢–∞–π–º–µ—Ä—ã –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è
        const HOLD_DURATION = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        const RESET_TOLERANCE = 300; // –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º —Ç–∞–π–º–µ—Ä–∞ (–º—Å)
        let fistHoldStart = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∫—É–ª–∞–∫–∞ –Ω–∞ –º–æ–ª–µ–∫—É–ª–µ
        let twoFistsHoldStart = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è –¥–≤—É—Ö –∫—É–ª–∞–∫–æ–≤
        let fistHoldMolecule = null; // –ú–æ–ª–µ–∫—É–ª–∞, –Ω–∞–¥ –∫–æ—Ç–æ—Ä–æ–π —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∫—É–ª–∞–∫
        let crossedHoldStart = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è —Å–∫—Ä–µ—â–µ–Ω–Ω—ã—Ö –ø–∞–ª—å—Ü–µ–≤
        let crossedHoldMolecule = null; // –ú–æ–ª–µ–∫—É–ª–∞, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç—è—Ç —É–¥–∞–ª–∏—Ç—å
        let crossedHoldLostTime = null; // –í—Ä–µ–º—è –∫–æ–≥–¥–∞ –∂–µ—Å—Ç –±—ã–ª –ø–æ—Ç–µ—Ä—è–Ω

        let config = {
            moleculeSize: 150, // –£–í–ï–õ–ò–ß–ï–ù–û: –±—ã–ª–æ 100, —Ç–µ–ø–µ—Ä—å 150 - –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–π –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
            mergeStrength: 1.5,
            audioSensitivity: 20,
            audioEnabled: true,
            showVideo: false
        };

        // –ê—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–µ—Ç–∞–±–æ–ª–ª–æ–≤
        const gridResolution = 15; // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–µ—Ç–∫–∏ –¥–ª—è marching squares

        // –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (Spatial Hashing)
        const spatialCellSize = 150; // –†–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–µ—Ç–∫–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–¥–∏—É—Å–∞ –≤–ª–∏—è–Ω–∏—è –º–æ–ª–µ–∫—É–ª—ã)
        let spatialHash = new Map(); // –•–µ—à-—Ç–∞–±–ª–∏—Ü–∞: –∫–ª—é—á = "x,y" –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏, –∑–Ω–∞—á–µ–Ω–∏–µ = –º–∞—Å—Å–∏–≤ –º–æ–ª–µ–∫—É–ª

        // –§—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ö–µ—à–∞
        function buildSpatialHash() {
            spatialHash.clear();

            for (const mol of molecules) {
                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è –º–æ–ª–µ–∫—É–ª—ã —Å —É—á—ë—Ç–æ–º —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è
                // –î–ª—è –≤—ã—Ç—è–Ω—É—Ç—ã—Ö –º–æ–ª–µ–∫—É–ª —Ä–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è –±–æ–ª—å—à–µ
                const maxStretch = Math.max(mol.stretchX || 1, mol.stretchY || 1);
                const influenceRadius = mol.size * maxStretch * 2.5; // –ó–∞–ø–∞—Å –¥–ª—è –≤—ã—Ç—è–Ω—É—Ç—ã—Ö –º–æ–ª–µ–∫—É–ª

                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —è—á–µ–π–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã —ç—Ç–æ–π –º–æ–ª–µ–∫—É–ª–æ–π
                const minCellX = Math.floor((mol.x - influenceRadius) / spatialCellSize);
                const maxCellX = Math.floor((mol.x + influenceRadius) / spatialCellSize);
                const minCellY = Math.floor((mol.y - influenceRadius) / spatialCellSize);
                const maxCellY = Math.floor((mol.y + influenceRadius) / spatialCellSize);

                // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–ª–µ–∫—É–ª—É –≤–æ –≤—Å–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —è—á–µ–π–∫–∏
                for (let cy = minCellY; cy <= maxCellY; cy++) {
                    for (let cx = minCellX; cx <= maxCellX; cx++) {
                        const key = `${cx},${cy}`;
                        if (!spatialHash.has(key)) {
                            spatialHash.set(key, []);
                        }
                        spatialHash.get(key).push(mol);
                    }
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–ª–µ–∫—É–ª, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ —Ç–æ—á–∫—É (x, y)
        function getNearbyMolecules(x, y) {
            const cellX = Math.floor(x / spatialCellSize);
            const cellY = Math.floor(y / spatialCellSize);
            const key = `${cellX},${cellY}`;
            return spatialHash.get(key) || [];
        }

        // –ö–ª–∞—Å—Å –º–æ–ª–µ–∫—É–ª—ã (–º–µ—Ç–∞–±–æ–ª)
        class Molecule {
            constructor(x, y, size) {
                this.x = x;
                this.y = y;
                this.baseSize = size;
                this.size = size;
                this.targetSize = size;  // –¶–µ–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                this.vx = 0;
                this.vy = 0;
                this.targetX = x;
                this.targetY = y;

                // –î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç —Ä—É–∫
                this.stretchX = 1;
                this.stretchY = 1;

                // –£–≥–æ–ª –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–¥–ª—è —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è –ø–æ–¥ —É–≥–ª–æ–º)
                this.deformAngle = 0;

                // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                this._cachedCos = 1; // cos(0)
                this._cachedSin = 0; // sin(0)
                this._lastCachedAngle = 0;

                // –î–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ - –ø–æ–∑–∏—Ü–∏–∏ —Ä—É–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                this.editingHands = null; // { hand1: {x, y}, hand2: {x, y} }

                // –î–ª—è –∑–≤—É–∫–æ–≤—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
                this.audioPhase = Math.random() * Math.PI * 2;
                this.creationAudioLevel = audioLevel;

                // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞—Ö–≤–∞—Ç–∞
                this.isGrabbed = false;
                this.isLocked = false; // –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–∑–∏—Ü–∏—è
                this.isShapeLocked = false; // –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ —Ñ–æ—Ä–º–∞ (—Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ)
                this.isEditing = false; // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

                // –¶–≤–µ—Ç–∞ –¥–ª—è Paint —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (—Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ)
                this.fillColor = null; // –¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                this.edgeColor = null; // –¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –∫–æ–Ω—Ç—É—Ä–∞ (–ø–∏–∫—Å–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
                this.emboss = false; // –≠—Ñ—Ñ–µ–∫—Ç —Ç–∏—Å–Ω–µ–Ω–∏—è (bevel & emboss)
                this.microStripes = false; // –≠—Ñ—Ñ–µ–∫—Ç –º–∏–∫—Ä–æ-–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã—Ö –ø–æ–ª–æ—Å–æ–∫
                this.stripeColor1 = '#ff0000'; // –¶–≤–µ—Ç 1 –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –ø–æ–ª–æ—Å–æ–∫
                this.stripeColor2 = '#0000ff'; // –¶–≤–µ—Ç 2 –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –ø–æ–ª–æ—Å–æ–∫
                this.stripeWidth = 2; // –®–∏—Ä–∏–Ω–∞ –ø–æ–ª–æ—Å–æ–∫
                this.stripeSpacing = 3; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–æ–ª–æ—Å–∫–∞–º–∏

                // –ö–µ—à –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                this._gradientCache = null;
                this._gradientCacheKey = null;

                // –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã - —Å—á–µ—Ç—á–∏–∫ –∫–∞–¥—Ä–æ–≤ —Å –¥–≤—É–º—è —Ä—É–∫–∞–º–∏
                this.twoHandsFrameCount = 0; // –°–∫–æ–ª—å–∫–æ –∫–∞–¥—Ä–æ–≤ –ø–æ–¥—Ä—è–¥ –≤–∏–¥–∏–º 2 —Ä—É–∫–∏
                this.STABLE_HANDS_THRESHOLD = 5; // –ù—É–∂–Ω–æ 5 –∫–∞–¥—Ä–æ–≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
            }

            update() {
                // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏ (–µ—Å–ª–∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)
                if (!this.isLocked) {
                    this.x += (this.targetX - this.x) * 0.1;
                    this.y += (this.targetY - this.y) * 0.1;
                }

                // –ü–ª–∞–≤–Ω–∞—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è (–µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)
                // –£–ü–†–û–©–ï–ù–û: –ø—Ä—è–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–µ–∑ targetStretch –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
                if (!this.isShapeLocked) {
                    // –î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                }

                // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
                this.size += (this.targetSize - this.size) * 0.1;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–∑—É –¥–ª—è –∑–≤—É–∫–∞
                this.audioPhase += 0.05;

                // –ï—Å–ª–∏ –º–æ–ª–µ–∫—É–ª–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ - –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –∂–µ—Å—Ç—ã
                if (this.isLocked) {
                    this.isGrabbed = false;
                    return;
                }

                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä—É–∫–∏
                let openHands = hands.filter(h => h.isOpen && !h.isPinching && !h.isFist);

                if (this.isEditing) {
                    // –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤—É–º—è —Ä—É–∫–∞–º–∏
                    if (openHands.length === 2) {
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                        this.twoHandsFrameCount++;

                        // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä—É–∫ –¥–ª—è —É–≥–ª–∞ –∏ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è (–±–µ–∑ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è)
                        // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ —Ü–µ–Ω—Ç—Ä–∞ –º–æ–ª–µ–∫—É–ª—ã
                        const rawHand1 = openHands[0];
                        const rawHand2 = openHands[1];

                        this.isGrabbed = true;

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Ä—É–∫ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                        this.editingHands = {
                            hand1: { x: rawHand1.x, y: rawHand1.y },
                            hand2: { x: rawHand2.x, y: rawHand2.y }
                        };

                        // === –î–ï–§–û–†–ú–ê–¶–ò–Ø: –º–µ–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä—É–∫–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã ===
                        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
                        if (this.twoHandsFrameCount >= this.STABLE_HANDS_THRESHOLD) {
                            // –í–µ–∫—Ç–æ—Ä –º–µ–∂–¥—É —Ä—É–∫–∞–º–∏
                            const handsVecX = rawHand2.x - rawHand1.x;
                            const handsVecY = rawHand2.y - rawHand1.y;
                            const handsDist = Math.sqrt(handsVecX * handsVecX + handsVecY * handsVecY);

                            // –£–ì–û–õ: –ø—Ä—è–º–æ –æ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è —Ä—É–∫, –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫
                            this.deformAngle = Math.atan2(handsVecY, handsVecX);

                            // –†–ê–°–¢–Ø–ñ–ï–ù–ò–ï –í–î–û–õ–¨ –û–°–ò –†–£–ö (X –≤ –ø–æ–≤—ë—Ä–Ω—É—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
                            // –ü—Ä—è–º–∞—è –ø—Ä–æ–ø–æ—Ä—Ü–∏—è: handsDist / baseSize
                            const baseStretch = handsDist / this.size;
                            this.stretchX = Math.max(0.2, Math.min(5.0, baseStretch));

                            // –°–ñ–ê–¢–ò–ï –ü–û–ü–ï–†–Å–ö (Y –≤ –ø–æ–≤—ë—Ä–Ω—É—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
                            // –ö–æ–≥–¥–∞ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –≤–¥–æ–ª—å - —Å–∂–∏–º–∞–µ–º –ø–æ–ø–µ—Ä—ë–∫ (–∫–∞–∫ —Ä–µ–∑–∏–Ω–∫–∞)
                            if (this.stretchX > 1.2) {
                                // –ï—Å–ª–∏ —Ä–∞—Å—Ç—è–Ω—É—Ç–∞ - —Å–∂–∏–º–∞–µ–º –ø–æ–ø–µ—Ä—ë–∫
                                this.stretchY = Math.max(0.3, 1.0 / Math.sqrt(this.stretchX));
                            } else if (this.stretchX < 0.8) {
                                // –ï—Å–ª–∏ —Å–∂–∞—Ç–∞ –≤–¥–æ–ª—å - —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –ø–æ–ø–µ—Ä—ë–∫
                                this.stretchY = Math.min(2.5, 1.0 / Math.sqrt(this.stretchX));
                            } else {
                                // –ë–ª–∏–∑–∫–æ –∫ 1.0 - –ø–æ—á—Ç–∏ –∫—Ä—É–≥–ª–∞—è
                                this.stretchY = 1.0;
                            }
                        }
                        // –ï—Å–ª–∏ —Ä—É–∫–∏ –µ—â—ë –Ω–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã - —Ñ–æ—Ä–º–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å

                        // === –ü–û–ó–ò–¶–ò–Ø –ò –†–ê–ó–ú–ï–†: –º–æ–∂–µ–º —Å–≥–ª–∞–¥–∏—Ç—å –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ ===

                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ª—ë–≥–∫–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∫ –ø–æ–∑–∏—Ü–∏—è–º (–Ω–µ –∫ —É–≥–ª—É!)
                        const smoothedHands = smoothHandPositions(openHands);
                        const hand1 = smoothedHands[0];
                        const hand2 = smoothedHands[1];

                        // –¶–µ–Ω—Ç—Ä –º–µ–∂–¥—É –¥–≤—É–º—è —Ä—É–∫–∞–º–∏ (—Å–≥–ª–∞–∂–µ–Ω–Ω—ã–π –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è)
                        const centerX = (hand1.x + hand2.x) / 2;
                        const centerY = (hand1.y + hand2.y) / 2;

                        this.targetX = centerX;
                        this.targetY = centerY;

                        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–ó–ú–ï–†–û–ú - —Å—Ä–µ–¥–Ω—è—è —à–∏—Ä–∏–Ω–∞ –ª–∞–¥–æ–Ω–µ–π
                        const avgHandWidth = (hand1.handWidth + hand2.handWidth) / 2;
                        const newSize = Math.max(30, Math.min(600, avgHandWidth * 800));
                        this.targetSize = newSize;
                    } else if (openHands.length === 1) {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –µ—Å–ª–∏ –≤–∏–¥–∏–º –æ–¥–Ω—É —Ä—É–∫—É
                        this.twoHandsFrameCount = 0;
                        // –û–¥–Ω–∞ —Ä—É–∫–∞ - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏ —Ä–∞–∑–º–µ—Ä
                        const hand = openHands[0];
                        const dist = Math.sqrt((this.x - hand.x) ** 2 + (this.y - hand.y) ** 2);

                        if (dist < 150) {
                            this.isGrabbed = true;
                            this.targetX = hand.x;
                            this.targetY = hand.y;

                            // –®–∏—Ä–∏–Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ª–∞–¥–æ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä
                            const newSize = Math.max(30, Math.min(600, hand.handWidth * 800));
                            this.targetSize = newSize;

                            // –§–æ—Ä–º–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–π —Ä—É–∫–æ–π
                            this.editingHands = null;
                        } else {
                            this.isGrabbed = false;
                            this.editingHands = null;
                        }
                    } else {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –µ—Å–ª–∏ —Ä—É–∫ –Ω–µ—Ç –∏–ª–∏ –Ω–µ –≤–∏–¥–∏–º –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                        this.twoHandsFrameCount = 0;
                        this.isGrabbed = false;
                        this.editingHands = null;
                    }
                } else if (!this.isEditing && openHands.length === 1) {
                    // –û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ª–∞–¥–æ–Ω—å—é (—Ñ–æ—Ä–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è!)
                    const hand = openHands[0];
                    const dist = Math.sqrt((this.x - hand.x) ** 2 + (this.y - hand.y) ** 2);

                    if (dist < 120) {
                        this.isGrabbed = true;
                        this.targetX = hand.x;
                        this.targetY = hand.y;
                        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –§–æ—Ä–º–∞ –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
                    } else {
                        this.isGrabbed = false;
                    }
                } else {
                    // –ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä—É–∫ - –æ—Ç–ø—É—Å–∫–∞–µ–º
                    this.isGrabbed = false;
                }

                // –ì—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º margin —á—Ç–æ–±—ã –±–æ–ª—å—à–∏–µ –º–æ–ª–µ–∫—É–ª—ã –Ω–µ "—É–ª–µ—Ç–∞–ª–∏" –∑–∞ —ç–∫—Ä–∞–Ω
                const margin = Math.min(this.size * 1.5, 200);
                this.targetX = Math.max(margin, Math.min(width - margin, this.targetX));
                this.targetY = Math.max(margin, Math.min(height - margin, this.targetY));
            }

            // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º–æ–ª–µ–∫—É–ª—É (–¥–ª—è UI)
            unlock() {
                this.isLocked = false;
                this.isShapeLocked = false;
            }

            // –§—É–Ω–∫—Ü–∏—è –≤–ª–∏—è–Ω–∏—è –¥–ª—è –º–µ—Ç–∞–±–æ–ª–ª–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–æ–≤–æ—Ä–æ—Ç–∞ –∏ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è
            getInfluence(px, py) {
                // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –º–æ–ª–µ–∫—É–ª—ã
                const dx = px - this.x;
                const dy = py - this.y;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏–∏ –µ—Å–ª–∏ —É–≥–æ–ª –∏–∑–º–µ–Ω–∏–ª—Å—è
                if (this.deformAngle !== this._lastCachedAngle) {
                    this._cachedCos = Math.cos(-this.deformAngle);
                    this._cachedSin = Math.sin(-this.deformAngle);
                    this._lastCachedAngle = this.deformAngle;
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const rotatedX = dx * this._cachedCos - dy * this._cachedSin;
                const rotatedY = dx * this._cachedSin + dy * this._cachedCos;

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ –≤ –ø–æ–≤—ë—Ä–Ω—É—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                const stretchedX = rotatedX / this.stretchX;
                const stretchedY = rotatedY / this.stretchY;
                const distSq = stretchedX * stretchedX + stretchedY * stretchedY;

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤—É–∫–æ–≤—É—é –º–æ–¥—É–ª—è—Ü–∏—é (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∂–µ—Å—Ç–æ–≤)
                let audioMod = 1;
                if (config.audioEnabled && !editorMode) {
                    const angle = Math.atan2(dy, dx);
                    audioMod = 1 + Math.sin(angle * 3 + this.audioPhase) * audioLevel * config.audioSensitivity * 0.02;
                }

                const effectiveSize = this.size * audioMod;

                // mergeStrength —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è - –º–æ–ª–µ–∫—É–ª—ã "–¥–æ—Ç—è–≥–∏–≤–∞—é—Ç—Å—è" –¥–∞–ª—å—à–µ
                const effectiveRadius = effectiveSize * Math.sqrt(config.mergeStrength);
                const effectiveRadiusSq = effectiveRadius * effectiveRadius;

                if (distSq > effectiveRadiusSq * 4) return 0;

                // Smooth kernel –¥–ª—è –º–µ—Ç–∞–±–æ–ª–ª–æ–≤
                return effectiveRadiusSq / (distSq + effectiveRadiusSq);
            }
        }

        // === –°–ò–°–¢–ï–ú–ê –°–õ–ò–Ø–ù–ò–Ø –ú–û–õ–ï–ö–£–õ ===

        // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ–ª–∂–Ω—ã –ª–∏ –¥–≤–µ –º–æ–ª–µ–∫—É–ª—ã —Å–ª–∏—Ç—å—Å—è
        function shouldMergeMolecules(mol1, mol2) {
            // –ù–µ —Å–ª–∏–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –º–æ–ª–µ–∫—É–ª—ã
            if (mol1.isLocked || mol2.isLocked) return false;
            if (mol1.isEditing || mol2.isEditing) return false;

            // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ü–µ–Ω—Ç—Ä–∞–º–∏
            const dx = mol2.x - mol1.x;
            const dy = mol2.y - mol1.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // –ü–æ—Ä–æ–≥ —Å–ª–∏—è–Ω–∏—è: —Å—É–º–º–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ √ó 0.3
            // –°–¢–†–û–ì–ò–ô –ü–û–†–û–ì: –º–æ–ª–µ–∫—É–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –û–ß–ï–ù–¨ –±–ª–∏–∑–∫–æ, –ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å—Å—è
            // –ü—Ä–∏ 0.3 —Ü–µ–Ω—Ç—Ä—ã –º–æ–ª–µ–∫—É–ª –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ < 30% –æ—Ç —Å—É–º–º—ã —Ä–∞–∑–º–µ—Ä–æ–≤
            // –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–≤–µ –º–æ–ª–µ–∫—É–ª—ã –ø–æ 100px: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å < 60px –¥–ª—è —Å–ª–∏—è–Ω–∏—è
            const mergeThreshold = (mol1.size + mol2.size) * 0.3;

            // –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
            if (distance >= mergeThreshold) return false;

            // === –ó–ê–©–ò–¢–ê –û–¢ –°–õ–ò–Ø–ù–ò–Ø –ö–†–ï–°–¢–û–û–ë–†–ê–ó–ù–´–• –§–û–†–ú ===
            // –ï—Å–ª–∏ –º–æ–ª–µ–∫—É–ª—ã –≤—ã—Ç—è–Ω—É—Ç—ã –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ (–∫–∞–∫ –≤ –∫—Ä–µ—Å—Ç–∏–∫–µ),
            // –æ–Ω–∏ –ù–ï –¥–æ–ª–∂–Ω—ã —Å–ª–∏–≤–∞—Ç—å—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Ü–µ–Ω—Ç—Ä—ã –±–ª–∏–∑–∫–æ

            const isStretched1 = mol1.stretchX > 1.5; // –ú–æ–ª–µ–∫—É–ª–∞ 1 –≤—ã—Ç—è–Ω—É—Ç–∞
            const isStretched2 = mol2.stretchX > 1.5; // –ú–æ–ª–µ–∫—É–ª–∞ 2 –≤—ã—Ç—è–Ω—É—Ç–∞

            // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –º–æ–ª–µ–∫—É–ª–∞ —Å–∏–ª—å–Ω–æ –≤—ã—Ç—è–Ω—É—Ç–∞
            if (isStretched1 || isStretched2) {
                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É —É–≥–ª–æ–≤
                let angleDiff = Math.abs(mol1.deformAngle - mol2.deformAngle);

                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–∞–∑–Ω–∏—Ü—É —É–≥–ª–æ–≤ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [0, œÄ]
                while (angleDiff > Math.PI) angleDiff -= Math.PI;
                if (angleDiff > Math.PI / 2) angleDiff = Math.PI - angleDiff;

                // –ï—Å–ª–∏ —É–≥–ª—ã –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –Ω–∞ ~90¬∞ (¬± 30¬∞), —ç—Ç–æ –∫—Ä–µ—Å—Ç - –ù–ï —Å–ª–∏–≤–∞–µ–º
                const isPerpendicular = Math.abs(angleDiff - Math.PI / 2) < Math.PI / 6; // ¬±30¬∞

                if (isPerpendicular) {
                    return false; // –ö—Ä–µ—Å—Ç–æ–æ–±—Ä–∞–∑–Ω–∞—è —Ñ–æ—Ä–º–∞ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–µ –º–æ–ª–µ–∫—É–ª—ã
                }

                // –¢–∞–∫–∂–µ –ù–ï —Å–ª–∏–≤–∞–µ–º –µ—Å–ª–∏ —É–≥–ª—ã –ø–æ—á—Ç–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ (~0¬∞ –∏–ª–∏ ~180¬∞)
                // –Ω–æ –º–æ–ª–µ–∫—É–ª—ã –≤—ã—Ç—è–Ω—É—Ç—ã —Å–ª–∞–±–æ –≤ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
                // (—ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏)
                const isParallel = angleDiff < Math.PI / 6; // ¬±30¬∞
                const isAntiParallel = Math.abs(angleDiff - Math.PI) < Math.PI / 6;

                if (isParallel || isAntiParallel) {
                    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –≤—ã—Ç—è–Ω—É—Ç—ã–µ –º–æ–ª–µ–∫—É–ª—ã –º–æ–≥—É—Ç —Å–ª–∏–≤–∞—Ç—å—Å—è
                    // (—ç—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
                    return true;
                }
            }

            // –ï—Å–ª–∏ –º–æ–ª–µ–∫—É–ª—ã –Ω–µ –≤—ã—Ç—è–Ω—É—Ç—ã –∏–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –æ–¥–∏–Ω–∞–∫–æ–≤–æ - —Å–ª–∏–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
            return true;
        }

        // –°–ª–∏–≤–∞–µ—Ç –¥–≤–µ –º–æ–ª–µ–∫—É–ª—ã –≤ –æ–¥–Ω—É –Ω–æ–≤—É—é
        // –°–º–µ—à–∏–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ RGB —Å –≤–µ—Å–∞–º–∏
        function blendColors(color1, color2, weight1, weight2) {
            if (!color1 && !color2) return null;
            if (!color1) return color2;
            if (!color2) return color1;

            // –ü–∞—Ä—Å–∏–º —Ü–≤–µ—Ç–∞ –∏–∑ HEX –≤ RGB
            const parseColor = (hex) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return { r, g, b };
            };

            const c1 = parseColor(color1);
            const c2 = parseColor(color2);

            // –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ RGB
            const r = Math.round(c1.r * weight1 + c2.r * weight2);
            const g = Math.round(c1.g * weight1 + c2.g * weight2);
            const b = Math.round(c1.b * weight1 + c2.b * weight2);

            // –û–±—Ä–∞—Ç–Ω–æ –≤ HEX
            const toHex = (n) => {
                const hex = n.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };

            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        function mergeMolecules(mol1, mol2) {
            // –í—ã—á–∏—Å–ª—è–µ–º –≤–µ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–æ—â–∞–¥–∏ (size¬≤)
            const area1 = mol1.size * mol1.size;
            const area2 = mol2.size * mol2.size;
            const totalArea = area1 + area2;
            const weight1 = area1 / totalArea;
            const weight2 = area2 / totalArea;

            // –ü–û–ó–ò–¶–ò–Ø: –í–∑–≤–µ—à–µ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä –º–∞—Å—Å
            const newX = mol1.x * weight1 + mol2.x * weight2;
            const newY = mol1.y * weight1 + mol2.y * weight2;

            // –†–ê–ó–ú–ï–†: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å
            // newArea = area1 + area2
            // newSize¬≤ = size1¬≤ + size2¬≤
            const newSize = Math.sqrt(area1 + area2);

            // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –º–æ–ª–µ–∫—É–ª—É
            const merged = new Molecule(newX, newY, newSize);

            // –§–û–†–ú–ê: –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–π
            // –ë–æ–ª—å—à–∞—è –º–æ–ª–µ–∫—É–ª–∞ –∏–º–µ–µ—Ç –±–æ–ª—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ñ–æ—Ä–º—É
            merged.stretchX = mol1.stretchX * weight1 + mol2.stretchX * weight2;
            merged.stretchY = mol1.stretchY * weight1 + mol2.stretchY * weight2;

            // –£–ì–û–õ: –£—Å—Ä–µ–¥–Ω—è–µ–º —É–≥–ª—ã (—É—á–∏—Ç—ã–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å)
            // –ü–µ—Ä–µ–≤–æ–¥–∏–º —É–≥–ª—ã –≤ –≤–µ–∫—Ç–æ—Ä—ã, —É—Å—Ä–µ–¥–Ω—è–µ–º, –ø–µ—Ä–µ–≤–æ–¥–∏–º –æ–±—Ä–∞—Ç–Ω–æ
            const angle1X = Math.cos(mol1.deformAngle);
            const angle1Y = Math.sin(mol1.deformAngle);
            const angle2X = Math.cos(mol2.deformAngle);
            const angle2Y = Math.sin(mol2.deformAngle);

            const avgAngleX = angle1X * weight1 + angle2X * weight2;
            const avgAngleY = angle1Y * weight1 + angle2Y * weight2;
            merged.deformAngle = Math.atan2(avgAngleY, avgAngleX);

            // –°–ö–û–†–û–°–¢–¨: –£—Å—Ä–µ–¥–Ω—è–µ–º (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–ø—É–ª—å—Å–∞)
            merged.vx = mol1.vx * weight1 + mol2.vx * weight2;
            merged.vy = mol1.vy * weight1 + mol2.vy * weight2;
            merged.targetX = newX;
            merged.targetY = newY;

            // –ó–í–£–ö: –£—Å—Ä–µ–¥–Ω—è–µ–º —Ñ–∞–∑—É
            merged.audioPhase = (mol1.audioPhase + mol2.audioPhase) / 2;

            // –¶–í–ï–¢–ê: –°–º–µ—à–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –≤–∑–≤–µ—à–µ–Ω–Ω–æ
            merged.fillColor = blendColors(mol1.fillColor, mol2.fillColor, weight1, weight2);
            merged.edgeColor = blendColors(mol1.edgeColor, mol2.edgeColor, weight1, weight2);

            // –≠–§–§–ï–ö–¢–´: –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –º–æ–ª–µ–∫—É–ª–∞ –∏–º–µ–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç - –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            merged.emboss = mol1.emboss || mol2.emboss;

            return merged;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–∏—è–Ω–∏—è –º–æ–ª–µ–∫—É–ª
        function checkAndMergeMolecules() {
            let merged = false;

            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º –º–æ–ª–µ–∫—É–ª
            for (let i = 0; i < molecules.length; i++) {
                for (let j = i + 1; j < molecules.length; j++) {
                    const mol1 = molecules[i];
                    const mol2 = molecules[j];

                    if (shouldMergeMolecules(mol1, mol2)) {
                        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—É—é –º–æ–ª–µ–∫—É–ª—É
                        const newMolecule = mergeMolecules(mol1, mol2);

                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–æ–ª–µ–∫—É–ª—ã
                        molecules.splice(j, 1); // –£–¥–∞–ª—è–µ–º j —Å–Ω–∞—á–∞–ª–∞ (–±–æ–ª—å—à–∏–π –∏–Ω–¥–µ–∫—Å)
                        molecules.splice(i, 1); // –ü–æ—Ç–æ–º i

                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é
                        molecules.push(newMolecule);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–æ–ª–µ–∫—É–ª—ã –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ hovered
                        if (hoveredMolecule === mol1 || hoveredMolecule === mol2) {
                            hoveredMolecule = newMolecule;
                        }
                        if (lastHoveredMolecule === mol1 || lastHoveredMolecule === mol2) {
                            lastHoveredMolecule = newMolecule;
                        }
                        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: editingMolecule –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º, —Ç.–∫. —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –º–æ–ª–µ–∫—É–ª—ã
                        // –Ω–µ –º–æ–≥—É—Ç —Å–ª–∏–≤–∞—Ç—å—Å—è (—Å–º. shouldMergeMolecules)

                        merged = true;
                        break;
                    }
                }
                if (merged) break; // –í—ã—Ö–æ–¥–∏–º –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ü–∏–∫–ª–∞
            }

            // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–ª–∏—è–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—â—ë —Ä–∞–∑ (–º–æ–≥—É—Ç –±—ã—Ç—å —Ü–µ–ø–Ω—ã–µ —Å–ª–∏—è–Ω–∏—è)
            if (merged) {
                checkAndMergeMolecules();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ
        async function setupAudio() {
            console.log('–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∞—É–¥–∏–æ...');
            try {
                console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω!', stream);

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);

                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                microphone.connect(analyser);

                // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
                const audioBars = document.getElementById('audioBars');
                for (let i = 0; i < 10; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'audio-bar';
                    audioBars.appendChild(bar);
                }

                console.log('–ê—É–¥–∏–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                console.error('–ò–º—è –æ—à–∏–±–∫–∏:', error.name);
                console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
                return false;
            }
        }

        // –ê–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ
        function analyzeAudio() {
            if (!analyser || !dataArray) return;

            analyser.getByteFrequencyData(dataArray);

            // –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            audioLevel = (sum / dataArray.length) / 255;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            const bars = document.querySelectorAll('.audio-bar');
            bars.forEach((bar, i) => {
                const value = dataArray[i * Math.floor(dataArray.length / bars.length)] / 255;
                bar.style.height = `${value * 100}%`;
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ–Ω–∞ (—Ü–≤–µ—Ç –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
        function renderBackgroundToCache() {
            // –°–æ–∑–¥–∞—ë–º OffscreenCanvas –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ä–∞–∑–º–µ—Ä
            if (!backgroundCache || backgroundCache.width !== width || backgroundCache.height !== height) {
                backgroundCache = new OffscreenCanvas(width, height);
                backgroundCacheCtx = backgroundCache.getContext('2d');
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ñ–æ–Ω –≤ –∫–µ—à
            if (backgroundType === 'color') {
                backgroundCacheCtx.fillStyle = backgroundColor;
                backgroundCacheCtx.fillRect(0, 0, width, height);
            } else if (backgroundType === 'image' && backgroundImage) {
                const imgAspect = backgroundImage.width / backgroundImage.height;
                const canvasAspect = width / height;
                let drawWidth, drawHeight, offsetX, offsetY;

                if (imgAspect > canvasAspect) {
                    drawHeight = height;
                    drawWidth = height * imgAspect;
                    offsetX = (width - drawWidth) / 2;
                    offsetY = 0;
                } else {
                    drawWidth = width;
                    drawHeight = width / imgAspect;
                    offsetX = 0;
                    offsetY = (height - drawHeight) / 2;
                }

                backgroundCacheCtx.drawImage(backgroundImage, offsetX, offsetY, drawWidth, drawHeight);
            } else {
                // –ë–µ–ª—ã–π —Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                backgroundCacheCtx.fillStyle = '#ffffff';
                backgroundCacheCtx.fillRect(0, 0, width, height);
            }

            backgroundCacheValid = true;
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–ª–æ–≤ —á–µ—Ä–µ–∑ marching squares
        function drawMetaballs() {
            // –ù–£–õ–ï–í–û–ô –°–õ–û–ô: –§–æ–Ω (—Ä–∏—Å—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –≤–∫–ª—é—á–µ–Ω–æ "–ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ")
            // –í —Ä–µ–∂–∏–º–µ "–ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ" —Ñ–æ–Ω —É–∂–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω –≤ animate() - —ç—Ç–æ –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã
            if (!config.showVideo) {
                if (backgroundType === 'video' && backgroundImage) {
                    // –í–∏–¥–µ–æ —Ñ–æ–Ω —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä (–Ω–µ –∫–µ—à–∏—Ä—É–µ–º)
                    const vidAspect = backgroundImage.videoWidth / backgroundImage.videoHeight;
                    const canvasAspect = width / height;
                    let drawWidth, drawHeight, offsetX, offsetY;

                    if (vidAspect > canvasAspect) {
                        drawHeight = height;
                        drawWidth = height * vidAspect;
                        offsetX = (width - drawWidth) / 2;
                        offsetY = 0;
                    } else {
                        drawWidth = width;
                        drawHeight = width / vidAspect;
                        offsetX = 0;
                        offsetY = (height - drawHeight) / 2;
                    }

                    ctx.drawImage(backgroundImage, offsetX, offsetY, drawWidth, drawHeight);
                } else {
                    // –î–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à
                    if (!backgroundCacheValid) {
                        renderBackgroundToCache();
                    }
                    // –ü—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω
                    ctx.drawImage(backgroundCache, 0, 0);
                }
            }

            if (molecules.length === 0) return;

            // –°—Ç—Ä–æ–∏–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ö–µ—à –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            const spatialHashStartTime = performance.now();
            buildSpatialHash();
            const spatialHashTime = performance.now() - spatialHashStartTime;

            // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –ò –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏—Ö –º–æ–ª–µ–∫—É–ª
            const cols = Math.ceil(width / gridResolution) + 1;
            const rows = Math.ceil(height / gridResolution) + 1;
            const field = [];
            const dominantMolecule = []; // –ú–æ–ª–µ–∫—É–ª–∞ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –≤–ª–∏—è–Ω–∏–µ–º –≤ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–µ

            // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–ª–µ –≤–ª–∏—è–Ω–∏—è –∏ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ –º–æ–ª–µ–∫—É–ª—ã
            for (let i = 0; i < rows; i++) {
                field[i] = [];
                dominantMolecule[i] = [];
                for (let j = 0; j < cols; j++) {
                    const x = j * gridResolution;
                    const y = i * gridResolution;
                    let sum = 0;
                    let maxInfluence = 0;
                    let dominantMol = null;

                    // –°—É–º–º–∏—Ä—É–µ–º –≤–ª–∏—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –±–ª–∏–∑–∫–∏—Ö –º–æ–ª–µ–∫—É–ª (–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
                    const nearbyMolecules = getNearbyMolecules(x, y);
                    for (const mol of nearbyMolecules) {
                        const influence = mol.getInfluence(x, y);
                        sum += influence;

                        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –º–æ–ª–µ–∫—É–ª—É —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –≤–ª–∏—è–Ω–∏–µ–º
                        if (influence > maxInfluence) {
                            maxInfluence = influence;
                            dominantMol = mol;
                        }
                    }

                    field[i][j] = sum;
                    dominantMolecule[i][j] = dominantMol;
                }
            }

            // –ò–°–ü–†–ê–í–õ–ï–ù–û: Threshold —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫, —á—Ç–æ–±—ã –æ–¥–∏–Ω–æ—á–Ω–∞—è –º–æ–ª–µ–∫—É–ª–∞
            // —Å–æ—Ö—Ä–∞–Ω—è–ª–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —Ä–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è
            // –§–æ—Ä–º—É–ª–∞: –ø—Ä–∏ mergeStrength=1 threshold=0.5, –ø—Ä–∏ mergeStrength=2 threshold=0.667
            // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–ª–µ–∫—É–ª–∞–º —Å–ª–∏–≤–∞—Ç—å—Å—è –Ω–∞ –±–æ–ª—å—à–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º mergeStrength
            const threshold = config.mergeStrength / (1 + config.mergeStrength);

            // –ü–ï–†–í–´–ô –°–õ–û–ô: –ì–ª–∞–¥–∫–∞—è –∑–∞–ª–∏–≤–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –æ–±–ª–∞—Å—Ç–µ–π
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∏–∫—Å–µ–ª—è–º —Å–µ—Ç–∫–∏ –∏ –∑–∞–ª–∏–≤–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≥–ª–∞–¥–∫–æ
            const fillResolution = 4; // –®–∞–≥ –¥–ª—è –∑–∞–ª–∏–≤–∫–∏ (–ø–∏–∫—Å–µ–ª–∏)

            for (let py = 0; py < height; py += fillResolution) {
                for (let px = 0; px < width; px += fillResolution) {
                    // –í—ã—á–∏—Å–ª—è–µ–º –≤–ª–∏—è–Ω–∏–µ –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
                    let totalInfluence = 0;
                    let maxInfluence = 0;
                    let dominantMol = null;

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
                    const nearbyMolecules = getNearbyMolecules(px, py);
                    for (const mol of nearbyMolecules) {
                        const influence = mol.getInfluence(px, py);
                        totalInfluence += influence;

                        if (influence > maxInfluence) {
                            maxInfluence = influence;
                            dominantMol = mol;
                        }
                    }

                    // –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç—É—Ä–∞ (–≤–ª–∏—è–Ω–∏–µ –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞) –∏ –µ—Å—Ç—å fillColor
                    if (totalInfluence >= threshold && dominantMol && dominantMol.fillColor) {
                        ctx.fillStyle = dominantMol.fillColor;
                        ctx.fillRect(px, py, fillResolution, fillResolution);
                    }
                }
            }

            // –í–¢–û–†–û–ô –°–õ–û–ô: Marching squares —Å –±–ª–æ—á–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º –Ω–∞ –∫–æ–Ω—Ç—É—Ä–∞—Ö
            ctx.fillStyle = '#f5f5f5';
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 2.5;

            for (let i = 0; i < rows - 1; i++) {
                for (let j = 0; j < cols - 1; j++) {
                    const x = j * gridResolution;
                    const y = i * gridResolution;

                    const tl = field[i][j] >= threshold ? 1 : 0;
                    const tr = field[i][j + 1] >= threshold ? 1 : 0;
                    const br = field[i + 1][j + 1] >= threshold ? 1 : 0;
                    const bl = field[i + 1][j] >= threshold ? 1 : 0;

                    const cellIndex = tl * 8 + tr * 4 + br * 2 + bl * 1;

                    if (cellIndex === 0 || cellIndex === 15) continue;

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∫–æ–Ω—Ç—É—Ä–∞ –¥–ª—è —ç—Ç–æ–π —è—á–µ–π–∫–∏ (–ø–æ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–π –º–æ–ª–µ–∫—É–ª–µ –≤ —Ü–µ–Ω—Ç—Ä–µ)
                    const centerMol = dominantMolecule[i][j];
                    const cellEdgeColor = (centerMol && centerMol.edgeColor) ? centerMol.edgeColor : null;

                    // –†–∏—Å—É–µ–º —è—á–µ–π–∫—É —Å –±–ª–æ—á–Ω–æ–π –∑–∞–ª–∏–≤–∫–æ–π –∫–æ–Ω—Ç—É—Ä–∞
                    drawMarchingSquareCell(x, y, cellIndex, field, i, j, threshold, cellEdgeColor);
                }
            }

            // –¢–†–ï–¢–ò–ô –°–õ–û–ô: –≠—Ñ—Ñ–µ–∫—Ç —Ç–∏—Å–Ω–µ–Ω–∏—è (Bevel & Emboss) - —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–ª—é–∑–∏–∏ —Ä–µ–ª—å–µ—Ñ–∞
            // –†–∏—Å—É–µ–º —Å–º–µ—â–µ–Ω–Ω—ã–µ —Å–≤–µ—Ç–ª—ã–µ –∏ —Ç–µ–º–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤—ã–ø—É–∫–ª–æ—Å—Ç–∏/–≤–æ–≥–Ω—É—Ç–æ—Å—Ç–∏

            // –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç—É—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏ –¥–ª—è –º–æ–ª–µ–∫—É–ª —Å —Ç–∏—Å–Ω–µ–Ω–∏–µ–º
            const embossContours = [];

            for (let i = 0; i < rows - 1; i++) {
                for (let j = 0; j < cols - 1; j++) {
                    const x = j * gridResolution;
                    const y = i * gridResolution;

                    const tl = field[i][j] >= threshold ? 1 : 0;
                    const tr = field[i][j + 1] >= threshold ? 1 : 0;
                    const br = field[i + 1][j + 1] >= threshold ? 1 : 0;
                    const bl = field[i + 1][j] >= threshold ? 1 : 0;

                    const cellIndex = tl * 8 + tr * 4 + br * 2 + bl * 1;

                    if (cellIndex === 0 || cellIndex === 15) continue;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–æ–ª–µ–∫—É–ª–∞ –∏–º–µ–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç —Ç–∏—Å–Ω–µ–Ω–∏—è
                    const centerMol = dominantMolecule[i][j];
                    if (!centerMol || !centerMol.emboss) continue;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç—É—Ä–Ω—ã—Ö –ª–∏–Ω–∏—è—Ö
                    embossContours.push({ x, y, i, j, cellIndex, mol: centerMol });
                }
            }

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç—É—Ä—ã —Å —Ç–∏—Å–Ω–µ–Ω–∏–µ–º - —Ä–∏—Å—É–µ–º —ç—Ñ—Ñ–µ–∫—Ç
            if (embossContours.length > 0) {
                const size = gridResolution;
                const embossDistance = 7; // –£–°–ò–õ–ï–ù–û: –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –≥–ª—É–±–∏–Ω—ã (–±—ã–ª–æ 3)
                const lightAngle = -135 * Math.PI / 180; // –£–≥–æ–ª —Å–≤–µ—Ç–∞ (—Å–≤–µ—Ä—Ö—É-—Å–ª–µ–≤–∞)
                const offsetX = Math.cos(lightAngle) * embossDistance;
                const offsetY = Math.sin(lightAngle) * embossDistance;

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞
                const getBgColor = () => {
                    if (backgroundType === 'color') {
                        return backgroundColor;
                    }
                    return '#f5f5f5'; // –î–µ—Ñ–æ–ª—Ç
                };

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å–≤–µ—Ç–ª–µ–Ω–∏—è/–∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞
                const adjustColor = (color, amount) => {
                    const r = parseInt(color.slice(1, 3), 16);
                    const g = parseInt(color.slice(3, 5), 16);
                    const b = parseInt(color.slice(5, 7), 16);

                    const newR = Math.max(0, Math.min(255, r + amount));
                    const newG = Math.max(0, Math.min(255, g + amount));
                    const newB = Math.max(0, Math.min(255, b + amount));

                    return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
                };

                // –õ–∏–Ω–∏–∏ –¥–ª—è marching squares
                const lines = {
                    1: [[3, 2]], 2: [[1, 2]], 3: [[3, 1]],
                    4: [[0, 1]], 5: [[0, 3], [1, 2]], 6: [[0, 2]],
                    7: [[0, 3]], 8: [[0, 3]], 9: [[0, 2]],
                    10: [[0, 1], [3, 2]], 11: [[0, 1]], 12: [[3, 1]],
                    13: [[1, 2]], 14: [[3, 2]]
                };

                function getEdgePoint(edge, i, j) {
                    const tl = field[i][j];
                    const tr = field[i][j + 1];
                    const br = field[i + 1][j + 1];
                    const bl = field[i + 1][j];
                    let t = 0.5;

                    switch(edge) {
                        case 0: // –í–µ—Ä—Ö
                            t = (threshold - tl) / (tr - tl);
                            return { x: t * size, y: 0 };
                        case 1: // –ü—Ä–∞–≤–æ
                            t = (threshold - tr) / (br - tr);
                            return { x: size, y: t * size };
                        case 2: // –ù–∏–∑
                            t = (threshold - bl) / (br - bl);
                            return { x: t * size, y: size };
                        case 3: // –õ–µ–≤–æ
                            t = (threshold - tl) / (bl - tl);
                            return { x: 0, y: t * size };
                    }
                }

                // –†–∏—Å—É–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞
                for (const contour of embossContours) {
                    const { x, y, i, j, cellIndex, mol } = contour;

                    if (!lines[cellIndex]) continue;

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç (—Ñ–æ–Ω –∏–ª–∏ –∑–∞–ª–∏–≤–∫–∞ –º–æ–ª–µ–∫—É–ª—ã)
                    const baseColor = mol.fillColor || getBgColor();

                    // –°–í–ï–¢–õ–´–ô –ö–û–ù–¢–£–† (—Å–º–µ—â–µ–Ω –≤ —Å—Ç–æ—Ä–æ–Ω—É —Å–≤–µ—Ç–∞)
                    ctx.strokeStyle = adjustColor(baseColor, 130); // –£–°–ò–õ–ï–ù–û: –°–≤–µ—Ç–ª–µ–µ (–±—ã–ª–æ 80)
                    ctx.lineWidth = 4.5; // –£–°–ò–õ–ï–ù–û: –¢–æ–ª—â–µ (–±—ã–ª–æ 2.5)
                    ctx.shadowColor = 'rgba(255, 255, 255, 0.9)'; // –£–°–ò–õ–ï–ù–û: –Ø—Ä—á–µ —Ç–µ–Ω—å (–±—ã–ª–æ 0.6)
                    ctx.shadowBlur = 6; // –£–°–ò–õ–ï–ù–û: –ú—è–≥—á–µ —Ç–µ–Ω—å (–±—ã–ª–æ 3)

                    ctx.beginPath();
                    for (const [e1, e2] of lines[cellIndex]) {
                        const p1 = getEdgePoint(e1, i, j);
                        const p2 = getEdgePoint(e2, i, j);
                        ctx.moveTo(x + p1.x + offsetX, y + p1.y + offsetY);
                        ctx.lineTo(x + p2.x + offsetX, y + p2.y + offsetY);
                    }
                    ctx.stroke();
                    ctx.shadowBlur = 0;

                    // –¢–ï–ú–ù–´–ô –ö–û–ù–¢–£–† (—Å–º–µ—â–µ–Ω –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ —Å–≤–µ—Ç—É)
                    ctx.strokeStyle = adjustColor(baseColor, -130); // –£–°–ò–õ–ï–ù–û: –¢–µ–º–Ω–µ–µ (–±—ã–ª–æ -80)
                    ctx.lineWidth = 4.5; // –£–°–ò–õ–ï–ù–û: –¢–æ–ª—â–µ (–±—ã–ª–æ 2.5)
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.9)'; // –£–°–ò–õ–ï–ù–û: –¢–µ–º–Ω–µ–µ —Ç–µ–Ω—å (–±—ã–ª–æ 0.6)
                    ctx.shadowBlur = 6; // –£–°–ò–õ–ï–ù–û: –ú—è–≥—á–µ —Ç–µ–Ω—å (–±—ã–ª–æ 3)

                    ctx.beginPath();
                    for (const [e1, e2] of lines[cellIndex]) {
                        const p1 = getEdgePoint(e1, i, j);
                        const p2 = getEdgePoint(e2, i, j);
                        ctx.moveTo(x + p1.x - offsetX, y + p1.y - offsetY);
                        ctx.lineTo(x + p2.x - offsetX, y + p2.y - offsetY);
                    }
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                }
            }

            // –ß–ï–¢–í–ï–†–¢–´–ô –°–õ–û–ô: –ú–∏–∫—Ä–æ-–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å—é –ø–ª–æ—â–∞–¥—å –º–æ–ª–µ–∫—É–ª—ã –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–º–∏ –ø–æ–ª–æ—Å–∫–∞–º–∏

            // –°–æ–±–∏—Ä–∞–µ–º –º–æ–ª–µ–∫—É–ª—ã —Å –º–∏–∫—Ä–æ–ø–æ–ª–æ—Å–∫–∞–º–∏
            const moleculesWithStripes = molecules.filter(mol => mol.microStripes);

            if (moleculesWithStripes.length > 0) {
                for (const mol of moleculesWithStripes) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –º–æ–ª–µ–∫—É–ª—ã
                    const stripeWidth = mol.stripeWidth || 2;
                    const stripeSpacing = mol.stripeSpacing || 3;
                    const color1 = mol.stripeColor1 || '#ff0000';
                    const color2 = mol.stripeColor2 || '#0000ff';

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º bounding box –º–æ–ª–µ–∫—É–ª—ã
                    let minX = Infinity, maxX = -Infinity;
                    let minY = Infinity, maxY = -Infinity;

                    // –ù–∞—Ö–æ–¥–∏–º –≥—Ä–∞–Ω–∏—Ü—ã –º–æ–ª–µ–∫—É–ª—ã –ø–æ –ø–æ–ª—é
                    for (let i = 0; i < rows; i++) {
                        for (let j = 0; j < cols; j++) {
                            if (dominantMolecule[i][j] === mol && field[i][j] >= threshold) {
                                const x = j * gridResolution;
                                const y = i * gridResolution;
                                minX = Math.min(minX, x);
                                maxX = Math.max(maxX, x);
                                minY = Math.min(minY, y);
                                maxY = Math.max(maxY, y);
                            }
                        }
                    }

                    if (minX === Infinity) continue;

                    // –ö–µ—à–∏—Ä—É–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
                    const cacheKey = `${color1}_${color2}`;
                    let colorStops;

                    if (mol._gradientCacheKey === cacheKey && mol._gradientCache) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞
                        colorStops = mol._gradientCache;
                    } else {
                        // –í—ã—á–∏—Å–ª—è–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
                        const r1 = parseInt(color1.slice(1, 3), 16);
                        const g1 = parseInt(color1.slice(3, 5), 16);
                        const b1 = parseInt(color1.slice(5, 7), 16);

                        const r2 = parseInt(color2.slice(1, 3), 16);
                        const g2 = parseInt(color2.slice(3, 5), 16);
                        const b2 = parseInt(color2.slice(5, 7), 16);

                        // –ü—Ä–µ–¥–≤—ã—á–∏—Å–ª—è–µ–º –≤—Å–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
                        const numStops = 10;
                        colorStops = [];
                        for (let i = 0; i <= numStops; i++) {
                            const t = i / numStops;
                            const baseR = r1 + (r2 - r1) * t;
                            const baseG = g1 + (g2 - g1) * t;
                            const baseB = b1 + (b2 - b1) * t;
                            colorStops.push({ t, baseR, baseG, baseB });
                        }

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
                        mol._gradientCache = colorStops;
                        mol._gradientCacheKey = cacheKey;
                    }

                    // –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –¥–ª—è –º–æ–ª–µ–∫—É–ª—ã
                    ctx.save();
                    ctx.beginPath();

                    // –û–±–≤–æ–¥–∏–º –∫–æ–Ω—Ç—É—Ä –º–æ–ª–µ–∫—É–ª—ã –¥–ª—è –º–∞—Å–∫–∏
                    for (let i = 0; i < rows - 1; i++) {
                        for (let j = 0; j < cols - 1; j++) {
                            if (dominantMolecule[i][j] !== mol) continue;

                            const x = j * gridResolution;
                            const y = i * gridResolution;

                            const tl = field[i][j] >= threshold ? 1 : 0;
                            const tr = field[i][j + 1] >= threshold ? 1 : 0;
                            const br = field[i + 1][j + 1] >= threshold ? 1 : 0;
                            const bl = field[i + 1][j] >= threshold ? 1 : 0;

                            // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–ª–∏–≤–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –º–æ–ª–µ–∫—É–ª—ã
                            if (tl || tr || br || bl) {
                                ctx.rect(x, y, gridResolution, gridResolution);
                            }
                        }
                    }

                    ctx.clip(); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –æ–±–ª–∞—Å—Ç—å—é –º–æ–ª–µ–∫—É–ª—ã

                    // –†–∏—Å—É–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
                    for (let x = minX - stripeSpacing; x <= maxX + stripeSpacing; x += stripeSpacing) {
                        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å–∫–∏ –æ—Ç color1 –∫ color2
                        const gradient = ctx.createLinearGradient(x, minY, x, maxY);

                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
                        for (const stop of colorStops) {
                            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã
                            const variation = (Math.sin(x * 0.1 + stop.t * Math.PI * 4) * 0.5 + 0.5) * 20 - 10;

                            const newR = Math.max(0, Math.min(255, stop.baseR + variation));
                            const newG = Math.max(0, Math.min(255, stop.baseG + variation));
                            const newB = Math.max(0, Math.min(255, stop.baseB + variation));

                            gradient.addColorStop(stop.t, `rgb(${newR}, ${newG}, ${newB})`);
                        }

                        ctx.fillStyle = gradient;
                        ctx.fillRect(x, minY, stripeWidth, maxY - minY);
                    }

                    ctx.restore();
                }
            }

            // –ü–Ø–¢–´–ô –°–õ–û–ô: –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–æ–ª–µ–∫—É–ª—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            if (editorMode && hoveredMoleculeEditor && (currentTool === 'fill' || currentTool === 'eraser')) {
                const mol = hoveredMoleculeEditor;

                // –†–∏—Å—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ –∫–æ–Ω—Ç—É—Ä—É –º–æ–ª–µ–∫—É–ª—ã
                ctx.save();
                ctx.translate(mol.x, mol.y);
                ctx.rotate(mol.deformAngle);

                // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
                ctx.strokeStyle = currentTool === 'fill' ? 'rgba(0, 150, 255, 0.8)' : 'rgba(255, 100, 100, 0.8)';
                ctx.lineWidth = 4;
                ctx.setLineDash([10, 5]);

                // –†–∏—Å—É–µ–º —ç–ª–ª–∏–ø—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                ctx.beginPath();
                ctx.ellipse(0, 0, mol.size * mol.stretchX, mol.size * mol.stretchY, 0, 0, Math.PI * 2);
                ctx.stroke();

                ctx.setLineDash([]);
                ctx.restore();

                // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ —Ä–µ–∂–∏–º–µ –∑–∞–ª–∏–≤–∫–∏
                if (currentTool === 'fill') {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.font = '14px Arial';
                    const hint = fillMode === 'interior' ? 'ü™£ –í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å' :
                                 fillMode === 'edge' ? 'ü™£ –ö–æ–Ω—Ç—É—Ä' : 'ü™£ –û–±–∞';
                    const metrics = ctx.measureText(hint);
                    ctx.fillText(hint, mol.x - metrics.width / 2, mol.y - mol.size - 10);
                }
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–¥–Ω–æ–π —è—á–µ–π–∫–∏ marching squares
        function drawMarchingSquareCell(x, y, cellIndex, field, i, j, threshold, edgeColor) {
            const size = gridResolution;

            // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –≥—Ä–∞–Ω—è—Ö
            function lerp(v0, v1, t) {
                return v0 + t * (v1 - v0);
            }

            function getEdgePoint(edge) {
                const tl = field[i][j];
                const tr = field[i][j + 1];
                const br = field[i + 1][j + 1];
                const bl = field[i + 1][j];

                let t = 0.5; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ—Ä–µ–¥–∏–Ω–∞

                switch(edge) {
                    case 0: // –í–µ—Ä—Ö
                        t = (threshold - tl) / (tr - tl);
                        return { x: lerp(x, x + size, t), y: y };
                    case 1: // –ü—Ä–∞–≤–æ
                        t = (threshold - tr) / (br - tr);
                        return { x: x + size, y: lerp(y, y + size, t) };
                    case 2: // –ù–∏–∑
                        t = (threshold - bl) / (br - bl);
                        return { x: lerp(x, x + size, t), y: y + size };
                    case 3: // –õ–µ–≤–æ
                        t = (threshold - tl) / (bl - tl);
                        return { x: x, y: lerp(y, y + size, t) };
                }
            }

            // –õ–∏–Ω–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π marching squares
            const lines = {
                1: [[3, 2]], 2: [[1, 2]], 3: [[3, 1]],
                4: [[0, 1]], 5: [[0, 3], [1, 2]], 6: [[0, 2]],
                7: [[0, 3]], 8: [[0, 3]], 9: [[0, 2]],
                10: [[0, 1], [3, 2]], 11: [[0, 1]], 12: [[3, 1]],
                13: [[1, 2]], 14: [[3, 2]]
            };

            if (!lines[cellIndex]) return;

            // –ë–õ–û–ß–ù–´–ô –≠–§–§–ï–ö–¢: –†–∏—Å—É–µ–º –±–ª–æ—á–Ω—É—é –∑–∞–ª–∏–≤–∫—É —Ç–æ–ª—å–∫–æ –Ω–∞ –∫—Ä–∞–µ–≤—ã—Ö —è—á–µ–π–∫–∞—Ö
            // (—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è –∫–æ–Ω—Ç—É—Ä–æ–º - 1-2 –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —É–≥–ª–∞)
            // –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –∫—Ä—É—Ç–æ–π –ø–∏–∫—Å–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö
            if (edgeColor) {
                const tl = field[i][j] >= threshold;
                const tr = field[i][j + 1] >= threshold;
                const br = field[i + 1][j + 1] >= threshold;
                const bl = field[i + 1][j] >= threshold;

                const filledCorners = [tl, tr, br, bl].filter(Boolean).length;

                // –ë–ª–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫ (1-2 —É–≥–ª–∞)
                // –≠—Ç–æ —è—á–µ–π–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è –∫–æ–Ω—Ç—É—Ä–æ–º
                if (filledCorners >= 1 && filledCorners <= 2) {
                    ctx.fillStyle = edgeColor;
                    ctx.fillRect(x, y, size, size);
                }
            }

            // –†–∏—Å—É–µ–º –∫–æ–Ω—Ç—É—Ä –ø–æ–≤–µ—Ä—Ö
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            for (const [e1, e2] of lines[cellIndex]) {
                const p1 = getEdgePoint(e1);
                const p2 = getEdgePoint(e2);
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
            }
            ctx.stroke();
        }

        // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–≤ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∂–µ—Å—Ç —Å—Ç–∞–±–∏–ª–µ–Ω –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –∫–∞–¥—Ä–∞—Ö
        function getStableGesture(handIndex, gestureName) {
            if (gestureHistory.length < GESTURE_HISTORY_SIZE) {
                return false; // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –∫–∞–¥—Ä–∞—Ö –∂–µ—Å—Ç –±—ã–ª –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º
            let consistentCount = 0;
            for (let i = 0; i < GESTURE_HISTORY_SIZE; i++) {
                const frame = gestureHistory[gestureHistory.length - 1 - i];
                if (frame && frame[handIndex] && frame[handIndex][gestureName]) {
                    consistentCount++;
                }
            }

            // –¢—Ä–µ–±—É–µ–º –º–∏–Ω–∏–º—É–º 4 –∏–∑ 5 –∫–∞–¥—Ä–æ–≤ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            return consistentCount >= 4;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ–±–µ–∏—Ö —Ä—É–∫ (–Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º—Å—è –∫ –∏–Ω–¥–µ–∫—Å—É —Ä—É–∫–∏)
        function checkStableTwoHands(gestureName) {
            if (hands.length !== 2) return false;
            if (gestureHistory.length < 3) return false; // –£–º–µ–Ω—å—à–∞–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 –∫–∞–¥—Ä–∞—Ö –±—ã–ª–æ —Ä–æ–≤–Ω–æ 2 —Ä—É–∫–∏ —Å –Ω—É–∂–Ω—ã–º –∂–µ—Å—Ç–æ–º
            let consistentCount = 0;
            for (let i = 0; i < Math.min(3, gestureHistory.length); i++) {
                const frame = gestureHistory[gestureHistory.length - 1 - i];
                if (frame && frame.length === 2) {
                    // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ä—É–∫ –∏–º–µ—é—Ç –Ω—É–∂–Ω—ã–π –∂–µ—Å—Ç –≤ —ç—Ç–æ–º –∫–∞–¥—Ä–µ
                    const handsWithGesture = frame.filter(h => h[gestureName]).length;
                    if (handsWithGesture === 2) {
                        consistentCount++;
                    }
                }
            }

            // –¢—Ä–µ–±—É–µ–º –º–∏–Ω–∏–º—É–º 2 –∏–∑ 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–∞–¥—Ä–æ–≤
            return consistentCount >= 2;
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∂–µ—Å—Ç–æ–≤
        function getPinchDistance(landmarks) {
            const thumb = landmarks[4];
            const index = landmarks[8];
            const dx = thumb.x - index.x;
            const dy = thumb.y - index.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // –ù–û–í–û–ï: –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è —â–∏–ø–∫–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —â–∏–ø–æ–∫, –∞ –Ω–µ –Ω–∞—á–∞–ª–æ –∫—É–ª–∞–∫–∞
        function isPinching(landmarks) {
            const pinchDist = getPinchDistance(landmarks);

            // –û—Å–Ω–æ–≤–Ω–æ–π –∫—Ä–∏—Ç–µ—Ä–∏–π - –±–æ–ª—å—à–æ–π –∏ —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–ª—å—Ü—ã –±–ª–∏–∑–∫–æ
            if (pinchDist >= 0.05) return false;

            // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥—Ä—É–≥–∏–µ –ø–∞–ª—å—Ü—ã –ù–ï —Å–∂–∞—Ç—ã –≤ –∫—É–ª–∞–∫
            // –ü—Ä–∏ –Ω–∞—Å—Ç–æ—è—â–µ–º —â–∏–ø–∫–µ —Å—Ä–µ–¥–Ω–∏–π, –±–µ–∑—ã–º—è–Ω–Ω—ã–π –∏ –º–∏–∑–∏–Ω–µ—Ü –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã
            const palmCenter = landmarks[9];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const pinkyTip = landmarks[20];

            // –†–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥—Ä—É–≥–∏—Ö –ø–∞–ª—å—Ü–µ–≤ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ª–∞–¥–æ–Ω–∏
            const middleFromPalm = Math.sqrt(
                (middleTip.x - palmCenter.x) ** 2 +
                (middleTip.y - palmCenter.y) ** 2
            );
            const ringFromPalm = Math.sqrt(
                (ringTip.x - palmCenter.x) ** 2 +
                (ringTip.y - palmCenter.y) ** 2
            );
            const pinkyFromPalm = Math.sqrt(
                (pinkyTip.x - palmCenter.x) ** 2 +
                (pinkyTip.y - palmCenter.y) ** 2
            );

            // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –ø–∞–ª—å—Ü–µ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã
            // –ï—Å–ª–∏ –ø–∞–ª–µ—Ü –¥–∞–ª–µ–∫–æ –æ—Ç –ª–∞–¥–æ–Ω–∏ - –æ–Ω –æ—Ç–∫—Ä—ã—Ç
            let openFingersCount = 0;
            if (middleFromPalm > 0.10) openFingersCount++;
            if (ringFromPalm > 0.09) openFingersCount++;
            if (pinkyFromPalm > 0.08) openFingersCount++;

            // –î–ª—è —â–∏–ø–∫–∞ –º–∏–Ω–∏–º—É–º 2 –∏–∑ 3 –ø–∞–ª—å—Ü–µ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫—É–ª–∞–∫–∞
            return openFingersCount >= 2;
        }

        // –ù–û–í–û–ï: –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –∑–∞–≥–Ω—É—Ç—ã—Ö –ø–∞–ª—å—Ü–µ–≤ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function detectFoldedFingers(landmarks) {
            const palmCenter = landmarks[9];
            const palm = landmarks[0];

            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞–ª—å—Ü–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º:
            // 1. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—á–∏–∫–∞ –æ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏—è (–ø—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–∏–±–∞)
            // 2. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—á–∏–∫–∞ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ª–∞–¥–æ–Ω–∏ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
            // 3. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏

            // –ë–û–õ–¨–®–û–ô –ü–ê–õ–ï–¶
            const thumbTip = landmarks[4];
            const thumbBase = landmarks[2];
            const thumbLength = Math.sqrt(
                (thumbTip.x - thumbBase.x) ** 2 +
                (thumbTip.y - thumbBase.y) ** 2
            );
            const thumbToPalm = Math.sqrt(
                (thumbTip.x - palmCenter.x) ** 2 +
                (thumbTip.y - palmCenter.y) ** 2
            );
            const thumbFolded = thumbLength < 0.065 || thumbToPalm < 0.11;

            // –£–ö–ê–ó–ê–¢–ï–õ–¨–ù–´–ô –ü–ê–õ–ï–¶
            const indexTip = landmarks[8];
            const indexBase = landmarks[5];
            const indexMid = landmarks[6];
            const indexLength = Math.sqrt(
                (indexTip.x - indexBase.x) ** 2 +
                (indexTip.y - indexBase.y) ** 2
            );
            const indexToPalm = Math.sqrt(
                (indexTip.x - palmCenter.x) ** 2 +
                (indexTip.y - palmCenter.y) ** 2
            );
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≥–æ–ª —Å–≥–∏–±–∞ —á–µ—Ä–µ–∑ —Å—Ä–µ–¥–Ω—é—é —Ñ–∞–ª–∞–Ω–≥—É
            const indexBend = Math.sqrt(
                (indexTip.x - indexMid.x) ** 2 +
                (indexTip.y - indexMid.y) ** 2
            );
            const indexFolded = (indexLength < 0.09 && indexToPalm < 0.14) || indexBend < 0.05;

            // –°–†–ï–î–ù–ò–ô –ü–ê–õ–ï–¶
            const middleTip = landmarks[12];
            const middleBase = landmarks[9];
            const middleMid = landmarks[10];
            const middleLength = Math.sqrt(
                (middleTip.x - middleBase.x) ** 2 +
                (middleTip.y - middleBase.y) ** 2
            );
            const middleToPalm = Math.sqrt(
                (middleTip.x - palmCenter.x) ** 2 +
                (middleTip.y - palmCenter.y) ** 2
            );
            const middleBend = Math.sqrt(
                (middleTip.x - middleMid.x) ** 2 +
                (middleTip.y - middleMid.y) ** 2
            );
            const middleFolded = (middleLength < 0.10 && middleToPalm < 0.14) || middleBend < 0.05;

            // –ë–ï–ó–´–ú–Ø–ù–ù–´–ô –ü–ê–õ–ï–¶
            const ringTip = landmarks[16];
            const ringBase = landmarks[13];
            const ringMid = landmarks[14];
            const ringLength = Math.sqrt(
                (ringTip.x - ringBase.x) ** 2 +
                (ringTip.y - ringBase.y) ** 2
            );
            const ringToPalm = Math.sqrt(
                (ringTip.x - palmCenter.x) ** 2 +
                (ringTip.y - palmCenter.y) ** 2
            );
            const ringBend = Math.sqrt(
                (ringTip.x - ringMid.x) ** 2 +
                (ringTip.y - ringMid.y) ** 2
            );
            const ringFolded = (ringLength < 0.09 && ringToPalm < 0.13) || ringBend < 0.05;

            // –ú–ò–ó–ò–ù–ï–¶
            const pinkyTip = landmarks[20];
            const pinkyBase = landmarks[17];
            const pinkyMid = landmarks[18];
            const pinkyLength = Math.sqrt(
                (pinkyTip.x - pinkyBase.x) ** 2 +
                (pinkyTip.y - pinkyBase.y) ** 2
            );
            const pinkyToPalm = Math.sqrt(
                (pinkyTip.x - palmCenter.x) ** 2 +
                (pinkyTip.y - palmCenter.y) ** 2
            );
            const pinkyBend = Math.sqrt(
                (pinkyTip.x - pinkyMid.x) ** 2 +
                (pinkyTip.y - pinkyMid.y) ** 2
            );
            const pinkyFolded = (pinkyLength < 0.07 && pinkyToPalm < 0.12) || pinkyBend < 0.04;

            return {
                thumb: thumbFolded,
                index: indexFolded,
                middle: middleFolded,
                ring: ringFolded,
                pinky: pinkyFolded
            };
        }

        function isHandOpen(landmarks) {
            // –£–õ–£–ß–®–ï–ù–û: –ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç–æ–π –ª–∞–¥–æ–Ω–∏
            const palm = landmarks[0];
            const palmCenter = landmarks[9];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—á–∏–∫–æ–≤ –ø–∞–ª—å—Ü–µ–≤ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ª–∞–¥–æ–Ω–∏
            const fingerTips = [
                { tip: landmarks[8], base: landmarks[5], name: 'index' },    // –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π
                { tip: landmarks[12], base: landmarks[9], name: 'middle' },  // –°—Ä–µ–¥–Ω–∏–π
                { tip: landmarks[16], base: landmarks[13], name: 'ring' },   // –ë–µ–∑—ã–º—è–Ω–Ω—ã–π
                { tip: landmarks[20], base: landmarks[17], name: 'pinky' }   // –ú–∏–∑–∏–Ω–µ—Ü
            ];

            let extendedCount = 0;
            fingerTips.forEach(finger => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞–ª–µ—Ü –≤—ã—Ç—è–Ω—É—Ç (–∫–æ–Ω—á–∏–∫ –¥–∞–ª–µ–∫–æ –æ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏—è)
                const tipToBase = Math.sqrt(
                    (finger.tip.x - finger.base.x) ** 2 +
                    (finger.tip.y - finger.base.y) ** 2
                );

                // –ò –ø–∞–ª–µ—Ü –¥–∞–ª–µ–∫–æ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ª–∞–¥–æ–Ω–∏
                const tipToPalm = Math.sqrt(
                    (finger.tip.x - palmCenter.x) ** 2 +
                    (finger.tip.y - palmCenter.y) ** 2
                );

                // –ü–∞–ª–µ—Ü —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –µ—Å–ª–∏ –æ–Ω –≤—ã—Ç—è–Ω—É—Ç –ò –¥–∞–ª–µ–∫–æ –æ—Ç –ª–∞–¥–æ–Ω–∏
                if (tipToBase > 0.07 && tipToPalm > 0.13) {
                    extendedCount++;
                }
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü –æ—Ç–¥–µ–ª—å–Ω–æ
            const thumbTip = landmarks[4];
            const thumbBase = landmarks[2];
            const thumbExtended = Math.sqrt(
                (thumbTip.x - thumbBase.x) ** 2 +
                (thumbTip.y - thumbBase.y) ** 2
            ) > 0.06;

            // –õ–∞–¥–æ–Ω—å –æ—Ç–∫—Ä—ã—Ç–∞ –µ—Å–ª–∏ –º–∏–Ω–∏–º—É–º 3 –ø–∞–ª—å—Ü–∞ (–Ω–µ —Å—á–∏—Ç–∞—è –±–æ–ª—å—à–æ–π) –≤—ã—Ç—è–Ω—É—Ç—ã
            // –ò–õ–ò –≤—Å–µ 4 –ø–∞–ª—å—Ü–∞ + –±–æ–ª—å—à–æ–π –≤—ã—Ç—è–Ω—É—Ç—ã
            return extendedCount >= 3 || (extendedCount >= 2 && thumbExtended);
        }

        function isHandFist(landmarks) {
            // –£–õ–£–ß–®–ï–ù–û: –ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–∞–∫–∞
            const palmCenter = landmarks[9];
            const palm = landmarks[0];

            const fingerPairs = [
                { tip: landmarks[8], base: landmarks[5], name: 'index' },    // –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π
                { tip: landmarks[12], base: landmarks[9], name: 'middle' },  // –°—Ä–µ–¥–Ω–∏–π
                { tip: landmarks[16], base: landmarks[13], name: 'ring' },   // –ë–µ–∑—ã–º—è–Ω–Ω—ã–π
                { tip: landmarks[20], base: landmarks[17], name: 'pinky' }   // –ú–∏–∑–∏–Ω–µ—Ü
            ];

            let closedCount = 0;
            fingerPairs.forEach(finger => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—á–∏–∫ –±–ª–∏–∑–∫–æ –∫ –æ—Å–Ω–æ–≤–∞–Ω–∏—é (–ø–∞–ª–µ—Ü —Å–æ–≥–Ω—É—Ç)
                const tipToBase = Math.sqrt(
                    (finger.tip.x - finger.base.x) ** 2 +
                    (finger.tip.y - finger.base.y) ** 2
                );

                // –ò –∫–æ–Ω—á–∏–∫ –ù–ï –¥–∞–ª–µ–∫–æ –æ—Ç –ª–∞–¥–æ–Ω–∏
                const tipToPalm = Math.sqrt(
                    (finger.tip.x - palmCenter.x) ** 2 +
                    (finger.tip.y - palmCenter.y) ** 2
                );

                // –ü–∞–ª–µ—Ü —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–∫—Ä—ã—Ç—ã–º –µ—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—á–∏–∫-–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –º–∞–ª–æ
                // –ò –∫–æ–Ω—á–∏–∫ –±–ª–∏–∑–∫–æ –∫ —Ü–µ–Ω—Ç—Ä—É –ª–∞–¥–æ–Ω–∏
                if (tipToBase < 0.09 && tipToPalm < 0.15) {
                    closedCount++;
                }
            });

            // –ë–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–Ω –±–ª–∏–∑–∫–æ –∫ –ª–∞–¥–æ–Ω–∏ –∏–ª–∏ —Å–æ–≥–Ω—É—Ç
            const thumbTip = landmarks[4];
            const thumbBase = landmarks[2];
            const thumbToPalm = Math.sqrt(
                (thumbTip.x - palmCenter.x) ** 2 +
                (thumbTip.y - palmCenter.y) ** 2
            );
            const thumbClosed = thumbToPalm < 0.13;

            // –£–õ–£–ß–®–ï–ù–û: –ö—É–ª–∞–∫ = –º–∏–Ω–∏–º—É–º 3 –ø–∞–ª—å—Ü–∞ —Å–æ–≥–Ω—É—Ç—ã –ò –±–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü —Ç–æ–∂–µ —Å–æ–≥–Ω—É—Ç
            // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –Ω–µ —â–∏–ø–æ–∫ (thumb –∏ index –Ω–µ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ)
            const thumbIndexDist = Math.sqrt(
                (thumbTip.x - landmarks[8].x) ** 2 +
                (thumbTip.y - landmarks[8].y) ** 2
            );
            const notPinching = thumbIndexDist > 0.06; // –ù–µ —â–∏–ø–æ–∫

            return closedCount >= 3 && thumbClosed && notPinching;
        }

        function isFingersCrossed(landmarks) {
            // –£–õ–£–ß–®–ï–ù–û v5: –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å—é
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const palm = landmarks[0];
            const palmCenter = landmarks[9];
            const indexBase = landmarks[5];
            const middleBase = landmarks[9];

            // 1. –ö–õ–Æ–ß–ï–í–û–ô –ö–†–ò–¢–ï–†–ò–ô: –ü–∞–ª—å—Ü—ã –±–ª–∏–∑–∫–æ –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É
            const fingersDist = Math.sqrt(
                (indexTip.x - middleTip.x) ** 2 +
                (indexTip.y - middleTip.y) ** 2
            );

            // 2. –û–±–∞ –ø–∞–ª—å—Ü–∞ –≤—ã—Ç—è–Ω—É—Ç—ã –æ—Ç –ª–∞–¥–æ–Ω–∏
            const indexFromPalm = Math.sqrt(
                (indexTip.x - palm.x) ** 2 +
                (indexTip.y - palm.y) ** 2
            );
            const middleFromPalm = Math.sqrt(
                (middleTip.x - palm.x) ** 2 +
                (middleTip.y - palm.y) ** 2
            );

            // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞–ª—å—Ü—ã –≤—ã—Ç—è–Ω—É—Ç—ã
            const indexLength = Math.sqrt(
                (indexTip.x - indexBase.x) ** 2 +
                (indexTip.y - indexBase.y) ** 2
            );
            const middleLength = Math.sqrt(
                (middleTip.x - middleBase.x) ** 2 +
                (middleTip.y - middleBase.y) ** 2
            );

            // 4. –ù–µ —â–∏–ø–æ–∫
            const thumbTip = landmarks[4];
            const thumbIndexDist = Math.sqrt(
                (thumbTip.x - indexTip.x) ** 2 +
                (thumbTip.y - indexTip.y) ** 2
            );

            // 5. –ù–µ –∫—É–ª–∞–∫
            const thumbToPalm = Math.sqrt(
                (thumbTip.x - palmCenter.x) ** 2 +
                (thumbTip.y - palmCenter.y) ** 2
            );

            // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ–±–∞ –ø–∞–ª—å—Ü–∞ –≤—ã—Ç—è–Ω—É—Ç—ã –û–î–ò–ù–ê–ö–û–í–û (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã)
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∫–æ–≥–¥–∞ –æ–¥–∏–Ω –ø–∞–ª–µ—Ü —Å–æ–≥–Ω—É—Ç
            const fingersEvenlyExtended = Math.abs(indexFromPalm - middleFromPalm) < 0.04;

            // –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò (–∑–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞):
            const fingersClose = fingersDist < 0.035;             // –ë–ê–õ–ê–ù–°: –º–µ–∂–¥—É —Å—Ç—Ä–æ–≥–∏–º (0.025) –∏ –º—è–≥–∫–∏–º (0.055)
            const bothExtended = indexFromPalm > 0.14 &&          // –ë–ê–õ–ê–ù–°: –º–µ–∂–¥—É 0.12 –∏ 0.15
                                middleFromPalm > 0.14;
            const bothLongEnough = indexLength > 0.075 &&         // –ë–ê–õ–ê–ù–°: –º–µ–∂–¥—É 0.07 –∏ 0.08
                                  middleLength > 0.075;
            const notPinching = thumbIndexDist > 0.055;           // –ß—É—Ç—å –º—è–≥—á–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            const notFist = thumbToPalm > 0.085;                  // –ë–ê–õ–ê–ù–°: –º–µ–∂–¥—É 0.08 –∏ 0.09

            return fingersClose &&
                   bothExtended &&
                   bothLongEnough &&
                   fingersEvenlyExtended &&  // –ù–û–í–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞!
                   notPinching &&
                   notFist;
        }

        // –î–µ—Ç–µ–∫—Ü–∏—è –º–∏–∑–∏–Ω—Ü–∞ (—Ç–æ–ª—å–∫–æ –º–∏–∑–∏–Ω–µ—Ü –ø–æ–¥–Ω—è—Ç)
        function isPinkyUp(landmarks) {
            const palm = landmarks[0];
            const palmCenter = landmarks[9];
            const pinkyTip = landmarks[20];
            const pinkyBase = landmarks[17];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const thumbTip = landmarks[4];

            // 1. –ú–∏–∑–∏–Ω–µ—Ü –≤—ã—Ç—è–Ω—É—Ç
            const pinkyExtended = Math.sqrt(
                (pinkyTip.x - pinkyBase.x) ** 2 +
                (pinkyTip.y - pinkyBase.y) ** 2
            ) > 0.05;

            // 2. –†–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç –ª–∞–¥–æ–Ω–∏
            const pinkyFromPalm = Math.sqrt(
                (pinkyTip.x - palmCenter.x) ** 2 +
                (pinkyTip.y - palmCenter.y) ** 2
            );
            const indexFromPalm = Math.sqrt(
                (indexTip.x - palmCenter.x) ** 2 +
                (indexTip.y - palmCenter.y) ** 2
            );
            const middleFromPalm = Math.sqrt(
                (middleTip.x - palmCenter.x) ** 2 +
                (middleTip.y - palmCenter.y) ** 2
            );
            const ringFromPalm = Math.sqrt(
                (ringTip.x - palmCenter.x) ** 2 +
                (ringTip.y - palmCenter.y) ** 2
            );
            const thumbFromPalm = Math.sqrt(
                (thumbTip.x - palmCenter.x) ** 2 +
                (thumbTip.y - palmCenter.y) ** 2
            );

            // –£–õ–£–ß–®–ï–ù–û v2: –ë–æ–ª–µ–µ –≥–∏–±–∫–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è
            // 3. –ú–∏–∑–∏–Ω–µ—Ü –¥–∞–ª—å—à–µ –æ—Ç –ª–∞–¥–æ–Ω–∏ —á–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞–ª—å—Ü—ã (–°–ú–Ø–ì–ß–ï–ù–û)
            const pinkyFarthest = pinkyFromPalm > 0.10 &&                    // –°–ú–Ø–ì–ß–ï–ù–û: –±—ã–ª–æ 0.12
                                  pinkyFromPalm > indexFromPalm * 0.80 &&    // –°–ú–Ø–ì–ß–ï–ù–û: –±—ã–ª–æ 0.85
                                  pinkyFromPalm > middleFromPalm * 0.80 &&
                                  pinkyFromPalm > ringFromPalm * 0.75;       // –°–ú–Ø–ì–ß–ï–ù–û: –±—ã–ª–æ 0.85

            // 4. –î—Ä—É–≥–∏–µ –ø–∞–ª—å—Ü—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–æ–≥–Ω—É—Ç—ã (–°–ú–Ø–ì–ß–ï–ù–û)
            const othersClosed = indexFromPalm < 0.15 &&    // –°–ú–Ø–ì–ß–ï–ù–û: –±—ã–ª–æ 0.14
                                middleFromPalm < 0.15 &&
                                ringFromPalm < 0.13;        // –°–ú–Ø–ì–ß–ï–ù–û: –±—ã–ª–æ 0.12

            // 5. –ë–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü –Ω–µ —Å–∏–ª—å–Ω–æ –≤—ã—Ç—è–Ω—É—Ç (–°–ú–Ø–ì–ß–ï–ù–û)
            const thumbNotExtended = thumbFromPalm < 0.17;  // –°–ú–Ø–ì–ß–ï–ù–û: –±—ã–ª–æ 0.16

            // 6. –ù–µ —â–∏–ø–æ–∫
            const thumbIndexDist = Math.sqrt(
                (thumbTip.x - indexTip.x) ** 2 +
                (thumbTip.y - indexTip.y) ** 2
            );
            const notPinching = thumbIndexDist > 0.05;

            return pinkyExtended &&
                   pinkyFarthest &&
                   othersClosed &&
                   thumbNotExtended &&
                   notPinching;
        }

        // –£–õ–£–ß–®–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∂–µ—Å—Ç–∞
        function isGestureStable(gestureName, currentValue) {
            const stability = GESTURE_STABILITY[gestureName];
            if (!stability) return currentValue;

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            stability.history.push(currentValue);
            if (stability.history.length > GESTURE_HISTORY_SIZE) {
                stability.history.shift();
            }

            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∂–µ—Å—Ç –±—ã–ª true –≤ –∏—Å—Ç–æ—Ä–∏–∏
            const trueCount = stability.history.filter(v => v).length;

            // –ñ–µ—Å—Ç —Å—Ç–∞–±–∏–ª–µ–Ω –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ
            return trueCount >= stability.required;
        }

        // –£–õ–£–ß–®–ï–ù–û: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂–µ—Å—Ç–∞ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º (–¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
        function getPrimaryGesture(landmarks) {
            const pinchDist = getPinchDistance(landmarks);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∂–µ—Å—Ç—ã (raw detection)
            const rawGestures = {
                isPinching: isPinching(landmarks),  // –£–õ–£–ß–®–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
                isPinky: isPinkyUp(landmarks),
                isCrossed: isFingersCrossed(landmarks),
                isFist: isHandFist(landmarks),
                isOpen: isHandOpen(landmarks)
            };

            // –£–õ–£–ß–®–ï–ù–û: –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫ –∫–∞–∂–¥–æ–º—É –∂–µ—Å—Ç—É –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ
            const stableGestures = {
                isPinching: isGestureStable('pinch', rawGestures.isPinching),
                isPinky: isGestureStable('pinky', rawGestures.isPinky),
                isCrossed: isGestureStable('crossed', rawGestures.isCrossed),
                isFist: isGestureStable('fist', rawGestures.isFist),
                isOpen: isGestureStable('open', rawGestures.isOpen)
            };

            // –ü–†–ò–û–†–ò–¢–ï–¢ –ñ–ï–°–¢–û–í (–æ—Ç –≤—ã—Å–æ–∫–æ–≥–æ –∫ –Ω–∏–∑–∫–æ–º—É):
            // 1. –©–∏–ø–æ–∫ - –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–ª–µ–∫—É–ª (—Å–∞–º—ã–π —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π)
            if (stableGestures.isPinching) {
                return {
                    isPinching: true,
                    isPinky: false,
                    isCrossed: false,
                    isFist: false,
                    isOpen: false,
                    primaryGesture: 'pinch'
                };
            }

            // 2. –ú–∏–∑–∏–Ω–µ—Ü - –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–æ—á–µ–Ω—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∂–µ—Å—Ç)
            if (stableGestures.isPinky) {
                return {
                    isPinching: false,
                    isPinky: true,
                    isCrossed: false,
                    isFist: false,
                    isOpen: false,
                    primaryGesture: 'pinky'
                };
            }

            // 3. –°–∫—Ä–µ—â–µ–Ω–Ω—ã–µ –ø–∞–ª—å—Ü—ã - –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π)
            if (stableGestures.isCrossed) {
                return {
                    isPinching: false,
                    isPinky: false,
                    isCrossed: true,
                    isFist: false,
                    isOpen: false,
                    primaryGesture: 'crossed'
                };
            }

            // 4. –ö—É–ª–∞–∫ - –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ (–±–æ–ª–µ–µ –æ–±—â–∏–π)
            if (stableGestures.isFist) {
                return {
                    isPinching: false,
                    isPinky: false,
                    isCrossed: false,
                    isFist: true,
                    isOpen: false,
                    primaryGesture: 'fist'
                };
            }

            // 5. –û—Ç–∫—Ä—ã—Ç–∞—è –ª–∞–¥–æ–Ω—å - –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (—Å–∞–º—ã–π –æ–±—â–∏–π)
            if (stableGestures.isOpen) {
                return {
                    isPinching: false,
                    isPinky: false,
                    isCrossed: false,
                    isFist: false,
                    isOpen: true,
                    primaryGesture: 'open'
                };
            }

            // –ù–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –∂–µ—Å—Ç–∞
            return {
                isPinching: false,
                isPinky: false,
                isCrossed: false,
                isFist: false,
                isOpen: false,
                primaryGesture: 'none'
            };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ MediaPipe
        let frameCount = 0;
        function onResults(results) {
            const newHands = [];
            const currentFrame = [];

            // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 60 –∫–∞–¥—Ä–æ–≤
            frameCount++;
            if (frameCount === 1) {
                console.log('üéâ onResults –≤—ã–∑–≤–∞–Ω –ø–µ—Ä–≤—ã–π —Ä–∞–∑! MediaPipe —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                console.log('‚úÖ WASM —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:', wasmFilesLoaded);
            }
            if (frameCount % 60 === 0) {
                console.log('MediaPipe Hands —Ä–∞–±–æ—Ç–∞–µ—Ç. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä—É–∫:', results.multiHandLandmarks ? results.multiHandLandmarks.length : 0);
            }

            if (results.multiHandLandmarks) {
                results.multiHandLandmarks.forEach((landmarks, idx) => {
                    const palm = landmarks[9];
                    const handX = (1 - palm.x) * width;
                    const handY = palm.y * height;

                    // –£–õ–£–ß–®–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∂–µ—Å—Ç–æ–≤
                    const gestureResult = getPrimaryGesture(landmarks);
                    const pinchDist = getPinchDistance(landmarks);

                    const isPinching = gestureResult.isPinching;
                    const isOpen = gestureResult.isOpen;
                    const isFist = gestureResult.isFist;
                    const isCrossed = gestureResult.isCrossed;
                    const isPinky = gestureResult.isPinky;

                    // –£–õ–£–ß–®–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—É—é –¥–µ—Ç–µ–∫—Ü–∏—é –∑–∞–≥–Ω—É—Ç—ã—Ö –ø–∞–ª—å—Ü–µ–≤
                    const fingersState = detectFoldedFingers(landmarks);

                    // –®–∏—Ä–∏–Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ª–∞–¥–æ–Ω–∏ (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞ –¥–æ –º–∏–∑–∏–Ω—Ü–∞)
                    const handWidth = Math.sqrt(
                        (landmarks[4].x - landmarks[20].x) ** 2 +
                        (landmarks[4].y - landmarks[20].y) ** 2
                    );

                    const handData = {
                        x: handX,
                        y: handY,
                        isPinching,
                        isOpen,
                        isFist,
                        isCrossed,
                        isPinky,
                        fingersState,
                        handWidth,
                        pinchDist // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                    };

                    newHands.push(handData);
                    currentFrame.push(handData);

                    // –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–ª–µ–∫—É–ª—ã –ø—Ä–∏ —â–∏–ø–∫–µ (–Ω–æ –ù–ï –ø—Ä–∏ –∫—É–ª–∞–∫–µ –∏ –¥—Ä—É–≥–∏—Ö –∂–µ—Å—Ç–∞—Ö!)
                    // –£–õ–£–ß–®–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∫—Ä–µ—â–µ–Ω–Ω—ã–µ –ø–∞–ª—å—Ü—ã –∏ –º–∏–∑–∏–Ω–µ—Ü
                    if (isPinching && !isFist && !isCrossed && !isPinky && !previousPinchStates[idx]) {
                        molecules.push(new Molecule(
                            handX,
                            handY,
                            config.moleculeSize
                        ));
                    }

                    previousPinchStates[idx] = isPinching;
                });
            }

            hands = newHands;

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –≤ –∏—Å—Ç–æ—Ä–∏—é
            gestureHistory.push(currentFrame);
            if (gestureHistory.length > GESTURE_HISTORY_SIZE) {
                gestureHistory.shift(); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–∞–¥—Ä—ã
            }
        }

        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å MediaPipe
        console.log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ë–†–ê–£–ó–ï–†–ê ===');
        console.log('–ë—Ä–∞—É–∑–µ—Ä:', navigator.userAgent);
        console.log('crossOriginIsolated:', window.crossOriginIsolated);
        console.log('SharedArrayBuffer:', typeof SharedArrayBuffer !== 'undefined');
        console.log('WebAssembly:', typeof WebAssembly !== 'undefined');

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        let wasmFilesLoaded = [];
        let wasmLoadErrors = [];

        window.addEventListener('error', (event) => {
            if (event.filename && event.filename.includes('mediapipe')) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ MediaPipe:', event.filename, event.message);
                wasmLoadErrors.push(event.filename);
            }
        }, true);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaPipe Hands
        console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø MEDIAPIPE HANDS ===');
        const handsDetector = new Hands({
            locateFile: (file) => {
                console.log('üì¶ MediaPipe –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç:', file);
                wasmFilesLoaded.push(file);
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }
        });

        handsDetector.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });
        console.log('MediaPipe Hands –Ω–∞—Å—Ç—Ä–æ–µ–Ω');

        handsDetector.onResults(onResults);
        console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ onResults –ø–æ–¥–∫–ª—é—á–µ–Ω');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaPipe FaceMesh –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —Ä—Ç–∞
        const faceMesh = new FaceMesh({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
            }
        });

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults(onFaceResults);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ FaceMesh
        function onFaceResults(results) {
            try {
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];

                    // FaceMesh –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã:
                    // 13 - –≤–µ—Ä—Ö–Ω—è—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≥—É–±–∞
                    // 14 - –Ω–∏–∂–Ω—è—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≥—É–±–∞
                    // –î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º:
                    // 13 –∏ 14 –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ç–æ—á–µ–∫ –≥—É–±
                    if (landmarks[13] && landmarks[14]) {
                        const upperLip = landmarks[13];
                        const lowerLip = landmarks[14];

                        // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤–µ—Ä—Ö–Ω–µ–π –∏ –Ω–∏–∂–Ω–µ–π –≥—É–±–æ–π
                        const mouthOpenDistance = Math.abs(lowerLip.y - upperLip.y);

                        // –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –±–æ–ª—å—à–µ –ø–æ—Ä–æ–≥–∞ - —Ä–æ—Ç –æ—Ç–∫—Ä—ã—Ç
                        isMouthOpen = mouthOpenDistance > 0.02; // –ü–æ–¥–æ–±—Ä–∞–Ω–Ω—ã–π –ø–æ—Ä–æ–≥

                        // TOGGLE —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä—Ç–∞
                        if (isMouthOpen && !wasMouthOpen) {
                            // –ú–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä—Ç–∞ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
                            if (editingMolecule) {
                                // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                                editingMolecule.isEditing = false;
                                editingMolecule = null;
                            } else {
                                // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –¥–ª—è –º–æ–ª–µ–∫—É–ª—ã –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–≤–µ–¥–µ–Ω–∞ —Ä—É–∫–∞
                                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ç–µ–∫—É—â–∞—è hovered –º–æ–ª–µ–∫—É–ª–∞ > –ø–æ—Å–ª–µ–¥–Ω—è—è hovered –º–æ–ª–µ–∫—É–ª–∞
                                let moleculeToEdit = hoveredMolecule || lastHoveredMolecule;

                                if (moleculeToEdit && molecules.includes(moleculeToEdit)) {
                                    // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —É –≤—Å–µ—Ö –º–æ–ª–µ–∫—É–ª
                                    molecules.forEach(m => m.isEditing = false);
                                    // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π
                                    moleculeToEdit.isEditing = true;
                                    editingMolecule = moleculeToEdit;
                                }
                            }
                        }

                        wasMouthOpen = isMouthOpen;
                    } else {
                        isMouthOpen = false;
                        wasMouthOpen = false;
                    }
                } else {
                    isMouthOpen = false;
                    wasMouthOpen = false;
                }
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –≤ onFaceResults:', error);
                isMouthOpen = false;
                wasMouthOpen = false;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
        async function setupCamera() {
            console.log('–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞–º–µ—Ä—ã...');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É API
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                status.textContent = '–û—à–∏–±–∫–∞: –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ';
                return null;
            }

            try {
                console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...');

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–¥–µ–æ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                const videoConstraints = isMobile ? {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user' // –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –∂–µ—Å—Ç–æ–≤
                } : {
                    width: 1280,
                    height: 720,
                    facingMode: 'user'
                };

                console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–¥–µ–æ:', videoConstraints);

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: videoConstraints
                });

                console.log('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø–æ–ª—É—á–µ–Ω!', stream);
                video.srcObject = stream;

                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        console.log('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                        resolve(video);
                    };
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
                console.error('–ò–º—è –æ—à–∏–±–∫–∏:', error.name);
                console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);

                status.textContent = `–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ${error.name}`;

                // –ü—Ä–æ–±—É–µ–º —Å –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                try {
                    console.log('–ü—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∫–∞–º–µ—Ä—É —Å –±–∞–∑–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏...');
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: true
                    });
                    console.log('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø–æ–ª—É—á–µ–Ω (–±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)!', stream);
                    video.srcObject = stream;
                    return new Promise((resolve) => {
                        video.onloadedmetadata = () => {
                            console.log('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (–±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)');
                            resolve(video);
                        };
                    });
                } catch (fallbackError) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ:', fallbackError);
                    status.textContent = `–û—à–∏–±–∫–∞: ${fallbackError.message}`;
                    return null;
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            backgroundCacheValid = false; // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∞–Ω–∏–º–∞—Ü–∏–∏
        function animate() {
            // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ canvas –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–∞–¥—Ä–∞
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—ã –æ—Ç –¥–≤–∏–∂—É—â–∏—Ö—Å—è –æ–±—ä–µ–∫—Ç–æ–≤
            ctx.clearRect(0, 0, width, height);

            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ "–ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ" - —Ä–∏—Å—É–µ–º –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã –∫–∞–∫ —Ñ–æ–Ω
            if (config.showVideo && video.videoWidth > 0) {
                ctx.save();
                // –û—Ç–∑–µ—Ä–∫–∞–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
                ctx.scale(-1, 1);
                ctx.drawImage(video, -width, 0, width, height);
                ctx.restore();
            }

            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–≤—É–∫ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∂–µ—Å—Ç–æ–≤)
            if (config.audioEnabled && !editorMode) {
                analyzeAudio();
            }

            // –§–∏–∫—Å–∞—Ü–∏—è —Å —Ç–∞–π–º–µ—Ä–æ–º
            const fists = hands.filter(h => h.isFist);
            const twoFistsStable = checkStableTwoHands('isFist');

            // –§–ò–ö–°–ê–¶–ò–Ø –í–°–ï–• –ú–û–õ–ï–ö–£–õ - –¥–≤–∞ –∫—É–ª–∞–∫–∞ —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã
            if (fists.length === 2 && twoFistsStable) {
                if (twoFistsHoldStart === null) {
                    twoFistsHoldStart = Date.now();
                } else {
                    const holdDuration = Date.now() - twoFistsHoldStart;
                    if (holdDuration >= HOLD_DURATION) {
                        // –§–∏–∫—Å–∏—Ä—É–µ–º –í–°–ï –º–æ–ª–µ–∫—É–ª—ã
                        molecules.forEach(mol => {
                            if (!mol.isLocked) {
                                mol.isLocked = true;
                                mol.isShapeLocked = true;
                                mol.isGrabbed = false;
                                // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º isEditing –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                            }
                        });
                    }
                }
            } else {
                twoFistsHoldStart = null;
            }

            // –§–ò–ö–°–ê–¶–ò–Ø –û–î–ù–û–ô –ú–û–õ–ï–ö–£–õ–´ - –æ–¥–∏–Ω –∫—É–ª–∞–∫ –Ω–∞–¥ –º–æ–ª–µ–∫—É–ª–æ–π —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã
            if (fists.length === 1 && hands.length === 1) {
                const fist = fists[0];
                let closestMol = null;
                let closestDist = Infinity;

                // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é –º–æ–ª–µ–∫—É–ª—É
                molecules.forEach(mol => {
                    if (!mol.isLocked) {
                        const dist = Math.sqrt((mol.x - fist.x) ** 2 + (mol.y - fist.y) ** 2);
                        if (dist < 150 && dist < closestDist) {
                            closestDist = dist;
                            closestMol = mol;
                        }
                    }
                });

                if (closestMol) {
                    if (fistHoldMolecule === closestMol) {
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–∞–¥ —Ç–æ–π –∂–µ –º–æ–ª–µ–∫—É–ª–æ–π
                        const holdDuration = Date.now() - fistHoldStart;
                        if (holdDuration >= HOLD_DURATION) {
                            // –§–∏–∫—Å–∏—Ä—É–µ–º —ç—Ç—É –º–æ–ª–µ–∫—É–ª—É
                            closestMol.isLocked = true;
                            closestMol.isShapeLocked = true;
                            closestMol.isGrabbed = false;
                            // –ù–ï –°–ë–†–ê–°–´–í–ê–ï–ú isEditing - –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ
                            fistHoldStart = null;
                            fistHoldMolecule = null;
                        }
                    } else {
                        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å—á–µ—Ç —Å –Ω–æ–≤–æ–π –º–æ–ª–µ–∫—É–ª–æ–π
                        fistHoldStart = Date.now();
                        fistHoldMolecule = closestMol;
                    }
                } else {
                    fistHoldStart = null;
                    fistHoldMolecule = null;
                }
            } else {
                fistHoldStart = null;
                fistHoldMolecule = null;
            }

            // –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê –ú–ò–ó–ò–ù–¶–ï–ú - –ø–æ–∫–∞–∑–∞—Ç—å –º–∏–∑–∏–Ω–µ—Ü –Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–ª–µ–∫—É–ª–µ
            const pinkyHands = hands.filter(h => h.isPinky);
            if (pinkyHands.length === 1) {
                const pinky = pinkyHands[0];
                molecules.forEach(mol => {
                    if (mol.isLocked) {
                        const dist = Math.sqrt((mol.x - pinky.x) ** 2 + (mol.y - pinky.y) ** 2);
                        if (dist < 150) {
                            mol.isLocked = false;
                            mol.isShapeLocked = false;
                        }
                    }
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–ª–µ–∫—É–ª (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∂–µ—Å—Ç–æ–≤)
            if (!editorMode) {
                molecules.forEach(mol => mol.update());

                // –ü–†–û–í–ï–†–ö–ê –ò –°–õ–ò–Ø–ù–ò–ï –ú–û–õ–ï–ö–£–õ
                checkAndMergeMolecules();
            }

            // –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –ú–û–õ–ï–ö–£–õ–´ –ü–û–î –õ–ê–î–û–ù–¨–Æ (–¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
            hoveredMolecule = null;
            const openHands = hands.filter(h => h.isOpen && !h.isPinching && !h.isFist && !h.isCrossed && !h.isPinky);
            if (openHands.length > 0) {
                // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –º–æ–ª–µ–∫—É–ª—É –ø–æ–¥ –ª—é–±–æ–π –æ—Ç–∫—Ä—ã—Ç–æ–π –ª–∞–¥–æ–Ω—å—é
                let closestMol = null;
                let closestDist = Infinity;

                openHands.forEach(hand => {
                    molecules.forEach(mol => {
                        const dist = Math.sqrt((mol.x - hand.x) ** 2 + (mol.y - hand.y) ** 2);
                        if (dist < 150 && dist < closestDist) {
                            closestDist = dist;
                            closestMol = mol;
                        }
                    });
                });

                if (closestMol) {
                    hoveredMolecule = closestMol;
                    lastHoveredMolecule = closestMol;
                }
            }

            // –£–î–ê–õ–ï–ù–ò–ï –ú–û–õ–ï–ö–£–õ–´ - —Å–∫—Ä–µ—â–µ–Ω–Ω—ã–µ –ø–∞–ª—å—Ü—ã —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã
            const crossedHands = hands.filter(h => h.isCrossed);
            if (crossedHands.length === 1) {
                const crossed = crossedHands[0];
                let closestMol = null;
                let closestDist = Infinity;

                // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –º–æ–ª–µ–∫—É–ª—É
                molecules.forEach(mol => {
                    const dist = Math.sqrt((mol.x - crossed.x) ** 2 + (mol.y - crossed.y) ** 2);
                    if (dist < 120 && dist < closestDist) {
                        closestDist = dist;
                        closestMol = mol;
                    }
                });

                if (closestMol) {
                    // –£–õ–£–ß–®–ï–ù–û: –ñ–µ—Å—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏
                    crossedHoldLostTime = null;

                    if (crossedHoldMolecule === closestMol) {
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–∞–¥ —Ç–æ–π –∂–µ –º–æ–ª–µ–∫—É–ª–æ–π
                        const holdDuration = Date.now() - crossedHoldStart;
                        if (holdDuration >= HOLD_DURATION) {
                            // –£–¥–∞–ª—è–µ–º –º–æ–ª–µ–∫—É–ª—É –ø–æ—Å–ª–µ 2 —Å–µ–∫—É–Ω–¥
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ —É–¥–∞–ª—è–µ–º–∞—è –º–æ–ª–µ–∫—É–ª–∞ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ
                            if (editingMolecule === closestMol) {
                                editingMolecule = null;
                            }
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º lastHoveredMolecule –µ—Å–ª–∏ —ç—Ç–æ –æ–Ω–∞
                            if (lastHoveredMolecule === closestMol) {
                                lastHoveredMolecule = null;
                            }
                            molecules = molecules.filter(m => m !== closestMol);
                            crossedHoldStart = null;
                            crossedHoldMolecule = null;
                            crossedHoldLostTime = null;
                        }
                    } else {
                        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å—á–µ—Ç —Å –Ω–æ–≤–æ–π –º–æ–ª–µ–∫—É–ª–æ–π
                        crossedHoldStart = Date.now();
                        crossedHoldMolecule = closestMol;
                        crossedHoldLostTime = null;
                    }
                } else {
                    // –£–õ–£–ß–®–ï–ù–û: –ù–µ—Ç –º–æ–ª–µ–∫—É–ª—ã —Ä—è–¥–æ–º - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å
                    if (crossedHoldStart && !crossedHoldLostTime) {
                        crossedHoldLostTime = Date.now();
                    } else if (crossedHoldLostTime && (Date.now() - crossedHoldLostTime > RESET_TOLERANCE)) {
                        crossedHoldStart = null;
                        crossedHoldMolecule = null;
                        crossedHoldLostTime = null;
                    }
                }
            } else {
                // –£–õ–£–ß–®–ï–ù–û: –ñ–µ—Å—Ç –ø–æ—Ç–µ—Ä—è–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º
                if (crossedHoldStart && !crossedHoldLostTime) {
                    crossedHoldLostTime = Date.now();
                } else if (crossedHoldLostTime && (Date.now() - crossedHoldLostTime > RESET_TOLERANCE)) {
                    crossedHoldStart = null;
                    crossedHoldMolecule = null;
                    crossedHoldLostTime = null;
                }
            }

            // –†–∏—Å–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–ª–æ–≤
            drawMetaballs();

            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ç–∞–π–º–µ—Ä–æ–≤

            // –ü—Ä–æ–≥—Ä–µ—Å—Å —Ñ–∏–∫—Å–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –º–æ–ª–µ–∫—É–ª—ã
            if (fistHoldMolecule && fistHoldStart) {
                const progress = (Date.now() - fistHoldStart) / HOLD_DURATION;
                const angle = Math.PI * 2 * progress;

                ctx.strokeStyle = 'rgba(255, 200, 0, 0.9)';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(fistHoldMolecule.x, fistHoldMolecule.y, 35, -Math.PI / 2, -Math.PI / 2 + angle);
                ctx.stroke();

                // –¢–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                ctx.fillStyle = 'rgba(255, 200, 0, 0.9)';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üîí', fistHoldMolecule.x, fistHoldMolecule.y);
            }

            // –ü—Ä–æ–≥—Ä–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è –º–æ–ª–µ–∫—É–ª—ã
            if (crossedHoldMolecule && crossedHoldStart) {
                const progress = (Date.now() - crossedHoldStart) / HOLD_DURATION;
                const angle = Math.PI * 2 * progress;

                ctx.strokeStyle = 'rgba(255, 50, 50, 0.9)';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(crossedHoldMolecule.x, crossedHoldMolecule.y, 35, -Math.PI / 2, -Math.PI / 2 + angle);
                ctx.stroke();

                // –¢–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                ctx.fillStyle = 'rgba(255, 50, 50, 0.9)';
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üóëÔ∏è', crossedHoldMolecule.x, crossedHoldMolecule.y);
            }

            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–ª–µ–∫—É–ª
            molecules.forEach(mol => {
                if (mol.isLocked) {
                    if (mol.isShapeLocked) {
                        // –î–≤–æ–π–Ω–æ–π –∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã
                        ctx.strokeStyle = 'rgba(255, 100, 0, 0.8)';
                        ctx.lineWidth = 3;
                        const size = 15;

                        // –í–Ω–µ—à–Ω–∏–π –∫—Ä–µ—Å—Ç–∏–∫
                        ctx.beginPath();
                        ctx.moveTo(mol.x - size, mol.y - size);
                        ctx.lineTo(mol.x + size, mol.y + size);
                        ctx.moveTo(mol.x + size, mol.y - size);
                        ctx.lineTo(mol.x - size, mol.y + size);
                        ctx.stroke();

                        // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä–µ—Å—Ç–∏–∫
                        ctx.strokeStyle = 'rgba(255, 150, 50, 0.6)';
                        ctx.lineWidth = 2;
                        const smallSize = 8;
                        ctx.beginPath();
                        ctx.moveTo(mol.x - smallSize, mol.y - smallSize);
                        ctx.lineTo(mol.x + smallSize, mol.y + smallSize);
                        ctx.moveTo(mol.x + smallSize, mol.y - smallSize);
                        ctx.lineTo(mol.x - smallSize, mol.y + smallSize);
                        ctx.stroke();
                    } else {
                        // –ö—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                        ctx.strokeStyle = 'rgba(255, 50, 50, 0.7)';
                        ctx.lineWidth = 3;
                        const size = 15;
                        ctx.beginPath();
                        ctx.moveTo(mol.x - size, mol.y - size);
                        ctx.lineTo(mol.x + size, mol.y + size);
                        ctx.moveTo(mol.x + size, mol.y - size);
                        ctx.lineTo(mol.x - size, mol.y + size);
                        ctx.stroke();
                    }
                } else if (mol.isEditing) {
                    // –í–ò–ó–£–ê–õ–¨–ù–´–ô –ü–†–ï–í–¨–Æ –î–ï–§–û–†–ú–ê–¶–ò–ò

                    // 1. –Ø—Ä–∫–∏–π –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π –∫—Ä—É–≥ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    const pulse = 0.5 + Math.sin(Date.now() / 300) * 0.2;
                    ctx.strokeStyle = `rgba(50, 150, 255, ${pulse})`;
                    ctx.lineWidth = 5;
                    ctx.setLineDash([10, 5]);
                    ctx.beginPath();
                    ctx.arc(mol.x, mol.y, 35 + Math.sin(Date.now() / 400) * 3, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // 2. –ù–û–í–û–ï: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä—É–∫ –∏ –æ—Å–∏ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    if (mol.editingHands) {
                        const h1 = mol.editingHands.hand1;
                        const h2 = mol.editingHands.hand2;

                        // –õ–∏–Ω–∏—è –º–µ–∂–¥—É —Ä—É–∫–∞–º–∏ (–∑–µ–ª—ë–Ω–∞—è) - –æ—Å—å —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è
                        ctx.strokeStyle = 'rgba(50, 255, 100, 0.8)';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([10, 5]);
                        ctx.beginPath();
                        ctx.moveTo(h1.x, h1.y);
                        ctx.lineTo(h2.x, h2.y);
                        ctx.stroke();
                        ctx.setLineDash([]);

                        // –¢–æ—á–∫–∏ —Ä—É–∫
                        ctx.fillStyle = 'rgba(255, 100, 100, 0.9)';
                        ctx.beginPath();
                        ctx.arc(h1.x, h1.y, 10, 0, Math.PI * 2);
                        ctx.fill();

                        ctx.fillStyle = 'rgba(255, 150, 50, 0.9)';
                        ctx.beginPath();
                        ctx.arc(h2.x, h2.y, 10, 0, Math.PI * 2);
                        ctx.fill();

                        // –û—Å—å –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –º–æ–ª–µ–∫—É–ª—É
                        const axisLength = mol.size * mol.stretchX * 0.8;
                        const axisX1 = mol.x + Math.cos(mol.deformAngle) * axisLength;
                        const axisY1 = mol.y + Math.sin(mol.deformAngle) * axisLength;
                        const axisX2 = mol.x - Math.cos(mol.deformAngle) * axisLength;
                        const axisY2 = mol.y - Math.sin(mol.deformAngle) * axisLength;

                        ctx.strokeStyle = 'rgba(255, 100, 255, 0.7)';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([8, 4]);
                        ctx.beginPath();
                        ctx.moveTo(axisX1, axisY1);
                        ctx.lineTo(axisX2, axisY2);
                        ctx.stroke();

                        // –ü–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–∞—è –æ—Å—å (—Å–∂–∞—Ç–∏–µ)
                        const perpAngle = mol.deformAngle + Math.PI / 2;
                        const perpLength = mol.size * mol.stretchY * 0.8;
                        const perpX1 = mol.x + Math.cos(perpAngle) * perpLength;
                        const perpY1 = mol.y + Math.sin(perpAngle) * perpLength;
                        const perpX2 = mol.x - Math.cos(perpAngle) * perpLength;
                        const perpY2 = mol.y - Math.sin(perpAngle) * perpLength;

                        ctx.strokeStyle = 'rgba(100, 255, 255, 0.6)';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([4, 4]);
                        ctx.beginPath();
                        ctx.moveTo(perpX1, perpY1);
                        ctx.lineTo(perpX2, perpY2);
                        ctx.stroke();
                        ctx.setLineDash([]);

                        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–µ–ø–µ–Ω–∏ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';

                        // –†–∞—Å—Ç—è–∂–µ–Ω–∏–µ –≤–¥–æ–ª—å (X)
                        ctx.fillStyle = 'rgba(255, 100, 255, 0.9)';
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.lineWidth = 3;
                        ctx.strokeText(`${mol.stretchX.toFixed(1)}x`, axisX1 + Math.cos(mol.deformAngle) * 20, axisY1 + Math.sin(mol.deformAngle) * 20);
                        ctx.fillText(`${mol.stretchX.toFixed(1)}x`, axisX1 + Math.cos(mol.deformAngle) * 20, axisY1 + Math.sin(mol.deformAngle) * 20);

                        // –°–∂–∞—Ç–∏–µ –ø–æ–ø–µ—Ä—ë–∫ (Y)
                        ctx.fillStyle = 'rgba(100, 255, 255, 0.9)';
                        ctx.strokeText(`${mol.stretchY.toFixed(1)}x`, perpX1 + Math.cos(perpAngle) * 20, perpY1 + Math.sin(perpAngle) * 20);
                        ctx.fillText(`${mol.stretchY.toFixed(1)}x`, perpX1 + Math.cos(perpAngle) * 20, perpY1 + Math.sin(perpAngle) * 20);
                    }

                    // 3. –ò–∫–æ–Ω–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = 'rgba(50, 150, 255, 0.9)';
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.lineWidth = 2;
                    ctx.strokeText('‚úé', mol.x, mol.y - 50);
                    ctx.fillText('‚úé', mol.x, mol.y - 50);

                    // 4. –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ —Ä–µ–∂–∏–º–µ
                    ctx.font = '13px Arial';
                    ctx.fillStyle = 'rgba(50, 150, 255, 0.8)';
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)';
                    ctx.lineWidth = 2;
                    const hint = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–æ—Ç–∫—Ä–æ–π—Ç–µ —Ä–æ—Ç –¥–ª—è –≤—ã—Ö–æ–¥–∞)';
                    ctx.strokeText(hint, mol.x, mol.y + 55);
                    ctx.fillText(hint, mol.x, mol.y + 55);
                } else if (mol.isGrabbed) {
                    // –ó–µ–ª—ë–Ω—ã–π –∫—Ä—É–≥ –¥–ª—è –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö
                    ctx.strokeStyle = 'rgba(50, 255, 50, 0.8)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(mol.x, mol.y, 25, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // –ù–û–í–û–ï: –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–æ–ª–µ–∫—É–ª—ã –ø–æ–¥ –ª–∞–¥–æ–Ω—å—é (–≥–æ—Ç–æ–≤–∞ –∫ –≤—ã–±–æ—Ä—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                if (mol === hoveredMolecule && !mol.isEditing && !mol.isLocked) {
                    // –ñ—ë–ª—Ç—ã–π –∫—Ä—É–≥ —Å –ø—É–Ω–∫—Ç–∏—Ä–æ–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ —ç—Ç–∞ –º–æ–ª–µ–∫—É–ª–∞ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–∞
                    ctx.strokeStyle = 'rgba(255, 200, 50, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([6, 3]);
                    ctx.beginPath();
                    ctx.arc(mol.x, mol.y, 28, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // –ü–æ–¥—Å–∫–∞–∑–∫–∞
                    ctx.font = '11px Arial';
                    ctx.fillStyle = 'rgba(255, 200, 50, 0.9)';
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)';
                    ctx.lineWidth = 2;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    const hintText = '–û—Ç–∫—Ä–æ–π—Ç–µ —Ä–æ—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                    ctx.strokeText(hintText, mol.x, mol.y + 35);
                    ctx.fillText(hintText, mol.x, mol.y + 35);
                }

                // PAINT –†–ï–î–ê–ö–¢–û–†: –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–ª–µ–∫—É–ª—ã
                if (editorMode && mol === selectedMolecule) {
                    // –û—Ä–∞–Ω–∂–µ–≤—ã–π –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π –∫–æ–Ω—Ç—É—Ä
                    const pulse = 0.6 + Math.sin(Date.now() / 200) * 0.3;
                    ctx.strokeStyle = `rgba(255, 165, 0, ${pulse})`;
                    ctx.lineWidth = 4;
                    ctx.setLineDash([8, 4]);
                    ctx.beginPath();
                    ctx.arc(mol.x, mol.y, mol.size * 1.1, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // –ú–µ—Ç–∫–∞ "–í–´–ë–†–ê–ù–ê"
                    ctx.font = 'bold 14px Arial';
                    ctx.fillStyle = 'rgba(255, 165, 0, 0.9)';
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.lineWidth = 3;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.strokeText('–í–´–ë–†–ê–ù–ê', mol.x, mol.y - mol.size - 10);
                    ctx.fillText('–í–´–ë–†–ê–ù–ê', mol.x, mol.y - mol.size - 10);
                }
            });

            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä—É–∫
            hands.forEach(hand => {
                let color, label;
                // –£–õ–£–ß–®–ï–ù–û: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∂–µ—Å—Ç–æ–≤
                if (hand.isPinching) {
                    color = 'rgba(255, 100, 100, 0.6)';
                    label = '‚úåÔ∏è';
                } else if (hand.isPinky) {
                    color = 'rgba(255, 200, 0, 0.7)';
                    label = 'ü§ô';
                } else if (hand.isCrossed) {
                    color = 'rgba(255, 50, 150, 0.7)';
                    label = 'ü§û';
                } else if (hand.isFist) {
                    color = 'rgba(255, 150, 50, 0.6)';
                    label = '‚úä';
                } else if (hand.isOpen) {
                    color = 'rgba(100, 255, 100, 0.6)';
                    label = '‚úã';
                } else {
                    color = 'rgba(150, 150, 150, 0.5)';
                    label = '';
                }

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(hand.x, hand.y, 15, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#1a1a1a';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Emoji –¥–ª—è –∂–µ—Å—Ç–∞
                if (label) {
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(label, hand.x, hand.y - 35);
                }
            });

            // –õ–∏–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ä—É–∫–∞–º–∏
            const openHandsForLine = hands.filter(h => h.isOpen);
            if (openHandsForLine.length === 2) {
                // –ï—Å–ª–∏ –º–æ–ª–µ–∫—É–ª–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é
                const inEditMode = editingMolecule && editingMolecule.isEditing;

                if (inEditMode) {
                    // –Ø—Ä–∫–∞—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–∏–Ω–∏—è –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    const gradient = ctx.createLinearGradient(
                        openHandsForLine[0].x, openHandsForLine[0].y,
                        openHandsForLine[1].x, openHandsForLine[1].y
                    );
                    gradient.addColorStop(0, 'rgba(50, 150, 255, 0.7)');
                    gradient.addColorStop(0.5, 'rgba(100, 200, 255, 0.9)');
                    gradient.addColorStop(1, 'rgba(50, 150, 255, 0.7)');

                    ctx.strokeStyle = gradient;
                    ctx.lineWidth = 4;
                    ctx.setLineDash([10, 5]);
                    ctx.beginPath();
                    ctx.moveTo(openHandsForLine[0].x, openHandsForLine[0].y);
                    ctx.lineTo(openHandsForLine[1].x, openHandsForLine[1].y);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                    const distX = Math.abs(openHandsForLine[1].x - openHandsForLine[0].x);
                    const distY = Math.abs(openHandsForLine[1].y - openHandsForLine[0].y);
                    const midX = (openHandsForLine[0].x + openHandsForLine[1].x) / 2;
                    const midY = (openHandsForLine[0].y + openHandsForLine[1].y) / 2;

                    ctx.font = '12px Arial';
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ —É–≥–æ–ª
                    const totalDist = Math.round(Math.sqrt(distX * distX + distY * distY));
                    const angle = Math.round(editingMolecule.targetDeformAngle * 180 / Math.PI);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    const text = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${totalDist}px | –£–≥–æ–ª: ${angle}¬∞`;
                    ctx.strokeText(text, midX, midY - 10);
                    ctx.fillText(text, midX, midY - 10);

                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    const stretchInfo = `–†–∞—Å—Ç—è–∂–µ–Ω–∏–µ: ${editingMolecule.stretchX.toFixed(2)} √ó ${editingMolecule.stretchY.toFixed(2)}`;
                    ctx.font = '10px Arial';
                    ctx.strokeText(stretchInfo, midX, midY + 10);
                    ctx.fillText(stretchInfo, midX, midY + 10);
                } else {
                    // –û–±—ã—á–Ω–∞—è –ª–∏–Ω–∏—è
                    ctx.strokeStyle = 'rgba(100, 255, 100, 0.4)';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(openHandsForLine[0].x, openHandsForLine[0].y);
                    ctx.lineTo(openHandsForLine[1].x, openHandsForLine[1].y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }

            requestAnimationFrame(animate);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è MediaPipe
        let detectHandsStarted = false;
        let sendCount = 0;
        async function detectHands() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                if (!detectHandsStarted) {
                    console.log('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ, –Ω–∞—á–∏–Ω–∞–µ–º –¥–µ—Ç–µ–∫—Ü–∏—é —Ä—É–∫');
                    detectHandsStarted = true;
                }
                try {
                    sendCount++;
                    if (sendCount === 1) {
                        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä –≤ MediaPipe...');
                    }
                    if (sendCount === 30 && frameCount === 0) {
                        console.warn('‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 30 –∫–∞–¥—Ä–æ–≤, –Ω–æ onResults –Ω–∏ —Ä–∞–∑—É –Ω–µ –≤—ã–∑–≤–∞–Ω!');
                        console.warn('MediaPipe WASM –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è.');
                        console.warn('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:', wasmFilesLoaded);
                        console.warn('–û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏:', wasmLoadErrors.length > 0 ? wasmLoadErrors : '–Ω–µ—Ç');
                        console.warn('crossOriginIsolated:', window.crossOriginIsolated);
                    }
                    if (sendCount === 100 && frameCount === 0) {
                        console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: MediaPipe –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ 100 –∫–∞–¥—Ä–æ–≤!');
                        console.error('–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å CORS –∏–ª–∏ COEP –ø–æ–ª–∏—Ç–∏–∫–æ–π.');
                        console.error('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network –≤–∫–ª–∞–¥–∫—É –≤ DevTools –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
                    }

                    await handsDetector.send({ image: video });
                    // FaceMesh –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Ä—É–∫
                    try {
                        await faceMesh.send({ image: video });
                    } catch (faceError) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ FaceMesh
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ä—É–∫:', error);
                }
            }
            requestAnimationFrame(detectHands);
        }

        // UI –∫–æ–Ω—Ç—Ä–æ–ª—ã
        document.getElementById('molSizeSlider').addEventListener('input', (e) => {
            config.moleculeSize = parseInt(e.target.value);
            document.getElementById('molSize').textContent = config.moleculeSize;
        });

        document.getElementById('mergeSlider').addEventListener('input', (e) => {
            config.mergeStrength = parseFloat(e.target.value);
            document.getElementById('mergeStrength').textContent = config.mergeStrength.toFixed(1);
        });

        document.getElementById('audioSensSlider').addEventListener('input', (e) => {
            config.audioSensitivity = parseInt(e.target.value);
            document.getElementById('audioSens').textContent = config.audioSensitivity;
        });

        document.getElementById('audioEnabled').addEventListener('change', (e) => {
            config.audioEnabled = e.target.checked;
        });

        document.getElementById('showVideo').addEventListener('change', (e) => {
            config.showVideo = e.target.checked;
            video.style.opacity = config.showVideo ? '0.3' : '0';
        });

        document.getElementById('unlockBtn').addEventListener('click', () => {
            molecules.forEach(mol => mol.unlock());
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            molecules = [];
        });

        // UI —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π
        const gestureHint = document.getElementById('gestureHint');
        const controlsPanel = document.getElementById('controls');
        const toggleHintsBtn = document.getElementById('toggleHints');
        const toggleControlsBtn = document.getElementById('toggleControls');
        const closeHintsBtn = document.getElementById('closeHints');
        const closeControlsBtn = document.getElementById('closeControls');

        // –°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
        closeHintsBtn.addEventListener('click', () => {
            gestureHint.classList.add('minimized');
            toggleHintsBtn.classList.add('visible');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
        toggleHintsBtn.addEventListener('click', () => {
            gestureHint.classList.remove('minimized');
            toggleHintsBtn.classList.remove('visible');
        });

        // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        closeControlsBtn.addEventListener('click', () => {
            controlsPanel.classList.add('minimized');
            toggleControlsBtn.classList.add('visible');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        toggleControlsBtn.addEventListener('click', () => {
            controlsPanel.classList.remove('minimized');
            toggleControlsBtn.classList.remove('visible');
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobile) {
            setTimeout(() => {
                gestureHint.classList.add('minimized');
                toggleHintsBtn.classList.add('visible');
            }, 10000); // 10 —Å–µ–∫—É–Ω–¥
        }

        // === PAINT –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê - UI ===

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–ª–∏—Ç—Ä—ã —Ü–≤–µ—Ç–æ–≤
        function initColorPalette() {
            const colorGrid = document.getElementById('colorGrid');
            paintColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.background = color;
                swatch.dataset.color = color;

                swatch.addEventListener('click', (e) => {
                    // –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ - –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç, –ø—Ä–∞–≤–∞—è - —Ñ–æ–Ω–æ–≤—ã–π
                    if (e.button === 0) {
                        primaryColor = color;
                        document.getElementById('primaryColor').style.background = color;

                        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
                        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                        swatch.classList.add('selected');
                    }
                });

                swatch.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    secondaryColor = color;
                    document.getElementById('secondaryColor').style.background = color;
                });

                colorGrid.appendChild(swatch);
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
        function toggleEditorMode() {
            editorMode = !editorMode;

            const modeBtn = document.getElementById('modeToggleBtn');
            const modeIndicator = document.getElementById('modeIndicator');
            const paintToolbar = document.getElementById('paintToolbar');
            const colorPalette = document.getElementById('colorPalette');
            const controlsPanel = document.getElementById('controls');
            const gestureHint = document.getElementById('gestureHint');

            if (editorMode) {
                // –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                modeBtn.textContent = 'üëã –†–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤';

                modeIndicator.textContent = 'üé® –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞';
                modeIndicator.className = 'mode-indicator editor-mode active';

                paintToolbar.classList.add('active');
                colorPalette.classList.add('active');

                // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∂–µ—Å—Ç–æ–≤, –ø–∞–Ω–µ–ª—å controls –æ—Å—Ç–∞–≤–ª—è–µ–º
                gestureHint.classList.add('minimized');

                // –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–ª–µ–∫—É–ª
                frozenMolecules = molecules.map(mol => ({
                    x: mol.x,
                    y: mol.y,
                    size: mol.size,
                    stretchX: mol.stretchX,
                    stretchY: mol.stretchY,
                    deformAngle: mol.deformAngle,
                    fillColor: mol.fillColor || null, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                    edgeColor: mol.edgeColor || null, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –∫–æ–Ω—Ç—É—Ä–∞
                    emboss: mol.emboss || false       // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Ç–∏—Å–Ω–µ–Ω–∏—è
                }));

                status.textContent = `–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ | –ú–æ–ª–µ–∫—É–ª: ${molecules.length}`;
            } else {
                // –í–æ–∑–≤—Ä–∞—Ç –≤ —Ä–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤
                modeBtn.textContent = 'üé® –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞';

                modeIndicator.textContent = 'üëã –†–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤';
                modeIndicator.className = 'mode-indicator gesture-mode active';

                paintToolbar.classList.remove('active');
                colorPalette.classList.remove('active');

                selectedMolecule = null;

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ –∫ –º–æ–ª–µ–∫—É–ª–∞–º
                frozenMolecules.forEach((frozen, i) => {
                    if (molecules[i]) {
                        molecules[i].fillColor = frozen.fillColor;
                        molecules[i].edgeColor = frozen.edgeColor;
                        molecules[i].emboss = frozen.emboss;
                    }
                });

                status.textContent = '–†–µ–∂–∏–º –∂–µ—Å—Ç–æ–≤ | –ì–æ—Ç–æ–≤';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
        document.getElementById('modeToggleBtn').addEventListener('click', toggleEditorMode);

        // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        document.querySelectorAll('.paint-tool').forEach(tool => {
            tool.addEventListener('click', () => {
                document.querySelectorAll('.paint-tool').forEach(t => t.classList.remove('selected'));
                tool.classList.add('selected');
                currentTool = tool.dataset.tool;
            });
        });

        // –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∑–∞–ª–∏–≤–∫–∏
        document.querySelectorAll('.fill-mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –±–µ–∑ data-mode (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–Ω–æ–ø–∫–∏ —Ñ–æ–Ω–∞)
                if (!btn.dataset.mode) return;

                document.querySelectorAll('.fill-mode-btn').forEach(b => {
                    if (b.dataset.mode) b.classList.remove('active');
                });
                btn.classList.add('active');
                fillMode = btn.dataset.mode;
                status.textContent = `–†–µ–∂–∏–º –∑–∞–ª–∏–≤–∫–∏: ${btn.textContent}`;
            });
        });

        // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞
        document.getElementById('bgColorPicker').addEventListener('input', (e) => {
            backgroundColor = e.target.value;
            backgroundType = 'color';
            backgroundImage = null;
            backgroundCacheValid = false; // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞
            document.getElementById('bgPreview').textContent = `–¶–≤–µ—Ç: ${backgroundColor}`;
            status.textContent = `–§–æ–Ω: —Ü–≤–µ—Ç ${backgroundColor}`;
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Ñ–æ–Ω–∞
        document.getElementById('bgFilePicker').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            const fileType = file.type;

            if (fileType.startsWith('image/')) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const img = new Image();
                img.onload = () => {
                    backgroundImage = img;
                    backgroundType = 'image';
                    backgroundCacheValid = false; // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞
                    document.getElementById('bgPreview').textContent = `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${file.name}`;
                    status.textContent = `–§–æ–Ω: ${file.name}`;
                };
                img.src = url;
            } else if (fileType.startsWith('video/')) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ
                const video = document.createElement('video');
                video.src = url;
                video.loop = true;
                video.muted = true;
                video.playsInline = true;
                video.play().then(() => {
                    backgroundImage = video;
                    backgroundType = 'video';
                    document.getElementById('bgPreview').textContent = `–í–∏–¥–µ–æ: ${file.name}`;
                    status.textContent = `–§–æ–Ω: ${file.name}`;
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', err);
                    status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ';
                });
            }
        });

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ–Ω–∞
        document.getElementById('bgClearBtn').addEventListener('click', () => {
            backgroundColor = '#ffffff';
            backgroundImage = null;
            backgroundType = 'color';
            backgroundCacheValid = false; // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Ñ–æ–Ω–∞
            document.getElementById('bgColorPicker').value = '#ffffff';
            document.getElementById('bgPreview').textContent = '';
            status.textContent = '–§–æ–Ω –æ—á–∏—â–µ–Ω (–±–µ–ª—ã–π)';
        });

        // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∏–∫—Ä–æ–ø–æ–ª–æ—Å–æ–∫
        document.getElementById('microStripesEffect').addEventListener('change', (e) => {
            const settings = document.getElementById('microStripesSettings');
            settings.style.display = e.target.checked ? 'flex' : 'none';
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã –ø–æ–ª–æ—Å–æ–∫
        document.getElementById('stripeWidth').addEventListener('input', (e) => {
            document.getElementById('stripeWidthValue').textContent = e.target.value;
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª–æ—Å–∫–∞–º–∏
        document.getElementById('stripeSpacing').addEventListener('input', (e) => {
            document.getElementById('stripeSpacingValue').textContent = e.target.value;
        });

        // –î–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ - –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        canvas.addEventListener('mousemove', (e) => {
            if (!editorMode) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;

            // –ù–∞—Ö–æ–¥–∏–º –º–æ–ª–µ–∫—É–ª—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
            hoveredMoleculeEditor = null;
            for (let i = molecules.length - 1; i >= 0; i--) {
                const mol = molecules[i];
                const dx = mouseX - mol.x;
                const dy = mouseY - mol.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < mol.size) {
                    hoveredMoleculeEditor = mol;
                    break;
                }
            }

            // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
            if (currentTool === 'fill' || currentTool === 'eraser') {
                canvas.style.cursor = hoveredMoleculeEditor ? 'pointer' : 'crosshair';
            } else if (currentTool === 'select') {
                canvas.style.cursor = hoveredMoleculeEditor ? 'pointer' : 'default';
            }
        });

        // –ö–ª–∏–∫ –Ω–∞ canvas –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        canvas.addEventListener('click', (e) => {
            if (!editorMode) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clickX = (e.clientX - rect.left) * scaleX;
            const clickY = (e.clientY - rect.top) * scaleY;

            // –ù–∞—Ö–æ–¥–∏–º –º–æ–ª–µ–∫—É–ª—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º hoveredMoleculeEditor –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏)
            let clickedMolecule = hoveredMoleculeEditor;

            if (currentTool === 'select') {
                selectedMolecule = clickedMolecule;
                status.textContent = clickedMolecule ?
                    `–í—ã–±—Ä–∞–Ω–∞ –º–æ–ª–µ–∫—É–ª–∞ (${clickedMolecule.size.toFixed(0)}px)` :
                    '–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–ª–µ–∫—É–ª—ã';
            } else if (currentTool === 'fill' && clickedMolecule) {
                // –ó–∞–ª–∏–≤–∫–∞ —Ü–≤–µ—Ç–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (fillMode === 'interior' || fillMode === 'both') {
                    clickedMolecule.fillColor = primaryColor;
                }
                if (fillMode === 'edge' || fillMode === 'both') {
                    clickedMolecule.edgeColor = primaryColor;
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã
                const embossCheckbox = document.getElementById('embossEffect');
                const microStripesCheckbox = document.getElementById('microStripesEffect');
                clickedMolecule.emboss = embossCheckbox.checked;
                clickedMolecule.microStripes = microStripesCheckbox.checked;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ–ø–æ–ª–æ—Å–æ–∫ –µ—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –≤–∫–ª—é—á–µ–Ω
                if (clickedMolecule.microStripes) {
                    clickedMolecule.stripeColor1 = document.getElementById('stripeColor1').value;
                    clickedMolecule.stripeColor2 = document.getElementById('stripeColor2').value;
                    clickedMolecule.stripeWidth = parseInt(document.getElementById('stripeWidth').value);
                    clickedMolecule.stripeSpacing = parseInt(document.getElementById('stripeSpacing').value);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const molIndex = molecules.indexOf(clickedMolecule);
                if (frozenMolecules[molIndex]) {
                    if (fillMode === 'interior' || fillMode === 'both') {
                        frozenMolecules[molIndex].fillColor = primaryColor;
                    }
                    if (fillMode === 'edge' || fillMode === 'both') {
                        frozenMolecules[molIndex].edgeColor = primaryColor;
                    }
                    frozenMolecules[molIndex].emboss = clickedMolecule.emboss;
                    frozenMolecules[molIndex].microStripes = clickedMolecule.microStripes;
                    frozenMolecules[molIndex].stripeColor1 = clickedMolecule.stripeColor1;
                    frozenMolecules[molIndex].stripeColor2 = clickedMolecule.stripeColor2;
                    frozenMolecules[molIndex].stripeWidth = clickedMolecule.stripeWidth;
                    frozenMolecules[molIndex].stripeSpacing = clickedMolecule.stripeSpacing;
                }

                const modeText = fillMode === 'interior' ? '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å' :
                                 fillMode === 'edge' ? '–∫–æ–Ω—Ç—É—Ä' : '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å+–∫–æ–Ω—Ç—É—Ä';
                const effectsText = [];
                if (clickedMolecule.emboss) effectsText.push('—Ç–∏—Å–Ω–µ–Ω–∏–µ');
                if (clickedMolecule.microStripes) effectsText.push('–ø–æ–ª–æ—Å–∫–∏');
                const effectsSuffix = effectsText.length > 0 ? ' + ' + effectsText.join(' + ') : '';
                status.textContent = `–ó–∞–ª–∏—Ç–æ ${modeText} —Ü–≤–µ—Ç–æ–º ${primaryColor}${effectsSuffix}`;
            } else if (currentTool === 'eraser' && clickedMolecule) {
                // –õ–∞—Å—Ç–∏–∫ —É–¥–∞–ª—è–µ—Ç –∑–∞–ª–∏–≤–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (fillMode === 'interior' || fillMode === 'both') {
                    clickedMolecule.fillColor = null;
                }
                if (fillMode === 'edge' || fillMode === 'both') {
                    clickedMolecule.edgeColor = null;
                }
                clickedMolecule.emboss = false; // –£–±–∏—Ä–∞–µ–º —Ç–∏—Å–Ω–µ–Ω–∏–µ
                clickedMolecule.microStripes = false; // –£–±–∏—Ä–∞–µ–º –ø–æ–ª–æ—Å–∫–∏

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const molIndex = molecules.indexOf(clickedMolecule);
                if (frozenMolecules[molIndex]) {
                    if (fillMode === 'interior' || fillMode === 'both') {
                        frozenMolecules[molIndex].fillColor = null;
                    }
                    if (fillMode === 'edge' || fillMode === 'both') {
                        frozenMolecules[molIndex].edgeColor = null;
                    }
                    frozenMolecules[molIndex].emboss = false;
                    frozenMolecules[molIndex].microStripes = false;
                }

                const modeText = fillMode === 'interior' ? '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å' :
                                 fillMode === 'edge' ? '–∫–æ–Ω—Ç—É—Ä' : '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å+–∫–æ–Ω—Ç—É—Ä';
                status.textContent = `–°—Ç—ë—Ä—Ç–æ ${modeText}`;
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            console.log('=== –ù–ê–ß–ê–õ–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ===');

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–ª–∏—Ç—Ä—É —Ü–≤–µ—Ç–æ–≤ Paint
            initColorPalette();

            resize();
            window.addEventListener('resize', resize);

            console.log('–ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é...');
            animate();

            console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
            const [camera, audio] = await Promise.all([
                setupCamera(),
                setupAudio()
            ]);

            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - –ö–∞–º–µ—Ä–∞:', camera, '–ê—É–¥–∏–æ:', audio);

            if (camera && audio) {
                console.log('‚úÖ –í–°–Å –£–°–ü–ï–®–ù–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–û');
                loading.style.display = 'none';
                status.textContent = '–ì–æ—Ç–æ–≤–æ! ‚úåÔ∏è = —Å–æ–∑–¥–∞—Ç—å | üòÆ = —Ä–µ–∂–∏–º ‚úé | ‚úã = –¥–≤–∏–≥–∞—Ç—å | ‚úä 2—Å = —Ñ–∏–∫—Å | ü§ô = —Ä–∞–∑–±–ª–æ–∫ | ü§û 2—Å = —É–¥–∞–ª–∏—Ç—å';
                detectHands();
            } else {
                console.log('‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –ö–∞–º–µ—Ä–∞:', !!camera, '–ê—É–¥–∏–æ:', !!audio);
                loading.style.display = 'none';
                status.textContent = camera ? '–†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∑–≤—É–∫–∞' : '–†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∫–∞–º–µ—Ä—ã';
                if (camera) detectHands();
            }

            console.log('=== –ö–û–ù–ï–¶ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ===');
        }

        console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
        init();
    </script>
</body>
</html>
